/**
 * MADAS Marketing Website Server with Firebase Integration
 * Handles signup, contact forms, and newsletter subscriptions
 */

const express = require('express');
const cors = require('cors');
const path = require('path');
const { initializeFirebase, getFirestore, getAuth, firebaseConfig } = require('./firebase-config');

// Initialize Express
const app = express();
const PORT = process.env.PORT || 3000;

// Middleware
app.use(cors());
app.use(express.json());
app.use(express.urlencoded({ extended: true }));

// Initialize Firebase
const firebaseReady = initializeFirebase();

// Serve static files (HTML pages)
app.use(express.static(__dirname));

// Routes for HTML pages
app.get('/', (req, res) => {
  res.sendFile(path.join(__dirname, 'index.html'));
});

app.get('/pricing', (req, res) => {
  res.sendFile(path.join(__dirname, 'pricing.html'));
});

app.get('/signup', (req, res) => {
  res.sendFile(path.join(__dirname, 'signup.html'));
});

app.get('/about', (req, res) => {
  res.sendFile(path.join(__dirname, 'about.html'));
});

app.get('/contact', (req, res) => {
  res.sendFile(path.join(__dirname, 'contact.html'));
});

// API Routes

/**
 * POST /api/register
 * Register new business account with Firebase
 */
app.post('/api/register', async (req, res) => {
  try {
    const {
      businessName,
      industry,
      businessEmail,
      phone,
      companySize,
      plan,
      userName,
      userEmail,
      password
    } = req.body;

    console.log('ðŸ“ Registration Data Received:');
    console.log('Business:', businessName, industry, companySize);
    console.log('Contact:', businessEmail, phone);
    console.log('Plan:', plan);
    console.log('User:', userName, userEmail);

    // Validation
    if (!businessName || !businessEmail || !industry || !companySize) {
      return res.status(400).json({ 
        error: 'Missing required business information' 
      });
    }

    if (!plan || !['basic', 'professional', 'enterprise'].includes(plan)) {
      return res.status(400).json({ 
        error: 'Invalid plan selected' 
      });
    }

    if (!userName || !userEmail || !password) {
      return res.status(400).json({ 
        error: 'Missing required account information' 
      });
    }

    if (firebaseReady) {
      // Firebase integration
      const db = getFirestore();
      const auth = getAuth();

      if (!db || !auth) {
        throw new Error('Firebase services not available');
      }

      // Check if business email already exists
      const existingBusinesses = await db.collection('businesses')
        .where('contact.email', '==', businessEmail)
        .get();

      if (!existingBusinesses.empty) {
        return res.status(409).json({ 
          error: 'A business with this email already exists' 
        });
      }

      // Create user in Firebase Auth
      let userRecord;
      try {
        userRecord = await auth.createUser({
          email: userEmail,
          password: password,
          displayName: userName
        });
        console.log('âœ… User created in Firebase Auth:', userRecord.uid);
      } catch (authError) {
        if (authError.code === 'auth/email-already-exists') {
          return res.status(409).json({ 
            error: 'An account with this email already exists' 
          });
        }
        throw authError;
      }

      // Create business document
      const businessRef = db.collection('businesses').doc();
      const businessId = businessRef.id;

      const now = admin.firestore.FieldValue.serverTimestamp();
      const trialEnd = new Date();
      trialEnd.setDate(trialEnd.getDate() + 14); // 14 day trial

      const businessData = {
        businessId,
        businessName,
        slug: businessName.toLowerCase().replace(/\s+/g, '-'),
        
        plan: {
          type: plan,
          status: 'trial',
          startDate: now,
          expiresAt: admin.firestore.Timestamp.fromDate(trialEnd),
          autoRenew: false,
          billingCycle: 'monthly'
        },
        
        contact: {
          email: businessEmail,
          phone: phone || '',
          website: ''
        },
        
        owner: {
          userId: userRecord.uid,
          name: userName,
          email: userEmail
        },
        
        businessInfo: {
          industry,
          companySize
        },
        
        limits: {
          maxStaff: plan === 'basic' ? 5 : (plan === 'professional' ? 20 : -1),
          maxProducts: plan === 'basic' ? 500 : (plan === 'professional' ? 1000 : -1),
          maxOrders: -1,
          maxStorage: plan === 'basic' ? 1 : (plan === 'professional' ? 50 : 500),
          maxApiCalls: plan === 'basic' ? 1000 : (plan === 'professional' ? 10000 : 100000),
          maxLocations: plan === 'basic' ? 1 : (plan === 'professional' ? 3 : -1)
        },
        
        usage: {
          staffCount: 1,
          productsCount: 0,
          ordersThisMonth: 0,
          storageUsed: 0,
          apiCallsThisMonth: 0,
          locationsCount: 0
        },
        
        features: {
          pos: true,
          inventory: true,
          orders: true,
          customers: true,
          analytics: true,
          reports: true,
          advanced_reports: plan !== 'basic',
          insights: plan === 'enterprise',
          gamification: plan !== 'basic',
          loyalty: plan !== 'basic',
          madas_pass: plan !== 'basic',
          reviews: plan !== 'basic',
          collections: plan !== 'basic',
          customer_wallet: plan !== 'basic',
          website_builder: plan === 'enterprise',
          api_access: plan !== 'basic',
          custom_domain: plan === 'enterprise',
          multi_location: plan === 'enterprise',
          shares_management: plan === 'enterprise'
        },
        
        settings: {
          currency: 'USD',
          timezone: 'America/New_York',
          language: 'en',
          dateFormat: 'MM/DD/YYYY',
          logo: null,
          primaryColor: '#6366F1',
          taxRate: 0
        },
        
        status: 'active',
        suspensionReason: null,
        
        metadata: {
          createdAt: now,
          createdBy: userRecord.uid,
          updatedAt: now,
          lastActivityAt: now,
          isVerified: false
        }
      };

      await businessRef.set(businessData);
      console.log('âœ… Business document created:', businessId);

      // Create user document
      await db.collection('users').doc(userRecord.uid).set({
        userId: userRecord.uid,
        name: userName,
        email: userEmail,
        phone: phone || '',
        avatar: null,
        
        emailVerified: false,
        phoneVerified: false,
        authProvider: 'email',
        
        businesses: [{
          businessId,
          businessName,
          role: 'owner',
          joinedAt: now
        }],
        
        currentBusinessId: businessId,
        platformRole: null,
        
        preferences: {
          language: 'en',
          timezone: 'America/New_York',
          notifications: {
            email: true,
            push: true,
            sms: false
          }
        },
        
        metadata: {
          createdAt: now,
          updatedAt: now,
          lastLogin: null,
          lastSeen: null
        }
      });

      // Add owner as staff member
      await businessRef.collection('staff').doc(userRecord.uid).set({
        staffId: userRecord.uid,
        userId: userRecord.uid,
        businessId,
        
        name: userName,
        email: userEmail,
        phone: phone || '',
        avatar: null,
        
        role: 'owner',
        permissions: {
          canViewProducts: true,
          canCreateProducts: true,
          canEditProducts: true,
          canDeleteProducts: true,
          canViewOrders: true,
          canCreateOrders: true,
          canEditOrders: true,
          canCancelOrders: true,
          canRefundOrders: true,
          canViewCustomers: true,
          canEditCustomers: true,
          canDeleteCustomers: true,
          canViewReports: true,
          canViewFinances: true,
          canManageExpenses: true,
          canViewStaff: true,
          canManageStaff: true,
          canAccessPOS: true,
          canEditSettings: true,
          canManageBilling: true
        },
        
        employment: {
          status: 'active',
          hireDate: now,
          terminationDate: null,
          position: 'Owner',
          location: 'Main Office'
        },
        
        metadata: {
          invitedAt: now,
          invitedBy: 'system',
          joinedAt: now,
          lastLogin: null,
          createdAt: now
        }
      });

      // Create custom token for immediate login
      const customToken = await auth.createCustomToken(userRecord.uid);

      console.log('âœ… Firebase registration completed successfully');

      res.status(201).json({
        success: true,
        message: 'Account created successfully!',
        user: {
          userId: userRecord.uid,
          email: userEmail,
          name: userName
        },
        business: {
          businessId,
          businessName,
          plan: plan,
          trialEnds: trialEnd.toISOString()
        },
        token: customToken,
        firebase: true
      });

    } else {
      // Fallback to mock response if Firebase is not available
      console.log('âš ï¸  Firebase not available, using mock response');
      
      await new Promise(resolve => setTimeout(resolve, 1000));

      res.status(201).json({
        success: true,
        message: 'Account created successfully! (Mock Mode)',
        user: {
          userId: 'mock_user_' + Date.now(),
          email: userEmail,
          name: userName
        },
        business: {
          businessId: 'mock_business_' + Date.now(),
          businessName,
          plan: plan,
          trialEnds: new Date(Date.now() + 14 * 24 * 60 * 60 * 1000).toISOString()
        },
        token: 'mock_token_' + Date.now(),
        firebase: false
      });
    }

  } catch (error) {
    console.error('âŒ Registration error:', error);
    
    // Cleanup: delete user if business creation failed
    if (error.userRecord && firebaseReady) {
      try {
        const auth = getAuth();
        if (auth) {
          await auth.deleteUser(error.userRecord.uid);
        }
      } catch (deleteError) {
        console.error('Failed to cleanup user:', deleteError);
      }
    }

    res.status(500).json({ 
      error: 'Registration failed',
      message: 'An error occurred during registration. Please try again.' 
    });
  }
});

/**
 * POST /api/contact
 * Handle contact form submissions
 */
app.post('/api/contact', async (req, res) => {
  try {
    const { name, email, subject, message } = req.body;

    console.log('ðŸ“§ Contact Form Received:');
    console.log('From:', name, email);
    console.log('Subject:', subject);

    if (!name || !email || !subject || !message) {
      return res.status(400).json({ 
        error: 'All fields are required' 
      });
    }

    if (firebaseReady) {
      const db = getFirestore();
      if (db) {
        // Save to Firestore
        const submissionRef = db.collection('contact-submissions').doc();
        
        await submissionRef.set({
          submissionId: submissionRef.id,
          name,
          email,
          subject,
          message,
          status: 'new',
          metadata: {
            submittedAt: admin.firestore.FieldValue.serverTimestamp(),
            respondedAt: null,
            notes: ''
          }
        });

        console.log('âœ… Contact submission saved to Firebase');
      }
    }

    res.json({
      success: true,
      message: 'Message sent successfully. We\'ll get back to you soon!'
    });

  } catch (error) {
    console.error('âŒ Contact form error:', error);
    res.status(500).json({ 
      error: 'Failed to send message. Please try again.' 
    });
  }
});

/**
 * POST /api/newsletter/subscribe
 * Newsletter subscription
 */
app.post('/api/newsletter/subscribe', async (req, res) => {
  try {
    const { email, name } = req.body;

    console.log('ðŸ“° Newsletter Subscription:', email, name);

    if (!email) {
      return res.status(400).json({ error: 'Email is required' });
    }

    if (firebaseReady) {
      const db = getFirestore();
      if (db) {
        // Check if already subscribed
        const existing = await db.collection('newsletter-subscribers').doc(email).get();

        if (existing.exists) {
          return res.status(409).json({ 
            message: 'You\'re already subscribed to our newsletter' 
          });
        }

        // Add to newsletter
        await db.collection('newsletter-subscribers').doc(email).set({
          email,
          name: name || '',
          subscribedAt: admin.firestore.FieldValue.serverTimestamp(),
          source: req.body.source || 'website',
          isActive: true
        });

        console.log('âœ… Newsletter subscription saved to Firebase');
      }
    }

    res.json({
      success: true,
      message: 'Successfully subscribed to our newsletter!'
    });

  } catch (error) {
    console.error('âŒ Newsletter error:', error);
    res.status(500).json({ 
      error: 'Failed to subscribe. Please try again.' 
    });
  }
});

// Health check
app.get('/health', (req, res) => {
  res.json({ 
    status: 'ok', 
    firebase: firebaseReady,
    timestamp: new Date().toISOString() 
  });
});

// 404 handler
app.use((req, res) => {
  res.status(404).send(`
    <!DOCTYPE html>
    <html>
    <head>
      <title>404 - Page Not Found</title>
      <style>
        body {
          font-family: 'Inter', sans-serif;
          display: flex;
          align-items: center;
          justify-content: center;
          height: 100vh;
          margin: 0;
          background: linear-gradient(135deg, #667EEA 0%, #764BA2 100%);
          color: white;
        }
        .container {
          text-align: center;
        }
        h1 { font-size: 4rem; margin: 0; }
        p { font-size: 1.5rem; margin: 1rem 0; }
        a {
          display: inline-block;
          margin-top: 2rem;
          padding: 1rem 2rem;
          background: white;
          color: #6366F1;
          text-decoration: none;
          border-radius: 8px;
          font-weight: 600;
        }
        a:hover { transform: translateY(-2px); }
      </style>
    </head>
    <body>
      <div class="container">
        <h1>404</h1>
        <p>Oops! Page not found.</p>
        <a href="/">Go Home</a>
      </div>
    </body>
    </html>
  `);
});

// Error handler
app.use((err, req, res, next) => {
  console.error('Error:', err);
  res.status(500).json({ 
    error: 'Internal server error',
    message: err.message 
  });
});

// Start server
app.listen(PORT, () => {
  console.log(`
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                                                              â•‘
â•‘   ðŸ”¥ MADAS Marketing Website with Firebase                  â•‘
â•‘                                                              â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âœ… Server running on: http://localhost:${PORT}

ðŸ“„ Available Pages:
   â†’ Landing:  http://localhost:${PORT}/
   â†’ Pricing:  http://localhost:${PORT}/pricing
   â†’ Signup:   http://localhost:${PORT}/signup
   â†’ About:    http://localhost:${PORT}/about
   â†’ Contact:  http://localhost:${PORT}/contact

ðŸ”¥ Firebase Status: ${firebaseReady ? 'âœ… Connected' : 'âŒ Not Connected'}

ðŸ”§ API Endpoints:
   â†’ POST /api/register ${firebaseReady ? '(Firebase)' : '(Mock)'}
   â†’ POST /api/contact ${firebaseReady ? '(Firebase)' : '(Mock)'}
   â†’ POST /api/newsletter/subscribe ${firebaseReady ? '(Firebase)' : '(Mock)'}

ðŸ’¡ Health Check:
   â†’ GET /health

ðŸš€ Ready to test your signup form!

Press Ctrl+C to stop the server
  `);
});

// Graceful shutdown
process.on('SIGTERM', () => {
  console.log('SIGTERM signal received: closing HTTP server');
  app.close(() => {
    console.log('HTTP server closed');
  });
});
 * MADAS Marketing Website Server with Firebase Integration
 * Handles signup, contact forms, and newsletter subscriptions
 */

const express = require('express');
const cors = require('cors');
const path = require('path');
const { initializeFirebase, getFirestore, getAuth, firebaseConfig } = require('./firebase-config');

// Initialize Express
const app = express();
const PORT = process.env.PORT || 3000;

// Middleware
app.use(cors());
app.use(express.json());
app.use(express.urlencoded({ extended: true }));

// Initialize Firebase
const firebaseReady = initializeFirebase();

// Serve static files (HTML pages)
app.use(express.static(__dirname));

// Routes for HTML pages
app.get('/', (req, res) => {
  res.sendFile(path.join(__dirname, 'index.html'));
});

app.get('/pricing', (req, res) => {
  res.sendFile(path.join(__dirname, 'pricing.html'));
});

app.get('/signup', (req, res) => {
  res.sendFile(path.join(__dirname, 'signup.html'));
});

app.get('/about', (req, res) => {
  res.sendFile(path.join(__dirname, 'about.html'));
});

app.get('/contact', (req, res) => {
  res.sendFile(path.join(__dirname, 'contact.html'));
});

// API Routes

/**
 * POST /api/register
 * Register new business account with Firebase
 */
app.post('/api/register', async (req, res) => {
  try {
    const {
      businessName,
      industry,
      businessEmail,
      phone,
      companySize,
      plan,
      userName,
      userEmail,
      password
    } = req.body;

    console.log('ðŸ“ Registration Data Received:');
    console.log('Business:', businessName, industry, companySize);
    console.log('Contact:', businessEmail, phone);
    console.log('Plan:', plan);
    console.log('User:', userName, userEmail);

    // Validation
    if (!businessName || !businessEmail || !industry || !companySize) {
      return res.status(400).json({ 
        error: 'Missing required business information' 
      });
    }

    if (!plan || !['basic', 'professional', 'enterprise'].includes(plan)) {
      return res.status(400).json({ 
        error: 'Invalid plan selected' 
      });
    }

    if (!userName || !userEmail || !password) {
      return res.status(400).json({ 
        error: 'Missing required account information' 
      });
    }

    if (firebaseReady) {
      // Firebase integration
      const db = getFirestore();
      const auth = getAuth();

      if (!db || !auth) {
        throw new Error('Firebase services not available');
      }

      // Check if business email already exists
      const existingBusinesses = await db.collection('businesses')
        .where('contact.email', '==', businessEmail)
        .get();

      if (!existingBusinesses.empty) {
        return res.status(409).json({ 
          error: 'A business with this email already exists' 
        });
      }

      // Create user in Firebase Auth
      let userRecord;
      try {
        userRecord = await auth.createUser({
          email: userEmail,
          password: password,
          displayName: userName
        });
        console.log('âœ… User created in Firebase Auth:', userRecord.uid);
      } catch (authError) {
        if (authError.code === 'auth/email-already-exists') {
          return res.status(409).json({ 
            error: 'An account with this email already exists' 
          });
        }
        throw authError;
      }

      // Create business document
      const businessRef = db.collection('businesses').doc();
      const businessId = businessRef.id;

      const now = admin.firestore.FieldValue.serverTimestamp();
      const trialEnd = new Date();
      trialEnd.setDate(trialEnd.getDate() + 14); // 14 day trial

      const businessData = {
        businessId,
        businessName,
        slug: businessName.toLowerCase().replace(/\s+/g, '-'),
        
        plan: {
          type: plan,
          status: 'trial',
          startDate: now,
          expiresAt: admin.firestore.Timestamp.fromDate(trialEnd),
          autoRenew: false,
          billingCycle: 'monthly'
        },
        
        contact: {
          email: businessEmail,
          phone: phone || '',
          website: ''
        },
        
        owner: {
          userId: userRecord.uid,
          name: userName,
          email: userEmail
        },
        
        businessInfo: {
          industry,
          companySize
        },
        
        limits: {
          maxStaff: plan === 'basic' ? 5 : (plan === 'professional' ? 20 : -1),
          maxProducts: plan === 'basic' ? 500 : (plan === 'professional' ? 1000 : -1),
          maxOrders: -1,
          maxStorage: plan === 'basic' ? 1 : (plan === 'professional' ? 50 : 500),
          maxApiCalls: plan === 'basic' ? 1000 : (plan === 'professional' ? 10000 : 100000),
          maxLocations: plan === 'basic' ? 1 : (plan === 'professional' ? 3 : -1)
        },
        
        usage: {
          staffCount: 1,
          productsCount: 0,
          ordersThisMonth: 0,
          storageUsed: 0,
          apiCallsThisMonth: 0,
          locationsCount: 0
        },
        
        features: {
          pos: true,
          inventory: true,
          orders: true,
          customers: true,
          analytics: true,
          reports: true,
          advanced_reports: plan !== 'basic',
          insights: plan === 'enterprise',
          gamification: plan !== 'basic',
          loyalty: plan !== 'basic',
          madas_pass: plan !== 'basic',
          reviews: plan !== 'basic',
          collections: plan !== 'basic',
          customer_wallet: plan !== 'basic',
          website_builder: plan === 'enterprise',
          api_access: plan !== 'basic',
          custom_domain: plan === 'enterprise',
          multi_location: plan === 'enterprise',
          shares_management: plan === 'enterprise'
        },
        
        settings: {
          currency: 'USD',
          timezone: 'America/New_York',
          language: 'en',
          dateFormat: 'MM/DD/YYYY',
          logo: null,
          primaryColor: '#6366F1',
          taxRate: 0
        },
        
        status: 'active',
        suspensionReason: null,
        
        metadata: {
          createdAt: now,
          createdBy: userRecord.uid,
          updatedAt: now,
          lastActivityAt: now,
          isVerified: false
        }
      };

      await businessRef.set(businessData);
      console.log('âœ… Business document created:', businessId);

      // Create user document
      await db.collection('users').doc(userRecord.uid).set({
        userId: userRecord.uid,
        name: userName,
        email: userEmail,
        phone: phone || '',
        avatar: null,
        
        emailVerified: false,
        phoneVerified: false,
        authProvider: 'email',
        
        businesses: [{
          businessId,
          businessName,
          role: 'owner',
          joinedAt: now
        }],
        
        currentBusinessId: businessId,
        platformRole: null,
        
        preferences: {
          language: 'en',
          timezone: 'America/New_York',
          notifications: {
            email: true,
            push: true,
            sms: false
          }
        },
        
        metadata: {
          createdAt: now,
          updatedAt: now,
          lastLogin: null,
          lastSeen: null
        }
      });

      // Add owner as staff member
      await businessRef.collection('staff').doc(userRecord.uid).set({
        staffId: userRecord.uid,
        userId: userRecord.uid,
        businessId,
        
        name: userName,
        email: userEmail,
        phone: phone || '',
        avatar: null,
        
        role: 'owner',
        permissions: {
          canViewProducts: true,
          canCreateProducts: true,
          canEditProducts: true,
          canDeleteProducts: true,
          canViewOrders: true,
          canCreateOrders: true,
          canEditOrders: true,
          canCancelOrders: true,
          canRefundOrders: true,
          canViewCustomers: true,
          canEditCustomers: true,
          canDeleteCustomers: true,
          canViewReports: true,
          canViewFinances: true,
          canManageExpenses: true,
          canViewStaff: true,
          canManageStaff: true,
          canAccessPOS: true,
          canEditSettings: true,
          canManageBilling: true
        },
        
        employment: {
          status: 'active',
          hireDate: now,
          terminationDate: null,
          position: 'Owner',
          location: 'Main Office'
        },
        
        metadata: {
          invitedAt: now,
          invitedBy: 'system',
          joinedAt: now,
          lastLogin: null,
          createdAt: now
        }
      });

      // Create custom token for immediate login
      const customToken = await auth.createCustomToken(userRecord.uid);

      console.log('âœ… Firebase registration completed successfully');

      res.status(201).json({
        success: true,
        message: 'Account created successfully!',
        user: {
          userId: userRecord.uid,
          email: userEmail,
          name: userName
        },
        business: {
          businessId,
          businessName,
          plan: plan,
          trialEnds: trialEnd.toISOString()
        },
        token: customToken,
        firebase: true
      });

    } else {
      // Fallback to mock response if Firebase is not available
      console.log('âš ï¸  Firebase not available, using mock response');
      
      await new Promise(resolve => setTimeout(resolve, 1000));

      res.status(201).json({
        success: true,
        message: 'Account created successfully! (Mock Mode)',
        user: {
          userId: 'mock_user_' + Date.now(),
          email: userEmail,
          name: userName
        },
        business: {
          businessId: 'mock_business_' + Date.now(),
          businessName,
          plan: plan,
          trialEnds: new Date(Date.now() + 14 * 24 * 60 * 60 * 1000).toISOString()
        },
        token: 'mock_token_' + Date.now(),
        firebase: false
      });
    }

  } catch (error) {
    console.error('âŒ Registration error:', error);
    
    // Cleanup: delete user if business creation failed
    if (error.userRecord && firebaseReady) {
      try {
        const auth = getAuth();
        if (auth) {
          await auth.deleteUser(error.userRecord.uid);
        }
      } catch (deleteError) {
        console.error('Failed to cleanup user:', deleteError);
      }
    }

    res.status(500).json({ 
      error: 'Registration failed',
      message: 'An error occurred during registration. Please try again.' 
    });
  }
});

/**
 * POST /api/contact
 * Handle contact form submissions
 */
app.post('/api/contact', async (req, res) => {
  try {
    const { name, email, subject, message } = req.body;

    console.log('ðŸ“§ Contact Form Received:');
    console.log('From:', name, email);
    console.log('Subject:', subject);

    if (!name || !email || !subject || !message) {
      return res.status(400).json({ 
        error: 'All fields are required' 
      });
    }

    if (firebaseReady) {
      const db = getFirestore();
      if (db) {
        // Save to Firestore
        const submissionRef = db.collection('contact-submissions').doc();
        
        await submissionRef.set({
          submissionId: submissionRef.id,
          name,
          email,
          subject,
          message,
          status: 'new',
          metadata: {
            submittedAt: admin.firestore.FieldValue.serverTimestamp(),
            respondedAt: null,
            notes: ''
          }
        });

        console.log('âœ… Contact submission saved to Firebase');
      }
    }

    res.json({
      success: true,
      message: 'Message sent successfully. We\'ll get back to you soon!'
    });

  } catch (error) {
    console.error('âŒ Contact form error:', error);
    res.status(500).json({ 
      error: 'Failed to send message. Please try again.' 
    });
  }
});

/**
 * POST /api/newsletter/subscribe
 * Newsletter subscription
 */
app.post('/api/newsletter/subscribe', async (req, res) => {
  try {
    const { email, name } = req.body;

    console.log('ðŸ“° Newsletter Subscription:', email, name);

    if (!email) {
      return res.status(400).json({ error: 'Email is required' });
    }

    if (firebaseReady) {
      const db = getFirestore();
      if (db) {
        // Check if already subscribed
        const existing = await db.collection('newsletter-subscribers').doc(email).get();

        if (existing.exists) {
          return res.status(409).json({ 
            message: 'You\'re already subscribed to our newsletter' 
          });
        }

        // Add to newsletter
        await db.collection('newsletter-subscribers').doc(email).set({
          email,
          name: name || '',
          subscribedAt: admin.firestore.FieldValue.serverTimestamp(),
          source: req.body.source || 'website',
          isActive: true
        });

        console.log('âœ… Newsletter subscription saved to Firebase');
      }
    }

    res.json({
      success: true,
      message: 'Successfully subscribed to our newsletter!'
    });

  } catch (error) {
    console.error('âŒ Newsletter error:', error);
    res.status(500).json({ 
      error: 'Failed to subscribe. Please try again.' 
    });
  }
});

// Health check
app.get('/health', (req, res) => {
  res.json({ 
    status: 'ok', 
    firebase: firebaseReady,
    timestamp: new Date().toISOString() 
  });
});

// 404 handler
app.use((req, res) => {
  res.status(404).send(`
    <!DOCTYPE html>
    <html>
    <head>
      <title>404 - Page Not Found</title>
      <style>
        body {
          font-family: 'Inter', sans-serif;
          display: flex;
          align-items: center;
          justify-content: center;
          height: 100vh;
          margin: 0;
          background: linear-gradient(135deg, #667EEA 0%, #764BA2 100%);
          color: white;
        }
        .container {
          text-align: center;
        }
        h1 { font-size: 4rem; margin: 0; }
        p { font-size: 1.5rem; margin: 1rem 0; }
        a {
          display: inline-block;
          margin-top: 2rem;
          padding: 1rem 2rem;
          background: white;
          color: #6366F1;
          text-decoration: none;
          border-radius: 8px;
          font-weight: 600;
        }
        a:hover { transform: translateY(-2px); }
      </style>
    </head>
    <body>
      <div class="container">
        <h1>404</h1>
        <p>Oops! Page not found.</p>
        <a href="/">Go Home</a>
      </div>
    </body>
    </html>
  `);
});

// Error handler
app.use((err, req, res, next) => {
  console.error('Error:', err);
  res.status(500).json({ 
    error: 'Internal server error',
    message: err.message 
  });
});

// Start server
app.listen(PORT, () => {
  console.log(`
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                                                              â•‘
â•‘   ðŸ”¥ MADAS Marketing Website with Firebase                  â•‘
â•‘                                                              â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âœ… Server running on: http://localhost:${PORT}

ðŸ“„ Available Pages:
   â†’ Landing:  http://localhost:${PORT}/
   â†’ Pricing:  http://localhost:${PORT}/pricing
   â†’ Signup:   http://localhost:${PORT}/signup
   â†’ About:    http://localhost:${PORT}/about
   â†’ Contact:  http://localhost:${PORT}/contact

ðŸ”¥ Firebase Status: ${firebaseReady ? 'âœ… Connected' : 'âŒ Not Connected'}

ðŸ”§ API Endpoints:
   â†’ POST /api/register ${firebaseReady ? '(Firebase)' : '(Mock)'}
   â†’ POST /api/contact ${firebaseReady ? '(Firebase)' : '(Mock)'}
   â†’ POST /api/newsletter/subscribe ${firebaseReady ? '(Firebase)' : '(Mock)'}

ðŸ’¡ Health Check:
   â†’ GET /health

ðŸš€ Ready to test your signup form!

Press Ctrl+C to stop the server
  `);
});

// Graceful shutdown
process.on('SIGTERM', () => {
  console.log('SIGTERM signal received: closing HTTP server');
  app.close(() => {
    console.log('HTTP server closed');
  });
});


