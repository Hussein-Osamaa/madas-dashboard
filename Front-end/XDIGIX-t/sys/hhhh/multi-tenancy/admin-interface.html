<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Business Management - DIGIX Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --primary: #3B82F6;
            --success: #10B981;
            --warning: #F59E0B;
            --danger: #EF4444;
        }

        body {
            font-family: 'Inter', sans-serif;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 50;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .tab-button {
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .tab-button.active {
            border-bottom-color: var(--primary);
            color: var(--primary);
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .status-active {
            background: #D1FAE5;
            color: #065F46;
        }

        .status-trial {
            background: #FEF3C7;
            color: #92400E;
        }

        .status-suspended {
            background: #FEE2E2;
            color: #991B1B;
        }

        .plan-badge {
            padding: 4px 12px;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .plan-basic {
            background: #E0E7FF;
            color: #3730A3;
        }

        .plan-professional {
            background: #DDD6FE;
            color: #5B21B6;
        }

        .plan-enterprise {
            background: #FCE7F3;
            color: #831843;
        }

        .checkbox-feature {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .feature-category {
            background: #F9FAFB;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 12px;
        }

        .action-btn {
            padding: 8px;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .action-btn:hover {
            transform: scale(1.1);
        }
    </style>
</head>

<body class="bg-gray-50">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b sticky top-0 z-40">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-2xl font-bold text-gray-900">Business Management</h1>
                    <p class="text-sm text-gray-500">Multi-tenant admin panel</p>
                </div>
                <div class="flex items-center gap-4">
                    <span class="px-3 py-1 bg-purple-100 text-purple-700 rounded-full text-sm font-medium">
                        Super Admin
                    </span>
                    <div class="flex items-center gap-2">
                        <div
                            class="w-10 h-10 rounded-full bg-blue-500 flex items-center justify-center text-white font-bold">
                            <span id="user-initial">A</span>
                        </div>
                        <div>
                            <p class="text-sm font-medium" id="user-name">Admin User</p>
                            <p class="text-xs text-gray-500" id="user-email">admin@madas.com</p>
                        </div>
                    </div>
                    <button id="logout-btn" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600">
                        Logout
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Tabs -->
    <div class="bg-white border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <nav class="flex space-x-8">
                <button class="tab-button active px-4 py-4 font-medium flex items-center gap-2" data-tab="businesses">
                    <span class="material-icons text-sm">business</span>
                    Businesses
                </button>
                <button class="tab-button px-4 py-4 font-medium text-gray-500 flex items-center gap-2" data-tab="staff">
                    <span class="material-icons text-sm">people</span>
                    Staff Management
                </button>
                <button class="tab-button px-4 py-4 font-medium text-gray-500 flex items-center gap-2"
                    data-tab="analytics">
                    <span class="material-icons text-sm">analytics</span>
                    Analytics
                </button>
            </nav>
        </div>
    </div>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

        <!-- Tab 1: Businesses -->
        <div id="tab-businesses" class="tab-content">
            <!-- Stats Cards -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-500 text-sm">Total Businesses</p>
                            <p class="text-3xl font-bold text-gray-900" id="stat-total">0</p>
                        </div>
                        <span class="material-icons text-blue-500 text-4xl">business</span>
                    </div>
                    <p class="text-green-500 text-sm mt-2">‚Üë 12% from last month</p>
                </div>

                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-500 text-sm">Active</p>
                            <p class="text-3xl font-bold text-green-600" id="stat-active">0</p>
                        </div>
                        <span class="material-icons text-green-500 text-4xl">check_circle</span>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-500 text-sm">Trial</p>
                            <p class="text-3xl font-bold text-orange-600" id="stat-trial">0</p>
                        </div>
                        <span class="material-icons text-orange-500 text-4xl">schedule</span>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-500 text-sm">Suspended</p>
                            <p class="text-3xl font-bold text-red-600" id="stat-suspended">0</p>
                        </div>
                        <span class="material-icons text-red-500 text-4xl">block</span>
                    </div>
                </div>
            </div>

            <!-- Action Bar -->
            <div class="bg-white rounded-lg shadow p-6 mb-6">
                <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                    <div class="flex-1">
                        <div class="relative">
                            <span class="material-icons absolute left-3 top-3 text-gray-400">search</span>
                            <input type="text" id="search-businesses" placeholder="Search businesses..."
                                class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                    <div class="flex gap-3">
                        <select id="filter-plan"
                            class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">All Plans</option>
                            <option value="basic">Basic</option>
                            <option value="professional">Professional</option>
                            <option value="enterprise">Enterprise</option>
                        </select>
                        <select id="filter-status"
                            class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">All Status</option>
                            <option value="active">Active</option>
                            <option value="trial">Trial</option>
                            <option value="suspended">Suspended</option>
                        </select>
                        <button id="add-business-btn"
                            class="bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600 flex items-center gap-2">
                            <span class="material-icons">add</span>
                            Add Business
                        </button>
                    </div>
                </div>
            </div>

            <!-- Businesses Table -->
            <div class="bg-white rounded-lg shadow overflow-hidden">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Business</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Plan</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Status</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Staff</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Created</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Actions</th>
                        </tr>
                    </thead>
                    <tbody id="businesses-tbody" class="bg-white divide-y divide-gray-200">
                        <!-- Rows will be inserted here -->
                        <tr>
                            <td colspan="6" class="px-6 py-12 text-center text-gray-500">
                                <div class="flex flex-col items-center">
                                    <span class="material-icons text-6xl text-gray-300 mb-4">business</span>
                                    <p class="text-lg">No businesses yet</p>
                                    <p class="text-sm">Click "Add Business" to create your first business account</p>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Tab 2: Staff Management -->
        <div id="tab-staff" class="tab-content hidden">
            <div class="bg-white rounded-lg shadow p-6 mb-6">
                <h3 class="text-lg font-medium mb-4">Select Business to Manage Staff</h3>
                <select id="business-selector" class="w-full md:w-96 px-4 py-2 border border-gray-300 rounded-lg">
                    <option value="">Select a business...</option>
                </select>
            </div>

            <div id="staff-content" class="hidden">
                <div class="bg-white rounded-lg shadow p-6 mb-6">
                    <div class="flex justify-between items-center">
                        <div>
                            <h3 class="text-xl font-bold" id="selected-business-name">Business Name</h3>
                            <p class="text-sm text-gray-500" id="selected-business-plan">Plan: Professional</p>
                        </div>
                        <button id="add-staff-btn"
                            class="bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600 flex items-center gap-2">
                            <span class="material-icons">person_add</span>
                            Add Staff
                        </button>
                    </div>
                </div>

                <!-- Staff Table -->
                <div class="bg-white rounded-lg shadow overflow-hidden">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Staff Member
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Role</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Joined</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Actions
                                </th>
                            </tr>
                        </thead>
                        <tbody id="staff-tbody" class="bg-white divide-y divide-gray-200">
                            <tr>
                                <td colspan="5" class="px-6 py-12 text-center text-gray-500">
                                    No staff members yet
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Tab 3: Analytics -->
        <div id="tab-analytics" class="tab-content hidden">
            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-xl font-bold mb-4">Platform Analytics</h3>
                <p class="text-gray-500">Analytics dashboard coming soon...</p>
            </div>
        </div>

    </main>

    <!-- Add/Edit Business Modal -->
    <div id="business-modal" class="modal">
        <div class="modal-content">
            <div class="p-6 border-b">
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-bold" id="modal-title">Add New Business</h3>
                    <button class="text-gray-400 hover:text-gray-600" onclick="closeModal('business-modal')">
                        <span class="material-icons">close</span>
                    </button>
                </div>
            </div>

            <form id="business-form" class="p-6">
                <input type="hidden" id="business-id">

                <!-- Business Name -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Business Name *</label>
                    <input type="text" id="business-name" required
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                        placeholder="e.g. Acme Corporation">
                </div>

                <!-- Contact Email -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Contact Email *</label>
                    <input type="email" id="business-email" required
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                        placeholder="admin@business.com">
                </div>

                <!-- Phone (optional) -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Phone</label>
                    <input type="tel" id="business-phone"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                        placeholder="+1234567890">
                </div>

                <!-- Plan Selection -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Subscription Plan *</label>
                    <select id="business-plan" required
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">Select a plan...</option>
                        <option value="basic">Basic - $29/month</option>
                        <option value="professional">Professional - $79/month</option>
                        <option value="enterprise">Enterprise - $199/month</option>
                    </select>
                </div>

                <!-- Features Selection -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-3">Features (Customize per
                        business)</label>

                    <div class="feature-category">
                        <h4 class="font-semibold text-sm mb-2">Core Features</h4>
                        <div class="space-y-2">
                            <label class="flex items-center gap-2">
                                <input type="checkbox" class="checkbox-feature" name="feature" value="pos" checked>
                                <span class="text-sm">Point of Sale (POS)</span>
                            </label>
                            <label class="flex items-center gap-2">
                                <input type="checkbox" class="checkbox-feature" name="feature" value="inventory"
                                    checked>
                                <span class="text-sm">Inventory Management</span>
                            </label>
                            <label class="flex items-center gap-2">
                                <input type="checkbox" class="checkbox-feature" name="feature" value="orders" checked>
                                <span class="text-sm">Order Management</span>
                            </label>
                            <label class="flex items-center gap-2">
                                <input type="checkbox" class="checkbox-feature" name="feature" value="customers"
                                    checked>
                                <span class="text-sm">Customer Management</span>
                            </label>
                        </div>
                    </div>

                    <div class="feature-category">
                        <h4 class="font-semibold text-sm mb-2">Analytics & Reports</h4>
                        <div class="space-y-2">
                            <label class="flex items-center gap-2">
                                <input type="checkbox" class="checkbox-feature" name="feature" value="analytics"
                                    checked>
                                <span class="text-sm">Basic Analytics</span>
                            </label>
                            <label class="flex items-center gap-2">
                                <input type="checkbox" class="checkbox-feature" name="feature" value="advanced_reports">
                                <span class="text-sm">Advanced Reports</span>
                            </label>
                            <label class="flex items-center gap-2">
                                <input type="checkbox" class="checkbox-feature" name="feature" value="insights">
                                <span class="text-sm">Advanced Insights</span>
                            </label>
                        </div>
                    </div>

                    <div class="feature-category">
                        <h4 class="font-semibold text-sm mb-2">Engagement Features</h4>
                        <div class="space-y-2">
                            <label class="flex items-center gap-2">
                                <input type="checkbox" class="checkbox-feature" name="feature" value="gamification">
                                <span class="text-sm">üéÆ Gamification Hub</span>
                            </label>
                            <label class="flex items-center gap-2">
                                <input type="checkbox" class="checkbox-feature" name="feature" value="loyalty">
                                <span class="text-sm">üíé Loyalty Program</span>
                            </label>
                            <label class="flex items-center gap-2">
                                <input type="checkbox" class="checkbox-feature" name="feature" value="madas_pass">
                                <span class="text-sm">üé´ MADAS Pass</span>
                            </label>
                            <label class="flex items-center gap-2">
                                <input type="checkbox" class="checkbox-feature" name="feature" value="reviews">
                                <span class="text-sm">‚≠ê Product Reviews</span>
                            </label>
                        </div>
                    </div>

                    <div class="feature-category">
                        <h4 class="font-semibold text-sm mb-2">Advanced Features</h4>
                        <div class="space-y-2">
                            <label class="flex items-center gap-2">
                                <input type="checkbox" class="checkbox-feature" name="feature" value="website_builder">
                                <span class="text-sm">Website Builder</span>
                            </label>
                            <label class="flex items-center gap-2">
                                <input type="checkbox" class="checkbox-feature" name="feature" value="api_access">
                                <span class="text-sm">API Access</span>
                            </label>
                            <label class="flex items-center gap-2">
                                <input type="checkbox" class="checkbox-feature" name="feature" value="custom_domain">
                                <span class="text-sm">Custom Domain</span>
                            </label>
                            <label class="flex items-center gap-2">
                                <input type="checkbox" class="checkbox-feature" name="feature" value="multi_location">
                                <span class="text-sm">Multi-Location</span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Trial Period -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Trial Days</label>
                    <input type="number" id="trial-days" value="14"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                        placeholder="14">
                    <p class="text-xs text-gray-500 mt-1">Number of days for free trial</p>
                </div>

                <!-- Submit Button -->
                <div class="flex gap-3 mt-6">
                    <button type="submit"
                        class="flex-1 bg-blue-500 text-white px-6 py-3 rounded-lg hover:bg-blue-600 font-medium">
                        Create Business
                    </button>
                    <button type="button" onclick="closeModal('business-modal')"
                        class="px-6 py-3 border border-gray-300 rounded-lg hover:bg-gray-50">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Staff Modal -->
    <div id="staff-modal" class="modal">
        <div class="modal-content">
            <div class="p-6 border-b">
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-bold">Add Staff Member</h3>
                    <button class="text-gray-400 hover:text-gray-600" onclick="closeModal('staff-modal')">
                        <span class="material-icons">close</span>
                    </button>
                </div>
            </div>

            <form id="staff-form" class="p-6">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Email *</label>
                    <input type="email" id="staff-email" required
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                        placeholder="staff@business.com">
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Name *</label>
                    <input type="text" id="staff-name" required
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                        placeholder="John Doe">
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Role *</label>
                    <select id="staff-role" required
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">Select role...</option>
                        <option value="admin">Admin</option>
                        <option value="manager">Manager</option>
                        <option value="staff">Staff</option>
                        <option value="cashier">Cashier</option>
                    </select>
                </div>

                <div class="flex gap-3 mt-6">
                    <button type="submit"
                        class="flex-1 bg-blue-500 text-white px-6 py-3 rounded-lg hover:bg-blue-600 font-medium">
                        Send Invitation
                    </button>
                    <button type="button" onclick="closeModal('staff-modal')"
                        class="px-6 py-3 border border-gray-300 rounded-lg hover:bg-gray-50">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, getDocs, addDoc, updateDoc, deleteDoc, doc, query, where, Timestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyC-ls1TrvSkrw71KqmB_kHYgPoj0H550a8",
            authDomain: "madas-store.firebaseapp.com",
            projectId: "madas-store",
            storageBucket: "madas-store.firebasestorage.app",
            messagingSenderId: "527071300010",
            appId: "1:527071300010:web:70470e2204065b4590583d3"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Global variables
        let currentUser = null;
        let businesses = [];
        let selectedBusinessId = null;

        // Check admin authorization first
        function checkAdminAuth() {
            const adminUser = localStorage.getItem('adminUser');
            if (!adminUser) {
                window.location.href = '/admin-login.html';
                return false;
            }

            try {
                const adminData = JSON.parse(adminUser);
                if (!adminData.isAdmin || adminData.email !== 'hesainosama@gmail.com') {
                    localStorage.removeItem('adminUser');
                    window.location.href = '/admin-login.html';
                    return false;
                }
                return true;
            } catch (error) {
                localStorage.removeItem('adminUser');
                window.location.href = '/admin-login.html';
                return false;
            }
        }

        // Auth state
        onAuthStateChanged(auth, (user) => {
            // First check admin authorization
            if (!checkAdminAuth()) return;

            currentUser = user;
            if (user && user.email === 'hesainosama@gmail.com') {
                document.getElementById('user-name').textContent = 'Super Admin';
                document.getElementById('user-email').textContent = user.email || '';
                document.getElementById('user-initial').textContent = 'A';

                // Load data
                loadBusinesses();
            } else {
                localStorage.removeItem('adminUser');
                window.location.href = '/admin-login.html';
            }
        });

        // Logout
        document.getElementById('logout-btn').addEventListener('click', async () => {
            await signOut(auth);
            localStorage.removeItem('adminUser');
            window.location.href = '/admin-login.html';
        });

        // Tab switching
        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', () => {
                const tabName = button.dataset.tab;

                // Update buttons
                document.querySelectorAll('.tab-button').forEach(btn => {
                    btn.classList.remove('active', 'text-blue-600');
                    btn.classList.add('text-gray-500');
                });
                button.classList.add('active', 'text-blue-600');
                button.classList.remove('text-gray-500');

                // Show/hide content
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.add('hidden');
                });
                document.getElementById(`tab-${tabName}`).classList.remove('hidden');
            });
        });

        // Modal functions
        window.openModal = (modalId) => {
            document.getElementById(modalId).classList.add('active');
        };

        window.closeModal = (modalId) => {
            document.getElementById(modalId).classList.remove('active');
        };

        // Add Business button
        document.getElementById('add-business-btn').addEventListener('click', () => {
            document.getElementById('business-form').reset();
            document.getElementById('business-id').value = ''; // Clear business ID for new business
            document.getElementById('modal-title').textContent = 'Add New Business';
            openModal('business-modal');
        });

        // Add Staff button
        document.getElementById('add-staff-btn')?.addEventListener('click', () => {
            document.getElementById('staff-form').reset();
            openModal('staff-modal');
        });

        // Business form submission
        document.getElementById('business-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const businessId = document.getElementById('business-id').value;
            const name = document.getElementById('business-name').value;
            const email = document.getElementById('business-email').value;
            const phone = document.getElementById('business-phone').value;
            const plan = document.getElementById('business-plan').value;
            const trialDays = parseInt(document.getElementById('trial-days').value) || 14;

            // Get selected features
            const features = {};
            document.querySelectorAll('input[name="feature"]:checked').forEach(checkbox => {
                features[checkbox.value] = true;
            });

            const businessData = {
                businessName: name,
                plan: {
                    type: plan,
                    status: businessId ? (businesses.find(b => b.id === businessId)?.plan?.status || 'trial') : 'trial'
                },
                contact: {
                    email: email,
                    phone: phone
                },
                features: features,
                status: businessId ? (businesses.find(b => b.id === businessId)?.status || 'active') : 'active',
                staffCount: businessId ? (businesses.find(b => b.id === businessId)?.staffCount || 0) : 0,
                updatedAt: Timestamp.now()
            };

            // Add creation fields only for new businesses
            if (!businessId) {
                businessData.createdAt = Timestamp.now();
                businessData.createdBy = currentUser.uid;
            }

            try {
                if (businessId) {
                    // Update existing business
                    await updateDoc(doc(db, 'businesses', businessId), businessData);
                    alert('Business updated successfully!');
                } else {
                    // Create new business
                    await addDoc(collection(db, 'businesses'), businessData);
                    alert('Business created successfully!');
                }
                closeModal('business-modal');
                loadBusinesses();
            } catch (error) {
                console.error('Error saving business:', error);
                alert(`Failed to ${businessId ? 'update' : 'create'} business. Please try again.`);
            }
        });

        // Load businesses
        async function loadBusinesses() {
            try {
                const querySnapshot = await getDocs(collection(db, 'businesses'));
                businesses = [];

                querySnapshot.forEach((doc) => {
                    businesses.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });

                updateStats();
                renderBusinesses();
                updateBusinessSelector();
            } catch (error) {
                console.error('Error loading businesses:', error);
            }
        }

        // Update stats
        function updateStats() {
            const total = businesses.length;
            const active = businesses.filter(b => b.status === 'active').length;
            const trial = businesses.filter(b => b.plan?.status === 'trial').length;
            const suspended = businesses.filter(b => b.status === 'suspended').length;

            document.getElementById('stat-total').textContent = total;
            document.getElementById('stat-active').textContent = active;
            document.getElementById('stat-trial').textContent = trial;
            document.getElementById('stat-suspended').textContent = suspended;
        }

        // Render businesses table
        function renderBusinesses() {
            const tbody = document.getElementById('businesses-tbody');
            const searchTerm = document.getElementById('search-businesses')?.value.toLowerCase() || '';
            const filterPlan = document.getElementById('filter-plan')?.value || '';
            const filterStatus = document.getElementById('filter-status')?.value || '';

            let filtered = businesses;

            // Apply filters
            if (searchTerm) {
                filtered = filtered.filter(b =>
                    b.businessName.toLowerCase().includes(searchTerm) ||
                    b.contact.email.toLowerCase().includes(searchTerm)
                );
            }
            if (filterPlan) {
                filtered = filtered.filter(b => b.plan?.type === filterPlan);
            }
            if (filterStatus) {
                filtered = filtered.filter(b => b.status === filterStatus);
            }

            if (filtered.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="px-6 py-12 text-center text-gray-500">
                            No businesses found
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = filtered.map(business => {
                const date = business.createdAt?.toDate?.() || new Date();
                const dateStr = date.toLocaleDateString();

                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                <div class="flex-shrink-0 h-10 w-10">
                                    <div class="h-10 w-10 rounded-full bg-blue-500 flex items-center justify-center text-white font-bold">
                                        ${business.businessName.charAt(0).toUpperCase()}
                                    </div>
                                </div>
                                <div class="ml-4">
                                    <div class="text-sm font-medium text-gray-900">${business.businessName}</div>
                                    <div class="text-sm text-gray-500">${business.contact.email}</div>
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="plan-badge plan-${business.plan?.type || 'basic'}">
                                ${(business.plan?.type || 'basic').charAt(0).toUpperCase() + (business.plan?.type || 'basic').slice(1)}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="status-badge status-${business.status || 'active'}">
                                ${(business.status || 'active').charAt(0).toUpperCase() + (business.status || 'active').slice(1)}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            ${business.staffCount || 0}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            ${dateStr}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <button class="action-btn text-blue-600 hover:bg-blue-50" onclick="editBusiness('${business.id}')" title="Edit">
                                <span class="material-icons text-sm">edit</span>
                            </button>
                            <button class="action-btn text-green-600 hover:bg-green-50" onclick="viewStaff('${business.id}')" title="View Staff">
                                <span class="material-icons text-sm">people</span>
                            </button>
                            <button class="action-btn text-orange-600 hover:bg-orange-50" onclick="suspendBusiness('${business.id}')" title="Suspend">
                                <span class="material-icons text-sm">pause_circle</span>
                            </button>
                            <button class="action-btn text-red-600 hover:bg-red-50" onclick="deleteBusiness('${business.id}')" title="Delete">
                                <span class="material-icons text-sm">delete</span>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Update business selector
        function updateBusinessSelector() {
            const selector = document.getElementById('business-selector');
            selector.innerHTML = '<option value="">Select a business...</option>' +
                businesses.map(b => `<option value="${b.id}">${b.businessName}</option>`).join('');
        }

        // Business selector change
        document.getElementById('business-selector').addEventListener('change', (e) => {
            selectedBusinessId = e.target.value;
            if (selectedBusinessId) {
                const business = businesses.find(b => b.id === selectedBusinessId);
                document.getElementById('selected-business-name').textContent = business.businessName;
                document.getElementById('selected-business-plan').textContent = `Plan: ${business.plan?.type || 'Basic'}`;
                document.getElementById('staff-content').classList.remove('hidden');
                loadStaff(selectedBusinessId);
            } else {
                document.getElementById('staff-content').classList.add('hidden');
            }
        });

        // Load staff for selected business
        async function loadStaff(businessId) {
            // Implementation here - load staff from businesses/{businessId}/staff
            document.getElementById('staff-tbody').innerHTML = `
                <tr>
                    <td colspan="5" class="px-6 py-12 text-center text-gray-500">
                        No staff members yet. Click "Add Staff" to invite team members.
                    </td>
                </tr>
            `;
        }

        // Global functions for actions
        window.editBusiness = (id) => {
            const business = businesses.find(b => b.id === id);
            if (business) {
                document.getElementById('business-id').value = id;
                document.getElementById('business-name').value = business.businessName;
                document.getElementById('business-email').value = business.contact.email;
                document.getElementById('business-phone').value = business.contact.phone || '';
                document.getElementById('business-plan').value = business.plan?.type || 'basic';

                // Set features
                document.querySelectorAll('input[name="feature"]').forEach(checkbox => {
                    checkbox.checked = business.features?.[checkbox.value] || false;
                });

                document.getElementById('modal-title').textContent = 'Edit Business';
                openModal('business-modal');
            }
        };

        window.viewStaff = (id) => {
            const business = businesses.find(b => b.id === id);
            if (business) {
                document.getElementById('business-selector').value = id;
                document.getElementById('business-selector').dispatchEvent(new Event('change'));

                // Switch to staff tab
                document.querySelector('[data-tab="staff"]').click();
            }
        };

        window.suspendBusiness = async (id) => {
            if (confirm('Are you sure you want to suspend this business?')) {
                try {
                    await updateDoc(doc(db, 'businesses', id), {
                        status: 'suspended',
                        suspendedAt: Timestamp.now()
                    });
                    alert('Business suspended successfully');
                    loadBusinesses();
                } catch (error) {
                    console.error('Error suspending business:', error);
                    alert('Failed to suspend business');
                }
            }
        };

        window.deleteBusiness = async (id) => {
            if (confirm('Are you sure you want to delete this business? This action cannot be undone.')) {
                try {
                    await deleteDoc(doc(db, 'businesses', id));
                    alert('Business deleted successfully');
                    loadBusinesses();
                } catch (error) {
                    console.error('Error deleting business:', error);
                    alert('Failed to delete business');
                }
            }
        };

        // Search and filter handlers
        document.getElementById('search-businesses').addEventListener('input', renderBusinesses);
        document.getElementById('filter-plan').addEventListener('change', renderBusinesses);
        document.getElementById('filter-status').addEventListener('change', renderBusinesses);
    </script>
</body>

</html>