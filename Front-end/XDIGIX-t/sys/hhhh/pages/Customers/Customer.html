<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Customers - MADAS Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="icon" type="image/x-icon" href="/assets/img/madas-logo.png">
    <!-- Firebase Permission Checker -->
    <script type="module" src="../../js/firebase-permission-check.js"></script>
    <style>
        :root {
            --madas-primary: #27491F;
            --madas-dark: #F0CAE1;
            --madas-light: #F4F4F4;
            --madas-accent: #FFD300;
            --bg-main: #F4F4F4;
            --text-main: #1F2937;
            --text-secondary: #6B7280;
            --card-bg: #FFFFFF;
            --card-border: #E5E7EB;
            --sidebar-bg: #FFFFFF;
            --header-bg: #FFFFFF;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-main) !important;
            color: var(--text-main) !important;
            transition: background 0.5s, color 0.5s;
        }

        /* Dark mode styles */
        body.dark-mode {
            --madas-primary: #FFD700;
            --madas-dark: #232946;
            --madas-light: #181825;
            --madas-accent: #7209b7;
            --bg-main: #181825;
            --text-main: #F8F8F2;
            --text-secondary: #A8A8A8;
            --card-bg: #232946;
            --card-border: #2D3748;
            --sidebar-bg: #232946;
            --header-bg: #232946;
        }

        .dark-toggle {
            background: var(--madas-accent);
            border: 2px solid var(--madas-primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .dark-toggle svg {
            width: 20px;
            height: 20px;
            fill: var(--madas-primary);
            transition: fill 0.3s;
        }

        .dark-toggle:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 8px rgba(255, 215, 0, 0.3);
        }

        .dark-toggle:active {
            transform: scale(0.95);
        }

        /* Transition all elements */
        * {
            transition: background-color 0.5s, color 0.5s, border-color 0.5s;
        }

        /* Override specific backgrounds */
        .bg-white {
            background-color: var(--card-bg) !important;
        }

        .bg-gray-50 {
            background-color: var(--bg-main) !important;
        }

        .text-gray-900 {
            color: var(--text-main) !important;
        }

        .text-gray-600 {
            color: var(--text-secondary) !important;
        }

        .text-gray-500 {
            color: var(--text-secondary) !important;
        }

        .border-gray-100 {
            border-color: var(--card-border) !important;
        }

        .bg-gray-50 {
            background-color: var(--bg-main) !important;
        }

        .bg-gray-100 {
            background-color: var(--card-bg) !important;
        }

        /* Sidebar and header */
        #sidebar {
            background-color: var(--sidebar-bg) !important;
        }

        .bg-white {
            background-color: var(--card-bg) !important;
        }

        .dark-mode header {
            background-color: var(--header-bg) !important;
            border-color: var(--card-border) !important;
        }

        .dark-mode aside {
            background-color: var(--sidebar-bg) !important;
        }

        .dark-mode .bg-white {
            background-color: var(--card-bg) !important;
        }

        .dark-mode .text-gray-900 {
            color: var(--text-main) !important;
        }

        .dark-mode .text-gray-600 {
            color: var(--text-secondary) !important;
        }

        .dark-mode .text-gray-500 {
            color: var(--text-secondary) !important;
        }

        .dark-mode .border-gray-200 {
            border-color: var(--card-border) !important;
        }

        .dark-mode .border-gray-100 {
            border-color: var(--card-border) !important;
        }

        .dark-mode .bg-gray-50 {
            background-color: var(--bg-main) !important;
        }

        .dark-mode .bg-gray-100 {
            background-color: var(--card-bg) !important;
        }

        .dark-mode .hover\:bg-gray-100:hover {
            background-color: var(--card-bg) !important;
        }

        .dark-mode .shadow-sm {
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.3) !important;
        }

        .dark-mode .divide-gray-200 {
            border-color: var(--card-border) !important;
        }

        .dark-mode .bg-gray-50 {
            background-color: var(--card-bg) !important;
        }

        /* Table header styling */
        thead {
            background-color: var(--card-bg) !important;
        }

        /* Main content background */
        main {
            background-color: var(--bg-main) !important;
        }

        /* Enhanced Sidebar Link Styles */
        .sidebar-link {
            position: relative;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden;
        }

        /* Override Tailwind text color classes */
        .sidebar-link.text-gray-700,
        .sidebar-link.text-gray-600 {
            color: var(--text-main) !important;
        }

        body.dark-mode .sidebar-link.text-gray-700,
        body.dark-mode .sidebar-link.text-gray-600 {
            color: var(--text-main) !important;
        }



        .sidebar-link:hover {
            transform: translateX(6px) scale(1.02);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            background: var(--madas-light);
        }

        .sidebar-link:active {
            transform: translateX(3px) scale(0.98);
            transition: all 0.1s ease;
        }

        /* Simple Active state for current page */
        .sidebar-link.active {
            background: var(--madas-light);
            color: var(--madas-primary) !important;
            font-weight: 600;
        }

        .sidebar-link.active .material-icons {
            color: var(--madas-primary) !important;
        }

        /* Simple Submenu active state */
        .sidebar-link.submenu-link.active {
            background: var(--madas-light);
            color: var(--madas-primary) !important;
            font-weight: 600;
        }

        .sidebar-link.submenu-link.active .material-icons {
            color: var(--madas-primary) !important;
        }

        /* Icon animation on hover */
        .sidebar-link:hover .material-icons {
            transform: scale(1.1) rotate(2deg);
            transition: all 0.3s ease;
        }

        /* Submenu link enhancements */
        .sidebar-link.submenu-link {
            position: relative;
            margin-left: 1rem;
            border-left: 2px solid transparent;
            transition: all 0.3s ease;
            color: var(--text-main) !important;
        }

        .sidebar-link.submenu-link:hover {
            border-left-color: var(--madas-primary);
            background: var(--madas-light);
            transform: translateX(8px);
            color: var(--text-main) !important;
        }

        .sidebar-link.submenu-link.active {
            border-left-color: var(--madas-primary);
            background: var(--madas-light);
            color: var(--madas-primary);
        }

        /* Dark mode submenu text color */
        body.dark-mode .sidebar-link.submenu-link {
            color: var(--text-main) !important;
        }

        body.dark-mode .sidebar-link.submenu-link:hover {
            color: var(--text-main) !important;
        }

        .finance-dropdown-menu.show {
            display: block;
            animation: slideDown 0.3s ease;
            background: white !important;
            border: 1px solid #e5e7eb !important;
            border-radius: 8px !important;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06) !important;
            margin: 8px 0 !important;
            padding: 8px 0 !important;
        }

        .card-hover {
            transition: all 0.3s ease;
        }

        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        /* Finance Dropdown Styles */
        .finance-dropdown {
            position: relative;
        }

        .finance-dropdown-menu {
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .finance-dropdown-menu.show {
            display: block;
            animation: slideDown 0.3s ease;
        }

        .finance-dropdown-menu.hidden {
            display: none;
        }

        .finance-arrow.rotated {
            transform: rotate(180deg);
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Input fields and form elements */
        input[type="text"],
        input[type="number"],
        input[type="email"],
        input[type="password"],
        input[type="date"],
        textarea,
        select {
            background-color: var(--card-bg) !important;
            color: var(--text-main) !important;
            border-color: var(--card-border) !important;
            border-width: 1px !important;
            border-style: solid !important;
        }

        input[type="text"]:focus,
        input[type="number"]:focus,
        input[type="email"]:focus,
        input[type="password"]:focus,
        input[type="date"]:focus,
        textarea:focus,
        select:focus {
            border-color: var(--madas-accent) !important;
            box-shadow: 0 0 0 2px rgba(255, 215, 0, 0.2) !important;
            outline: none !important;
        }

        input[type="text"]::placeholder,
        input[type="number"]::placeholder,
        input[type="email"]::placeholder,
        input[type="password"]::placeholder,
        input[type="date"]::placeholder,
        textarea::placeholder {
            color: var(--text-secondary) !important;
        }

        /* Search bar specific styling */
        input[type="search"] {
            background-color: var(--card-bg) !important;
            color: var(--text-main) !important;
            border-color: var(--card-border) !important;
        }

        input[type="search"]:focus {
            border-color: var(--madas-accent) !important;
            box-shadow: 0 0 0 2px rgba(255, 215, 0, 0.2) !important;
        }

        input[type="search"]::placeholder {
            color: var(--text-secondary) !important;
        }

        /* Select dropdowns */
        select {
            background-color: var(--card-bg) !important;
            color: var(--text-main) !important;
            border-color: var(--card-border) !important;
        }

        select:focus {
            border-color: var(--madas-accent) !important;
            box-shadow: 0 0 0 2px rgba(255, 215, 0, 0.2) !important;
        }

        /* Date input specific styling */
        input[type="date"] {
            background-color: var(--card-bg) !important;
            color: var(--text-main) !important;
            border-color: var(--card-border) !important;
        }

        input[type="date"]::-webkit-calendar-picker-indicator {
            filter: var(--text-main) !important;
            opacity: 0.7;
        }

        input[type="date"]::-webkit-calendar-picker-indicator:hover {
            opacity: 1;
        }

        /* Modal styling */
        .modal,
        .modal .bg-white,
        .glass-effect {
            background-color: var(--card-bg) !important;
        }

        /* Form labels */
        label {
            color: var(--text-main) !important;
        }

        /* Readonly inputs */
        input[readonly] {
            background-color: var(--bg-main) !important;
            color: var(--text-secondary) !important;
        }

        /* Checkbox styling */
        input[type="checkbox"] {
            background-color: var(--card-bg) !important;
            border-color: var(--card-border) !important;
        }

        input[type="checkbox"]:checked {
            background-color: var(--madas-accent) !important;
            border-color: var(--madas-accent) !important;
        }

        /* --- ENHANCED DARK MODE FIXES --- */
        /* Table header and body */
        thead th {
            background-color: var(--card-bg) !important;
            color: var(--text-main) !important;
            border-color: var(--card-border) !important;
        }

        tbody td {
            background-color: var(--card-bg) !important;
            color: var(--text-main) !important;
            border-color: var(--card-border) !important;
        }

        /* Table row hover */
        tbody tr.hover\:bg-gray-50:hover {
            background-color: var(--madas-light) !important;
        }

        body.dark-mode tbody tr.hover\:bg-gray-50:hover {
            background-color: #232946 !important;
        }

        /* Card backgrounds */
        .card-hover,
        .bg-white,
        .bg-gray-100 {
            background-color: var(--card-bg) !important;
            color: var(--text-main) !important;
            border-color: var(--card-border) !important;
        }

        /* Sidebar active link */
        .sidebar-link.bg-\[var\(--madas-primary\)\] {
            background-color: var(--madas-primary) !important;
            color: #fff !important;
        }

        body.dark-mode .sidebar-link.bg-\[var\(--madas-primary\)\] {
            background-color: var(--madas-primary) !important;
            color: #232946 !important;
        }

        /* Status badges */
        .bg-green-100,
        .bg-gray-100,
        .bg-purple-100,
        .bg-orange-100 {
            background-color: var(--card-bg) !important;
            color: var(--text-main) !important;
        }

        .text-green-800,
        .text-gray-800,
        .text-purple-800,
        .text-orange-600 {
            color: var(--madas-accent) !important;
        }

        /* Button fixes */
        .bg-\[var\(--madas-primary\)\] {
            background-color: var(--madas-primary) !important;
            color: #fff !important;
        }

        .hover\:bg-\[\#1f3c19\]:hover {
            background-color: #1f3c19 !important;
        }

        /* Export button */
        .bg-gray-100 {
            background-color: var(--card-bg) !important;
            color: var(--text-main) !important;
        }

        .hover\:bg-gray-200:hover {
            background-color: var(--madas-light) !important;
        }

        /* Fix notification badge */
        .bg-red-500 {
            background-color: #e53e3e !important;
        }

        .text-white {
            color: #fff !important;
        }

        /* Fix dark mode for notification badge */
        body.dark-mode .bg-red-500 {
            background-color: #FFD700 !important;
            color: #232946 !important;
        }

        /* Fix dark mode for sidebar and header */
        body.dark-mode #sidebar {
            background-color: var(--sidebar-bg) !important;
        }

        body.dark-mode header {
            background-color: var(--header-bg) !important;
            border-color: var(--card-border) !important;
        }

        /* Fix quick actions card */
        .bg-\[var\(--madas-light\)\] {
            background-color: var(--madas-light) !important;
            color: var(--text-main) !important;
        }

        body.dark-mode .bg-\[var\(--madas-light\)\] {
            background-color: #232946 !important;
            color: var(--text-main) !important;
        }

        /* Fix modal and glass effect */
        .modal,
        .modal .bg-white,
        .glass-effect {
            background-color: var(--card-bg) !important;
        }

        /* Fix form labels */
        label {
            color: var(--text-main) !important;
        }

        /* Fix readonly inputs */
        input[readonly] {
            background-color: var(--bg-main) !important;
            color: var(--text-secondary) !important;
        }

        /* Fix dark mode toggle button */
        .dark-toggle {
            background: var(--madas-accent) !important;
            border: 2px solid var(--madas-primary) !important;
        }

        .dark-toggle svg {
            fill: var(--madas-primary) !important;
        }

        /* Unified Dropdown Menu Styling - No 3D Effects */
        .inventory-submenu,
        .finance-dropdown-menu,
        .ecommerce-dropdown-menu {
            background: transparent !important;
            border: none !important;
            border-radius: 0 !important;
            box-shadow: none !important;
            margin: 0 !important;
            padding: 0 !important;
        }

        /* Unified Dropdown Items - Same as Main Navigation */
        .inventory-submenu .sidebar-link,
        .finance-dropdown-menu .sidebar-link,
        .ecommerce-dropdown-menu .sidebar-link {
            padding: 10px 14px !important;
            margin: 0 !important;
            border-radius: 0 !important;
            transition: all 0.2s ease !important;
        }

        .inventory-submenu .sidebar-link:hover,
        .finance-dropdown-menu .sidebar-link:hover,
        .ecommerce-dropdown-menu .sidebar-link:hover {
            background: var(--madas-light) !important;
            color: var(--madas-primary) !important;
        }


        /* Ensure all dropdown text sizes are uniform */
        .inventory-submenu .sidebar-link span,
        .finance-dropdown-menu .sidebar-link span,
        .ecommerce-dropdown-menu .sidebar-link span {
            font-size: 0.8rem !important;
        }

        /* Make dropdown icons smaller */
        .inventory-submenu .material-icons,
        .finance-dropdown-menu .material-icons,
        .ecommerce-dropdown-menu .material-icons {
            font-size: 18px !important;
        }

        /* Unified Dropdown Items Active State - EXACT Same as Main Navigation */
        .inventory-submenu .sidebar-link.active,
        .finance-dropdown-menu .sidebar-link.active,
        .ecommerce-dropdown-menu .sidebar-link.active {
            background: var(--madas-light) !important;
            color: var(--madas-primary) !important;
            font-weight: 600 !important;
        }

        .inventory-submenu .sidebar-link.active .material-icons,
        .finance-dropdown-menu .sidebar-link.active .material-icons,
        .ecommerce-dropdown-menu .sidebar-link.active .material-icons {
            color: var(--madas-primary) !important;
        }

        /* Unified Dropdown Button Styling */
        .inventory-dropdown button,
        .finance-dropdown button,
        .ecommerce-dropdown button {
            background: transparent !important;
            border: none !important;
            padding: 10px 14px !important;
            border-radius: 8px !important;
            transition: all 0.2s ease !important;
            width: 100% !important;
            text-align: left !important;
        }

        .inventory-dropdown button:hover,
        .finance-dropdown button:hover,
        .ecommerce-dropdown button:hover {
            background: var(--madas-light) !important;
        }

        /* Unified Dropdown Arrow */
        .dropdown-arrow {
            transition: transform 0.2s ease !important;
        }

        .dropdown-arrow.rotate {
            transform: rotate(180deg) !important;
        }

        /* Unified Visible States for Dropdowns - No 3D Effects */
        .inventory-submenu:not(.hidden) {
            opacity: 1 !important;
            transform: translateY(0) !important;
            pointer-events: auto !important;
            background: transparent !important;
            border: none !important;
            border-radius: 0 !important;
            box-shadow: none !important;
            margin: 0 !important;
            padding: 0 !important;
        }

        .finance-dropdown-menu.show {
            display: block !important;
            animation: slideDown 0.3s ease !important;
            background: transparent !important;
            border: none !important;
            border-radius: 0 !important;
            box-shadow: none !important;
            margin: 0 !important;
            padding: 0 !important;
        }

        .ecommerce-dropdown-menu.show {
            display: block !important;
            animation: slideDown 0.3s ease !important;
            background: transparent !important;
            border: none !important;
            border-radius: 0 !important;
            box-shadow: none !important;
            margin: 0 !important;
            padding: 0 !important;
        }
    </style>
</head>

<body class="font-sans">
    <!-- Loading Screen -->
    <div id="loadingScreen" class="fixed inset-0 z-50 flex items-center justify-center"
        style="background-color: var(--card-bg);">
        <div class="text-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-[var(--madas-primary)] mx-auto mb-4">
            </div>
            <p class="text-[var(--madas-primary)] font-medium">Loading Customers...</p>
        </div>
    </div>

    <!-- Header -->
    <header class="bg-white shadow-sm border-b border-gray-200 fixed top-0 left-0 right-0 z-40 h-16">
        <div class="flex items-center justify-between h-full px-4 lg:px-6">
            <div class="flex items-center space-x-4">
                <button id="menu-toggle" class="lg:hidden text-[var(--madas-primary)] p-2 rounded-lg hover:bg-gray-100">
                    <span class="material-icons">menu</span>
                </button>
                <div class="flex items-center space-x-3">
                    <div class="w-8 h-8 bg-[var(--madas-primary)] rounded-lg flex items-center justify-center">
                        <span class="text-white font-bold text-sm">M</span>
                    </div>
                    <div>
                        <h1 id="business-name" class="text-xl font-bold text-[var(--madas-primary)]">Loading...</h1>
                        <button id="plan-badge" onclick="window.location.href='/pages/settings.html#plans'"
                            class="text-xs px-2 py-0.5 rounded-full bg-blue-100 text-blue-800 hover:bg-blue-200 transition-colors cursor-pointer">
                            Loading Plan...
                        </button>
                    </div>
                </div>
            </div>

            <div class="flex items-center space-x-4">
                <div class="hidden md:flex items-center space-x-2 text-sm text-gray-600">
                    <span class="material-icons text-[var(--madas-primary)]">notifications</span>
                    <span class="bg-red-500 text-white text-xs rounded-full px-2 py-1">3</span>
                </div>
                <div class="flex items-center space-x-3">
                    <!-- Dark mode toggle button -->
                    <button class="dark-toggle" id="darkToggle" title="Toggle dark mode">
                        <svg id="darkToggleIcon" viewBox="0 0 24 24">
                            <path
                                d="M12 2a1 1 0 0 1 1 1v1a1 1 0 1 1-2 0V3a1 1 0 0 1 1-1zm5.657 3.343a1 1 0 0 1 1.414 0l.707.707a1 1 0 1 1-1.414 1.414l-.707-.707a1 1 0 0 1 0-1.414zM21 11a1 1 0 1 1 0 2h-1a1 1 0 1 1 0-2h1zm-2.929 7.071a1 1 0 0 1 0 1.414l-.707.707a1 1 0 1 1-1.414-1.414l.707-.707a1 1 0 0 1 1.414 0zM12 20a1 1 0 0 1-1-1v-1a1 1 0 1 1 2 0v1a1 1 0 0 1-1 1zm-7.071-2.929a1 1 0 0 1-1.414 0l-.707-.707a1 1 0 1 1 1.414-1.414l.707.707a1 1 0 0 1 0 1.414zM4 13a1 1 0 1 1 0-2H3a1 1 0 1 1 0 2h1zm2.343-7.657a1 1 0 0 1 0 1.414l-.707.707A1 1 0 1 1 4.222 6.05l.707-.707a1 1 0 0 1 1.414 0zM12 6a6 6 0 1 1 0 12A6 6 0 0 1 12 6z" />
                        </svg>
                    </button>
                    <div class="hidden md:block text-right">
                        <p id="user-name" class="text-sm font-medium text-gray-900">Loading...</p>
                        <p id="user-email" class="text-xs text-gray-500">loading@example.com</p>
                    </div>
                    <button id="profile-btn"
                        class="w-8 h-8 bg-[var(--madas-accent)] rounded-full flex items-center justify-center hover:bg-yellow-400 transition-colors cursor-pointer">
                        <span class="text-[var(--madas-primary)] font-bold text-sm" id="user-initial">U</span>
                    </button>
                    <button id="logout-btn"
                        class="text-gray-500 hover:text-[var(--madas-primary)] p-2 rounded-lg hover:bg-gray-100">
                        <span class="material-icons">logout</span>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <div class="flex h-screen pt-16">

        <!-- Sidebar -->
        <aside id="sidebar"
            class="fixed lg:static left-0 top-16 h-full w-64 bg-white shadow-lg lg:shadow-none z-30 transform lg:translate-x-0 -translate-x-full transition-transform duration-300 ease-in-out">
            <div class="flex flex-col h-full">
                <nav class="flex-1 px-4 py-6 space-y-2 overflow-y-auto">
                    <a href="/dashboard"
                        class="sidebar-link flex items-center space-x-3 px-4 py-3 rounded-xl text-gray-700 hover:bg-[var(--madas-light)] hover:text-[var(--madas-primary)] transition-all">
                        <span class="material-icons">dashboard</span>
                        <span>Dashboard</span>
                    </a>
                    <a href="/pages/Orders/orders.html"
                        class="sidebar-link flex items-center space-x-3 px-4 py-3 rounded-xl text-gray-700 hover:bg-[var(--madas-light)] hover:text-[var(--madas-primary)] transition-all">
                        <span class="material-icons">receipt_long</span>
                        <span>Orders</span>
                    </a>
                    <a href="/pages/pos.html"
                        class="sidebar-link flex items-center space-x-3 px-4 py-3 rounded-xl text-gray-700 hover:bg-[var(--madas-light)] hover:text-[var(--madas-primary)] transition-all">
                        <span class="material-icons">point_of_sale</span>
                        <span>POS</span>
                    </a>

                    <!-- Inventory Dropdown -->
                    <div class="inventory-dropdown">
                        <button
                            class="sidebar-link flex items-center justify-between w-full px-4 py-3 rounded-xl text-gray-700 hover:bg-[var(--madas-light)] hover:text-[var(--madas-primary)] transition-all"
                            id="inventory-toggle">
                            <div class="flex items-center space-x-3">
                                <span class="material-icons">inventory_2</span>
                                <span>Inventory</span>
                            </div>
                            <span class="material-icons transition-transform duration-200"
                                id="inventory-arrow">expand_more</span>
                        </button>
                        <div class="inventory-submenu hidden ml-6 mt-2 space-y-1" id="inventory-submenu">
                            <a href="/pages/Inventory/products.html"
                                class="sidebar-link submenu-link flex items-center space-x-3 px-4 py-2 rounded-lg text-gray-600 hover:bg-[var(--madas-light)] hover:text-[var(--madas-primary)] transition-all">
                                <span class="material-icons text-lg">inventory</span>
                                <span>Products</span>
                            </a>
                            <a href="/pages/Inventory/collections.html"
                                class="sidebar-link submenu-link flex items-center space-x-3 px-4 py-2 rounded-lg text-gray-600 hover:bg-[var(--madas-light)] hover:text-[var(--madas-primary)] transition-all">
                                <span class="material-icons text-lg">collections</span>
                                <span>Collections</span>
                            </a>
                            <a href="/pages/Inventory/product-reviews.html"
                                class="sidebar-link submenu-link flex items-center space-x-3 px-4 py-2 rounded-lg text-gray-600 hover:bg-[var(--madas-light)] hover:text-[var(--madas-primary)] transition-all">
                                <span class="material-icons text-lg">rate_review</span>
                                <span>Reviews</span>
                            </a>
                            <a href="/pages/Inventory/low-stock.html"
                                class="sidebar-link submenu-link flex items-center space-x-3 px-4 py-2 rounded-lg text-gray-600 hover:bg-[var(--madas-light)] hover:text-[var(--madas-primary)] transition-all">
                                <span class="material-icons text-lg">warning</span>
                                <span>Low Stock</span>
                            </a>
                        </div>
                    </div>

                    <a href="/pages/Customers/Customer.html"
                        class="sidebar-link flex items-center space-x-3 px-4 py-3 rounded-xl text-gray-700 hover:bg-[var(--madas-light)] hover:text-[var(--madas-primary)] transition-all">
                        <span class="material-icons">group</span>
                        <span>Customers</span>
                    </a>

                    <!-- E-commerce Dropdown -->
                    <div class="ecommerce-dropdown">
                        <button id="ecommerce-dropdown-btn"
                            class="sidebar-link w-full flex items-center justify-between px-4 py-3 rounded-xl text-gray-700 hover:bg-[var(--madas-light)] hover:text-[var(--madas-primary)] transition-all">
                            <div class="flex items-center space-x-3">
                                <span class="material-icons">storefront</span>
                                <span>E-commerce</span>
                            </div>
                            <span class="material-icons dropdown-arrow transition-transform duration-200"
                                id="ecommerce-arrow">expand_more</span>
                        </button>
                        <div id="ecommerce-dropdown-menu" class="ecommerce-dropdown-menu hidden">
                            <a href="/pages/Web-builder/theme-library.html"
                                class="sidebar-link submenu-link flex items-center space-x-3 px-4 py-2 ml-8 text-sm text-gray-600 hover:text-[var(--madas-primary)] hover:bg-[var(--madas-light)] rounded-lg transition-all">
                                <span class="material-icons text-sm">web</span>
                                <span>Website Builder</span>
                            </a>
                            <a href="/pages/shoes-store.html"
                                class="sidebar-link submenu-link flex items-center space-x-3 px-4 py-2 ml-8 text-sm text-gray-600 hover:text-[var(--madas-primary)] hover:bg-[var(--madas-light)] rounded-lg transition-all">
                                <span class="material-icons text-sm">shopping_bag</span>
                                <span>Shoes Store</span>
                            </a>
                            <a href="/pages/advanced/domains.html"
                                class="sidebar-link submenu-link flex items-center space-x-3 px-4 py-2 ml-8 text-sm text-gray-600 hover:text-[var(--madas-primary)] hover:bg-[var(--madas-light)] rounded-lg transition-all">
                                <span class="material-icons text-sm">language</span>
                                <span>Custom Domains</span>
                            </a>
                        </div>
                    </div>

                    <!-- Finance Dropdown -->
                    <div class="finance-dropdown">
                        <button id="finance-dropdown-btn"
                            class="sidebar-link w-full flex items-center justify-between px-4 py-3 rounded-xl text-gray-700 hover:bg-[var(--madas-light)] hover:text-[var(--madas-primary)] transition-all">
                            <div class="flex items-center space-x-3">
                                <span class="material-icons">account_balance_wallet</span>
                                <span>Finance</span>
                            </div>
                            <span
                                class="material-icons dropdown-arrow transition-transform duration-200">expand_more</span>
                        </button>
                        <div id="finance-dropdown-menu" class="finance-dropdown-menu hidden">
                            <a href="/pages/Finance/finance.html"
                                class="sidebar-link submenu-link flex items-center space-x-3 px-4 py-2 ml-8 text-sm text-gray-600 hover:text-[var(--madas-primary)] hover:bg-[var(--madas-light)] rounded-lg transition-all">
                                <span class="material-icons text-sm">account_balance</span>
                                <span>Overview</span>
                            </a>
                            <a href="/pages/advanced/deposit-money-simple.html"
                                class="sidebar-link submenu-link flex items-center space-x-3 px-4 py-2 ml-8 text-sm text-gray-600 hover:text-[var(--madas-primary)] hover:bg-[var(--madas-light)] rounded-lg transition-all">
                                <span class="material-icons text-sm">add_circle</span>
                                <span>Add Money Transfer</span>
                            </a>
                            <a href="/pages/Finance/expenses.html"
                                class="sidebar-link submenu-link flex items-center space-x-3 px-4 py-2 ml-8 text-sm text-gray-600 hover:text-[var(--madas-primary)] hover:bg-[var(--madas-light)] rounded-lg transition-all">
                                <span class="material-icons text-sm">receipt</span>
                                <span>Expenses</span>
                            </a>
                            <a href="/pages/Finance/analytics.html"
                                class="sidebar-link submenu-link flex items-center space-x-3 px-4 py-2 ml-8 text-sm text-gray-600 hover:text-[var(--madas-primary)] hover:bg-[var(--madas-light)] rounded-lg transition-all">
                                <span class="material-icons text-sm">analytics</span>
                                <span>Analytics</span>
                            </a>
                            <a href="/pages/Finance/reports.html"
                                class="sidebar-link submenu-link flex items-center space-x-3 px-4 py-2 ml-8 text-sm text-gray-600 hover:text-[var(--madas-primary)] hover:bg-[var(--madas-light)] rounded-lg transition-all">
                                <span class="material-icons text-sm">assessment</span>
                                <span>Reports</span>
                            </a>
                            <a href="/pages/Finance/insights.html"
                                class="sidebar-link submenu-link flex items-center space-x-3 px-4 py-2 ml-8 text-sm text-gray-600 hover:text-[var(--madas-primary)] hover:bg-[var(--madas-light)] rounded-lg transition-all">
                                <span class="material-icons text-sm">lightbulb</span>
                                <span>Insights</span>
                            </a>
                        </div>
                    </div>

                    <a href="/pages/settings/general-settings.html"
                        class="sidebar-link flex items-center space-x-3 px-4 py-3 rounded-xl text-gray-700 hover:bg-[var(--madas-light)] hover:text-[var(--madas-primary)] transition-all">
                        <span class="material-icons">settings</span>
                        <span>Settings</span>
                    </a>
                </nav>

                <div class="p-4 border-t border-gray-200">
                    <div class="bg-[var(--madas-light)] rounded-xl p-4">
                        <h3 class="text-sm font-medium text-[var(--madas-primary)] mb-2">Quick Actions</h3>
                        <div class="space-y-2">
                            <button
                                class="w-full text-left text-xs text-gray-600 hover:text-[var(--madas-primary)] flex items-center space-x-2">
                                <span class="material-icons text-sm">add</span>
                                <span>New Order</span>
                            </button>
                            <button
                                class="w-full text-left text-xs text-gray-600 hover:text-[var(--madas-primary)] flex items-center space-x-2">
                                <span class="material-icons text-sm">add</span>
                                <span>Add Product</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 overflow-y-auto">
            <div class="p-6 lg:p-8">
                <!-- Page Header -->
                <div class="mb-8">
                    <div class="flex items-center justify-between">
                        <div>
                            <h2 class="text-3xl font-bold text-[var(--madas-primary)] mb-2">Customer Management</h2>
                            <p class="text-gray-600">Manage your customer database and relationships</p>
                        </div>
                        <button id="addCustomerBtn"
                            class="bg-[var(--madas-primary)] text-white px-6 py-3 rounded-lg hover:bg-[#1f3c19] transition-colors flex items-center space-x-2">
                            <span class="material-icons">add</span>
                            <span>Add Customer</span>
                        </button>
                    </div>
                </div>

                <!-- Stats Cards -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                    <div class="card-hover bg-white rounded-xl p-6 shadow-sm border border-gray-100">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-gray-600">Total Customers</p>
                                <p id="total-customers" class="text-2xl font-bold text-[var(--madas-primary)]">0</p>
                            </div>
                            <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                                <span class="material-icons text-blue-600">group</span>
                            </div>
                        </div>
                    </div>

                    <div class="card-hover bg-white rounded-xl p-6 shadow-sm border border-gray-100">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-gray-600">New This Month</p>
                                <p id="new-customers" class="text-2xl font-bold text-green-600">0</p>
                            </div>
                            <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                                <span class="material-icons text-green-600">person_add</span>
                            </div>
                        </div>
                    </div>

                    <div class="card-hover bg-white rounded-xl p-6 shadow-sm border border-gray-100">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-gray-600">Active Customers</p>
                                <p id="active-customers" class="text-2xl font-bold text-purple-600">0</p>
                            </div>
                            <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center">
                                <span class="material-icons text-purple-600">check_circle</span>
                            </div>
                        </div>
                    </div>

                    <div class="card-hover bg-white rounded-xl p-6 shadow-sm border border-gray-100">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-gray-600">Total Revenue</p>
                                <p id="total-revenue" class="text-2xl font-bold text-[var(--madas-primary)]">$0</p>
                            </div>
                            <div class="w-12 h-12 bg-orange-100 rounded-lg flex items-center justify-center">
                                <span class="material-icons text-orange-600">attach_money</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Search and Filters -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 mb-8">
                    <div class="flex flex-col lg:flex-row gap-4">
                        <div class="flex-1">
                            <div class="relative">
                                <span class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <span class="material-icons text-gray-400">search</span>
                                </span>
                                <input type="text" id="searchInput"
                                    placeholder="Search customers by name, email, or phone..."
                                    class="w-full pl-10 pr-4 py-2 rounded-lg" />
                            </div>
                        </div>
                        <div class="flex gap-3">
                            <select id="statusFilter" class="px-4 py-2 rounded-lg">
                                <option value="">All Status</option>
                                <option value="active">Active</option>
                                <option value="inactive">Inactive</option>
                                <option value="vip">VIP</option>
                            </select>
                            <button id="importCustomersBtn"
                                class="bg-gray-100 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-200 transition-colors flex items-center space-x-2">
                                <span class="material-icons text-sm">upload</span>
                                <span>Import</span>
                            </button>
                            <button id="exportBtn"
                                class="bg-gray-100 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-200 transition-colors flex items-center space-x-2"
                                onclick="exportCustomersExcelStyled()">
                                <span class="material-icons text-sm">download</span>
                                <span>Export</span>
                            </button>
                            <button id="testCustomersBtn"
                                class="bg-blue-100 text-blue-700 px-4 py-2 rounded-lg hover:bg-blue-200 transition-colors flex items-center space-x-2">
                                <span class="material-icons text-sm">add_circle</span>
                                <span>Add Test Data</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Customers Table -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead>
                                <tr>
                                    <th
                                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Customer</th>
                                    <th
                                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Contact</th>
                                    <th
                                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Orders</th>
                                    <th
                                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Total Spent</th>
                                    <th
                                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Status</th>
                                    <th
                                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Last Order</th>
                                    <th
                                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Actions</th>
                                </tr>
                            </thead>
                            <tbody id="customersTableBody" class="bg-white divide-y divide-gray-200">
                                <!-- Customers will be loaded here -->
                                <tr>
                                    <td colspan="7" class="px-6 py-4 text-center text-gray-500">
                                        <div class="flex items-center justify-center space-x-2">
                                            <div
                                                class="animate-spin rounded-full h-4 w-4 border-b-2 border-[var(--madas-primary)]">
                                            </div>
                                            <span>Loading customers...</span>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Import Customers Modal -->
    <div id="importModal" class="fixed inset-0 hidden flex items-center justify-center z-50"
        style="background-color: rgba(0, 0, 0, 0.5);">
        <div class="bg-white p-6 rounded-xl shadow-lg w-full max-w-md max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold text-[var(--madas-primary)]">Import Customers</h3>
                <button type="button" id="closeImportModalBtn" class="text-gray-500 hover:text-gray-700">
                    <span class="material-icons">close</span>
                </button>
            </div>

            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Select File</label>
                    <input type="file" id="csvFileInput" accept=".csv,.html,.htm"
                        class="w-full border border-gray-300 px-3 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-[var(--madas-accent)] focus:border-transparent">
                    <p class="text-xs text-gray-500 mt-1">Supported formats: CSV, HTML (Excel exports)</p>
                </div>

                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <h4 class="text-sm font-medium text-blue-800 mb-2">File Format Requirements:</h4>
                    <div class="text-xs text-blue-700 space-y-2">
                        <div>
                            <strong>CSV Format:</strong>
                            <ul class="ml-2 space-y-1">
                                <li>• Required columns: name, email</li>
                                <li>• Optional columns: phone, status, totalSpent, orderCount</li>
                                <li>• Status values: active, inactive, vip</li>
                                <li>• First row should contain column headers</li>
                            </ul>
                        </div>
                        <div>
                            <strong>HTML Format (Excel exports):</strong>
                            <ul class="ml-2 space-y-1">
                                <li>• Automatically converts Excel-exported HTML files</li>
                                <li>• Maps columns: Name, Email, Phone Number, etc.</li>
                                <li>• Supports comprehensive customer data</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <div id="importPreview" class="hidden">
                    <h4 class="text-sm font-medium text-gray-700 mb-2">Preview (First 5 rows):</h4>
                    <div class="max-h-32 overflow-y-auto border border-gray-200 rounded-lg">
                        <table class="w-full text-xs">
                            <thead id="previewHeader" class="bg-gray-50">
                                <!-- Headers will be populated here -->
                            </thead>
                            <tbody id="previewBody">
                                <!-- Preview data will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="flex justify-end space-x-3 pt-4 border-t border-gray-200">
                    <button type="button" id="cancelImportBtn"
                        class="bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400 transition-colors">
                        Cancel
                    </button>
                    <button type="button" id="confirmImportBtn" disabled
                        class="bg-[var(--madas-primary)] text-white px-6 py-2 rounded-lg hover:bg-[#1f3c19] transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                        Import Customers
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Customer Modal -->
    <div id="addCustomerModal" class="fixed inset-0 hidden flex items-center justify-center z-50"
        style="background-color: rgba(0, 0, 0, 0.5);">
        <div class="bg-white rounded-xl shadow-lg w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <!-- Modal Header -->
            <div class="flex items-center justify-between p-6 border-b border-gray-200">
                <h3 class="text-2xl font-bold text-[var(--madas-primary)]">Add customer</h3>
                <button type="button" id="closeAddCustomerModalBtn" class="text-gray-500 hover:text-gray-700">
                    <span class="material-icons">close</span>
                </button>
            </div>

            <!-- Modal Content -->
            <div class="p-6">
                <form id="addCustomerForm" class="space-y-6">
                    <!-- Personal Information Section -->
                    <div>
                        <h4 class="text-lg font-semibold text-gray-800 mb-4">Personal Information</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">First name *</label>
                                <input type="text" id="customerFirstName" required
                                    class="w-full border border-gray-300 px-3 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-[var(--madas-accent)] focus:border-transparent">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Last name *</label>
                                <input type="text" id="customerLastName" required
                                    class="w-full border border-gray-300 px-3 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-[var(--madas-accent)] focus:border-transparent">
                            </div>
                        </div>

                        <div class="mt-4">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Email address *</label>
                            <input type="email" id="customerEmail" required
                                class="w-full border border-gray-300 px-3 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-[var(--madas-accent)] focus:border-transparent">
                        </div>

                        <div class="mt-4">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Phone number</label>
                            <div class="relative">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <span class="text-gray-500">🇪🇬 +20</span>
                                </div>
                                <input type="tel" id="customerPhone"
                                    class="w-full border border-gray-300 px-3 py-2 pl-16 rounded-lg focus:outline-none focus:ring-2 focus:ring-[var(--madas-accent)] focus:border-transparent"
                                    placeholder="Enter phone number">
                            </div>
                        </div>
                    </div>

                    <!-- Address Section -->
                    <div>
                        <h4 class="text-lg font-semibold text-gray-800 mb-4">Address</h4>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Address line</label>
                                <input type="text" id="customerAddressLine"
                                    class="w-full border border-gray-300 px-3 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-[var(--madas-accent)] focus:border-transparent">
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Apartment</label>
                                    <input type="text" id="customerApartment"
                                        class="w-full border border-gray-300 px-3 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-[var(--madas-accent)] focus:border-transparent">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Floor</label>
                                    <input type="text" id="customerFloor"
                                        class="w-full border border-gray-300 px-3 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-[var(--madas-accent)] focus:border-transparent">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Building</label>
                                    <input type="text" id="customerBuilding"
                                        class="w-full border border-gray-300 px-3 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-[var(--madas-accent)] focus:border-transparent">
                                </div>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Country *</label>
                                    <select id="customerCountry" required
                                        class="w-full border border-gray-300 px-3 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-[var(--madas-accent)] focus:border-transparent">
                                        <option value="">Select Country</option>
                                        <option value="Egypt" selected>Egypt</option>
                                        <option value="United States">United States</option>
                                        <option value="United Kingdom">United Kingdom</option>
                                        <option value="Canada">Canada</option>
                                        <option value="Germany">Germany</option>
                                        <option value="France">France</option>
                                        <option value="Italy">Italy</option>
                                        <option value="Spain">Spain</option>
                                        <option value="Australia">Australia</option>
                                        <option value="Japan">Japan</option>
                                        <option value="China">China</option>
                                        <option value="India">India</option>
                                        <option value="Brazil">Brazil</option>
                                        <option value="Mexico">Mexico</option>
                                        <option value="Saudi Arabia">Saudi Arabia</option>
                                        <option value="UAE">United Arab Emirates</option>
                                        <option value="Kuwait">Kuwait</option>
                                        <option value="Qatar">Qatar</option>
                                        <option value="Jordan">Jordan</option>
                                        <option value="Lebanon">Lebanon</option>
                                        <option value="Turkey">Turkey</option>
                                        <option value="Morocco">Morocco</option>
                                        <option value="Tunisia">Tunisia</option>
                                        <option value="Algeria">Algeria</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Governorate/State
                                        *</label>
                                    <select id="customerGovernorate" required
                                        class="w-full border border-gray-300 px-3 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-[var(--madas-accent)] focus:border-transparent">
                                        <option value="">Select Governorate/State</option>
                                        <!-- Options will be populated dynamically based on country selection -->
                                    </select>
                                    <div id="governorateError" class="hidden text-red-500 text-sm mt-1">This field is
                                        required!</div>
                                </div>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label
                                        class="block text-sm font-medium text-gray-700 mb-1">Neighborhood/City</label>
                                    <input type="text" id="customerNeighborhood"
                                        class="w-full border border-gray-300 px-3 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-[var(--madas-accent)] focus:border-transparent"
                                        placeholder="Enter neighborhood or city">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">District/Area</label>
                                    <input type="text" id="customerDistrict"
                                        class="w-full border border-gray-300 px-3 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-[var(--madas-accent)] focus:border-transparent"
                                        placeholder="Enter district or area">
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>

            <!-- Modal Footer -->
            <div class="flex justify-end space-x-3 p-6 border-t border-gray-200">
                <button type="button" id="cancelAddCustomerBtn"
                    class="bg-gray-300 text-gray-700 px-6 py-2 rounded-lg hover:bg-gray-400 transition-colors">Cancel</button>
                <button type="submit" id="saveCustomerBtn" form="addCustomerForm"
                    class="bg-[var(--madas-primary)] text-white px-6 py-2 rounded-lg hover:bg-[#1f3c19] transition-colors">Save</button>
            </div>
        </div>
    </div>

    <script>
        const sidebar = document.getElementById('sidebar');
        const toggleBtn = document.getElementById('menu-toggle');

        // Close sidebar when clicking outside on mobile
        document.addEventListener('click', (e) => {
            if (!sidebar || !toggleBtn) return;
            if (window.innerWidth < 1024 &&
                !sidebar.contains(e.target) &&
                !toggleBtn.contains(e.target)) {
                sidebar.classList.add('-translate-x-full');
            }
        });
    </script>

    <script src="/dashboard/js/html-to-csv-converter.js"></script>
    <script src="/dashboard/js/csv-processor.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.4.0/exceljs.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
        import { getFirestore, collection, getDocs, query, where, updateDoc, doc, deleteDoc, addDoc, getDoc, updateDoc as updateDocument } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

        // Multi-tenancy authentication will be handled inline

        // Helper function for business-scoped collections
        window.getScopedCollection = function (db, collectionName) {
            if (!window.currentBusinessId) {
                console.error('❌ No business context available for scoped collection');
                return collection(db, collectionName); // Fallback
            }
            return collection(db, "businesses", window.currentBusinessId, collectionName);
        };

        const firebaseConfig = {
            apiKey: "AIzaSyC-ls1TrvSkrw71KqmB_kHYgPoj0H550a8",
            authDomain: "madas-store.firebaseapp.com",
            projectId: "madas-store",
            storageBucket: "madas-store.firebasestorage.app",
            messagingSenderId: "527071300010",
            appId: "1:527071300010:web:7470e2204065b4590583d3"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                window.location.href = "/login";
                return;
            }

            try {
                console.log('🔐 User authenticated:', user.email);

                // ============================================
                // TENANT ISOLATION: Detect Business Context
                // ============================================

                // Find user's business (check if owner)
                const businessesQuery = query(collection(db, "businesses"), where("owner.userId", "==", user.uid));
                const businessSnapshot = await getDocs(businessesQuery);

                if (!businessSnapshot.empty) {
                    // User is a business owner
                    const businessDoc = businessSnapshot.docs[0];
                    window.currentBusinessId = businessDoc.id;
                    window.currentBusinessData = businessDoc.data();
                    window.currentUserRole = 'owner';

                    console.log('✅ Business Owner:', window.currentBusinessData.businessName);
                    console.log('🏢 Business ID:', window.currentBusinessId);
                    console.log('📋 Plan:', window.currentBusinessData.plan?.type);

                } else {
                    // Step 2: Check if user is staff member
                    const allBusinesses = await getDocs(collection(db, "businesses"));
                    let foundBusiness = false;

                    for (const businessDoc of allBusinesses.docs) {
                        const businessId = businessDoc.id;
                        const staffRef = doc(db, 'businesses', businessId, 'staff', user.uid);
                        const staffDoc = await getDoc(staffRef);

                        if (staffDoc.exists()) {
                            const staffData = staffDoc.data();
                            window.currentBusinessId = businessId;
                            window.currentBusinessData = businessDoc.data();
                            window.currentUserRole = staffData.role;
                            window.currentUserPermissions = staffData.permissions;

                            console.log('✅ Staff Member:', window.currentBusinessData.businessName);
                            console.log('🏢 Business ID:', window.currentBusinessId);
                            console.log('👤 Role:', window.currentUserRole);

                            foundBusiness = true;
                            break;
                        }
                    }

                    if (!foundBusiness) {
                        console.warn("❌ User not associated with any business. Redirecting to no-access.");
                        window.location.href = "/no-access.html";
                        return;
                    }
                }

                // Set user permissions based on role
                let userData = {
                    email: user.email,
                    displayName: user.displayName || window.currentBusinessData?.owner?.name,
                    role: window.currentUserRole,
                    approved: true // All business users are approved by default
                };

                // Set permissions based on role
                if (window.currentUserRole === 'owner') {
                    userData.permissions = {
                        home: ["view"],
                        orders: ["view", "search", "create", "edit"],
                        inventory: ["view", "edit"],
                        customers: ["view", "edit"],
                        employees: ["view", "edit"],
                        finance: ["view", "reports"],
                        analytics: ["view", "export"],
                        settings: ["view", "edit"]
                    };
                } else if (window.currentUserRole === 'admin') {
                    userData.permissions = {
                        home: ["view"],
                        orders: ["view", "search", "create", "edit"],
                        inventory: ["view", "edit"],
                        customers: ["view", "edit"],
                        employees: ["view", "edit"],
                        finance: ["view", "reports"],
                        analytics: ["view", "export"],
                        settings: ["view", "edit"]
                    };
                } else {
                    // For staff members, use permissions from their staff document
                    userData.permissions = window.currentUserPermissions || {
                        home: ["view"],
                        customers: ["view"] // Default customers permission
                    };
                }

                // Auto-approve super admin users
                const superAdminEmails = [
                    "hesainosama@gmail.com",
                    "test@example.com"
                ];

                if (superAdminEmails.includes(user.email)) {
                    console.log("🔑 Super admin detected - granting full access");
                    userData.role = "super-admin";
                    userData.approved = true;
                    userData.permissions = {
                        home: ["view"],
                        orders: ["view", "search", "create", "edit"],
                        inventory: ["view", "edit"],
                        customers: ["view", "edit"],
                        employees: ["view", "edit"],
                        finance: ["view", "reports"],
                        analytics: ["view", "export"],
                        settings: ["view", "edit"],
                        admin: ["view", "manage_all_businesses"]
                    };
                }

                console.log('✅ User data created for customers page:', {
                    email: userData.email,
                    role: userData.role,
                    businessId: window.currentBusinessId,
                    approved: userData.approved
                });

                // Store user data
                localStorage.setItem("madasUser", JSON.stringify(userData));

                // Update UI
                const username = userData.displayName || window.currentBusinessData?.owner?.name || user.displayName || user.email.split("@")[0];
                document.getElementById("user-name").textContent = username;
                document.getElementById("user-email").textContent = user.email;
                document.getElementById("user-initial").textContent = username.charAt(0).toUpperCase();

                // Update business name and plan
                const businessName = window.currentBusinessData?.businessName || "DIGIX Admin";
                const planType = window.currentBusinessData?.plan?.type || "basic";
                const planStatus = window.currentBusinessData?.plan?.status || "active";

                document.getElementById("business-name").textContent = businessName;

                const planBadge = document.getElementById("plan-badge");
                if (planBadge) {
                    planBadge.textContent = `${planType.charAt(0).toUpperCase() + planType.slice(1)} Plan`;

                    // Set plan badge color based on plan type
                    if (planType === 'enterprise') {
                        planBadge.className = "text-xs px-2 py-0.5 rounded-full bg-purple-100 text-purple-800 hover:bg-purple-200 transition-colors cursor-pointer";
                    } else if (planType === 'professional') {
                        planBadge.className = "text-xs px-2 py-0.5 rounded-full bg-blue-100 text-blue-800 hover:bg-blue-200 transition-colors cursor-pointer";
                    } else {
                        planBadge.className = "text-xs px-2 py-0.5 rounded-full bg-green-100 text-green-800 hover:bg-green-200 transition-colors cursor-pointer";
                    }

                    // Add trial badge if in trial
                    if (planStatus === 'trial') {
                        planBadge.textContent += ' (Trial)';
                    }
                }

                // Hide loading screen
                document.getElementById('loadingScreen').style.display = 'none';

                // Apply permission-based UI controls
                applyPermissionBasedUI(userData.permissions);

                // Load customers with business context
                await loadCustomers();

            } catch (error) {
                console.error("❌ Authentication error:", error);
                window.location.href = "/login";
            }
        });

        // Function to apply permission-based UI controls
        function applyPermissionBasedUI(permissions) {
            const addCustomerBtn = document.getElementById('addCustomerBtn');
            const addCustomerBtnSidebar = document.getElementById('addCustomerBtnSidebar');
            const importCustomersBtn = document.getElementById('importCustomersBtn');

            // Show/hide add customer button based on edit permission
            if (addCustomerBtn) {
                if (!permissions?.customers?.includes("edit")) {
                    addCustomerBtn.style.display = "none";
                } else {
                    addCustomerBtn.style.display = "flex";
                }
            }

            // Show/hide sidebar add customer button based on edit permission
            if (addCustomerBtnSidebar) {
                if (!permissions?.customers?.includes("edit")) {
                    addCustomerBtnSidebar.style.display = "none";
                } else {
                    addCustomerBtnSidebar.style.display = "block";
                }
            }

            // Show/hide import button based on edit permission
            if (importCustomersBtn) {
                if (!permissions?.customers?.includes("edit")) {
                    importCustomersBtn.style.display = "none";
                } else {
                    importCustomersBtn.style.display = "flex";
                }
            }
        }

        async function loadCustomers() {
            try {
                const customersSnapshot = await getDocs(window.getScopedCollection(db, "customers"));
                const customersTableBody = document.getElementById("customersTableBody");

                if (customersSnapshot.empty) {
                    customersTableBody.innerHTML = `
                        <tr>
                            <td colspan="7" class="px-6 py-4 text-center text-gray-500">
                                No customers found
                            </td>
                        </tr>
                    `;
                    return;
                }

                customersTableBody.innerHTML = "";
                let totalCustomers = 0;
                let newCustomers = 0;
                let activeCustomers = 0;
                let totalRevenue = 0;

                customersSnapshot.forEach((doc) => {
                    const customer = doc.data();
                    totalCustomers++;
                    totalRevenue += customer.totalSpent || 0;

                    if (customer.status === 'active') activeCustomers++;
                    if (customer.createdAt) {
                        const createdDate = customer.createdAt.toDate ? customer.createdAt.toDate() : new Date(customer.createdAt);
                        const now = new Date();
                        const diffTime = Math.abs(now - createdDate);
                        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                        if (diffDays <= 30) newCustomers++;
                    }

                    const statusColors = {
                        'active': 'bg-green-100 text-green-800',
                        'inactive': 'bg-gray-100 text-gray-800',
                        'vip': 'bg-purple-100 text-purple-800'
                    };

                    const row = document.createElement("tr");
                    row.className = "hover:bg-gray-50 cursor-pointer";
                    row.setAttribute('data-customer-id', doc.id);

                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                <div class="w-10 h-10 bg-[var(--madas-accent)] rounded-full flex items-center justify-center">
                                    <span class="text-[var(--madas-primary)] font-bold text-sm">${(customer.name || 'C').charAt(0).toUpperCase()}</span>
                                </div>
                                <div class="ml-4">
                                    <div class="text-sm font-medium text-gray-900">${customer.name || 'Unnamed Customer'}</div>
                                    <div class="text-sm text-gray-500">ID: ${doc.id.slice(-6)}</div>
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-900">${customer.email || 'N/A'}</div>
                            <div class="text-sm text-gray-500">${customer.phone || 'N/A'}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${customer.orderCount || 0}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">$${customer.totalSpent || 0}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusColors[customer.status] || 'bg-gray-100 text-gray-800'}">
                                ${customer.status || 'active'}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${customer.lastOrder ? new Date(customer.lastOrder.toDate ? customer.lastOrder.toDate() : customer.lastOrder).toLocaleDateString() : 'Never'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button class="edit-customer-btn text-blue-600 hover:text-blue-900 mr-3" data-customer-id="${doc.id}" onclick="event.stopPropagation()">Edit</button>
                            <button class="delete-customer-btn text-red-600 hover:text-red-900" data-customer-id="${doc.id}" onclick="event.stopPropagation()">Delete</button>
                        </td>
                    `;

                    customersTableBody.appendChild(row);
                });

                // Update stats
                document.getElementById("total-customers").textContent = totalCustomers;
                document.getElementById("new-customers").textContent = newCustomers;
                document.getElementById("active-customers").textContent = activeCustomers;
                document.getElementById("total-revenue").textContent = `$${totalRevenue.toFixed(2)}`;

            } catch (error) {
                console.error("Error loading customers:", error);
                document.getElementById("customersTableBody").innerHTML = `
                    <tr>
                        <td colspan="7" class="px-6 py-4 text-center text-red-500">
                            Error loading customers: ${error.message}
                        </td>
                    </tr>
                `;
            }
        }

        // Country-Governorate data
        const countryGovernorates = {
            'Egypt': [
                'Cairo', 'Giza', 'Alexandria', 'Sharkia', 'Dakahlia', 'Qalyubia',
                'Gharbia', 'Minya', 'Asyut', 'Sohag', 'Qena', 'Aswan', 'Luxor',
                'Red Sea', 'New Valley', 'Matrouh', 'North Sinai', 'South Sinai',
                'Suez', 'Ismailia', 'Port Said', 'Damietta', 'Kafr el-Sheikh',
                'Beheira', 'Monufia'
            ],
            'United States': [
                'Alabama', 'Alaska', 'Arizona', 'Arkansas', 'California', 'Colorado',
                'Connecticut', 'Delaware', 'Florida', 'Georgia', 'Hawaii', 'Idaho',
                'Illinois', 'Indiana', 'Iowa', 'Kansas', 'Kentucky', 'Louisiana',
                'Maine', 'Maryland', 'Massachusetts', 'Michigan', 'Minnesota',
                'Mississippi', 'Missouri', 'Montana', 'Nebraska', 'Nevada',
                'New Hampshire', 'New Jersey', 'New Mexico', 'New York',
                'North Carolina', 'North Dakota', 'Ohio', 'Oklahoma', 'Oregon',
                'Pennsylvania', 'Rhode Island', 'South Carolina', 'South Dakota',
                'Tennessee', 'Texas', 'Utah', 'Vermont', 'Virginia', 'Washington',
                'West Virginia', 'Wisconsin', 'Wyoming'
            ],
            'United Kingdom': [
                'England', 'Scotland', 'Wales', 'Northern Ireland'
            ],
            'Canada': [
                'Alberta', 'British Columbia', 'Manitoba', 'New Brunswick',
                'Newfoundland and Labrador', 'Northwest Territories', 'Nova Scotia',
                'Nunavut', 'Ontario', 'Prince Edward Island', 'Quebec', 'Saskatchewan',
                'Yukon'
            ],
            'Germany': [
                'Baden-Württemberg', 'Bavaria', 'Berlin', 'Brandenburg', 'Bremen',
                'Hamburg', 'Hesse', 'Lower Saxony', 'Mecklenburg-Vorpommern',
                'North Rhine-Westphalia', 'Rhineland-Palatinate', 'Saarland',
                'Saxony', 'Saxony-Anhalt', 'Schleswig-Holstein', 'Thuringia'
            ],
            'France': [
                'Auvergne-Rhône-Alpes', 'Bourgogne-Franche-Comté', 'Brittany',
                'Centre-Val de Loire', 'Corsica', 'Grand Est', 'Hauts-de-France',
                'Île-de-France', 'Normandy', 'Nouvelle-Aquitaine', 'Occitanie',
                'Pays de la Loire', 'Provence-Alpes-Côte d\'Azur'
            ],
            'Italy': [
                'Abruzzo', 'Basilicata', 'Calabria', 'Campania', 'Emilia-Romagna',
                'Friuli-Venezia Giulia', 'Lazio', 'Liguria', 'Lombardy', 'Marche',
                'Molise', 'Piedmont', 'Apulia', 'Sardinia', 'Sicily', 'Tuscany',
                'Trentino-Alto Adige', 'Umbria', 'Aosta Valley', 'Veneto'
            ],
            'Spain': [
                'Andalusia', 'Aragon', 'Asturias', 'Balearic Islands', 'Basque Country',
                'Canary Islands', 'Cantabria', 'Castile and León', 'Castilla-La Mancha',
                'Catalonia', 'Extremadura', 'Galicia', 'La Rioja', 'Madrid', 'Murcia',
                'Navarre', 'Valencian Community'
            ],
            'Australia': [
                'Australian Capital Territory', 'New South Wales', 'Northern Territory',
                'Queensland', 'South Australia', 'Tasmania', 'Victoria', 'Western Australia'
            ],
            'Japan': [
                'Hokkaido', 'Tohoku', 'Kanto', 'Chubu', 'Kansai', 'Chugoku',
                'Shikoku', 'Kyushu', 'Okinawa'
            ],
            'China': [
                'Beijing', 'Tianjin', 'Hebei', 'Shanxi', 'Inner Mongolia', 'Liaoning',
                'Jilin', 'Heilongjiang', 'Shanghai', 'Jiangsu', 'Zhejiang', 'Anhui',
                'Fujian', 'Jiangxi', 'Shandong', 'Henan', 'Hubei', 'Hunan', 'Guangdong',
                'Guangxi', 'Hainan', 'Chongqing', 'Sichuan', 'Guizhou', 'Yunnan',
                'Tibet', 'Shaanxi', 'Gansu', 'Qinghai', 'Ningxia', 'Xinjiang'
            ],
            'India': [
                'Andhra Pradesh', 'Arunachal Pradesh', 'Assam', 'Bihar', 'Chhattisgarh',
                'Goa', 'Gujarat', 'Haryana', 'Himachal Pradesh', 'Jharkhand', 'Karnataka',
                'Kerala', 'Madhya Pradesh', 'Maharashtra', 'Manipur', 'Meghalaya',
                'Mizoram', 'Nagaland', 'Odisha', 'Punjab', 'Rajasthan', 'Sikkim',
                'Tamil Nadu', 'Telangana', 'Tripura', 'Uttar Pradesh', 'Uttarakhand',
                'West Bengal', 'Andaman and Nicobar Islands', 'Chandigarh',
                'Dadra and Nagar Haveli', 'Daman and Diu', 'Delhi', 'Jammu and Kashmir',
                'Ladakh', 'Lakshadweep', 'Puducherry'
            ],
            'Brazil': [
                'Acre', 'Alagoas', 'Amapá', 'Amazonas', 'Bahia', 'Ceará', 'Distrito Federal',
                'Espírito Santo', 'Goiás', 'Maranhão', 'Mato Grosso', 'Mato Grosso do Sul',
                'Minas Gerais', 'Pará', 'Paraíba', 'Paraná', 'Pernambuco', 'Piauí',
                'Rio de Janeiro', 'Rio Grande do Norte', 'Rio Grande do Sul', 'Rondônia',
                'Roraima', 'Santa Catarina', 'São Paulo', 'Sergipe', 'Tocantins'
            ],
            'Mexico': [
                'Aguascalientes', 'Baja California', 'Baja California Sur', 'Campeche',
                'Chiapas', 'Chihuahua', 'Coahuila', 'Colima', 'Durango', 'Guanajuato',
                'Guerrero', 'Hidalgo', 'Jalisco', 'Mexico', 'Michoacán', 'Morelos',
                'Nayarit', 'Nuevo León', 'Oaxaca', 'Puebla', 'Querétaro', 'Quintana Roo',
                'San Luis Potosí', 'Sinaloa', 'Sonora', 'Tabasco', 'Tamaulipas',
                'Tlaxcala', 'Veracruz', 'Yucatán', 'Zacatecas', 'Mexico City'
            ],
            'Saudi Arabia': [
                'Al Bahah', 'Northern Borders', 'Al Jawf', 'Al Madinah', 'Al Qassim',
                'Ar Riyadh', 'Eastern Province', 'Asir', 'Hail', 'Jazan', 'Makkah',
                'Najran', 'Tabuk'
            ],
            'UAE': [
                'Abu Dhabi', 'Ajman', 'Dubai', 'Fujairah', 'Ras Al Khaimah', 'Sharjah',
                'Umm Al Quwain'
            ],
            'Kuwait': [
                'Al Ahmadi', 'Al Farwaniyah', 'Al Jahra', 'Capital', 'Hawalli', 'Mubarak Al-Kabeer'
            ],
            'Qatar': [
                'Ad Dawhah', 'Al Khor', 'Al Rayyan', 'Al Shamal', 'Al Wakrah', 'Ash Shamal',
                'Az Za\'ayin', 'Umm Salal'
            ],
            'Jordan': [
                'Ajloun', 'Amman', 'Aqaba', 'Balqa', 'Irbid', 'Jerash', 'Karak',
                'Ma\'an', 'Madaba', 'Mafraq', 'Tafilah', 'Zarqa'
            ],
            'Lebanon': [
                'Akkar', 'Baalbek-Hermel', 'Beirut', 'Beqaa', 'Mount Lebanon', 'Nabatieh',
                'North Lebanon', 'South Lebanon'
            ],
            'Turkey': [
                'Adana', 'Adıyaman', 'Afyonkarahisar', 'Ağrı', 'Amasya', 'Ankara',
                'Antalya', 'Artvin', 'Aydın', 'Balıkesir', 'Bilecik', 'Bingöl',
                'Bitlis', 'Bolu', 'Burdur', 'Bursa', 'Çanakkale', 'Çankırı', 'Çorum',
                'Denizli', 'Diyarbakır', 'Edirne', 'Elazığ', 'Erzincan', 'Erzurum',
                'Eskişehir', 'Gaziantep', 'Giresun', 'Gümüşhane', 'Hakkâri', 'Hatay',
                'Isparta', 'Mersin', 'İstanbul', 'İzmir', 'Kars', 'Kastamonu', 'Kayseri',
                'Kırklareli', 'Kırşehir', 'Kocaeli', 'Konya', 'Kütahya', 'Malatya',
                'Manisa', 'Kahramanmaraş', 'Mardin', 'Muğla', 'Muş', 'Nevşehir', 'Niğde',
                'Ordu', 'Rize', 'Sakarya', 'Samsun', 'Siirt', 'Sinop', 'Sivas', 'Tekirdağ',
                'Tokat', 'Trabzon', 'Tunceli', 'Şanlıurfa', 'Uşak', 'Van', 'Yozgat', 'Zonguldak'
            ],
            'Morocco': [
                'Casablanca-Settat', 'Rabat-Salé-Kénitra', 'Fès-Meknès', 'Marrakech-Safi',
                'Tanger-Tétouan-Al Hoceïma', 'Oriental', 'Beni Mellal-Khénifra',
                'Laâyoune-Sakia El Hamra', 'Drâa-Tafilalet', 'Souss-Massa', 'Guelmim-Oued Noun',
                'Dakhla-Oued Ed-Dahab'
            ],
            'Tunisia': [
                'Ariana', 'Béja', 'Ben Arous', 'Bizerte', 'Gabès', 'Gafsa', 'Jendouba',
                'Kairouan', 'Kasserine', 'Kébili', 'Kef', 'Mahdia', 'Manouba', 'Médenine',
                'Monastir', 'Nabeul', 'Sfax', 'Sidi Bouzid', 'Siliana', 'Sousse', 'Tataouine',
                'Tozeur', 'Tunis', 'Zaghouan'
            ],
            'Algeria': [
                'Adrar', 'Chlef', 'Laghouat', 'Oum El Bouaghi', 'Batna', 'Béjaïa', 'Biskra',
                'Béchar', 'Blida', 'Bouira', 'Tamanrasset', 'Tébessa', 'Tlemcen', 'Tiaret',
                'Tizi Ouzou', 'Algiers', 'Djelfa', 'Jijel', 'Sétif', 'Saïda', 'Skikda',
                'Sidi Bel Abbès', 'Annaba', 'Guelma', 'Constantine', 'Médéa', 'Mostaganem',
                'M\'Sila', 'Mascara', 'Ouargla', 'Oran', 'El Bayadh', 'Illizi', 'Bordj Bou Arréridj',
                'Boumerdès', 'El Tarf', 'Tindouf', 'Tissemsilt', 'El Oued', 'Khenchela', 'Souk Ahras',
                'Tipaza', 'Mila', 'Aïn Defla', 'Naâma', 'Aïn Témouchent', 'Ghardaïa', 'Relizane'
            ]
        };

        // Function to populate governorate dropdown based on selected country
        function populateGovernorates(country) {
            const governorateSelect = document.getElementById('customerGovernorate');
            governorateSelect.innerHTML = '<option value="">Select Governorate/State</option>';

            if (country && countryGovernorates[country]) {
                countryGovernorates[country].forEach(governorate => {
                    const option = document.createElement('option');
                    option.value = governorate;
                    option.textContent = governorate;
                    governorateSelect.appendChild(option);
                });
            }
        }

        // Function to get neighborhoods/districts for a specific governorate (Egyptian examples)
        function getNeighborhoodsForGovernorate(country, governorate) {
            if (country === 'Egypt') {
                const egyptNeighborhoods = {
                    'Cairo': ['Nasr City', 'Maadi', 'Heliopolis', 'Zamalek', 'Downtown', 'Garden City', 'New Cairo', '6th October City', 'Sheikh Zayed'],
                    'Giza': ['Dokki', 'Agouza', 'Mohandessin', 'Imbaba', 'El Haram', 'El Omraniya', 'Boulaq El Dakrour'],
                    'Alexandria': ['Smouha', 'Sidi Gaber', 'Gleem', 'San Stefano', 'Rushdy', 'Louran', 'Miami'],
                    'Sharkia': ['Zagazig', '10th of Ramadan City', 'Belbeis', 'Abu Hammad', 'Abu Kebir', 'Faqous', 'Hihya'],
                    'Dakahlia': ['Mansoura', 'Talkha', 'Aga', 'Dekernes', 'Gamasa', 'Mit Ghamr', 'Belqas']
                };
                return egyptNeighborhoods[governorate] || [];
            }
            return [];
        }

        // Import functionality
        let csvData = [];
        let csvHeaders = [];

        // Helper functions for Excel export
        function formatPhoneNumber(phone) {
            if (!phone) return '';

            // Clean the phone number
            const cleaned = phone.replace(/\D/g, '');

            // Format Egyptian phone numbers
            if (cleaned.startsWith('20')) {
                // International format: +20XXXXXXXXXX
                return `+${cleaned}`;
            } else if (cleaned.startsWith('0')) {
                // Local format: 0XXXXXXXXXX
                return cleaned;
            } else if (cleaned.length === 11 && !cleaned.startsWith('20')) {
                // Add country code if missing
                return `+20${cleaned}`;
            }

            return phone; // Return original if can't format
        }

        function formatDateForExcel(date) {
            if (!date) return '';

            try {
                let dateObj;

                // Handle Firestore Timestamp
                if (date.toDate) {
                    dateObj = date.toDate();
                }
                // Handle regular Date object
                else if (date instanceof Date) {
                    dateObj = date;
                }
                // Handle string date
                else {
                    dateObj = new Date(date);
                }

                // Format as MM/DD/YYYY for Excel
                const month = String(dateObj.getMonth() + 1).padStart(2, '0');
                const day = String(dateObj.getDate()).padStart(2, '0');
                const year = dateObj.getFullYear();

                return `${month}/${day}/${year}`;
            } catch (error) {
                console.error('Error formatting date:', error);
                return '';
            }
        }

        function generateSampleCustomers() {
            return [
                {
                    name: "Ahmed Hassan",
                    firstName: "Ahmed",
                    lastName: "Hassan",
                    email: "ahmed.hassan@email.com",
                    phone: "+20 10 1234 5678",
                    status: "active",
                    totalSpent: 2450.75,
                    orderCount: 8,
                    activeOrders: 2,
                    canceledOrders: 1,
                    pendingAmount: 350.00,
                    avgOrderValue: 306.34,
                    lastOrder: new Date('2024-01-15'),
                    createdAt: new Date('2023-06-10'),
                    addressDetails: {
                        line: "123 Tahrir Square",
                        addressLine2: "Apt 4B",
                        neighborhood: "Downtown",
                        governorate: "Cairo",
                        district: "Cairo",
                        country: "Egypt",
                        postalCode: "11511",
                        addressClarification: "Near the Egyptian Museum",
                        latitude: "30.0444",
                        longitude: "31.2357",
                        apartment: "4B",
                        floor: "4",
                        building: "Tahrir Plaza"
                    }
                },
                {
                    name: "Fatima Al-Zahra",
                    firstName: "Fatima",
                    lastName: "Al-Zahra",
                    email: "fatima.alzahra@email.com",
                    phone: "+20 12 9876 5432",
                    status: "vip",
                    totalSpent: 8750.25,
                    orderCount: 25,
                    activeOrders: 3,
                    canceledOrders: 0,
                    pendingAmount: 0.00,
                    avgOrderValue: 350.01,
                    lastOrder: new Date('2024-01-20'),
                    createdAt: new Date('2022-03-15'),
                    addressDetails: {
                        line: "456 Zamalek Street",
                        addressLine2: "Villa 12",
                        neighborhood: "Zamalek",
                        governorate: "Cairo",
                        district: "Cairo",
                        country: "Egypt",
                        postalCode: "11211",
                        addressClarification: "Facing the Nile River",
                        latitude: "30.0626",
                        longitude: "31.2197",
                        apartment: "",
                        floor: "",
                        building: "Nile Villa"
                    }
                },
                {
                    name: "Omar Mahmoud",
                    firstName: "Omar",
                    lastName: "Mahmoud",
                    email: "omar.mahmoud@email.com",
                    phone: "+20 11 5555 1234",
                    status: "active",
                    totalSpent: 1200.50,
                    orderCount: 5,
                    activeOrders: 1,
                    canceledOrders: 2,
                    pendingAmount: 150.00,
                    avgOrderValue: 240.10,
                    lastOrder: new Date('2024-01-18'),
                    createdAt: new Date('2023-09-22'),
                    addressDetails: {
                        line: "789 Heliopolis Avenue",
                        addressLine2: "Building C, Apt 15",
                        neighborhood: "Heliopolis",
                        governorate: "Cairo",
                        district: "Cairo",
                        country: "Egypt",
                        postalCode: "11341",
                        addressClarification: "Near Korba Square",
                        latitude: "30.0808",
                        longitude: "31.3208",
                        apartment: "15",
                        floor: "3",
                        building: "Heliopolis Tower C"
                    }
                },
                {
                    name: "Nour Ibrahim",
                    firstName: "Nour",
                    lastName: "Ibrahim",
                    email: "nour.ibrahim@email.com",
                    phone: "+20 15 7777 8888",
                    status: "inactive",
                    totalSpent: 450.00,
                    orderCount: 3,
                    activeOrders: 0,
                    canceledOrders: 1,
                    pendingAmount: 0.00,
                    avgOrderValue: 150.00,
                    lastOrder: new Date('2023-12-05'),
                    createdAt: new Date('2023-11-01'),
                    addressDetails: {
                        line: "321 Maadi Corniche",
                        addressLine2: "Floor 2, Apt 8",
                        neighborhood: "Maadi",
                        governorate: "Cairo",
                        district: "Cairo",
                        country: "Egypt",
                        postalCode: "11728",
                        addressClarification: "Near Maadi Metro Station",
                        latitude: "29.9607",
                        longitude: "31.2593",
                        apartment: "8",
                        floor: "2",
                        building: "Corniche Residence"
                    }
                },
                {
                    name: "Youssef Abdel Rahman",
                    firstName: "Youssef",
                    lastName: "Abdel Rahman",
                    email: "youssef.abdelrahman@email.com",
                    phone: "+20 16 9999 1111",
                    status: "active",
                    totalSpent: 3200.75,
                    orderCount: 12,
                    activeOrders: 2,
                    canceledOrders: 0,
                    pendingAmount: 500.00,
                    avgOrderValue: 266.73,
                    lastOrder: new Date('2024-01-22'),
                    createdAt: new Date('2023-04-12'),
                    addressDetails: {
                        line: "654 New Cairo City",
                        addressLine2: "Compound B, Villa 7",
                        neighborhood: "New Cairo",
                        governorate: "Cairo",
                        district: "Cairo",
                        country: "Egypt",
                        postalCode: "11835",
                        addressClarification: "Near AUC New Cairo Campus",
                        latitude: "30.0301",
                        longitude: "31.4997",
                        apartment: "",
                        floor: "",
                        building: "New Cairo Villa 7"
                    }
                }
            ];
        }

        // Excel Export with Full Styling using ExcelJS
        async function exportCustomersExcelStyled() {
            try {
                console.log('Styled Excel export started');

                // Get all customers from Firestore
                const customersCollection = window.getScopedCollection(db, "customers");
                const customersSnapshot = await getDocs(customersCollection);
                const customers = [];

                customersSnapshot.forEach((doc) => {
                    const customerData = doc.data();
                    customers.push({
                        id: doc.id,
                        ...customerData
                    });
                });

                console.log('Total customers found:', customers.length);

                // Always generate Excel content (either real data or sample data)
                let dataToExport;
                let filename;
                let message;

                if (customers.length === 0) {
                    // Generate sample data for testing
                    dataToExport = generateSampleCustomers();
                    filename = `Exported Customers ${new Date().toISOString().split('T')[0]}.xlsx`;
                    message = `No customers found in database. Generated styled Excel with ${dataToExport.length} customers for testing!`;
                } else {
                    // Use real customer data
                    dataToExport = customers;
                    filename = `Exported Customers ${new Date().toISOString().split('T')[0]}.xlsx`;
                    message = `Successfully exported ${dataToExport.length} customers to styled Excel!`;
                }

                // Create new workbook
                const workbook = new ExcelJS.Workbook();

                // Add worksheet
                const worksheet = workbook.addWorksheet('Customers');

                // Define headers
                const headers = [
                    'Name', 'Signup Date', 'Email', 'Phone Number', '# of Orders', 'Active Orders',
                    'Canceled Orders', 'Total Amount Spent', 'Amount Pending Payment', 'Average Order Value',
                    'Last Order', 'Address Line 1', 'Address Line 2', 'Neighborhood', 'Governorate',
                    'District', 'Country', 'Postal Code', 'Address Clarification', 'Lat', 'Lng',
                    'Apartment', 'Floor', 'Building'
                ];

                // Add header row
                worksheet.addRow(headers);

                // Style header row
                const headerRow = worksheet.getRow(1);
                headerRow.height = 25; // Set uniform row height
                headerRow.eachCell((cell, colNumber) => {
                    cell.fill = {
                        type: 'pattern',
                        pattern: 'solid',
                        fgColor: { argb: 'FF2C3E50' } // Dark blue-gray
                    };
                    cell.font = {
                        color: { argb: 'FFFFFFFF' }, // White text
                        bold: true,
                        size: 11
                    };
                    cell.alignment = {
                        horizontal: 'center',
                        vertical: 'middle',
                        wrapText: true
                    };
                    cell.border = {
                        top: { style: 'thin', color: { argb: 'FF000000' } },
                        left: { style: 'thin', color: { argb: 'FF000000' } },
                        bottom: { style: 'thin', color: { argb: 'FF000000' } },
                        right: { style: 'thin', color: { argb: 'FF000000' } }
                    };
                });

                // Add data rows with comprehensive styling
                dataToExport.forEach((customer, index) => {
                    const row = [
                        customer.name || '',
                        formatDateForExcel(customer.createdAt),
                        customer.email || '',
                        formatPhoneNumber(customer.phone || ''),
                        customer.orderCount || 0,
                        customer.activeOrders || 0,
                        customer.canceledOrders || 0,
                        customer.totalSpent || 0,
                        customer.pendingAmount || 0,
                        customer.avgOrderValue || 0,
                        formatDateForExcel(customer.lastOrder),
                        customer.addressDetails?.line || '',
                        customer.addressDetails?.addressLine2 || '',
                        customer.addressDetails?.neighborhood || '',
                        customer.addressDetails?.governorate || '',
                        customer.addressDetails?.district || '',
                        customer.addressDetails?.country || '',
                        customer.addressDetails?.postalCode || '',
                        customer.addressDetails?.addressClarification || '',
                        customer.addressDetails?.latitude || '',
                        customer.addressDetails?.longitude || '',
                        customer.addressDetails?.apartment || '',
                        customer.addressDetails?.floor || '',
                        customer.addressDetails?.building || ''
                    ];

                    const dataRow = worksheet.addRow(row);
                    dataRow.height = 25; // Set uniform row height for all data rows

                    // Style data rows with comprehensive formatting
                    dataRow.eachCell({ includeEmpty: true }, (cell, colNumber) => {
                        // Define different background colors for alternating rows
                        let backgroundColor;
                        let textColor = { argb: 'FF333333' }; // Dark gray text

                        if (index % 2 === 0) {
                            backgroundColor = { argb: 'FFF8F9FA' }; // Light gray
                        } else {
                            backgroundColor = { argb: 'FFFFFFFF' }; // White
                        }

                        // Special styling for different data types
                        if (colNumber === 1) { // Name column - Bold and prominent
                            cell.font = {
                                bold: true,
                                color: { argb: 'FF1A1A1A' }, // Very dark text
                                size: 11
                            };
                            cell.fill = {
                                type: 'pattern',
                                pattern: 'solid',
                                fgColor: backgroundColor
                            };
                        } else if (colNumber === 2 || colNumber === 11) { // Date columns - Green
                            cell.font = {
                                color: { argb: 'FF009900' }, // Green for dates
                                size: 10,
                                bold: false
                            };
                            cell.fill = {
                                type: 'pattern',
                                pattern: 'solid',
                                fgColor: backgroundColor
                            };
                            cell.alignment = {
                                horizontal: 'center',
                                vertical: 'middle',
                                wrapText: true
                            };
                        } else if (colNumber === 3) { // Email column - Purple
                            cell.font = {
                                color: { argb: 'FF800080' }, // Purple for email
                                size: 10
                            };
                            cell.fill = {
                                type: 'pattern',
                                pattern: 'solid',
                                fgColor: backgroundColor
                            };
                        } else if (colNumber === 4) { // Phone column - Blue
                            cell.font = {
                                color: { argb: 'FF0066CC' }, // Blue for phone
                                size: 10,
                                bold: true
                            };
                            cell.fill = {
                                type: 'pattern',
                                pattern: 'solid',
                                fgColor: backgroundColor
                            };
                            cell.alignment = {
                                horizontal: 'center',
                                vertical: 'middle',
                                wrapText: true
                            };
                        } else if (colNumber >= 5 && colNumber <= 10) { // Numeric columns - Blue with special formatting
                            const value = cell.value;
                            let numberColor = { argb: 'FF0066CC' }; // Default blue

                            // Special colors for different types of numbers
                            if (colNumber === 8 || colNumber === 9 || colNumber === 10) { // Money columns
                                numberColor = { argb: 'FFCC6600' }; // Orange for money
                            } else if (colNumber === 6 || colNumber === 7) { // Order counts
                                numberColor = { argb: 'FF006600' }; // Dark green for counts
                            }

                            cell.font = {
                                color: numberColor,
                                size: 10,
                                bold: true
                            };
                            cell.fill = {
                                type: 'pattern',
                                pattern: 'solid',
                                fgColor: backgroundColor
                            };
                            cell.alignment = {
                                horizontal: 'center',
                                vertical: 'middle',
                                wrapText: true
                            };
                        } else if (colNumber >= 12 && colNumber <= 24) { // Address columns
                            cell.font = {
                                color: { argb: 'FF444444' }, // Medium gray for addresses
                                size: 9
                            };
                            cell.fill = {
                                type: 'pattern',
                                pattern: 'solid',
                                fgColor: backgroundColor
                            };
                        } else { // Default styling
                            cell.font = {
                                color: textColor,
                                size: 10
                            };
                            cell.fill = {
                                type: 'pattern',
                                pattern: 'solid',
                                fgColor: backgroundColor
                            };
                        }

                        // Apply borders to all cells
                        cell.border = {
                            top: { style: 'thin', color: { argb: 'FFCCCCCC' } },
                            left: { style: 'thin', color: { argb: 'FFCCCCCC' } },
                            bottom: { style: 'thin', color: { argb: 'FFCCCCCC' } },
                            right: { style: 'thin', color: { argb: 'FFCCCCCC' } }
                        };

                        // Default alignment
                        if (!cell.alignment) {
                            cell.alignment = {
                                vertical: 'middle',
                                wrapText: true
                            };
                        }
                    });
                });

                // Set column widths
                const columnWidths = [20, 12, 25, 15, 10, 12, 14, 15, 18, 18, 12, 25, 25, 15, 15, 15, 12, 12, 20, 12, 12, 12, 8, 15];
                columnWidths.forEach((width, index) => {
                    worksheet.getColumn(index + 1).width = width;
                });

                // Freeze the header row
                worksheet.views = [{ state: 'frozen', ySplit: 1 }];

                // Generate and download the file
                const buffer = await workbook.xlsx.writeBuffer();
                const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });

                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);

                console.log('Styled Excel export completed successfully');
                alert(message);

            } catch (error) {
                console.error('Error exporting styled Excel:', error);
                alert('Error exporting styled Excel: ' + error.message);
            }
        }

        // Make the function globally accessible
        window.exportCustomersExcelStyled = exportCustomersExcelStyled;

        // Customer action functions
        async function viewCustomer(customerId) {
            try {
                const customerDoc = await getDoc(doc(db, "customers", customerId));
                if (customerDoc.exists()) {
                    const customer = customerDoc.data();
                    showCustomerDetails(customer, customerId);
                } else {
                    alert('Customer not found!');
                }
            } catch (error) {
                console.error('Error viewing customer:', error);
                alert('Error loading customer details: ' + error.message);
            }
        }

        async function editCustomer(customerId) {
            try {
                const customerDoc = await getDoc(doc(db, "customers", customerId));
                if (customerDoc.exists()) {
                    const customer = customerDoc.data();
                    openEditCustomerModal(customer, customerId);
                } else {
                    alert('Customer not found!');
                }
            } catch (error) {
                console.error('Error editing customer:', error);
                alert('Error loading customer for editing: ' + error.message);
            }
        }

        async function deleteCustomer(customerId) {
            if (confirm('Are you sure you want to delete this customer? This action cannot be undone.')) {
                try {
                    await deleteDoc(doc(db, "customers", customerId));
                    alert('Customer deleted successfully!');
                    await loadCustomers(); // Reload the customers list
                } catch (error) {
                    console.error('Error deleting customer:', error);
                    alert('Error deleting customer: ' + error.message);
                }
            }
        }

        function showCustomerDetails(customer, customerId) {
            // Create a modal to show customer details
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 flex items-center justify-center z-50';
            modal.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';

            modal.innerHTML = `
                <div class="bg-white rounded-xl shadow-lg w-full max-w-2xl max-h-[90vh] overflow-y-auto">
                    <div class="flex items-center justify-between p-6 border-b border-gray-200">
                        <h3 class="text-2xl font-bold text-[var(--madas-primary)]">Customer Details</h3>
                        <button class="close-details-modal text-gray-500 hover:text-gray-700">
                            <span class="material-icons">close</span>
                        </button>
                    </div>
                    <div class="p-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <h4 class="text-lg font-semibold text-gray-800 mb-4">Personal Information</h4>
                                <div class="space-y-3">
                                    <div>
                                        <label class="text-sm font-medium text-gray-600">Name:</label>
                                        <p class="text-gray-900">${customer.name || 'N/A'}</p>
                                    </div>
                                    <div>
                                        <label class="text-sm font-medium text-gray-600">Email:</label>
                                        <p class="text-gray-900">${customer.email || 'N/A'}</p>
                                    </div>
                                    <div>
                                        <label class="text-sm font-medium text-gray-600">Phone:</label>
                                        <p class="text-gray-900">${customer.phone || 'N/A'}</p>
                                    </div>
                                    <div>
                                        <label class="text-sm font-medium text-gray-600">Status:</label>
                                        <span class="px-2 py-1 text-xs font-semibold rounded-full ${customer.status === 'active' ? 'bg-green-100 text-green-800' : customer.status === 'vip' ? 'bg-purple-100 text-purple-800' : 'bg-gray-100 text-gray-800'}">
                                            ${customer.status || 'active'}
                                        </span>
                                    </div>
                                </div>
                            </div>
                            <div>
                                <h4 class="text-lg font-semibold text-gray-800 mb-4">Order Information</h4>
                                <div class="space-y-3">
                                    <div>
                                        <label class="text-sm font-medium text-gray-600">Total Orders:</label>
                                        <p class="text-gray-900">${customer.orderCount || 0}</p>
                                    </div>
                                    <div>
                                        <label class="text-sm font-medium text-gray-600">Total Spent:</label>
                                        <p class="text-gray-900">$${customer.totalSpent || 0}</p>
                                    </div>
                                    <div>
                                        <label class="text-sm font-medium text-gray-600">Active Orders:</label>
                                        <p class="text-gray-900">${customer.activeOrders || 0}</p>
                                    </div>
                                    <div>
                                        <label class="text-sm font-medium text-gray-600">Last Order:</label>
                                        <p class="text-gray-900">${customer.lastOrder ? new Date(customer.lastOrder.toDate ? customer.lastOrder.toDate() : customer.lastOrder).toLocaleDateString() : 'Never'}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        ${customer.addressDetails ? `
                        <div class="mt-6">
                            <h4 class="text-lg font-semibold text-gray-800 mb-4">Address Information</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="text-sm font-medium text-gray-600">Address Line:</label>
                                    <p class="text-gray-900">${customer.addressDetails.line || 'N/A'}</p>
                                </div>
                                <div>
                                    <label class="text-sm font-medium text-gray-600">Neighborhood:</label>
                                    <p class="text-gray-900">${customer.addressDetails.neighborhood || 'N/A'}</p>
                                </div>
                                <div>
                                    <label class="text-sm font-medium text-gray-600">Governorate:</label>
                                    <p class="text-gray-900">${customer.addressDetails.governorate || 'N/A'}</p>
                                </div>
                                <div>
                                    <label class="text-sm font-medium text-gray-600">Country:</label>
                                    <p class="text-gray-900">${customer.addressDetails.country || 'N/A'}</p>
                                </div>
                            </div>
                        </div>
                        ` : ''}
                    </div>
                    <div class="flex justify-end space-x-3 p-6 border-t border-gray-200">
                        <button class="close-details-modal bg-gray-300 text-gray-700 px-6 py-2 rounded-lg hover:bg-gray-400 transition-colors">Close</button>
                        <button class="edit-customer-from-details bg-[var(--madas-primary)] text-white px-6 py-2 rounded-lg hover:bg-[#1f3c19] transition-colors" data-customer-id="${customerId}">Edit Customer</button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // Add event listeners
            modal.querySelectorAll('.close-details-modal').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.body.removeChild(modal);
                });
            });

            modal.querySelector('.edit-customer-from-details').addEventListener('click', () => {
                document.body.removeChild(modal);
                editCustomer(customerId);
            });
        }

        function openEditCustomerModal(customer, customerId) {
            // Populate the existing add customer modal with customer data
            document.getElementById('customerFirstName').value = customer.firstName || customer.name?.split(' ')[0] || '';
            document.getElementById('customerLastName').value = customer.lastName || customer.name?.split(' ').slice(1).join(' ') || '';
            document.getElementById('customerEmail').value = customer.email || '';
            document.getElementById('customerPhone').value = customer.phone || '';
            document.getElementById('customerAddressLine').value = customer.addressDetails?.line || '';
            document.getElementById('customerApartment').value = customer.addressDetails?.apartment || '';
            document.getElementById('customerFloor').value = customer.addressDetails?.floor || '';
            document.getElementById('customerBuilding').value = customer.addressDetails?.building || '';
            document.getElementById('customerCountry').value = customer.addressDetails?.country || 'Egypt';
            document.getElementById('customerNeighborhood').value = customer.addressDetails?.neighborhood || '';
            document.getElementById('customerDistrict').value = customer.addressDetails?.district || '';

            // Populate governorates based on country
            populateGovernorates(customer.addressDetails?.country || 'Egypt');
            document.getElementById('customerGovernorate').value = customer.addressDetails?.governorate || '';

            // Change modal title and button text
            document.querySelector('#addCustomerModal h3').textContent = 'Edit Customer';
            document.getElementById('saveCustomerBtn').textContent = 'Update';

            // Store customer ID for update
            document.getElementById('saveCustomerBtn').setAttribute('data-customer-id', customerId);

            // Show modal
            document.getElementById('addCustomerModal').classList.remove('hidden');
        }

        // Import button event listener
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize Egypt as default country and populate governorates
            populateGovernorates('Egypt');

            // Country dropdown event listener
            const countrySelect = document.getElementById('customerCountry');
            if (countrySelect) {
                countrySelect.addEventListener('change', (e) => {
                    const selectedCountry = e.target.value;
                    populateGovernorates(selectedCountry);

                    // Clear neighborhood and district when country changes
                    document.getElementById('customerNeighborhood').value = '';
                    document.getElementById('customerDistrict').value = '';
                });
            }

            const importBtn = document.getElementById('importCustomersBtn');
            if (importBtn) {
                importBtn.addEventListener('click', () => {
                    document.getElementById('importModal').classList.remove('hidden');
                });
            }
            // Add test customers button (for testing purposes)
            const testCustomersBtn = document.getElementById('testCustomersBtn');
            if (testCustomersBtn) {
                testCustomersBtn.addEventListener('click', createTestCustomers);
            }

            // Close import modal
            const closeImportBtn = document.getElementById('closeImportModalBtn');
            const cancelImportBtn = document.getElementById('cancelImportBtn');
            if (closeImportBtn) {
                closeImportBtn.addEventListener('click', () => {
                    document.getElementById('importModal').classList.add('hidden');
                    resetImportModal();
                });
            }
            if (cancelImportBtn) {
                cancelImportBtn.addEventListener('click', () => {
                    document.getElementById('importModal').classList.add('hidden');
                    resetImportModal();
                });
            }

            // CSV file input handler
            const csvFileInput = document.getElementById('csvFileInput');
            if (csvFileInput) {
                csvFileInput.addEventListener('change', handleCSVFile);
            }

            // Confirm import button
            const confirmImportBtn = document.getElementById('confirmImportBtn');
            if (confirmImportBtn) {
                confirmImportBtn.addEventListener('click', importCustomers);
            }

            // Add customer button (main header)
            const addCustomerBtn = document.getElementById('addCustomerBtn');
            if (addCustomerBtn) {
                addCustomerBtn.addEventListener('click', () => {
                    console.log('Main add customer button clicked');
                    document.getElementById('addCustomerModal').classList.remove('hidden');
                });
            }

            // Add customer button (sidebar)
            const addCustomerBtnSidebar = document.getElementById('addCustomerBtnSidebar');
            if (addCustomerBtnSidebar) {
                addCustomerBtnSidebar.addEventListener('click', () => {
                    console.log('Sidebar add customer button clicked');
                    document.getElementById('addCustomerModal').classList.remove('hidden');
                });
            }

            // Close add customer modal
            const closeAddCustomerBtn = document.getElementById('closeAddCustomerModalBtn');
            const cancelAddCustomerBtn = document.getElementById('cancelAddCustomerBtn');
            if (closeAddCustomerBtn) {
                closeAddCustomerBtn.addEventListener('click', () => {
                    document.getElementById('addCustomerModal').classList.add('hidden');
                    resetAddCustomerForm();
                });
            }
            if (cancelAddCustomerBtn) {
                cancelAddCustomerBtn.addEventListener('click', () => {
                    document.getElementById('addCustomerModal').classList.add('hidden');
                    resetAddCustomerForm();
                });
            }

            // Add customer form submission
            const addCustomerForm = document.getElementById('addCustomerForm');
            if (addCustomerForm) {
                console.log('Add customer form found, adding submit listener');
                addCustomerForm.addEventListener('submit', handleAddCustomer);
            } else {
                console.error('Add customer form not found!');
            }

            // Handle add/edit customer form submission
            async function handleAddCustomer(e) {
                e.preventDefault();

                const firstName = document.getElementById('customerFirstName').value;
                const lastName = document.getElementById('customerLastName').value;
                const email = document.getElementById('customerEmail').value;
                const phone = document.getElementById('customerPhone').value;
                const addressLine = document.getElementById('customerAddressLine').value;
                const apartment = document.getElementById('customerApartment').value;
                const floor = document.getElementById('customerFloor').value;
                const building = document.getElementById('customerBuilding').value;
                const country = document.getElementById('customerCountry').value;
                const governorate = document.getElementById('customerGovernorate').value;
                const neighborhood = document.getElementById('customerNeighborhood').value;
                const district = document.getElementById('customerDistrict').value;

                // Check if this is an edit operation
                const saveBtn = document.getElementById('saveCustomerBtn');
                const customerId = saveBtn.getAttribute('data-customer-id');
                const isEdit = customerId !== null;

                try {
                    const customerData = {
                        name: `${firstName} ${lastName}`.trim(),
                        firstName: firstName,
                        lastName: lastName,
                        email: email,
                        phone: phone,
                        status: 'active',
                        totalSpent: 0,
                        orderCount: 0,
                        activeOrders: 0,
                        canceledOrders: 0,
                        pendingAmount: 0,
                        avgOrderValue: 0,
                        lastOrder: null,
                        addressDetails: {
                            line: addressLine,
                            addressLine2: '',
                            neighborhood: neighborhood,
                            governorate: governorate,
                            district: district,
                            country: country,
                            postalCode: '',
                            addressClarification: '',
                            latitude: '',
                            longitude: '',
                            apartment: apartment,
                            floor: floor,
                            building: building
                        }
                    };

                    if (isEdit) {
                        // Update existing customer
                        await updateDoc(doc(db, "customers", customerId), customerData);
                        alert('Customer updated successfully!');
                    } else {
                        // Add new customer
                        customerData.createdAt = new Date();
                        await addDoc(window.getScopedCollection(db, "customers"), customerData);
                        alert('Customer added successfully!');
                    }

                    // Close modal and reload customers
                    document.getElementById('addCustomerModal').classList.add('hidden');
                    resetAddCustomerForm();
                    await loadCustomers();

                } catch (error) {
                    console.error('Error saving customer:', error);
                    alert('Error saving customer: ' + error.message);
                }
            }

            function resetAddCustomerForm() {
                document.getElementById('addCustomerForm').reset();
                document.querySelector('#addCustomerModal h3').textContent = 'Add customer';
                document.getElementById('saveCustomerBtn').textContent = 'Save';
                document.getElementById('saveCustomerBtn').removeAttribute('data-customer-id');
                populateGovernorates('Egypt');
            }

            // File handling (CSV and HTML)
            function handleCSVFile(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    const text = e.target.result;
                    const fileName = file.name.toLowerCase();

                    // Check file type and handle accordingly
                    if (fileName.endsWith('.html') || fileName.endsWith('.htm')) {
                        handleHTMLFile(text);
                    } else {
                        parseCSV(text);
                    }
                };
                reader.readAsText(file);
            }

            function handleHTMLFile(htmlContent) {
                try {
                    // Use the HTML to CSV converter
                    const converter = new HTMLToCSVConverter();
                    const csvContent = converter.convert(htmlContent);

                    // Parse the converted CSV
                    parseCSV(csvContent);

                    // Show success message
                    const previewDiv = document.getElementById('importPreview');
                    if (previewDiv && !previewDiv.querySelector('.bg-green-50')) {
                        const successMsg = document.createElement('div');
                        successMsg.className = 'bg-green-50 border border-green-200 rounded-lg p-3 mb-4';
                        successMsg.innerHTML = `
                        <div class="flex items-center">
                            <span class="material-icons text-green-600 mr-2">check_circle</span>
                            <span class="text-sm text-green-800">HTML file converted successfully!</span>
                        </div>
                    `;
                        previewDiv.parentNode.insertBefore(successMsg, previewDiv);
                    }

                } catch (error) {
                    console.error('Error converting HTML:', error);
                    alert('Error converting HTML file: ' + error.message);
                }
            }

            function parseCSV(text) {
                try {
                    const processor = new CSVProcessor();
                    const customers = processor.parseCSV(text);

                    if (customers.length === 0) {
                        alert('No valid customer data found in the file. Please check the file format.');
                        return;
                    }

                    // Convert to dashboard format
                    csvData = processor.convertToDashboardFormat(customers);
                    csvHeaders = ['name', 'email', 'phone', 'status', 'totalSpent', 'orderCount'];

                    showCSVPreview();
                    document.getElementById('confirmImportBtn').disabled = false;

                } catch (error) {
                    console.error('Error parsing CSV:', error);
                    alert('Error parsing CSV file: ' + error.message);
                }
            }

            function showCSVPreview() {
                const previewDiv = document.getElementById('importPreview');
                const previewHeader = document.getElementById('previewHeader');
                const previewBody = document.getElementById('previewBody');
                const confirmBtn = document.getElementById('confirmImportBtn');

                // Show preview
                previewDiv.classList.remove('hidden');

                // Create header
                previewHeader.innerHTML = csvHeaders.map(header =>
                    `<th class="px-2 py-1 text-left text-xs font-medium text-gray-500 uppercase">${header}</th>`
                ).join('');

                // Create preview rows (first 5)
                previewBody.innerHTML = csvData.slice(0, 5).map(row =>
                    `<tr>
                    ${csvHeaders.map(header =>
                        `<td class="px-2 py-1 text-xs text-gray-900">${row[header] || ''}</td>`
                    ).join('')}
                </tr>`
                ).join('');

                // Enable confirm button
                confirmBtn.disabled = false;
            }

            function resetImportModal() {
                document.getElementById('csvFileInput').value = '';
                document.getElementById('importPreview').classList.add('hidden');
                document.getElementById('confirmImportBtn').disabled = true;
                csvData = [];
                csvHeaders = [];
            }

            async function importCustomers() {
                if (csvData.length === 0) return;

                const confirmBtn = document.getElementById('confirmImportBtn');
                confirmBtn.disabled = true;
                confirmBtn.textContent = 'Importing...';

                try {
                    let successCount = 0;
                    let errorCount = 0;

                    for (const row of csvData) {
                        try {
                            const customerData = {
                                name: row.name,
                                email: row.email,
                                phone: row.phone || '',
                                status: row.status || 'active',
                                totalSpent: parseFloat(row.totalspent) || 0,
                                orderCount: parseInt(row.ordercount) || 0,
                                createdAt: new Date(),
                                lastOrder: null
                            };

                            await addDoc(window.getScopedCollection(db, "customers"), customerData);
                            successCount++;
                        } catch (error) {
                            console.error('Error importing customer:', error);
                            errorCount++;
                        }
                    }

                    alert(`Import completed! ${successCount} customers imported successfully, ${errorCount} errors.`);

                    // Close modal and reload customers
                    document.getElementById('importModal').classList.add('hidden');
                    resetImportModal();
                    await loadCustomers();

                } catch (error) {
                    console.error('Import error:', error);
                    alert('Error during import: ' + error.message);
                } finally {
                    confirmBtn.disabled = false;
                    confirmBtn.textContent = 'Import Customers';
                }
            }

            // CSV Export functionality
            async function exportCustomersCSV() {
                try {
                    console.log('Export customers started');
                    console.log('Firebase config:', firebaseConfig);
                    console.log('Database instance:', db);

                    // Get all customers from Firestore
                    const customersCollection = window.getScopedCollection(db, "customers");
                    console.log('Customers collection:', customersCollection);

                    const customersSnapshot = await getDocs(customersCollection);
                    console.log('Snapshot:', customersSnapshot);
                    console.log('Snapshot size:', customersSnapshot.size);
                    console.log('Snapshot empty:', customersSnapshot.empty);

                    const customers = [];

                    customersSnapshot.forEach((doc) => {
                        const customerData = doc.data();
                        console.log('Customer ID:', doc.id);
                        console.log('Customer data:', customerData);
                        customers.push({
                            id: doc.id,
                            ...customerData
                        });
                    });

                    console.log('Total customers found:', customers.length);
                    console.log('Customers array:', customers);

                    // Always generate CSV content (either real data or sample data)
                    let csvContent;
                    let filename;
                    let message;

                    if (customers.length === 0) {
                        // Generate sample data for testing
                        const sampleCustomers = generateSampleCustomers();
                        console.log('No customers found, generating sample data:', sampleCustomers);

                        csvContent = convertCustomersToCSV(sampleCustomers);
                        filename = `sample_customers_export_${new Date().toISOString().split('T')[0]}.csv`;
                        message = `No customers found in database. Generated sample CSV with ${sampleCustomers.length} customers for testing!`;
                    } else {
                        // Use real customer data
                        csvContent = convertCustomersToCSV(customers);
                        filename = `customers_export_${new Date().toISOString().split('T')[0]}.csv`;
                        message = `Successfully exported ${customers.length} customers!`;
                    }

                    console.log('Generated CSV content:', csvContent.substring(0, 500) + '...');

                    // Create and download the file
                    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                    const link = document.createElement('a');

                    if (link.download !== undefined) {
                        const url = URL.createObjectURL(blob);
                        link.setAttribute('href', url);
                        link.setAttribute('download', filename);
                        link.style.visibility = 'hidden';
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);

                        console.log('Export completed successfully');
                        alert(message);
                    }
                } catch (error) {
                    console.error('Error exporting customers:', error);
                    console.error('Error details:', error.message);
                    console.error('Error stack:', error.stack);
                    alert('Error exporting customers: ' + error.message);
                }
            }

            // Excel Export functionality with styling
            async function exportCustomersExcel() {
                try {
                    console.log('Excel export started');

                    // Get all customers from Firestore
                    const customersCollection = window.getScopedCollection(db, "customers");
                    const customersSnapshot = await getDocs(customersCollection);
                    const customers = [];

                    customersSnapshot.forEach((doc) => {
                        const customerData = doc.data();
                        customers.push({
                            id: doc.id,
                            ...customerData
                        });
                    });

                    console.log('Total customers found:', customers.length);

                    // Always generate Excel content (either real data or sample data)
                    let dataToExport;
                    let filename;
                    let message;

                    if (customers.length === 0) {
                        // Generate sample data for testing
                        dataToExport = generateSampleCustomers();
                        filename = `sample_customers_export_${new Date().toISOString().split('T')[0]}.xlsx`;
                        message = `No customers found in database. Generated sample Excel with ${dataToExport.length} customers for testing!`;
                    } else {
                        // Use real customer data
                        dataToExport = customers;
                        filename = `customers_export_${new Date().toISOString().split('T')[0]}.xlsx`;
                        message = `Successfully exported ${dataToExport.length} customers to Excel!`;
                    }

                    // Create Excel workbook
                    const workbook = XLSX.utils.book_new();

                    // Define headers
                    const headers = [
                        'Name', 'Signup Date', 'Email', 'Phone Number', '# of Orders',
                        'Active Orders', 'Canceled Orders', 'Total Amount Spent',
                        'Amount Pending Payment', 'Average Order Value', 'Last Order',
                        'Address Line 1', 'Address Line 2', 'City', 'Region', 'District',
                        'Country', 'Postal Code', 'Address Clarification', 'Lat', 'Lng',
                        'Apartment', 'Floor', 'Building'
                    ];

                    // Prepare data for Excel
                    const excelData = [headers];

                    dataToExport.forEach(customer => {
                        const row = [
                            customer.name || '',
                            formatDateForExcel(customer.createdAt),
                            customer.email || '',
                            formatPhoneNumber(customer.phone || ''),
                            customer.orderCount || 0,
                            customer.activeOrders || 0,
                            customer.canceledOrders || 0,
                            customer.totalSpent || 0,
                            customer.pendingAmount || 0,
                            customer.avgOrderValue || 0,
                            formatDateForExcel(customer.lastOrder),
                            customer.addressDetails?.line || '',
                            customer.addressDetails?.addressLine2 || '',
                            customer.addressDetails?.neighborhood || '',
                            customer.addressDetails?.governorate || '',
                            customer.addressDetails?.district || '',
                            customer.addressDetails?.country || '',
                            customer.addressDetails?.postalCode || '',
                            customer.addressDetails?.addressClarification || '',
                            customer.addressDetails?.latitude || '',
                            customer.addressDetails?.longitude || '',
                            customer.addressDetails?.apartment || '',
                            customer.addressDetails?.floor || '',
                            customer.addressDetails?.building || ''
                        ];
                        excelData.push(row);
                    });

                    // Create worksheet
                    const worksheet = XLSX.utils.aoa_to_sheet(excelData);

                    // Apply comprehensive styling to the worksheet
                    const range = XLSX.utils.decode_range(worksheet['!ref']);

                    // Define styles for better compatibility
                    const headerStyle = {
                        fill: {
                            fgColor: { rgb: "2C3E50" },
                            patternType: "solid"
                        },
                        font: {
                            bold: true,
                            color: { rgb: "FFFFFF" },
                            sz: 12
                        },
                        alignment: {
                            horizontal: "center",
                            vertical: "center",
                            wrapText: true
                        },
                        border: {
                            top: { style: "thin", color: { rgb: "000000" } },
                            bottom: { style: "thin", color: { rgb: "000000" } },
                            left: { style: "thin", color: { rgb: "000000" } },
                            right: { style: "thin", color: { rgb: "000000" } }
                        }
                    };

                    const dataStyle = {
                        border: {
                            top: { style: "thin", color: { rgb: "CCCCCC" } },
                            bottom: { style: "thin", color: { rgb: "CCCCCC" } },
                            left: { style: "thin", color: { rgb: "CCCCCC" } },
                            right: { style: "thin", color: { rgb: "CCCCCC" } }
                        },
                        alignment: {
                            vertical: "center",
                            wrapText: true
                        }
                    };

                    const alternateRowStyle = {
                        fill: {
                            fgColor: { rgb: "F8F9FA" },
                            patternType: "solid"
                        },
                        border: {
                            top: { style: "thin", color: { rgb: "CCCCCC" } },
                            bottom: { style: "thin", color: { rgb: "CCCCCC" } },
                            left: { style: "thin", color: { rgb: "CCCCCC" } },
                            right: { style: "thin", color: { rgb: "CCCCCC" } }
                        },
                        alignment: {
                            vertical: "center",
                            wrapText: true
                        }
                    };

                    // Style header row (dark background, white text, bold, centered)
                    for (let col = range.s.c; col <= range.e.c; col++) {
                        const cellAddress = XLSX.utils.encode_cell({ r: 0, c: col });
                        if (!worksheet[cellAddress]) continue;

                        // Apply header style
                        worksheet[cellAddress].s = headerStyle;
                    }

                    // Style data rows with alternating colors
                    for (let row = 1; row <= range.e.r; row++) {
                        for (let col = range.s.c; col <= range.e.c; col++) {
                            const cellAddress = XLSX.utils.encode_cell({ r: row, c: col });
                            if (!worksheet[cellAddress]) continue;

                            // Apply alternating row colors
                            if (row % 2 === 0) {
                                worksheet[cellAddress].s = alternateRowStyle;
                            } else {
                                worksheet[cellAddress].s = dataStyle;
                            }
                        }
                    }

                    // Set column widths
                    const columnWidths = [
                        { wch: 20 }, // Name
                        { wch: 12 }, // Signup Date
                        { wch: 25 }, // Email
                        { wch: 15 }, // Phone Number
                        { wch: 10 }, // # of Orders
                        { wch: 12 }, // Active Orders
                        { wch: 14 }, // Canceled Orders
                        { wch: 15 }, // Total Amount Spent
                        { wch: 18 }, // Amount Pending Payment
                        { wch: 18 }, // Average Order Value
                        { wch: 12 }, // Last Order
                        { wch: 25 }, // Address Line 1
                        { wch: 25 }, // Address Line 2
                        { wch: 15 }, // City
                        { wch: 15 }, // Region
                        { wch: 15 }, // District
                        { wch: 12 }, // Country
                        { wch: 12 }, // Postal Code
                        { wch: 20 }, // Address Clarification
                        { wch: 12 }, // Lat
                        { wch: 12 }, // Lng
                        { wch: 12 }, // Apartment
                        { wch: 8 },  // Floor
                        { wch: 15 }  // Building
                    ];
                    worksheet['!cols'] = columnWidths;

                    // Add worksheet to workbook
                    XLSX.utils.book_append_sheet(workbook, worksheet, "Customers");

                    // Generate and download the file
                    XLSX.writeFile(workbook, filename);

                    console.log('Excel export completed successfully');
                    alert(message);

                } catch (error) {
                    console.error('Error exporting to Excel:', error);
                    alert('Error exporting to Excel: ' + error.message);
                }
            }

            // Create test customers in database (for testing purposes)
            async function createTestCustomers() {
                try {
                    console.log('Creating test customers...');

                    const testCustomers = generateSampleCustomers();
                    const promises = testCustomers.map(customer => {
                        // Remove the id field if it exists
                        const { id, ...customerData } = customer;
                        return addDoc(window.getScopedCollection(db, "customers"), customerData);
                    });

                    await Promise.all(promises);
                    console.log('Test customers created successfully');
                    alert(`Created ${testCustomers.length} test customers in the database!`);

                    // Refresh the customers list
                    await loadCustomers();
                } catch (error) {
                    console.error('Error creating test customers:', error);
                    alert('Error creating test customers: ' + error.message);
                }
            }

            // Inventory Dropdown functionality
            function setupInventoryDropdown() {
                const inventoryToggle = document.getElementById("inventory-toggle");
                const inventorySubmenu = document.getElementById("inventory-submenu");
                const inventoryArrow = document.getElementById("inventory-arrow");

                if (inventoryToggle && inventorySubmenu && inventoryArrow) {
                    inventoryToggle.addEventListener("click", () => {
                        const isOpen = !inventorySubmenu.classList.contains("hidden");
                        if (isOpen) {
                            inventorySubmenu.classList.add("hidden");
                            inventoryArrow.style.transform = "rotate(0deg)";
                        } else {
                            inventorySubmenu.classList.remove("hidden");
                            inventoryArrow.style.transform = "rotate(180deg)";
                        }
                    });
                }
            }

            // Finance Dropdown functionality
            function setupFinanceDropdown() {
                const financeDropdownBtn = document.getElementById("finance-dropdown-btn");
                const financeDropdownMenu = document.getElementById("finance-dropdown-menu");
                const dropdownArrow = document.querySelector("#finance-dropdown-btn .dropdown-arrow");

                if (financeDropdownBtn && financeDropdownMenu) {
                    financeDropdownBtn.addEventListener("click", (e) => {
                        e.preventDefault();
                        financeDropdownMenu.classList.toggle("show");
                        financeDropdownMenu.classList.toggle("hidden");
                        if (dropdownArrow) dropdownArrow.classList.toggle("rotate");
                    });
                    // Close on outside click
                    document.addEventListener("click", (e) => {
                        if (!financeDropdownBtn.contains(e.target) && !financeDropdownMenu.contains(e.target)) {
                            financeDropdownMenu.classList.add("hidden");
                            financeDropdownMenu.classList.remove("show");
                            if (dropdownArrow) dropdownArrow.classList.remove("rotate");
                        }
                    });
                }
            }

            // E-commerce Dropdown functionality
            function setupEcommerceDropdown() {
                const ecommerceDropdownBtn = document.getElementById("ecommerce-dropdown-btn");
                const ecommerceDropdownMenu = document.getElementById("ecommerce-dropdown-menu");
                const ecommerceArrow = document.getElementById("ecommerce-arrow");

                if (ecommerceDropdownBtn && ecommerceDropdownMenu) {
                    ecommerceDropdownBtn.addEventListener("click", (e) => {
                        e.preventDefault();
                        const isOpen = ecommerceDropdownMenu.classList.contains("show");
                        if (isOpen) {
                            ecommerceDropdownMenu.classList.remove("show");
                            ecommerceDropdownMenu.classList.add("hidden");
                            if (ecommerceArrow) ecommerceArrow.classList.remove("rotate");
                        } else {
                            ecommerceDropdownMenu.classList.remove("hidden");
                            ecommerceDropdownMenu.classList.add("show");
                            if (ecommerceArrow) ecommerceArrow.classList.add("rotate");
                        }
                    });
                    // Close on outside click
                    document.addEventListener("click", (e) => {
                        if (!ecommerceDropdownBtn.contains(e.target) && !ecommerceDropdownMenu.contains(e.target)) {
                            ecommerceDropdownMenu.classList.add("hidden");
                            ecommerceDropdownMenu.classList.remove("show");
                            if (ecommerceArrow) ecommerceArrow.classList.remove("rotate");
                        }
                    });
                }
            }

            function setupAllDropdowns() {
                setupInventoryDropdown();
                setupFinanceDropdown();
                setupEcommerceDropdown();
            }

            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', setupAllDropdowns);
            } else {
                setupAllDropdowns();
            }

            // Dark mode toggle functionality
            const darkToggle = document.getElementById('darkToggle');
            const darkIcon = document.querySelector('#darkToggle svg');

            function setDarkMode(isDark) {
                if (isDark) {
                    document.body.classList.add('dark-mode');
                    localStorage.setItem('dark-mode', '1');
                    darkIcon.innerHTML = '<path d="M12 3c-4.97 0-9 4.03-9 9s4.03 9 9 9 9-4.03 9-9c0-.46-.04-.92-.1-1.36-.98 1.37-2.58 2.26-4.4 2.26-2.98 0-5.4-2.42-5.4-5.4 0-1.81.89-3.42 2.26-4.4-.44-.06-.9-.1-1.36-.1z" />';
                } else {
                    document.body.classList.remove('dark-mode');
                    localStorage.setItem('dark-mode', '0');
                    darkIcon.innerHTML = '<path d="M12 2a1 1 0 0 1 1 1v1a1 1 0 1 1-2 0V3a1 1 0 0 1 1-1zm5.657 3.343a1 1 0 0 1 1.414 0l.707.707a1 1 0 1 1-1.414 1.414l-.707-.707a1 1 0 0 1 0-1.414zM21 11a1 1 0 1 1 0 2h-1a1 1 0 1 1 0-2h1zm-2.929 7.071a1 1 0 0 1 0 1.414l-.707.707a1 1 0 1 1-1.414-1.414l.707-.707a1 1 0 0 1 1.414 0zM12 20a1 1 0 0 1-1-1v-1a1 1 0 1 1 2 0v1a1 1 0 0 1-1 1zm-7.071-2.929a1 1 0 0 1-1.414 0l-.707-.707a1 1 0 1 1 1.414-1.414l.707.707a1 1 0 0 1 0 1.414zM4 13a1 1 0 1 1 0-2H3a1 1 0 1 1 0 2h1zm2.343-7.657a1 1 0 0 1 0 1.414l-.707.707A1 1 0 1 1 4.222 6.05l.707-.707a1 1 0 0 1 1.414 0zM12 6a6 6 0 1 1 0 12A6 6 0 0 1 12 6z" />';
                }
            }

            darkToggle.addEventListener('click', () => {
                setDarkMode(!document.body.classList.contains('dark-mode'));
            });

            // Action button event listeners (delegated)
            document.addEventListener('click', (e) => {
                if (e.target.classList.contains('edit-customer-btn')) {
                    const customerId = e.target.getAttribute('data-customer-id');
                    editCustomer(customerId);
                } else if (e.target.classList.contains('delete-customer-btn')) {
                    const customerId = e.target.getAttribute('data-customer-id');
                    deleteCustomer(customerId);
                } else if (e.target.closest('tr[data-customer-id]')) {
                    // Handle row click for customer details
                    const row = e.target.closest('tr[data-customer-id]');
                    const customerId = row.getAttribute('data-customer-id');
                    viewCustomer(customerId);
                }
            });
        }); // Close DOMContentLoaded event listener

        // Active Page Highlighting and Dropdown Management
        function highlightActivePage() {
            // Remove all active classes first
            document.querySelectorAll('.sidebar-link').forEach(link => {
                link.classList.remove('active');
            });

            // Get current page path
            const currentPath = window.location.pathname;
            const currentPageName = window.location.pathname.split('/').pop().replace('.html', '');

            console.log('Current path:', currentPath);
            console.log('Current page name:', currentPageName);

            // OTHER LINKS - Handle all other links
            const sidebarLinks = document.querySelectorAll('.sidebar-link');
            let foundMatch = false;

            // DASHBOARD LINK - Handle separately and FIRST
            const dashboardLink = document.querySelector('a[href="/dashboard"]');
            if (dashboardLink) {
                console.log('🔍 Checking Dashboard link for path:', currentPath);
                console.log('🔍 Current path details:', {
                    path: currentPath,
                    endsWithIndex: currentPath.endsWith('index.html'),
                    includesPages: currentPath.includes('pages'),
                    isRoot: currentPath === '/',
                    isDashboard: currentPath === '/dashboard'
                });

                // Dashboard should ONLY be active on dashboard page
                const isDashboardPage = (
                    currentPath === '/' ||
                    currentPath === '/dashboard' ||
                    currentPath === '/dashboard/' ||
                    currentPath.endsWith('/dashboard/index.html') ||
                    currentPath.endsWith('/index.html') ||
                    (currentPath.includes('index.html') && !currentPath.includes('pages')) ||
                    currentPath.startsWith('/dashboard') && !currentPath.includes('/pages')
                );

                if (isDashboardPage) {
                    dashboardLink.classList.add('active');
                    foundMatch = true;
                    console.log('✅ Dashboard page detected and highlighted for path:', currentPath);
                } else {
                    dashboardLink.classList.remove('active');
                    console.log('❌ Dashboard link NOT highlighted for path:', currentPath);
                }
            }

            // OTHER LINKS - Handle all other links
            sidebarLinks.forEach(link => {
                const href = link.getAttribute('href');
                if (!href || href === '#') return;

                // Skip Dashboard link - already handled above
                if (href === '/dashboard') return;

                // COMPLETELY DISABLE Dashboard highlighting on non-dashboard pages
                if (href === '/dashboard') {
                    // Dashboard should NEVER be highlighted on non-dashboard pages
                    console.log('Dashboard link found but NOT highlighting on non-dashboard page');
                    return; // Skip this link completely
                }

                // Handle other links with normal matching
                else {
                    // Check if current path matches this specific link
                    if (currentPath === href || currentPath.endsWith(href.replace('/dashboard', ''))) {
                        link.classList.add('active');
                        foundMatch = true;
                        console.log('Exact match found:', href);
                    }
                    // Check page name matching for other links
                    else if (!foundMatch) {
                        const linkPageName = href.split('/').pop().replace('.html', '');
                        if (currentPageName === linkPageName ||
                            (currentPageName && currentPageName.toLowerCase().includes(linkPageName.toLowerCase())) ||
                            (linkPageName && linkPageName.toLowerCase().includes(currentPageName.toLowerCase()))) {
                            link.classList.add('active');
                            foundMatch = true;
                            console.log('Page name match found:', href, 'for page:', currentPageName);
                        }
                    }
                }
            });

            // Special cases for specific pages with dropdown management
            if (currentPath.includes('collections') || currentPageName === 'collections') {
                const collectionsLink = document.querySelector('a[href*="collections"]');
                if (collectionsLink) {
                    collectionsLink.classList.add('active');
                    foundMatch = true;
                    console.log('Collections page detected');

                    // Keep inventory dropdown open
                    const inventoryDropdown = document.getElementById('inventory-submenu');
                    const inventoryArrow = document.getElementById('inventory-arrow');
                    if (inventoryDropdown && inventoryArrow) {
                        inventoryDropdown.classList.remove('hidden');
                        inventoryArrow.style.transform = 'rotate(180deg)';
                        console.log('Inventory dropdown kept open for collections');
                    }
                }
            }

            if (currentPath.includes('products') || currentPageName === 'products') {
                const productsLink = document.querySelector('a[href*="products"]');
                if (productsLink) {
                    productsLink.classList.add('active');
                    foundMatch = true;
                    console.log('Products page detected');

                    // Keep inventory dropdown open
                    const inventoryDropdown = document.getElementById('inventory-submenu');
                    const inventoryArrow = document.getElementById('inventory-arrow');
                    if (inventoryDropdown && inventoryArrow) {
                        inventoryDropdown.classList.remove('hidden');
                        inventoryArrow.style.transform = 'rotate(180deg)';
                        console.log('Inventory dropdown kept open for products');
                    }
                }
            }

            if (currentPath.includes('low-stock') || currentPageName === 'low-stock') {
                const lowStockLink = document.querySelector('a[href*="low-stock"]');
                if (lowStockLink) {
                    lowStockLink.classList.add('active');
                    foundMatch = true;
                    console.log('Low Stock page detected');

                    // Keep inventory dropdown open
                    const inventoryDropdown = document.getElementById('inventory-submenu');
                    const inventoryArrow = document.getElementById('inventory-arrow');
                    if (inventoryDropdown && inventoryArrow) {
                        inventoryDropdown.classList.remove('hidden');
                        inventoryArrow.style.transform = 'rotate(180deg)';
                        console.log('Inventory dropdown kept open for low-stock');
                    }
                }
            }

            if (currentPath.includes('product-reviews') || currentPageName === 'reviews') {
                const reviewsLink = document.querySelector('a[href*="product-reviews"]');
                if (reviewsLink) {
                    reviewsLink.classList.add('active');
                    foundMatch = true;
                    console.log('Reviews page detected');

                    // Keep inventory dropdown open
                    const inventoryDropdown = document.getElementById('inventory-submenu');
                    const inventoryArrow = document.getElementById('inventory-arrow');
                    if (inventoryDropdown && inventoryArrow) {
                        inventoryDropdown.classList.remove('hidden');
                        inventoryArrow.style.transform = 'rotate(180deg)';
                        console.log('Inventory dropdown kept open for reviews');
                    }
                }
            }

            if (currentPath.includes('orders') || currentPageName === 'orders') {
                const ordersLink = document.querySelector('a[href*="orders"]');
                if (ordersLink) {
                    ordersLink.classList.add('active');
                    foundMatch = true;
                    console.log('Orders page detected');
                }
            }

            if (currentPath.includes('Customer') || currentPageName === 'Customer') {
                const customerLink = document.querySelector('a[href*="Customer"]');
                if (customerLink) {
                    customerLink.classList.add('active');
                    foundMatch = true;
                    console.log('Customer page detected');
                }
            }

            if (currentPath.includes('Admin') || currentPageName === 'Admin') {
                const adminLink = document.querySelector('a[href*="Admin"]');
                if (adminLink) {
                    adminLink.classList.add('active');
                    foundMatch = true;
                    console.log('Admin page detected');
                }
            }

            if (currentPath.includes('settings') || currentPageName === 'settings') {
                const settingsLink = document.querySelector('a[href*="settings"]');
                if (settingsLink) {
                    settingsLink.classList.add('active');
                    foundMatch = true;
                    console.log('Settings page detected');
                }
            }

            if (currentPath.includes('finance') || currentPageName === 'finance') {
                const financeLink = document.querySelector('a[href*="finance"]');
                if (financeLink) {
                    financeLink.classList.add('active');
                    foundMatch = true;
                    console.log('Finance page detected');

                    // Keep finance dropdown open
                    const financeDropdown = document.getElementById('finance-dropdown-menu');
                    const financeArrow = document.querySelector('#finance-dropdown-btn .dropdown-arrow');
                    if (financeDropdown && financeArrow) {
                        financeDropdown.classList.remove('hidden');
                        financeDropdown.classList.add('show');
                        financeArrow.classList.add('rotated');
                        console.log('Finance dropdown kept open for finance page');
                    }
                }
            }

            if (currentPath.includes('analytics') || currentPageName === 'analytics') {
                const analyticsLink = document.querySelector('a[href*="analytics"]');
                if (analyticsLink) {
                    analyticsLink.classList.add('active');
                    foundMatch = true;
                    console.log('Analytics page detected');

                    // Keep finance dropdown open
                    const financeDropdown = document.getElementById('finance-dropdown-menu');
                    const financeArrow = document.querySelector('#finance-dropdown-btn .dropdown-arrow');
                    if (financeDropdown && financeArrow) {
                        financeDropdown.classList.remove('hidden');
                        financeDropdown.classList.add('show');
                        financeArrow.classList.add('rotated');
                        console.log('Finance dropdown kept open for analytics');
                    }
                }
            }

            if (currentPath.includes('reports') || currentPageName === 'reports') {
                const reportsLink = document.querySelector('a[href*="reports"]');
                if (reportsLink) {
                    reportsLink.classList.add('active');
                    foundMatch = true;
                    console.log('Reports page detected');

                    // Keep finance dropdown open
                    const financeDropdown = document.getElementById('finance-dropdown-menu');
                    const financeArrow = document.querySelector('#finance-dropdown-btn .dropdown-arrow');
                    if (financeDropdown && financeArrow) {
                        financeDropdown.classList.remove('hidden');
                        financeDropdown.classList.add('show');
                        financeArrow.classList.add('rotated');
                        console.log('Finance dropdown kept open for reports');
                    }
                }
            }

            if (currentPath.includes('insights') || currentPageName === 'insights') {
                const insightsLink = document.querySelector('a[href*="insights"]');
                if (insightsLink) {
                    insightsLink.classList.add('active');
                    foundMatch = true;
                    console.log('Insights page detected');

                    // Keep finance dropdown open
                    const financeDropdown = document.getElementById('finance-dropdown-menu');
                    const financeArrow = document.querySelector('#finance-dropdown-btn .dropdown-arrow');
                    if (financeDropdown && financeArrow) {
                        financeDropdown.classList.remove('hidden');
                        financeDropdown.classList.add('show');
                        financeArrow.classList.add('rotated');
                        console.log('Finance dropdown kept open for insights');
                    }
                }
            }

            if (currentPath.includes('expenses') || currentPageName === 'expenses') {
                const expensesLink = document.querySelector('a[href*="expenses"]');
                if (expensesLink) {
                    expensesLink.classList.add('active');
                    foundMatch = true;
                    console.log('Expenses page detected');

                    // Keep finance dropdown open
                    const financeDropdown = document.getElementById('finance-dropdown-menu');
                    const financeArrow = document.querySelector('#finance-dropdown-btn .dropdown-arrow');
                    if (financeDropdown && financeArrow) {
                        financeDropdown.classList.remove('hidden');
                        financeDropdown.classList.add('show');
                        financeArrow.classList.add('rotated');
                        console.log('Finance dropdown kept open for expenses');
                    }
                }
            }

            if (currentPath.includes('pos') || currentPageName === 'pos') {
                const posLink = document.querySelector('a[href*="pos"]');
                if (posLink) {
                    posLink.classList.add('active');
                    foundMatch = true;
                    console.log('POS page detected');
                }
            }
        }

        // Run on page load
        document.addEventListener('DOMContentLoaded', highlightActivePage);

        // Also run when navigation changes (for SPA-like behavior)
        window.addEventListener('popstate', highlightActivePage);

    </script>
</body>
<script src="/js/sidebar.js"></script>

</html>