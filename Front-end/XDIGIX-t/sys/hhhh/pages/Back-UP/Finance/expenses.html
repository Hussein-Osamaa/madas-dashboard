<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Expenses - MADAS Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    }

    // Close sidebar when clicking outside on mobile
    document.addEventListener('click', (e) => {
    if (window.innerWidth < 1024 && !sidebar.contains(e.target) && !toggleBtn.contains(e.target)) {
        sidebar.classList.add('-translate-x-full'); } }); </script>

        <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
        <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
            rel="stylesheet">
        <link rel="icon" type="image/x-icon" href="/assets/img/madas-logo.png">
        <!-- Firebase Permission Checker -->
        <script type="module" src="../../js/firebase-permission-check.js"></script>
        <style>
            :root {
                --madas-primary: #27491F;
                --madas-dark: #F0CAE1;
                --madas-light: #F4F4F4;
                --madas-accent: #FFD300;
                --bg-main: #F4F4F4;
                --text-main: #1F2937;
                --text-secondary: #6B7280;
                --card-bg: #FFFFFF;
                --card-border: #E5E7EB;
                --sidebar-bg: #FFFFFF;
                --header-bg: #FFFFFF;
            }

            body {
                font-family: 'Inter', sans-serif;
                background: var(--bg-main) !important;
                color: var(--text-main) !important;
                transition: background 0.5s, color 0.5s;
            }

            /* Dark mode styles */
            body.dark-mode {
                --madas-primary: #FFD700;
                --madas-dark: #232946;
                --madas-light: #181825;
                --madas-accent: #7209b7;
                --bg-main: #181825;
                --text-main: #F8F8F2;
                --text-secondary: #A8A8A8;
                --card-bg: #232946;
                --card-border: #2D3748;
                --sidebar-bg: #232946;
                --header-bg: #232946;
                background: var(--bg-main);
                color: var(--text-main);
            }

            /* ============================================
           ENHANCED ANIMATIONS & TRANSITIONS
           ============================================ */

            @keyframes fadeInUp {
                from {
                    opacity: 0;
                    transform: translateY(20px);
                }

                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            @keyframes fadeInScale {
                from {
                    opacity: 0;
                    transform: scale(0.95);
                }

                to {
                    opacity: 1;
                    transform: scale(1);
                }
            }

            @keyframes slideInRight {
                from {
                    opacity: 0;
                    transform: translateX(20px);
                }

                to {
                    opacity: 1;
                    transform: translateX(0);
                }
            }

            @keyframes pulse {

                0%,
                100% {
                    opacity: 1;
                }

                50% {
                    opacity: 0.5;
                }
            }

            @keyframes shimmer {
                0% {
                    background-position: -1000px 0;
                }

                100% {
                    background-position: 1000px 0;
                }
            }

            /* Smooth page entrance */
            .page-enter {
                animation: fadeInUp 0.6s ease-out;
            }

            /* Enhanced card hover effects */
            .enhanced-card {
                transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
                position: relative;
                overflow: hidden;
            }

            .enhanced-card::before {
                content: '';
                position: absolute;
                top: 0;
                left: -100%;
                width: 100%;
                height: 100%;
                background: linear-gradient(90deg,
                        transparent,
                        rgba(255, 255, 255, 0.2),
                        transparent);
                transition: left 0.5s;
            }

            .enhanced-card:hover::before {
                left: 100%;
            }

            .enhanced-card:hover {
                transform: translateY(-8px);
                box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
            }

            /* Gradient backgrounds for stat cards */
            .stat-card-gradient {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            }

            .stat-card-gradient-green {
                background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            }

            .stat-card-gradient-blue {
                background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            }

            .stat-card-gradient-orange {
                background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            }

            .stat-card-gradient-purple {
                background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            }

            .stat-card-gradient-yellow {
                background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            }

            .stat-card-gradient-pink {
                background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            }

            /* Modern button with gradient */
            .btn-gradient {
                background: linear-gradient(135deg, var(--madas-primary) 0%, #1f3c19 100%);
                transition: all 0.3s ease;
                position: relative;
                overflow: hidden;
            }

            .btn-gradient::before {
                content: '';
                position: absolute;
                top: 0;
                left: -100%;
                width: 100%;
                height: 100%;
                background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
                transition: left 0.5s;
            }

            .btn-gradient:hover::before {
                left: 100%;
            }

            .btn-gradient:hover {
                transform: translateY(-2px);
                box-shadow: 0 10px 30px rgba(39, 73, 31, 0.4);
            }

            .btn-gradient:active {
                transform: translateY(0);
            }

            /* Enhanced table row */
            .table-row-enhanced {
                transition: all 0.3s ease;
                position: relative;
            }

            .table-row-enhanced:hover {
                transform: translateX(4px);
                box-shadow: -4px 0 0 var(--madas-accent);
            }

            /* Loading skeleton with shimmer effect */
            .skeleton {
                background: linear-gradient(90deg,
                        #f0f0f0 25%,
                        #e0e0e0 50%,
                        #f0f0f0 75%);
                background-size: 200% 100%;
                animation: shimmer 1.5s infinite;
                border-radius: 0.25rem;
            }

            /* Dark mode skeleton */
            body.dark-mode .skeleton {
                background: linear-gradient(90deg,
                        #2d3748 25%,
                        #4a5568 50%,
                        #2d3748 75%);
                background-size: 200% 100%;
                animation: shimmer 1.5s infinite;
            }

            /* Enhanced skeleton variants for different sizes */
            .skeleton-circle {
                border-radius: 50% !important;
            }

            .skeleton-text {
                height: 1rem;
                border-radius: 0.25rem;
            }

            .skeleton-title {
                height: 1.5rem;
                border-radius: 0.25rem;
            }

            .skeleton-button {
                height: 2rem;
                border-radius: 0.5rem;
            }

            .skeleton-badge {
                height: 1.5rem;
                border-radius: 9999px;
            }

            /* Enhanced input focus */
            .input-enhanced {
                transition: all 0.3s ease;
            }

            .input-enhanced:focus {
                transform: translateY(-2px);
                box-shadow: 0 8px 20px rgba(255, 215, 0, 0.15);
            }

            /* Badge with animation */
            .badge-animated {
                animation: fadeInScale 0.3s ease-out;
                transition: all 0.3s ease;
            }

            .badge-animated:hover {
                transform: scale(1.1);
            }

            /* Icon animations */
            .icon-spin {
                animation: spin 2s linear infinite;
            }

            @keyframes spin {
                from {
                    transform: rotate(0deg);
                }

                to {
                    transform: rotate(360deg);
                }
            }

            /* Enhanced modal */
            .modal-enhanced {
                animation: fadeInScale 0.3s ease-out;
            }

            /* Progress bar */
            .progress-bar {
                position: relative;
                overflow: hidden;
            }

            .progress-bar::after {
                content: '';
                position: absolute;
                top: 0;
                left: -100%;
                width: 100%;
                height: 100%;
                background: linear-gradient(90deg,
                        transparent,
                        rgba(255, 255, 255, 0.3),
                        transparent);
                animation: shimmer 2s infinite;
            }

            /* Stagger animation for list items */
            .stagger-item {
                animation: fadeInUp 0.6s ease-out;
                animation-fill-mode: both;
            }

            .stagger-item:nth-child(1) {
                animation-delay: 0.1s;
            }

            .stagger-item:nth-child(2) {
                animation-delay: 0.2s;
            }

            .stagger-item:nth-child(3) {
                animation-delay: 0.3s;
            }

            .stagger-item:nth-child(4) {
                animation-delay: 0.4s;
            }

            .stagger-item:nth-child(5) {
                animation-delay: 0.5s;
            }

            /* Dark mode toggle styling */
            .dark-toggle {
                background: var(--madas-accent);
                border: 2px solid var(--madas-primary);
                border-radius: 50%;
                width: 40px;
                height: 40px;
                display: flex;
                align-items: center;
                justify-content: center;
                cursor: pointer;
                transition: all 0.3s ease;
            }

            .dark-toggle svg {
                width: 20px;
                height: 20px;
                fill: var(--madas-primary);
                transition: fill 0.3s;
            }

            .dark-toggle:hover {
                transform: scale(1.1) rotate(15deg);
                box-shadow: 0 4px 12px rgba(255, 215, 0, 0.4);
            }

            .dark-toggle:active {
                transform: scale(0.95);
            }

            /* Transition all elements */
            * {
                transition: background-color 0.5s, color 0.5s, border-color 0.5s;
            }

            /* Override specific backgrounds */
            .bg-white {
                background-color: var(--card-bg) !important;
            }

            .bg-gray-50 {
                background-color: var(--bg-main) !important;
            }

            .text-gray-900 {
                color: var(--text-main) !important;
            }

            .text-gray-600 {
                color: var(--text-secondary) !important;
            }

            .text-gray-500 {
                color: var(--text-secondary) !important;
            }

            .border-gray-100 {
                border-color: var(--card-border) !important;
            }

            .bg-gray-50 {
                background-color: var(--bg-main) !important;
            }

            .bg-gray-100 {
                background-color: var(--card-bg) !important;
            }

            /* Sidebar and header */
            #sidebar {
                background-color: var(--sidebar-bg) !important;
            }

            .bg-white {
                background-color: var(--card-bg) !important;
            }

            .dark-mode header {
                background-color: var(--header-bg) !important;
                border-color: var(--card-border) !important;
            }

            .dark-mode aside {
                background-color: var(--sidebar-bg) !important;
            }

            .dark-mode .bg-white {
                background-color: var(--card-bg) !important;
            }

            .dark-mode .text-gray-900 {
                color: var(--text-main) !important;
            }

            .dark-mode .text-gray-600 {
                color: var(--text-secondary) !important;
            }

            .dark-mode .text-gray-500 {
                color: var(--text-secondary) !important;
            }

            .dark-mode .border-gray-200 {
                border-color: var(--card-border) !important;
            }

            .dark-mode .border-gray-100 {
                border-color: var(--card-border) !important;
            }

            .dark-mode .bg-gray-50 {
                background-color: var(--bg-main) !important;
            }

            .dark-mode .bg-gray-100 {
                background-color: var(--card-bg) !important;
            }

            .dark-mode .hover\:bg-gray-100:hover {
                background-color: var(--card-bg) !important;
            }

            .dark-mode .shadow-sm {
                box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.3) !important;
            }

            .dark-mode .divide-gray-200 {
                border-color: var(--card-border) !important;
            }

            .dark-mode .bg-gray-50 {
                background-color: var(--card-bg) !important;
            }

            main {
                background-color: var(--bg-main) !important;
            }

            .bg-gray-50 {
                background-color: var(--bg-main) !important;
            }

            /* Table header styling */
            thead {
                background-color: var(--card-bg) !important;
            }

            /* Enhanced Sidebar Link Styles */
            .sidebar-link {
                position: relative;
                transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                overflow: hidden;
            }

            /* Override Tailwind text color classes */
            .sidebar-link.text-gray-700,
            .sidebar-link.text-gray-600 {
                color: var(--text-main) !important;
            }

            body.dark-mode .sidebar-link.text-gray-700,
            body.dark-mode .sidebar-link.text-gray-600 {
                color: var(--text-main) !important;
            }



            .sidebar-link:hover {
                transform: translateX(6px) scale(1.02);
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
                background: var(--madas-light);
            }

            .sidebar-link:active {
                transform: translateX(3px) scale(0.98);
                transition: all 0.1s ease;
            }.finance-dropdown-menu.show {
                display: block;
                animation: slideDown 0.3s ease;
                background: white !important;
                border: 1px solid #e5e7eb !important;
                border-radius: 8px !important;
                box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06) !important;
                margin: 8px 0 !important;
                padding: 8px 0 !important;
            }

            .card-hover {
                transition: all 0.3s ease;
            }

            .card-hover:hover {
                transform: translateY(-2px);
                box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            }

            .gradient-bg {
                background: linear-gradient(135deg, var(--madas-primary), #1f3c19);
            }

            .stat-card {
                position: relative;
                overflow: hidden;
            }

            .stat-card::before {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                height: 4px;
                background: linear-gradient(135deg, var(--madas-primary), var(--madas-accent));
            }

            /* Input fields and form elements */
            input[type="text"],
            input[type="number"],
            input[type="email"],
            input[type="password"],
            input[type="date"],
            textarea,
            select {
                background-color: var(--card-bg) !important;
                color: var(--text-main) !important;
                border-color: var(--card-border) !important;
                border-width: 1px !important;
                border-style: solid !important;
            }

            input[type="text"]:focus,
            input[type="number"]:focus,
            input[type="email"]:focus,
            input[type="password"]:focus,
            input[type="date"]:focus,
            textarea:focus,
            select:focus {
                border-color: var(--madas-accent) !important;
                box-shadow: 0 0 0 2px rgba(255, 215, 0, 0.2) !important;
                outline: none !important;
            }

            input[type="text"]::placeholder,
            input[type="number"]::placeholder,
            input[type="email"]::placeholder,
            input[type="password"]::placeholder,
            textarea::placeholder {
                color: var(--text-secondary) !important;
            }

            input[type="date"] {
                background-color: var(--card-bg) !important;
                color: var(--text-main) !important;
                border-color: var(--card-border) !important;
            }

            input[type="date"]::-webkit-calendar-picker-indicator {
                filter: var(--text-main) !important;
                opacity: 0.7;
            }

            input[type="date"]::-webkit-calendar-picker-indicator:hover {
                opacity: 1;
            }

            /* Search bar specific styling */
            input[type="search"] {
                background-color: var(--card-bg) !important;
                color: var(--text-main) !important;
                border-color: var(--card-border) !important;
            }

            input[type="search"]:focus {
                border-color: var(--madas-accent) !important;
                box-shadow: 0 0 0 2px rgba(255, 215, 0, 0.2) !important;
            }

            input[type="search"]::placeholder {
                color: var(--text-secondary) !important;
            }

            /* Select dropdowns */
            select {
                background-color: var(--card-bg) !important;
                color: var(--text-main) !important;
                border-color: var(--card-border) !important;
            }

            select:focus {
                border-color: var(--madas-accent) !important;
                box-shadow: 0 0 0 2px rgba(255, 215, 0, 0.2) !important;
            }

            /* Modal styling */
            .modal,
            .modal .bg-white,
            .glass-effect {
                background-color: var(--card-bg) !important;
            }

            /* Modal overlay */
            #expenseModal {
                background-color: rgba(0, 0, 0, 0.5) !important;
            }

            /* Form labels */
            label {
                color: var(--text-main) !important;
            }

            /* Readonly inputs */
            input[readonly] {
                background-color: var(--bg-main) !important;
                color: var(--text-secondary) !important;
            }

            /* Checkbox styling */
            input[type="checkbox"] {
                background-color: var(--card-bg) !important;
                border-color: var(--card-border) !important;
            }

            input[type="checkbox"]:checked {
                background-color: var(--madas-accent) !important;
                border-color: var(--madas-accent) !important;
            }

            /* Unified Dropdown Menu Styling - No 3D Effects */
            .inventory-submenu,
            .finance-dropdown-menu,
            .ecommerce-dropdown-menu {
                background: transparent !important;
                border: none !important;
                border-radius: 0 !important;
                box-shadow: none !important;
                margin: 0 !important;
                padding: 0 !important;
            }

            /* Unified Dropdown Items - Same as Main Navigation */
            .inventory-submenu .sidebar-link,
            .finance-dropdown-menu .sidebar-link,
            .ecommerce-dropdown-menu .sidebar-link {
                padding: 10px 14px !important;
                margin: 0 !important;
                border-radius: 0 !important;
                transition: all 0.2s ease !important;
            }

            .inventory-submenu .sidebar-link:hover,
            .finance-dropdown-menu .sidebar-link:hover,
            .ecommerce-dropdown-menu .sidebar-link:hover {
                background: var(--madas-light) !important;
                color: var(--madas-primary) !important;
            }

            /* Ensure dropdown hover maintains color in dark mode */
            body.dark-mode .inventory-submenu .sidebar-link:hover,
            body.dark-mode .finance-dropdown-menu .sidebar-link:hover,
            body.dark-mode .ecommerce-dropdown-menu .sidebar-link:hover {
                color: var(--madas-primary) !important;
            }


            /* Ensure all dropdown text sizes are uniform */
            .inventory-submenu .sidebar-link span,
            .finance-dropdown-menu .sidebar-link span,
            .ecommerce-dropdown-menu .sidebar-link span {
                font-size: 0.8rem !important;
            }

            /* Make dropdown icons smaller */
            .inventory-submenu .material-icons,
            .finance-dropdown-menu .material-icons,
            .ecommerce-dropdown-menu .material-icons {
                font-size: 18px !important;
            }

            /* Unified Dropdown Items Active State - EXACT Same as Main Navigation */
            .inventory-submenu .sidebar-link.active,
            .finance-dropdown-menu .sidebar-link.active,
            .ecommerce-dropdown-menu .sidebar-link.active {
                background: var(--madas-light) !important;
                color: var(--madas-primary) !important;
                font-weight: 600 !important;
            }

            .inventory-submenu .sidebar-link.active .material-icons,
            .finance-dropdown-menu .sidebar-link.active .material-icons,
            .ecommerce-dropdown-menu .sidebar-link.active .material-icons {
                color: var(--madas-primary) !important;
            }

            /* Unified Dropdown Button Styling */
            .inventory-dropdown button,
            .finance-dropdown button,
            .ecommerce-dropdown button {
                background: transparent !important;
                border: none !important;
                padding: 10px 14px !important;
                border-radius: 8px !important;
                transition: all 0.2s ease !important;
                width: 100% !important;
                text-align: left !important;
            }

            .inventory-dropdown button:hover,
            .finance-dropdown button:hover,
            .ecommerce-dropdown button:hover {
                background: var(--madas-light) !important;
            }

            /* Unified Dropdown Arrow */
            .dropdown-arrow {
                transition: transform 0.2s ease !important;
            }

            .dropdown-arrow.rotate {
                transform: rotate(180deg) !important;
            }

            /* Unified Visible States for Dropdowns - No 3D Effects */
            .inventory-submenu:not(.hidden) {
                opacity: 1 !important;
                transform: translateY(0) !important;
                pointer-events: auto !important;
                background: transparent !important;
                border: none !important;
                border-radius: 0 !important;
                box-shadow: none !important;
                margin: 0 !important;
                padding: 0 !important;
            }

            .finance-dropdown-menu.show {
                display: block !important;
                animation: slideDown 0.3s ease !important;
                background: transparent !important;
                border: none !important;
                border-radius: 0 !important;
                box-shadow: none !important;
                margin: 0 !important;
                padding: 0 !important;
            }

            .ecommerce-dropdown-menu.show {
                display: block !important;
                animation: slideDown 0.3s ease !important;
                background: transparent !important;
                border: none !important;
                border-radius: 0 !important;
                box-shadow: none !important;
                margin: 0 !important;
                padding: 0 !important;
            }
        </style>

        <script>
            // JavaScript code will be added here
        </script>
</head>

<body class="font-sans">
    <!-- Header -->
    <!-- Header -->
    <header class="bg-white shadow-sm border-b border-gray-200 fixed top-0 left-0 right-0 z-40 h-16">
        <div class="flex items-center justify-between h-full px-4 lg:px-6">
            <div class="flex items-center space-x-4">
                <button id="menu-toggle" class="lg:hidden text-[var(--madas-primary)] p-2 rounded-lg hover:bg-gray-100">
                    <span class="material-icons">menu</span>
                </button>
                <div class="flex items-center space-x-3">
                    <div class="w-8 h-8 bg-[var(--madas-primary)] rounded-lg flex items-center justify-center">
                        <span class="text-white font-bold text-sm">M</span>
                    </div>
                    <div>
                        <h1 id="business-name" class="text-xl font-bold text-[var(--madas-primary)]">Loading...</h1>
                        <button id="plan-badge" onclick="window.location.href='/pages/settings.html#plans'"
                            class="text-xs px-2 py-0.5 rounded-full bg-blue-100 text-blue-800 hover:bg-blue-200 transition-colors cursor-pointer">
                            Loading Plan...
                        </button>
                    </div>
                </div>
            </div>

            <div class="flex items-center space-x-4">
                <div class="hidden md:flex items-center space-x-2 text-sm text-gray-600">
                    <span class="material-icons text-[var(--madas-primary)]">notifications</span>
                    <span class="bg-red-500 text-white text-xs rounded-full px-2 py-1">3</span>
                </div>
                <div class="flex items-center space-x-3">
                    <!-- Dark mode toggle button -->
                    <button class="dark-toggle" id="darkToggle" title="Toggle dark mode">
                        <svg id="darkToggleIcon" viewBox="0 0 24 24">
                            <path
                                d="M12 2a1 1 0 0 1 1 1v1a1 1 0 1 1-2 0V3a1 1 0 0 1 1-1zm5.657 3.343a1 1 0 0 1 1.414 0l.707.707a1 1 0 1 1-1.414 1.414l-.707-.707a1 1 0 0 1 0-1.414zM21 11a1 1 0 1 1 0 2h-1a1 1 0 1 1 0-2h1zm-2.929 7.071a1 1 0 0 1 0 1.414l-.707.707a1 1 0 1 1-1.414-1.414l.707-.707a1 1 0 0 1 1.414 0zM12 20a1 1 0 0 1-1-1v-1a1 1 0 1 1 2 0v1a1 1 0 0 1-1 1zm-7.071-2.929a1 1 0 0 1-1.414 0l-.707-.707a1 1 0 1 1 1.414-1.414l.707.707a1 1 0 0 1 0 1.414zM4 13a1 1 0 1 1 0-2H3a1 1 0 1 1 0 2h1zm2.343-7.657a1 1 0 0 1 0 1.414l-.707.707A1 1 0 1 1 4.222 6.05l.707-.707a1 1 0 0 1 1.414 0zM12 6a6 6 0 1 1 0 12A6 6 0 0 1 12 6z" />
                        </svg>
                    </button>
                    <div class="hidden md:block text-right">
                        <p id="user-name" class="text-sm font-medium text-gray-900">Loading...</p>
                        <p id="user-email" class="text-xs text-gray-500">loading@example.com</p>
                    </div>
                    <button id="profile-btn"
                        class="w-8 h-8 bg-[var(--madas-accent)] rounded-full flex items-center justify-center hover:bg-yellow-400 transition-colors cursor-pointer">
                        <span class="text-[var(--madas-primary)] font-bold text-sm" id="user-initial">U</span>
                    </button>
                    <button id="logout-btn"
                        class="text-gray-500 hover:text-[var(--madas-primary)] p-2 rounded-lg hover:bg-gray-100">
                        <span class="material-icons">logout</span>
                    </button>
                </div>
            </div>
        </div>
    </header>
    <div class="flex h-screen pt-16">
        <!-- Sidebar -->
        <!-- Sidebar -->
        <aside id="sidebar"
            class="fixed lg:static left-0 top-16 h-full w-64 bg-white shadow-lg lg:shadow-none z-30 transform lg:translate-x-0 -translate-x-full transition-transform duration-300 ease-in-out">
            <div class="flex flex-col h-full">
                <nav class="flex-1 px-4 py-6 space-y-2 overflow-y-auto">
                    <a href="/dashboard"
                        class="sidebar-link flex items-center space-x-3 px-4 py-3 rounded-xl text-gray-700 hover:bg-[var(--madas-light)] hover:text-[var(--madas-primary)] transition-all">
                        <span class="material-icons">dashboard</span>
                        <span>Dashboard</span>
                    </a>
                    <a href="/pages/Orders/orders.html"
                        class="sidebar-link flex items-center space-x-3 px-4 py-3 rounded-xl text-gray-700 hover:bg-[var(--madas-light)] hover:text-[var(--madas-primary)] transition-all">
                        <span class="material-icons">receipt_long</span>
                        <span>Orders</span>
                    </a>
                    <a href="/pages/pos.html"
                        class="sidebar-link flex items-center space-x-3 px-4 py-3 rounded-xl text-gray-700 hover:bg-[var(--madas-light)] hover:text-[var(--madas-primary)] transition-all">
                        <span class="material-icons">point_of_sale</span>
                        <span>POS</span>
                    </a>

                    <!-- Inventory Dropdown -->
                    <div class="inventory-dropdown">
                        <button
                            class="sidebar-link flex items-center justify-between w-full px-4 py-3 rounded-xl text-gray-700 hover:bg-[var(--madas-light)] hover:text-[var(--madas-primary)] transition-all"
                            id="inventory-toggle">
                            <div class="flex items-center space-x-3">
                                <span class="material-icons">inventory_2</span>
                                <span>Inventory</span>
                            </div>
                            <span class="material-icons transition-transform duration-200"
                                id="inventory-arrow">expand_more</span>
                        </button>
                        <div class="inventory-submenu hidden ml-6 mt-2 space-y-1" id="inventory-submenu">
                            <a href="/pages/Inventory/products.html"
                                class="sidebar-link submenu-link flex items-center space-x-3 px-4 py-2 rounded-lg text-gray-600 hover:bg-[var(--madas-light)] hover:text-[var(--madas-primary)] transition-all">
                                <span class="material-icons text-lg">inventory</span>
                                <span>Products</span>
                            </a>
                            <a href="/pages/Inventory/collections.html"
                                class="sidebar-link submenu-link flex items-center space-x-3 px-4 py-2 rounded-lg text-gray-600 hover:bg-[var(--madas-light)] hover:text-[var(--madas-primary)] transition-all">
                                <span class="material-icons text-lg">collections</span>
                                <span>Collections</span>
                            </a>
                            <a href="/pages/Inventory/product-reviews.html"
                                class="sidebar-link submenu-link flex items-center space-x-3 px-4 py-2 rounded-lg text-gray-600 hover:bg-[var(--madas-light)] hover:text-[var(--madas-primary)] transition-all">
                                <span class="material-icons text-lg">rate_review</span>
                                <span>Reviews</span>
                            </a>
                            <a href="/pages/Inventory/low-stock.html"
                                class="sidebar-link submenu-link flex items-center space-x-3 px-4 py-2 rounded-lg text-gray-600 hover:bg-[var(--madas-light)] hover:text-[var(--madas-primary)] transition-all">
                                <span class="material-icons text-lg">warning</span>
                                <span>Low Stock</span>
                            </a>
                        </div>
                    </div>

                    <a href="/pages/Customers/Customer.html"
                        class="sidebar-link flex items-center space-x-3 px-4 py-3 rounded-xl text-gray-700 hover:bg-[var(--madas-light)] hover:text-[var(--madas-primary)] transition-all">
                        <span class="material-icons">group</span>
                        <span>Customers</span>
                    </a>

                    <!-- E-commerce Dropdown -->
                    <div class="ecommerce-dropdown">
                        <button id="ecommerce-dropdown-btn"
                            class="sidebar-link w-full flex items-center justify-between px-4 py-3 rounded-xl text-gray-700 hover:bg-[var(--madas-light)] hover:text-[var(--madas-primary)] transition-all">
                            <div class="flex items-center space-x-3">
                                <span class="material-icons">storefront</span>
                                <span>E-commerce</span>
                            </div>
                            <span class="material-icons dropdown-arrow transition-transform duration-200"
                                id="ecommerce-arrow">expand_more</span>
                        </button>
                        <div id="ecommerce-dropdown-menu" class="ecommerce-dropdown-menu hidden">
                            <a href="/pages/Web-builder/theme-library.html"
                                class="sidebar-link submenu-link flex items-center space-x-3 px-4 py-2 ml-8 text-sm text-gray-600 hover:text-[var(--madas-primary)] hover:bg-[var(--madas-light)] rounded-lg transition-all">
                                <span class="material-icons text-sm">web</span>
                                <span>Website Builder</span>
                            </a>
                            <a href="/pages/shoes-store.html"
                                class="sidebar-link submenu-link flex items-center space-x-3 px-4 py-2 ml-8 text-sm text-gray-600 hover:text-[var(--madas-primary)] hover:bg-[var(--madas-light)] rounded-lg transition-all">
                                <span class="material-icons text-sm">shopping_bag</span>
                                <span>Shoes Store</span>
                            </a>
                            <a href="/pages/advanced/domains.html"
                                class="sidebar-link submenu-link flex items-center space-x-3 px-4 py-2 ml-8 text-sm text-gray-600 hover:text-[var(--madas-primary)] hover:bg-[var(--madas-light)] rounded-lg transition-all">
                                <span class="material-icons text-sm">language</span>
                                <span>Custom Domains</span>
                            </a>
                        </div>
                    </div>

                    <!-- Finance Dropdown -->
                    <div class="finance-dropdown">
                        <button id="finance-dropdown-btn"
                            class="sidebar-link w-full flex items-center justify-between px-4 py-3 rounded-xl text-gray-700 hover:bg-[var(--madas-light)] hover:text-[var(--madas-primary)] transition-all">
                            <div class="flex items-center space-x-3">
                                <span class="material-icons">account_balance_wallet</span>
                                <span>Finance</span>
                            </div>
                            <span
                                class="material-icons dropdown-arrow transition-transform duration-200">expand_more</span>
                        </button>
                        <div id="finance-dropdown-menu" class="finance-dropdown-menu hidden">
                            <a href="/pages/Finance/finance.html"
                                class="sidebar-link submenu-link flex items-center space-x-3 px-4 py-2 ml-8 text-sm text-gray-600 hover:text-[var(--madas-primary)] hover:bg-[var(--madas-light)] rounded-lg transition-all">
                                <span class="material-icons text-sm">account_balance</span>
                                <span>Overview</span>
                            </a>
                            <a href="/pages/Finance/deposit-money-simple.html"
                                class="sidebar-link submenu-link flex items-center space-x-3 px-4 py-2 ml-8 text-sm text-gray-600 hover:text-[var(--madas-primary)] hover:bg-[var(--madas-light)] rounded-lg transition-all">
                                <span class="material-icons text-sm">add_circle</span>
                                <span>Deposits</span>
                            </a>
                            <a href="/pages/Finance/expenses.html"
                                class="sidebar-link submenu-link flex items-center space-x-3 px-4 py-2 ml-8 text-sm text-gray-600 hover:text-[var(--madas-primary)] hover:bg-[var(--madas-light)] rounded-lg transition-all">
                                <span class="material-icons text-sm">receipt</span>
                                <span>Expenses</span>
                            </a>
                            <a href="/pages/Finance/analytics.html"
                                class="sidebar-link submenu-link flex items-center space-x-3 px-4 py-2 ml-8 text-sm text-gray-600 hover:text-[var(--madas-primary)] hover:bg-[var(--madas-light)] rounded-lg transition-all">
                                <span class="material-icons text-sm">analytics</span>
                                <span>Analytics</span>
                            </a>
                            <a href="/pages/Finance/reports.html"
                                class="sidebar-link submenu-link flex items-center space-x-3 px-4 py-2 ml-8 text-sm text-gray-600 hover:text-[var(--madas-primary)] hover:bg-[var(--madas-light)] rounded-lg transition-all">
                                <span class="material-icons text-sm">assessment</span>
                                <span>Reports</span>
                            </a>
                            <a href="/pages/Finance/insights.html"
                                class="sidebar-link submenu-link flex items-center space-x-3 px-4 py-2 ml-8 text-sm text-gray-600 hover:text-[var(--madas-primary)] hover:bg-[var(--madas-light)] rounded-lg transition-all">
                                <span class="material-icons text-sm">lightbulb</span>
                                <span>Insights</span>
                            </a>
                        </div>
                    </div>

                    <a href="/pages/settings/general-settings.html"
                        class="sidebar-link flex items-center space-x-3 px-4 py-3 rounded-xl text-gray-700 hover:bg-[var(--madas-light)] hover:text-[var(--madas-primary)] transition-all">
                        <span class="material-icons">settings</span>
                        <span>Settings</span>
                    </a>
                </nav>

                <div class="p-4 border-t border-gray-200">
                    <div class="bg-[var(--madas-light)] rounded-xl p-4">
                        <h3 class="text-sm font-medium text-[var(--madas-primary)] mb-2">Quick Actions</h3>
                        <div class="space-y-2">
                            <button
                                class="w-full text-left text-xs text-gray-600 hover:text-[var(--madas-primary)] flex items-center space-x-2">
                                <span class="material-icons text-sm">add</span>
                                <span>New Order</span>
                            </button>
                            <button
                                class="w-full text-left text-xs text-gray-600 hover:text-[var(--madas-primary)] flex items-center space-x-2">
                                <span class="material-icons text-sm">add</span>
                                <span>Add Product</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </aside>
        <!-- Main Content -->
        <main class="flex-1 overflow-y-auto">
            <div class="p-6 lg:p-8">
                <div class="mb-8 flex items-center justify-between">
                    <div>
                        <h2 class="text-3xl font-bold text-[var(--madas-primary)] mb-2">Expenses</h2>
                        <p class="text-gray-600">Track and manage all your business expenses</p>
                    </div>
                    <button id="addExpenseBtn"
                        class="btn-gradient text-white px-6 py-3 rounded-lg flex items-center space-x-2 shadow-lg">
                        <span class="material-icons text-sm">add</span>
                        <span>Add Expense</span>
                    </button>
                </div>
                <!-- Time Filter -->
                <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-100 mb-8">
                    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                        <div>
                            <h3 class="text-lg font-semibold text-[var(--madas-primary)] mb-2">Filter Expenses</h3>
                            <p class="text-sm text-gray-600">Select a time period to filter your expenses</p>
                        </div>
                        <div class="flex flex-wrap items-center gap-4">
                            <div class="flex items-center space-x-2">
                                <label class="text-sm font-medium text-gray-700">Time Period:</label>
                                <select id="timeFilter"
                                    class="border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-[var(--madas-accent)] focus:border-[var(--madas-accent)]">
                                    <option value="all">All Time</option>
                                    <option value="today">Today</option>
                                    <option value="week">This Week</option>
                                    <option value="month" selected>This Month</option>
                                    <option value="quarter">This Quarter</option>
                                    <option value="year">This Year</option>
                                    <option value="custom">Custom Range</option>
                                </select>
                            </div>
                            <div id="customDateRange" class="hidden flex items-center space-x-2">
                                <input type="date" id="startDate"
                                    class="border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-[var(--madas-accent)] focus:border-[var(--madas-accent)]">
                                <span class="text-gray-500">to</span>
                                <input type="date" id="endDate"
                                    class="border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-[var(--madas-accent)] focus:border-[var(--madas-accent)]">
                            </div>
                            <button id="applyFilter"
                                class="bg-[var(--madas-primary)] text-white px-4 py-2 rounded-lg hover:bg-[#1f3c19] transition-colors flex items-center space-x-2">
                                <span class="material-icons text-sm">filter_list</span>
                                <span>Apply Filter</span>
                            </button>
                            <button id="clearFilter"
                                class="bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400 transition-colors flex items-center space-x-2">
                                <span class="material-icons text-sm">clear</span>
                                <span>Clear</span>
                            </button>
                        </div>
                    </div>
                </div>
                <!-- Summary Cards -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                    <div class="enhanced-card bg-white rounded-xl p-6 shadow-sm border border-gray-100 stagger-item">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-gray-600">Total Expenses</p>
                                <p id="total-expenses" class="text-2xl font-bold text-[var(--madas-primary)]">$0</p>
                            </div>
                            <div class="w-12 h-12 bg-red-100 rounded-lg flex items-center justify-center">
                                <span class="material-icons text-red-600">money_off</span>
                            </div>
                        </div>
                    </div>
                    <div class="enhanced-card bg-white rounded-xl p-6 shadow-sm border border-gray-100 stagger-item">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-gray-600">Categories</p>
                                <p id="expense-categories" class="text-2xl font-bold text-[var(--madas-primary)]">0</p>
                            </div>
                            <div class="w-12 h-12 bg-yellow-100 rounded-lg flex items-center justify-center">
                                <span class="material-icons text-yellow-600">category</span>
                            </div>
                        </div>
                    </div>
                    <div class="enhanced-card bg-white rounded-xl p-6 shadow-sm border border-gray-100 stagger-item">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-gray-600">This Month</p>
                                <p id="monthly-expenses" class="text-2xl font-bold text-[var(--madas-primary)]">$0</p>
                            </div>
                            <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                                <span class="material-icons text-blue-600">calendar_today</span>
                            </div>
                        </div>
                    </div>
                    <div class="enhanced-card bg-white rounded-xl p-6 shadow-sm border border-gray-100 stagger-item">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-gray-600">Average/Expense</p>
                                <p id="average-expense" class="text-2xl font-bold text-[var(--madas-primary)]">$0</p>
                            </div>
                            <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                                <span class="material-icons text-green-600">analytics</span>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Category Cards Grid -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <!-- Salaries Card -->
                    <div class="card-hover bg-white rounded-xl p-6 shadow-sm border border-green-200 stat-card">
                        <div class="flex items-center justify-between mb-4">
                            <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                                <span class="material-icons text-green-600">payments</span>
                            </div>
                            <div class="text-right">
                                <p class="text-xs text-gray-500">Total</p>
                                <p class="text-sm font-semibold text-green-700">Salaries</p>
                            </div>
                        </div>
                        <div>
                            <p class="text-2xl font-bold text-[var(--madas-primary)]" id="salary-expenses">$0</p>
                            <p class="text-gray-500 text-xs mt-1">Payroll expenses</p>
                        </div>
                    </div>
                    <!-- Personal Expenses Card -->
                    <div class="card-hover bg-white rounded-xl p-6 shadow-sm border border-purple-200 stat-card">
                        <div class="flex items-center justify-between mb-4">
                            <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center">
                                <span class="material-icons text-purple-600">person</span>
                            </div>
                            <div class="text-right">
                                <p class="text-xs text-gray-500">Total</p>
                                <p class="text-sm font-semibold text-purple-700">Personal</p>
                            </div>
                        </div>
                        <div>
                            <p class="text-2xl font-bold text-[var(--madas-primary)]" id="personal-expenses">EGP0</p>
                            <p class="text-gray-500 text-xs mt-1">Personal expenses</p>
                        </div>
                    </div>
                    <!-- Supplies Card -->
                    <div class="card-hover bg-white rounded-xl p-6 shadow-sm border border-yellow-200 stat-card">
                        <div class="flex items-center justify-between mb-4">
                            <div class="w-12 h-12 bg-yellow-100 rounded-lg flex items-center justify-center">
                                <span class="material-icons text-yellow-600">inventory_2</span>
                            </div>
                            <div class="text-right">
                                <p class="text-xs text-gray-500">Total</p>
                                <p class="text-sm font-semibold text-yellow-700">Supplies</p>
                            </div>
                        </div>
                        <div>
                            <p class="text-2xl font-bold text-[var(--madas-primary)]" id="supplies-expenses">EGP0</p>
                            <p class="text-gray-500 text-xs mt-1">Net Supplies (Total - Finance Capital Return)</p>
                        </div>
                    </div>
                    <!-- Marketing Card -->
                    <div class="card-hover bg-white rounded-xl p-6 shadow-sm border border-pink-200 stat-card">
                        <div class="flex items-center justify-between mb-4">
                            <div class="w-12 h-12 bg-pink-100 rounded-lg flex items-center justify-center">
                                <span class="material-icons text-pink-600">campaign</span>
                            </div>
                            <div class="text-right">
                                <p class="text-xs text-gray-500">Total</p>
                                <p class="text-sm font-semibold text-pink-700">Marketing</p>
                            </div>
                        </div>
                        <div>
                            <p class="text-2xl font-bold text-[var(--madas-primary)]" id="marketing-expenses">EGP0</p>
                            <p class="text-gray-500 text-xs mt-1">Marketing expenses</p>
                        </div>
                    </div>
                </div>
                <!-- Search and Quick Actions Bar -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 mb-6">
                    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                        <!-- Search -->
                        <div class="flex-1 max-w-md">
                            <div class="relative">
                                <span
                                    class="material-icons absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400">search</span>
                                <input type="text" id="searchExpense" placeholder="Search expenses by description..."
                                    class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[var(--madas-accent)] focus:border-[var(--madas-accent)] transition-all">
                            </div>
                        </div>
                        <!-- Quick Actions -->
                        <div class="flex items-center gap-3">
                            <button id="exportCSVBtn"
                                class="flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                                <span class="material-icons text-sm">download</span>
                                <span class="hidden sm:inline">Export CSV</span>
                            </button>
                            <button id="bulkDeleteBtn"
                                class="hidden flex items-center gap-2 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors">
                                <span class="material-icons text-sm">delete_sweep</span>
                                <span class="hidden sm:inline">Delete Selected</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Expenses Table -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                    <!-- Table Container -->
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left">
                                        <input type="checkbox" id="selectAllExpenses"
                                            class="w-4 h-4 text-[var(--madas-primary)] rounded border-gray-300 focus:ring-[var(--madas-accent)]">
                                    </th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:text-[var(--madas-primary)] transition-colors"
                                        data-sort="date">
                                        <div class="flex items-center gap-1">
                                            <span>Date</span>
                                            <span class="material-icons text-sm opacity-50">unfold_more</span>
                                        </div>
                                    </th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:text-[var(--madas-primary)] transition-colors"
                                        data-sort="category">
                                        <div class="flex items-center gap-1">
                                            <span>Category</span>
                                            <span class="material-icons text-sm opacity-50">unfold_more</span>
                                        </div>
                                    </th>
                                    <th
                                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Description
                                    </th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:text-[var(--madas-primary)] transition-colors"
                                        data-sort="amount">
                                        <div class="flex items-center gap-1">
                                            <span>Amount</span>
                                            <span class="material-icons text-sm opacity-50">unfold_more</span>
                                        </div>
                                    </th>
                                    <th
                                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Actions
                                    </th>
                                </tr>
                            </thead>
                            <tbody id="expensesTableBody" class="bg-white divide-y divide-gray-200">
                                <!-- Loading skeleton will be inserted here -->
                                <!-- Expenses will be loaded here -->
                            </tbody>
                        </table>
                    </div>

                    <!-- Empty State (initially hidden) -->
                    <div id="emptyState" class="hidden py-16 px-6 text-center">
                        <div class="max-w-md mx-auto">
                            <div
                                class="w-24 h-24 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                <span class="material-icons text-gray-400" style="font-size: 48px;">receipt_long</span>
                            </div>
                            <h3 class="text-lg font-semibold text-gray-900 mb-2">No expenses yet</h3>
                            <p class="text-gray-500 mb-6">Start tracking your business expenses by adding your first
                                entry.</p>
                            <button onclick="document.getElementById('addExpenseBtn').click()"
                                class="inline-flex items-center gap-2 bg-[var(--madas-primary)] text-white px-6 py-3 rounded-lg hover:bg-[#1f3c19] transition-colors">
                                <span class="material-icons text-sm">add</span>
                                <span>Add Your First Expense</span>
                            </button>
                        </div>
                    </div>

                    <!-- No Results State (initially hidden) -->
                    <div id="noResultsState" class="hidden py-16 px-6 text-center">
                        <div class="max-w-md mx-auto">
                            <div
                                class="w-24 h-24 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                <span class="material-icons text-gray-400" style="font-size: 48px;">search_off</span>
                            </div>
                            <h3 class="text-lg font-semibold text-gray-900 mb-2">No results found</h3>
                            <p class="text-gray-500 mb-6">Try adjusting your search or filter criteria.</p>
                            <button
                                onclick="document.getElementById('clearFilter').click(); document.getElementById('searchExpense').value=''; document.getElementById('searchExpense').dispatchEvent(new Event('input'));"
                                class="inline-flex items-center gap-2 bg-gray-600 text-white px-6 py-3 rounded-lg hover:bg-gray-700 transition-colors">
                                <span class="material-icons text-sm">refresh</span>
                                <span>Clear Filters</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    <!-- Toast Notification Container -->
    <div id="toastContainer" class="fixed top-4 right-4 z-[60] space-y-2"></div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteModal"
        class="fixed inset-0 hidden z-50 flex items-center justify-center bg-black bg-opacity-50 transition-opacity">
        <div
            class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-md transform transition-all scale-95 hover:scale-100">
            <div class="flex items-center gap-4 mb-4">
                <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center flex-shrink-0">
                    <span class="material-icons text-red-600">warning</span>
                </div>
                <div>
                    <h3 class="text-lg font-bold text-gray-900">Delete Expense</h3>
                    <p class="text-sm text-gray-600">This action cannot be undone</p>
                </div>
            </div>
            <p class="text-gray-700 mb-6" id="deleteModalMessage">Are you sure you want to delete this expense?</p>
            <div class="flex justify-end gap-3">
                <button id="cancelDeleteBtn"
                    class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors">
                    Cancel
                </button>
                <button id="confirmDeleteBtn"
                    class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors flex items-center gap-2">
                    <span class="material-icons text-sm">delete</span>
                    <span>Delete</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Add/Edit Expense Modal -->
    <div id="expenseModal"
        class="fixed inset-0 hidden z-50 flex items-center justify-center bg-black bg-opacity-50 transition-opacity"
        role="dialog" aria-labelledby="expenseModalTitle" aria-hidden="true">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-md mx-4 transform transition-all scale-95">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold text-[var(--madas-primary)]" id="expenseModalTitle">Add Expense</h3>
                <button id="closeExpenseModalBtn"
                    class="text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded-full p-1 transition-all">
                    <span class="material-icons">close</span>
                </button>
            </div>
            <form id="expenseForm" class="space-y-4" novalidate>
                <div>
                    <label for="expenseDate" class="block text-sm font-medium text-gray-700 mb-1">
                        Date <span class="text-red-500">*</span>
                    </label>
                    <input type="date" id="expenseDate" required
                        class="w-full border border-gray-300 px-3 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-[var(--madas-accent)] focus:border-[var(--madas-accent)] transition-all" />
                    <p class="text-red-600 text-xs mt-1 hidden" id="expenseDateError">Please select a date</p>
                </div>
                <div>
                    <label for="expenseCategory" class="block text-sm font-medium text-gray-700 mb-1">
                        Category <span class="text-red-500">*</span>
                    </label>
                    <select id="expenseCategory" required
                        class="w-full border border-gray-300 px-3 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-[var(--madas-accent)] focus:border-[var(--madas-accent)] transition-all">
                        <option value="">Select category</option>
                        <option value="Salaries"> Salaries</option>
                        <option value="Rent"> Rent</option>
                        <option value="Utilities"> Utilities</option>
                        <option value="Supplies"> Supplies</option>
                        <option value="Marketing"> Marketing</option>
                        <option value="Personal"> Personal</option>
                        <option value="Other"> Other</option>
                    </select>
                    <p class="text-red-600 text-xs mt-1 hidden" id="expenseCategoryError">Please select a category</p>
                </div>
                <div>
                    <label for="expenseDescription" class="block text-sm font-medium text-gray-700 mb-1">
                        Description <span class="text-red-500">*</span>
                    </label>
                    <input type="text" id="expenseDescription" required placeholder="e.g., June payroll"
                        class="w-full border border-gray-300 px-3 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-[var(--madas-accent)] focus:border-[var(--madas-accent)] transition-all" />
                    <p class="text-red-600 text-xs mt-1 hidden" id="expenseDescriptionError">Please enter a description
                    </p>
                </div>
                <div>
                    <label for="expenseAmount" class="block text-sm font-medium text-gray-700 mb-1">
                        Amount (EGP) <span class="text-red-500">*</span>
                    </label>
                    <div class="relative">
                        <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500">EGP</span>
                        <input type="number" id="expenseAmount" min="0.01" step="0.01" required placeholder="0.00"
                            class="w-full border border-gray-300 pl-14 pr-3 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-[var(--madas-accent)] focus:border-[var(--madas-accent)] transition-all" />
                    </div>
                    <p class="text-red-600 text-xs mt-1 hidden" id="expenseAmountError">Please enter a valid amount
                        greater than 0</p>
                </div>
                <div class="flex justify-end gap-3 pt-4 border-t border-gray-200">
                    <button type="button" id="cancelExpenseBtn"
                        class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors">
                        Cancel
                    </button>
                    <button type="submit" id="saveExpenseBtn"
                        class="px-6 py-2 bg-[var(--madas-primary)] text-white rounded-lg hover:bg-[#1f3c19] transition-colors flex items-center gap-2">
                        <span class="material-icons text-sm hidden" id="saveLoadingIcon">hourglass_empty</span>
                        <span id="saveButtonText">Save</span>
                    </button>
                </div>
            </form>
        </div>
    </div>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
        import { getFirestore, collection, getDocs, addDoc, updateDoc, deleteDoc, doc, Timestamp, query, orderBy, where, getDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
        import { getFinanceDataManager } from "../../js/finance-data.js";

        // Helper function for business-scoped collections
        window.getScopedCollection = function (db, collectionName) {
            if (!window.currentBusinessId) {
                console.error(' No business context available for scoped collection');
                return collection(db, collectionName);
            }
            return collection(db, "businesses", window.currentBusinessId, collectionName);
        };

        // Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyC-ls1TrvSkrw71KqmB_kHYgPoj0H550a8",
            authDomain: "madas-store.firebaseapp.com",
            projectId: "madas-store",
            storageBucket: "madas-store.appspot.com",
            messagingSenderId: "527071300010",
            appId: "1:527071300010:web:7470e2204065b4590583d3",
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // ============================================
        // TOAST NOTIFICATION SYSTEM
        // ============================================
        function showToast(message, type = 'success') {
            const toastContainer = document.getElementById('toastContainer');
            const toast = document.createElement('div');

            const icons = {
                success: 'check_circle',
                error: 'error',
                warning: 'warning',
                info: 'info'
            };

            const colors = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                warning: 'bg-yellow-500',
                info: 'bg-blue-500'
            };

            toast.className = `${colors[type]} text-white px-6 py-3 rounded-lg shadow-lg flex items-center gap-3 transform transition-all duration-300 translate-x-full opacity-0`;
            toast.innerHTML = `
                <span class="material-icons">${icons[type]}</span>
                <span>${message}</span>
                <button onclick="this.parentElement.remove()" class="ml-2 hover:bg-white hover:bg-opacity-20 rounded p-1">
                    <span class="material-icons text-sm">close</span>
                </button>
            `;

            toastContainer.appendChild(toast);

            // Trigger animation
            setTimeout(() => {
                toast.classList.remove('translate-x-full', 'opacity-0');
            }, 100);

            // Auto dismiss after 3 seconds
            setTimeout(() => {
                toast.classList.add('translate-x-full', 'opacity-0');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // ============================================
        // LOADING SKELETON
        // ============================================
        function showLoadingSkeleton() {
            const tbody = document.getElementById('expensesTableBody');
            tbody.innerHTML = Array(5).fill('').map((_, index) => `
                <tr class="animate-pulse stagger-item" style="animation-delay: ${index * 0.1}s">
                    <td class="px-6 py-4"><input type="checkbox" disabled class="opacity-50"></td>
                    <td class="px-6 py-4"><div class="skeleton skeleton-text w-24"></div></td>
                    <td class="px-6 py-4"><div class="skeleton skeleton-badge w-24"></div></td>
                    <td class="px-6 py-4"><div class="skeleton skeleton-text w-full max-w-xs"></div></td>
                    <td class="px-6 py-4"><div class="skeleton skeleton-title w-20"></div></td>
                    <td class="px-6 py-4">
                        <div class="flex gap-2">
                            <div class="skeleton skeleton-button w-16"></div>
                            <div class="skeleton skeleton-button w-16"></div>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        // ============================================
        // FORM VALIDATION
        // ============================================
        function validateForm() {
            let isValid = true;

            // Validate date
            const date = document.getElementById('expenseDate');
            const dateError = document.getElementById('expenseDateError');
            if (!date.value) {
                dateError.classList.remove('hidden');
                date.classList.add('border-red-500');
                isValid = false;
            } else {
                dateError.classList.add('hidden');
                date.classList.remove('border-red-500');
            }

            // Validate category
            const category = document.getElementById('expenseCategory');
            const categoryError = document.getElementById('expenseCategoryError');
            if (!category.value) {
                categoryError.classList.remove('hidden');
                category.classList.add('border-red-500');
                isValid = false;
            } else {
                categoryError.classList.add('hidden');
                category.classList.remove('border-red-500');
            }

            // Validate description
            const description = document.getElementById('expenseDescription');
            const descriptionError = document.getElementById('expenseDescriptionError');
            if (!description.value.trim()) {
                descriptionError.classList.remove('hidden');
                description.classList.add('border-red-500');
                isValid = false;
            } else {
                descriptionError.classList.add('hidden');
                description.classList.remove('border-red-500');
            }

            // Validate amount
            const amount = document.getElementById('expenseAmount');
            const amountError = document.getElementById('expenseAmountError');
            if (!amount.value || parseFloat(amount.value) <= 0) {
                amountError.classList.remove('hidden');
                amount.classList.add('border-red-500');
                isValid = false;
            } else {
                amountError.classList.add('hidden');
                amount.classList.remove('border-red-500');
            }

            return isValid;
        }

        // Clear validation errors on input
        function setupValidationClearance() {
            ['expenseDate', 'expenseCategory', 'expenseDescription', 'expenseAmount'].forEach(id => {
                const field = document.getElementById(id);
                if (field) {
                    field.addEventListener('input', () => {
                        const error = document.getElementById(id + 'Error');
                        if (error) error.classList.add('hidden');
                        field.classList.remove('border-red-500');
                    });
                }
            });
        }

        // ============================================
        // SEARCH AND FILTER STATE
        // ============================================
        let allExpenses = [];
        let filteredExpenses = [];
        let sortColumn = 'date';
        let sortDirection = 'desc';
        let currentUserId = null;

        // Auth and user info with multi-tenancy
        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                window.location.href = "/login";
                return;
            }

            try {
                console.log(' User authenticated:', user.email);

                // ============================================
                // TENANT ISOLATION: Initialize Business Context
                // ============================================

                // Check for super admin users first (bypass business detection)
                const superAdminEmails = [
                    "hesainosama@gmail.com",
                    "test@example.com"
                ];

                if (superAdminEmails.includes(user.email)) {
                    console.log(" Super admin detected - granting full access");
                    window.currentUserRole = "super-admin";
                    window.currentBusinessId = "super-admin";
                    window.currentBusinessData = {
                        businessName: "Super Admin",
                        plan: { type: "enterprise", status: "active" }
                    };

                    // Set super admin permissions
                    const userData = {
                        email: user.email,
                        displayName: user.displayName || "Super Admin",
                        role: "super-admin",
                        approved: true,
                        permissions: {
                            home: ["view"],
                            orders: ["view", "search", "create", "edit"],
                            inventory: ["view", "edit"],
                            customers: ["view", "edit"],
                            employees: ["view", "edit"],
                            finance: ["view", "reports"],
                            analytics: ["view", "export"],
                            settings: ["view", "edit"],
                            admin: ["view", "manage_all_businesses"]
                        }
                    };

                    // Store user data
                    localStorage.setItem("madasUser", JSON.stringify(userData));

                    // Update UI
                    const username = userData.displayName || user.displayName || user.email.split("@")[0];
                    const userNameEl = document.getElementById("user-name");
                    const userEmailEl = document.getElementById("user-email");
                    const userInitialEl = document.getElementById("user-initial");

                    if (userNameEl) userNameEl.textContent = username;
                    if (userEmailEl) userEmailEl.textContent = user.email;
                    if (userInitialEl) userInitialEl.textContent = username.charAt(0).toUpperCase();

                    // Update business name and plan
                    const businessNameEl = document.getElementById("business-name");
                    if (businessNameEl) businessNameEl.textContent = "Super Admin";

                    const planBadge = document.getElementById("plan-badge");
                    if (planBadge) {
                        planBadge.textContent = "Enterprise Plan";
                        planBadge.className = "text-xs px-2 py-0.5 rounded-full bg-purple-100 text-purple-800 hover:bg-purple-200 transition-colors cursor-pointer";
                    }

                    // Hide loading screen if it exists
                    const loadingScreen = document.getElementById('loadingScreen');
                    if (loadingScreen) loadingScreen.style.display = 'none';

                    return;
                }

                // Step 1: Find user's business (check if owner)
                const businessesQuery = query(collection(db, "businesses"), where("owner.userId", "==", user.uid));
                const businessSnapshot = await getDocs(businessesQuery);

                if (!businessSnapshot.empty) {
                    // User is a business owner
                    const businessDoc = businessSnapshot.docs[0];
                    window.currentBusinessId = businessDoc.id;
                    window.currentBusinessData = businessDoc.data();
                    window.currentUserRole = 'owner';

                    console.log(' Business Owner:', window.currentBusinessData.businessName);
                    console.log(' Business ID:', window.currentBusinessId);
                    console.log(' Plan:', window.currentBusinessData.plan?.type);

                } else {
                    // Step 2: Check if user is staff member
                    const allBusinesses = await getDocs(collection(db, "businesses"));
                    let foundBusiness = false;

                    for (const businessDoc of allBusinesses.docs) {
                        const businessId = businessDoc.id;
                        const staffRef = doc(db, 'businesses', businessId, 'staff', user.uid);
                        const staffDoc = await getDoc(staffRef);

                        if (staffDoc.exists()) {
                            const staffData = staffDoc.data();
                            window.currentBusinessId = businessId;
                            window.currentBusinessData = businessDoc.data();
                            window.currentUserRole = staffData.role;
                            window.currentUserPermissions = staffData.permissions;

                            console.log(' Staff Member:', window.currentBusinessData.businessName);
                            console.log(' Business ID:', window.currentBusinessId);
                            console.log(' Role:', window.currentUserRole);

                            foundBusiness = true;
                            break;
                        }
                    }

                    if (!foundBusiness) {
                        console.warn(" User not associated with any business.");
                        console.log(" User email:", user.email);
                        console.log(" User UID:", user.uid);

                        // For now, create a temporary business context for testing
                        console.log(" Creating temporary business context for testing...");
                        window.currentBusinessId = "temp-business";
                        window.currentBusinessData = {
                            businessName: "Temporary Business",
                            plan: { type: "basic", status: "active" },
                            owner: { name: user.displayName || user.email.split("@")[0] }
                        };
                        window.currentUserRole = "owner";

                        // Set basic permissions
                        const userData = {
                            email: user.email,
                            displayName: user.displayName || user.email.split("@")[0],
                            role: "owner",
                            approved: true,
                            permissions: {
                                home: ["view"],
                                orders: ["view", "search", "create", "edit"],
                                inventory: ["view", "edit"],
                                customers: ["view", "edit"],
                                employees: ["view", "edit"],
                                finance: ["view", "reports"],
                                analytics: ["view", "export"],
                                settings: ["view", "edit"]
                            }
                        };

                        // Store user data
                        localStorage.setItem("madasUser", JSON.stringify(userData));

                        // Update UI
                        const username = userData.displayName || user.displayName || user.email.split("@")[0];
                        const userNameEl = document.getElementById("user-name");
                        const userEmailEl = document.getElementById("user-email");
                        const userInitialEl = document.getElementById("user-initial");

                        if (userNameEl) userNameEl.textContent = username;
                        if (userEmailEl) userEmailEl.textContent = user.email;
                        if (userInitialEl) userInitialEl.textContent = username.charAt(0).toUpperCase();

                        // Update business name and plan
                        const businessNameEl = document.getElementById("business-name");
                        if (businessNameEl) businessNameEl.textContent = "Temporary Business";

                        const planBadge = document.getElementById("plan-badge");
                        if (planBadge) {
                            planBadge.textContent = "Basic Plan";
                            planBadge.className = "text-xs px-2 py-0.5 rounded-full bg-green-100 text-green-800 hover:bg-green-200 transition-colors cursor-pointer";
                        }

                        // Hide loading screen if it exists
                        const loadingScreen = document.getElementById('loadingScreen');
                        if (loadingScreen) loadingScreen.style.display = 'none';

                        return;
                    }
                }

                // Set user permissions based on role
                let userData = {
                    email: user.email,
                    displayName: user.displayName || window.currentBusinessData.owner?.name,
                    role: window.currentUserRole,
                    approved: true // All business users are approved by default
                };

                // Set permissions based on role
                if (window.currentUserRole === 'owner') {
                    userData.permissions = {
                        home: ["view"],
                        orders: ["view", "search", "create", "edit"],
                        inventory: ["view", "edit"],
                        customers: ["view", "edit"],
                        employees: ["view", "edit"],
                        finance: ["view", "reports"],
                        analytics: ["view", "export"],
                        settings: ["view", "edit"]
                    };
                } else if (window.currentUserRole === 'admin') {
                    userData.permissions = {
                        home: ["view"],
                        orders: ["view", "search", "create", "edit"],
                        inventory: ["view", "edit"],
                        customers: ["view", "edit"],
                        employees: ["view", "edit"],
                        finance: ["view", "reports"],
                        analytics: ["view", "export"],
                        settings: ["view", "edit"]
                    };
                } else {
                    // For staff members, use permissions from their staff document
                    userData.permissions = window.currentUserPermissions || {
                        home: ["view"]
                    };
                }

                console.log(' User data created:', {
                    email: userData.email,
                    role: userData.role,
                    businessId: window.currentBusinessId,
                    businessName: window.currentBusinessData?.businessName,
                    approved: userData.approved
                });

                // Store user data
                localStorage.setItem("madasUser", JSON.stringify(userData));

                // Update UI
                currentUserId = user.uid;
                const username = userData.displayName || window.currentBusinessData?.owner?.name || user.displayName || user.email.split("@")[0];

                // Update user info if elements exist
                const userNameEl = document.getElementById("user-name");
                const userEmailEl = document.getElementById("user-email");
                const userInitialEl = document.getElementById("user-initial");

                if (userNameEl) userNameEl.textContent = username;
                if (userEmailEl) userEmailEl.textContent = user.email;
                if (userInitialEl) userInitialEl.textContent = username.charAt(0).toUpperCase();

                // Update business name and plan
                const businessName = window.currentBusinessData?.businessName || "DIGIX Admin";
                const planType = window.currentBusinessData?.plan?.type || "basic";
                const planStatus = window.currentBusinessData?.plan?.status || "active";

                const businessNameEl = document.getElementById("business-name");
                if (businessNameEl) businessNameEl.textContent = businessName;

                const planBadge = document.getElementById("plan-badge");
                if (planBadge) {
                    planBadge.textContent = `${planType.charAt(0).toUpperCase() + planType.slice(1)} Plan`;

                    // Set plan badge color based on plan type
                    if (planType === 'enterprise') {
                        planBadge.className = "text-xs px-2 py-0.5 rounded-full bg-purple-100 text-purple-800 hover:bg-purple-200 transition-colors cursor-pointer";
                    } else if (planType === 'professional') {
                        planBadge.className = "text-xs px-2 py-0.5 rounded-full bg-blue-100 text-blue-800 hover:bg-blue-200 transition-colors cursor-pointer";
                    } else {
                        planBadge.className = "text-xs px-2 py-0.5 rounded-full bg-green-100 text-green-800 hover:bg-green-200 transition-colors cursor-pointer";
                    }

                    // Add trial badge if in trial
                    if (planStatus === 'trial') {
                        planBadge.textContent += ' (Trial)';
                    }
                }

                // Hide loading screen if it exists
                const loadingScreen = document.getElementById('loadingScreen');
                if (loadingScreen) loadingScreen.style.display = 'none';

                // Initialize page features after auth is complete
                initializeExpensePage();

            } catch (error) {
                console.error("Permission check failed:", error);
                window.location.href = "/login";
            }
        });
        // Logout logic
        const logoutBtn = document.getElementById("logout-btn");
        if (logoutBtn) {
            logoutBtn.addEventListener("click", () => {
                signOut(auth).then(() => {
                    window.location.href = "/login";
                });
            });
        }
        // Modal controls
        const expenseModal = document.getElementById('expenseModal');
        const addExpenseBtn = document.getElementById('addExpenseBtn');
        const closeExpenseModalBtn = document.getElementById('closeExpenseModalBtn');
        const cancelExpenseBtn = document.getElementById('cancelExpenseBtn');
        const expenseForm = document.getElementById('expenseForm');
        let editingExpenseId = null;
        function openExpenseModal(expense = null) {
            expenseModal.classList.remove('hidden');
            document.getElementById('expenseModalTitle').textContent = expense ? 'Edit Expense' : 'Add Expense';
            if (expense) {
                document.getElementById('expenseDate').value = expense.date;
                document.getElementById('expenseCategory').value = expense.category;
                document.getElementById('expenseDescription').value = expense.description;
                document.getElementById('expenseAmount').value = expense.amount;
                editingExpenseId = expense.id;
            } else {
                expenseForm.reset();
                editingExpenseId = null;
            }
        }
        function closeExpenseModal() {
            expenseModal.classList.add('hidden');
            expenseForm.reset();
            editingExpenseId = null;
        }
        if (addExpenseBtn) addExpenseBtn.addEventListener('click', () => openExpenseModal());
        if (closeExpenseModalBtn) closeExpenseModalBtn.addEventListener('click', closeExpenseModal);
        if (cancelExpenseBtn) cancelExpenseBtn.addEventListener('click', closeExpenseModal);
        // ============================================
        // ENHANCED RENDER EXPENSES FUNCTION
        // ============================================
        function renderExpenses(expenses) {
            const expensesTableBody = document.getElementById('expensesTableBody');
            const emptyState = document.getElementById('emptyState');
            const noResultsState = document.getElementById('noResultsState');

            // Hide empty states initially
            if (emptyState) emptyState.classList.add('hidden');
            if (noResultsState) noResultsState.classList.add('hidden');

            // Show appropriate empty state
            if (!expenses.length) {
                const hasSearchOrFilter = document.getElementById('searchExpense')?.value.trim();
                if (allExpenses.length === 0) {
                    // No expenses at all
                    emptyState.classList.remove('hidden');
                } else {
                    // Filtered results empty
                    noResultsState.classList.remove('hidden');
                }
                expensesTableBody.innerHTML = '';
                return;
            }

            // Category color mapping
            const categoryColors = {
                'Salaries': 'text-green-700 bg-green-50',
                'Personal': 'text-purple-700 bg-purple-50',
                'Supplies': 'text-yellow-700 bg-yellow-50',
                'Marketing': 'text-pink-700 bg-pink-50',
                'Rent': 'text-blue-700 bg-blue-50',
                'Utilities': 'text-indigo-700 bg-indigo-50',
                'Other': 'text-gray-700 bg-gray-50'
            };

            expensesTableBody.innerHTML = expenses.map(exp => `
                <tr class="hover:bg-gray-50 transition-colors">
                    <td class="px-6 py-4">
                        <input type="checkbox" class="expense-checkbox w-4 h-4 text-[var(--madas-primary)] rounded border-gray-300 focus:ring-[var(--madas-accent)]"
                            data-id="${exp.id}" onchange="handleCheckboxChange('${exp.id}', this.checked)">
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-medium">${exp.date}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${categoryColors[exp.category] || 'text-gray-700 bg-gray-50'}">
                            ${exp.category}
                        </span>
                    </td>
                    <td class="px-6 py-4 text-sm text-gray-700 max-w-md truncate" title="${exp.description}">${exp.description}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-gray-900">EGP ${exp.amount.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <div class="flex items-center gap-2">
                            <button class="edit-expense-btn inline-flex items-center gap-1 px-3 py-1.5 bg-blue-50 text-blue-600 rounded-lg hover:bg-blue-100 transition-colors" data-id="${exp.id}">
                                <span class="material-icons text-sm">edit</span>
                                <span class="hidden sm:inline">Edit</span>
                            </button>
                            <button class="delete-expense-btn inline-flex items-center gap-1 px-3 py-1.5 bg-red-50 text-red-600 rounded-lg hover:bg-red-100 transition-colors" data-id="${exp.id}">
                                <span class="material-icons text-sm">delete</span>
                                <span class="hidden sm:inline">Delete</span>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');

            // Attach edit listeners
            expensesTableBody.querySelectorAll('.edit-expense-btn').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const id = btn.getAttribute('data-id');
                    const expense = allExpenses.find(e => e.id === id);
                    if (expense) openExpenseModal(expense);
                });
            });

            // Attach delete listeners
            expensesTableBody.querySelectorAll('.delete-expense-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const id = btn.getAttribute('data-id');
                    const expense = allExpenses.find(e => e.id === id);
                    showDeleteModal(id, expense);
                });
            });
        }

        // Checkbox change handler (global function)
        window.handleCheckboxChange = function (id, checked) {
            if (checked) {
                selectedExpenses.add(id);
            } else {
                selectedExpenses.delete(id);
                document.getElementById('selectAllExpenses').checked = false;
            }
            updateBulkDeleteButton();
        };

        // ============================================
        // DELETE MODAL FUNCTIONS
        // ============================================
        function showDeleteModal(expenseId, expense) {
            const deleteModal = document.getElementById('deleteModal');
            const deleteMessage = document.getElementById('deleteModalMessage');
            const confirmBtn = document.getElementById('confirmDeleteBtn');
            const cancelBtn = document.getElementById('cancelDeleteBtn');

            deleteMessage.textContent = `Are you sure you want to delete "${expense.description}" (EGP ${expense.amount.toLocaleString()})?`;
            deleteModal.classList.remove('hidden');

            // Setup one-time handlers
            const handleConfirm = async () => {
                try {
                    // Initialize finance manager if not already initialized
                    if (!financeManager) {
                        financeManager = getFinanceDataManager(db, window.currentBusinessId);
                        await financeManager.initialize();
                    }

                    // Delete expense using finance manager
                    await financeManager.deleteExpense(expenseId);
                    showToast('Expense deleted successfully', 'success');
                    // Data will be updated automatically via subscription
                } catch (error) {
                    console.error('Error deleting expense:', error);
                    showToast('Failed to delete expense', 'error');
                }
                deleteModal.classList.add('hidden');
                confirmBtn.removeEventListener('click', handleConfirm);
                cancelBtn.removeEventListener('click', handleCancel);
            };

            const handleCancel = () => {
                deleteModal.classList.add('hidden');
                confirmBtn.removeEventListener('click', handleConfirm);
                cancelBtn.removeEventListener('click', handleCancel);
            };

            confirmBtn.addEventListener('click', handleConfirm);
            cancelBtn.addEventListener('click', handleCancel);
        }
        async function updateSummaryCards(expenses) {
            // Total expenses (excluding Supplies)
            const total = expenses.filter(e => e.category !== 'Supplies').reduce((sum, e) => sum + e.amount, 0);
            document.getElementById('total-expenses').textContent = `EGP${total.toLocaleString()}`;
            // Categories
            const categories = new Set(expenses.map(e => e.category));
            document.getElementById('expense-categories').textContent = categories.size;
            // This month (excluding Supplies)
            const now = new Date();
            const month = now.getMonth();
            const year = now.getFullYear();
            const monthly = expenses.filter(e => {
                const d = new Date(e.date);
                return d.getMonth() === month && d.getFullYear() === year && e.category !== 'Supplies';
            }).reduce((sum, e) => sum + e.amount, 0);
            document.getElementById('monthly-expenses').textContent = `EGP${monthly.toLocaleString()}`;
            // Salaries
            const salaries = expenses.filter(e => e.category === 'Salaries').reduce((sum, e) => sum + e.amount, 0);
            document.getElementById('salary-expenses').textContent = `EGP${salaries.toLocaleString()}`;
            // Personal Expenses
            const personal = expenses.filter(e => e.category === 'Personal').reduce((sum, e) => sum + e.amount, 0);
            document.getElementById('personal-expenses').textContent = `EGP${personal.toLocaleString()}`;
            // Supplies calculation: Total Supplies - Capital Return (from finance system)
            const totalSupplies = expenses.filter(e => e.category === 'Supplies').reduce((sum, e) => sum + e.amount, 0);
            const capitalReturnFromFinance = await getCapitalReturnFromFinance();
            const netSupplies = totalSupplies - capitalReturnFromFinance;
            document.getElementById('supplies-expenses').textContent = `EGP${netSupplies.toLocaleString()}`;

            // Marketing
            const marketing = expenses.filter(e => e.category === 'Marketing').reduce((sum, e) => sum + e.amount, 0);
            document.getElementById('marketing-expenses').textContent = `EGP${marketing.toLocaleString()}`;
            // Average expense (excluding Supplies)
            const expensesExcludingSupplies = expenses.filter(e => e.category !== 'Supplies');
            const average = expensesExcludingSupplies.length > 0 ? total / expensesExcludingSupplies.length : 0;
            document.getElementById('average-expense').textContent = `EGP${average.toFixed(2)}`;
        }
        // Add/Edit Expense
        expenseForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            // Validate form
            if (!validateForm()) {
                showToast('Please fill in all required fields', 'error');
                return;
            }

            const date = document.getElementById('expenseDate').value;
            const category = document.getElementById('expenseCategory').value;
            const description = document.getElementById('expenseDescription').value.trim();
            const amount = parseFloat(document.getElementById('expenseAmount').value);

            if (!window.currentBusinessId) {
                showToast('No business context available', 'error');
                return;
            }

            // Show loading state
            const saveBtn = document.getElementById('saveExpenseBtn');
            const saveLoadingIcon = document.getElementById('saveLoadingIcon');
            const saveButtonText = document.getElementById('saveButtonText');
            const originalText = saveButtonText.textContent;

            saveBtn.disabled = true;
            saveLoadingIcon.classList.remove('hidden');
            saveButtonText.textContent = editingExpenseId ? 'Updating...' : 'Saving...';

            try {
                // Initialize finance manager if not already initialized
                if (!financeManager) {
                    financeManager = getFinanceDataManager(db, window.currentBusinessId);
                    await financeManager.initialize();
                }

                if (editingExpenseId) {
                    // Update expense using finance manager
                    await financeManager.updateExpense(editingExpenseId, {
                        date,
                        category,
                        description,
                        amount: parseFloat(amount)
                    });
                    showToast('Expense updated successfully!', 'success');
                } else {
                    // Add expense using finance manager
                    await financeManager.addExpense({
                        date,
                        category,
                        description,
                        amount: parseFloat(amount)
                    });
                    showToast('Expense added successfully!', 'success');
                }
                closeExpenseModal();
                // Data will be updated automatically via subscription
            } catch (error) {
                console.error('Error saving expense:', error);
                showToast('Failed to save expense. Please try again.', 'error');
            } finally {
                saveBtn.disabled = false;
                saveLoadingIcon.classList.add('hidden');
                saveButtonText.textContent = originalText;
            }
        });

        // ============================================
        // KEYBOARD SHORTCUTS
        // ============================================
        document.addEventListener('keydown', (e) => {
            // ESC to close modal
            if (e.key === 'Escape') {
                const expenseModal = document.getElementById('expenseModal');
                const deleteModal = document.getElementById('deleteModal');
                if (!expenseModal.classList.contains('hidden')) {
                    closeExpenseModal();
                }
                if (!deleteModal.classList.contains('hidden')) {
                    deleteModal.classList.add('hidden');
                }
            }
        });

        // ============================================
        // SET DEFAULT DATE TO TODAY
        // ============================================
        function setDefaultDate() {
            const dateInput = document.getElementById('expenseDate');
            if (dateInput && !dateInput.value) {
                const today = new Date().toISOString().split('T')[0];
                dateInput.value = today;
            }
        }

        // ============================================
        // INITIALIZE ALL FEATURES
        // ============================================
        function initializeExpensePage() {
            setupValidationClearance();
            setupSearch();
            setupTableSorting();
            setupCSVExport();
            setupBulkSelection();
            loadExpenses();
        }

        // Update openExpenseModal to set default date
        const originalOpenModal = openExpenseModal;
        openExpenseModal = function (expense = null) {
            originalOpenModal(expense);
            if (!expense) {
                setDefaultDate();
            }
            // Focus first field
            setTimeout(() => {
                document.getElementById('expenseDate').focus();
            }, 100);
        };

        // Time filter functionality (variables already declared above)

        const timeFilter = document.getElementById('timeFilter');
        const customDateRange = document.getElementById('customDateRange');
        const startDate = document.getElementById('startDate');
        const endDate = document.getElementById('endDate');
        const applyFilter = document.getElementById('applyFilter');
        const clearFilter = document.getElementById('clearFilter');

        // Show/hide custom date range inputs
        if (timeFilter) {
            timeFilter.addEventListener('change', () => {
                if (timeFilter.value === 'custom') {
                    customDateRange.classList.remove('hidden');
                } else {
                    customDateRange.classList.add('hidden');
                }
            });
        }

        // Apply filter function
        async function applyTimeFilter() {
            const filterValue = timeFilter.value;
            const now = new Date();
            let start, end;

            switch (filterValue) {
                case 'today':
                    start = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                    end = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59);
                    break;
                case 'week':
                    const dayOfWeek = now.getDay();
                    const daysToSubtract = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
                    start = new Date(now.getFullYear(), now.getMonth(), now.getDate() - daysToSubtract);
                    end = new Date(now.getFullYear(), now.getMonth(), now.getDate() + (6 - dayOfWeek), 23, 59, 59);
                    break;
                case 'month':
                    start = new Date(now.getFullYear(), now.getMonth(), 1);
                    end = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59);
                    break;
                case 'quarter':
                    const quarter = Math.floor(now.getMonth() / 3);
                    start = new Date(now.getFullYear(), quarter * 3, 1);
                    end = new Date(now.getFullYear(), (quarter + 1) * 3, 0, 23, 59, 59);
                    break;
                case 'year':
                    start = new Date(now.getFullYear(), 0, 1);
                    end = new Date(now.getFullYear(), 11, 31, 23, 59, 59);
                    break;
                case 'custom':
                    if (startDate.value && endDate.value) {
                        start = new Date(startDate.value);
                        end = new Date(endDate.value);
                        end.setHours(23, 59, 59);
                    } else {
                        alert('Please select both start and end dates');
                        return;
                    }
                    break;
                default: // 'all'
                    start = new Date(0);
                    end = new Date(9999, 11, 31);
                    break;
            }

            filteredExpenses = allExpenses.filter(expense => {
                const expenseDate = new Date(expense.date);
                return expenseDate >= start && expenseDate <= end;
            });

            renderExpenses(filteredExpenses);
            await updateSummaryCards(filteredExpenses);
        }

        // Clear filter function
        async function clearTimeFilter() {
            timeFilter.value = 'month';
            customDateRange.classList.add('hidden');
            startDate.value = '';
            endDate.value = '';
            filteredExpenses = [...allExpenses];
            renderExpenses(allExpenses);
            await updateSummaryCards(allExpenses);
        }

        // Event listeners for filter buttons
        if (applyFilter) {
            applyFilter.addEventListener('click', applyTimeFilter);
        }

        if (clearFilter) {
            clearFilter.addEventListener('click', clearTimeFilter);
        }

        // Initialize finance data manager
        let financeManager = null;

        // Update loadExpenses function to use shared finance module
        async function loadExpenses() {
            if (!window.currentBusinessId) return;

            // Show loading skeleton
            showLoadingSkeleton();

            try {
                // Initialize finance data manager if not already initialized
                if (!financeManager) {
                    financeManager = getFinanceDataManager(db, window.currentBusinessId);
                    await financeManager.initialize();

                    // Subscribe to data changes
                    financeManager.subscribe((data) => {
                        updateExpensesFromManager(data.expenses);
                    });
                } else {
                    // Refresh data
                    await financeManager.refresh();
                }

                // Get expenses from finance manager
                const expenses = financeManager.expenses || [];
                allExpenses = expenses.map(expense => ({
                    id: expense.id,
                    date: expense.date instanceof Timestamp
                        ? expense.date.toDate().toISOString().slice(0, 10)
                        : expense.date || expense.createdAt?.toDate?.()?.toISOString().slice(0, 10) || new Date().toISOString().split('T')[0],
                    category: expense.category || 'Uncategorized',
                    description: expense.description || '',
                    amount: parseFloat(expense.amount) || 0
                }));

                filteredExpenses = [...allExpenses];
                applyFilters(); // Apply current filters and search
                await updateSummaryCards(allExpenses);
            } catch (error) {
                console.error('Error loading expenses:', error);
                showToast('Failed to load expenses', 'error');
                document.getElementById('expensesTableBody').innerHTML = `
                    <tr><td colspan="6" class="px-6 py-8 text-center text-gray-500">
                        <span class="material-icons text-4xl text-red-300 mb-2">error</span>
                        <p>Failed to load expenses. Please try again.</p>
                    </td></tr>
                `;
            }
        }

        // Update expenses from finance manager
        function updateExpensesFromManager(expenses) {
            allExpenses = expenses.map(expense => ({
                id: expense.id,
                date: expense.date instanceof Timestamp
                    ? expense.date.toDate().toISOString().slice(0, 10)
                    : expense.date || expense.createdAt?.toDate?.()?.toISOString().slice(0, 10) || new Date().toISOString().split('T')[0],
                category: expense.category || 'Uncategorized',
                description: expense.description || '',
                amount: parseFloat(expense.amount) || 0
            }));
            filteredExpenses = [...allExpenses];
            applyFilters();
            updateSummaryCards(allExpenses);
        }

        // ============================================
        // SEARCH AND FILTER FUNCTIONS
        // ============================================
        function applyFilters() {
            let result = [...allExpenses];

            // Apply search
            const searchTerm = document.getElementById('searchExpense')?.value.toLowerCase().trim();
            if (searchTerm) {
                result = result.filter(exp =>
                    exp.description.toLowerCase().includes(searchTerm) ||
                    exp.category.toLowerCase().includes(searchTerm)
                );
            }

            // Apply sorting
            result.sort((a, b) => {
                let aVal = a[sortColumn];
                let bVal = b[sortColumn];

                if (sortColumn === 'amount') {
                    aVal = parseFloat(aVal);
                    bVal = parseFloat(bVal);
                }

                if (aVal < bVal) return sortDirection === 'asc' ? -1 : 1;
                if (aVal > bVal) return sortDirection === 'asc' ? 1 : -1;
                return 0;
            });

            filteredExpenses = result;
            renderExpenses(result);
        }

        // Setup search listener
        function setupSearch() {
            const searchInput = document.getElementById('searchExpense');
            if (searchInput) {
                searchInput.addEventListener('input', () => {
                    applyFilters();
                });
            }
        }

        // Setup table sorting
        function setupTableSorting() {
            document.querySelectorAll('th[data-sort]').forEach(header => {
                header.addEventListener('click', () => {
                    const column = header.dataset.sort;

                    if (sortColumn === column) {
                        sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
                    } else {
                        sortColumn = column;
                        sortDirection = 'desc';
                    }

                    // Update icons
                    document.querySelectorAll('th[data-sort] .material-icons').forEach(icon => {
                        icon.textContent = 'unfold_more';
                        icon.classList.add('opacity-50');
                    });

                    const icon = header.querySelector('.material-icons');
                    icon.textContent = sortDirection === 'asc' ? 'arrow_upward' : 'arrow_downward';
                    icon.classList.remove('opacity-50');

                    applyFilters();
                });
            });
        }

        // ============================================
        // CSV EXPORT FUNCTION
        // ============================================
        function exportToCSV() {
            if (!filteredExpenses.length) {
                showToast('No expenses to export', 'warning');
                return;
            }

            const headers = ['Date', 'Category', 'Description', 'Amount (EGP)'];
            const csvContent = [
                headers.join(','),
                ...filteredExpenses.map(exp =>
                    [exp.date, exp.category, `"${exp.description}"`, exp.amount].join(',')
                )
            ].join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);

            link.setAttribute('href', url);
            link.setAttribute('download', `expenses_${new Date().toISOString().slice(0, 10)}.csv`);
            link.style.visibility = 'hidden';

            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            showToast('Expenses exported successfully!', 'success');
        }

        // Setup CSV export button
        function setupCSVExport() {
            const exportBtn = document.getElementById('exportCSVBtn');
            if (exportBtn) {
                exportBtn.addEventListener('click', exportToCSV);
            }
        }

        // ============================================
        // BULK DELETE FUNCTIONS
        // ============================================
        let selectedExpenses = new Set();

        function setupBulkSelection() {
            // Select all checkbox
            const selectAllCheckbox = document.getElementById('selectAllExpenses');
            if (selectAllCheckbox) {
                selectAllCheckbox.addEventListener('change', (e) => {
                    const checkboxes = document.querySelectorAll('.expense-checkbox');
                    checkboxes.forEach(cb => {
                        cb.checked = e.target.checked;
                        if (e.target.checked) {
                            selectedExpenses.add(cb.dataset.id);
                        } else {
                            selectedExpenses.delete(cb.dataset.id);
                        }
                    });
                    updateBulkDeleteButton();
                });
            }

            // Bulk delete button
            const bulkDeleteBtn = document.getElementById('bulkDeleteBtn');
            if (bulkDeleteBtn) {
                bulkDeleteBtn.addEventListener('click', handleBulkDelete);
            }
        }

        function updateBulkDeleteButton() {
            const bulkDeleteBtn = document.getElementById('bulkDeleteBtn');
            if (selectedExpenses.size > 0) {
                bulkDeleteBtn.classList.remove('hidden');
                bulkDeleteBtn.classList.add('flex');
            } else {
                bulkDeleteBtn.classList.add('hidden');
                bulkDeleteBtn.classList.remove('flex');
            }
        }

        async function handleBulkDelete() {
            if (selectedExpenses.size === 0) return;

            const deleteModal = document.getElementById('deleteModal');
            const deleteMessage = document.getElementById('deleteModalMessage');
            const confirmBtn = document.getElementById('confirmDeleteBtn');

            deleteMessage.textContent = `Are you sure you want to delete ${selectedExpenses.size} expense(s)? This action cannot be undone.`;
            deleteModal.classList.remove('hidden');

            // Setup one-time confirm handler
            const handleConfirm = async () => {
                try {
                    // Initialize finance manager if not already initialized
                    if (!financeManager) {
                        financeManager = getFinanceDataManager(db, window.currentBusinessId);
                        await financeManager.initialize();
                    }

                    // Delete expenses using finance manager
                    const deletePromises = Array.from(selectedExpenses).map(id =>
                        financeManager.deleteExpense(id)
                    );

                    await Promise.all(deletePromises);

                    showToast(`Successfully deleted ${selectedExpenses.size} expense(s)`, 'success');
                    selectedExpenses.clear();
                    document.getElementById('selectAllExpenses').checked = false;
                    updateBulkDeleteButton();
                    // Data will be updated automatically via subscription
                } catch (error) {
                    console.error('Error deleting expenses:', error);
                    showToast('Failed to delete some expenses', 'error');
                }

                deleteModal.classList.add('hidden');
                confirmBtn.removeEventListener('click', handleConfirm);
            };

            confirmBtn.addEventListener('click', handleConfirm);
        }

        // Profile button
        const profileBtn = document.getElementById("profile-btn");
        if (profileBtn) {
            profileBtn.addEventListener("click", () => {
                window.location.href = "./profile.html";
            });
        }

        // Dark mode toggle functionality
        const darkToggle = document.getElementById('darkToggle');
        const darkIcon = document.getElementById('darkToggleIcon');

        function setDarkMode(on) {
            document.body.classList.toggle('dark-mode', on);
            localStorage.setItem('dark-mode', on ? '1' : '0');
            if (on) {
                darkIcon.innerHTML = '<path d="M21.64 13.64A9 9 0 1 1 10.36 2.36a7 7 0 1 0 11.28 11.28z"/>';
            } else {
                darkIcon.innerHTML = '<path d="M12 2a1 1 0 0 1 1 1v1a1 1 0 1 1-2 0V3a1 1 0 0 1 1-1zm5.657 3.343a1 1 0 0 1 1.414 0l.707.707a1 1 0 1 1-1.414 1.414l-.707-.707a1 1 0 0 1 0-1.414zM21 11a1 1 0 1 1 0 2h-1a1 1 0 1 1 0-2h1zm-2.929 7.071a1 1 0 0 1 0 1.414l-.707.707a1 1 0 1 1-1.414-1.414l.707-.707a1 1 0 0 1 1.414 0zM12 20a1 1 0 0 1-1-1v-1a1 1 0 1 1 2 0v1a1 1 0 0 1-1 1zm-7.071-2.929a1 1 0 0 1-1.414 0l-.707-.707a1 1 0 1 1 1.414-1.414l.707.707a1 1 0 0 1 0 1.414zM4 13a1 1 0 1 1 0-2H3a1 1 0 1 1 0 2h1zm2.343-7.657a1 1 0 0 1 0 1.414l-.707.707A1 1 0 1 1 4.222 6.05l.707-.707a1 1 0 0 1 1.414 0zM12 6a6 6 0 1 1 0 12A6 6 0 0 1 12 6z" />';
            }
        }

        darkToggle.addEventListener('click', () => {
            setDarkMode(!document.body.classList.contains('dark-mode'));
        });

        if (localStorage.getItem('dark-mode') === '1') {
            setDarkMode(true);
        }

        // Get Capital Return from Finance System
        async function getCapitalReturnFromFinance() {
            try {
                console.log("Getting capital return from finance system...");

                // Use the existing Firebase db instance (already initialized at the top of the script)

                // Get scan logs to calculate capital return
                const q = query(
                    collection(db, "scan_log"),
                    orderBy("timestamp", "desc")
                );

                const scanLogsSnapshot = await getDocs(q);
                let capitalReturn = 0;
                let orderCount = 0;
                let returnCount = 0;

                console.log("Found", scanLogsSnapshot.size, "scan log entries in expenses calculation");

                scanLogsSnapshot.forEach((doc) => {
                    const log = doc.data();
                    console.log("Processing log in expenses:", log);

                    if (log.type === "order") {
                        // Add to capital return when order is processed
                        const price = parseFloat(log.price || 0);
                        capitalReturn += price;
                        orderCount++;
                        console.log("Order found in expenses - price:", price, "running total:", capitalReturn);
                    } else if (log.type === "return") {
                        // Subtract from capital return when return is processed
                        const price = parseFloat(log.price || 0);
                        capitalReturn -= price;
                        returnCount++;
                        console.log("Return found in expenses - price:", price, "running total:", capitalReturn);
                    }
                });

                console.log("Final capital return from expenses calculation:", capitalReturn);
                console.log("Orders processed:", orderCount, "Returns processed:", returnCount);

                return capitalReturn;
            } catch (error) {
                console.error("Error getting capital return from finance system:", error);
                return 0;
            }
        }

        // Finance dropdown functionality
        const financeDropdownBtn = document.getElementById('finance-dropdown-btn');
        const financeDropdownMenu = document.getElementById('finance-dropdown-menu');
        const dropdownArrow = financeDropdownBtn.querySelector('.dropdown-arrow');

        if (financeDropdownBtn && financeDropdownMenu) {
            financeDropdownBtn.addEventListener('click', () => {
                const isHidden = financeDropdownMenu.classList.contains('hidden');
                if (isHidden) {
                    financeDropdownMenu.classList.remove('hidden');
                    dropdownArrow.style.transform = 'rotate(180deg)';
                } else {
                    financeDropdownMenu.classList.add('hidden');
                    dropdownArrow.style.transform = 'rotate(0deg)';
                }
            });
        }

        // Burger menu functionality
        const menuToggle = document.getElementById('menu-toggle');
        const sidebar = document.getElementById('sidebar');

        if (menuToggle && sidebar) {
            menuToggle.addEventListener('click', () => {
                const isHidden = sidebar.classList.contains('-translate-x-full');
                if (isHidden) {
                    sidebar.classList.remove('-translate-x-full');
                    sidebar.classList.add('translate-x-0');
                } else {
                    sidebar.classList.add('-translate-x-full');
                    sidebar.classList.remove('translate-x-0');
                }
            });

            // Close sidebar when clicking outside on mobile
            document.addEventListener('click', (e) => {
                if (window.innerWidth < 1024) { // Only on mobile
                    if (!sidebar.contains(e.target) && !menuToggle.contains(e.target)) {
                        sidebar.classList.add('-translate-x-full');
                        sidebar.classList.remove('translate-x-0');
                    }
                }
            });
        }

        // Active Page Highlighting and Dropdown Management
        function highlightActivePage() {
            // Initialize foundMatch variable
            let foundMatch = false;

            // Get all sidebar links
            const sidebarLinks = document.querySelectorAll('.sidebar-link');

            // Remove all active classes first
            sidebarLinks.forEach(link => {
                link.classList.remove('active');
            });

            // Get current page path
            const currentPath = window.location.pathname;
            const currentPageName = window.location.pathname.split('/').pop().replace('.html', '');

            console.log('Current path:', currentPath);
            console.log('Current page name:', currentPageName);

            // DASHBOARD LINK - Handle separately and FIRST
            const dashboardLink = document.querySelector('a[href="/dashboard"]');
            if (dashboardLink) {
                console.log(' Checking Dashboard link for path:', currentPath);
                console.log(' Current path details:', {
                    path: currentPath,
                    endsWithIndex: currentPath.endsWith('index.html'),
                    includesPages: currentPath.includes('pages'),
                    isRoot: currentPath === '/',
                    isDashboard: currentPath === '/dashboard'
                });

                // Dashboard should ONLY be active on dashboard page
                const isDashboardPage = (
                    currentPath === '/' ||
                    currentPath === '/dashboard' ||
                    currentPath === '/dashboard/' ||
                    currentPath.endsWith('/dashboard/index.html') ||
                    currentPath.endsWith('/index.html') ||
                    (currentPath.includes('index.html') && !currentPath.includes('pages')) ||
                    currentPath.startsWith('/dashboard') && !currentPath.includes('/pages')
                );

                if (isDashboardPage) {
                    dashboardLink.classList.add('active');
                    foundMatch = true;
                    console.log(' Dashboard page detected and highlighted for path:', currentPath);
                } else {
                    dashboardLink.classList.remove('active');
                    console.log(' Dashboard link NOT highlighted for path:', currentPath);
                }
            }

            // OTHER LINKS - Handle all other links
            sidebarLinks.forEach(link => {
                const href = link.getAttribute('href');
                if (!href || href === '#') return;

                // Skip Dashboard link - already handled above
                if (href === '/dashboard') return;

                // Check if current path matches this specific link
                if (currentPath === href || currentPath.endsWith(href.replace('/dashboard', ''))) {
                    link.classList.add('active');
                    foundMatch = true;
                    console.log('Exact match found:', href);
                }
                // Check page name matching for other links
                else if (!foundMatch) {
                    const linkPageName = href.split('/').pop().replace('.html', '');
                    if (currentPageName === linkPageName ||
                        (currentPageName && currentPageName.toLowerCase().includes(linkPageName.toLowerCase())) ||
                        (linkPageName && linkPageName.toLowerCase().includes(currentPageName.toLowerCase()))) {
                        link.classList.add('active');
                        foundMatch = true;
                        console.log('Page name match found:', href, 'for page:', currentPageName);
                    }
                }
            });

            // Special cases for specific pages with dropdown management
            if (currentPath.includes('collections') || currentPageName === 'collections') {
                const collectionsLink = document.querySelector('a[href*="collections"]');
                if (collectionsLink) {
                    collectionsLink.classList.add('active');
                    foundMatch = true;
                    console.log('Collections page detected');

                    // Keep inventory dropdown open
                    const inventoryDropdown = document.getElementById('inventory-submenu');
                    const inventoryArrow = document.getElementById('inventory-arrow');
                    if (inventoryDropdown && inventoryArrow) {
                        inventoryDropdown.classList.remove('hidden');
                        inventoryArrow.style.transform = 'rotate(180deg)';
                        console.log('Inventory dropdown kept open for collections');
                    }
                }
            }

            if (currentPath.includes('products') || currentPageName === 'products') {
                const productsLink = document.querySelector('a[href*="products"]');
                if (productsLink) {
                    productsLink.classList.add('active');
                    foundMatch = true;
                    console.log('Products page detected');

                    // Keep inventory dropdown open
                    const inventoryDropdown = document.getElementById('inventory-submenu');
                    const inventoryArrow = document.getElementById('inventory-arrow');
                    if (inventoryDropdown && inventoryArrow) {
                        inventoryDropdown.classList.remove('hidden');
                        inventoryArrow.style.transform = 'rotate(180deg)';
                        console.log('Inventory dropdown kept open for products');
                    }
                }
            }

            if (currentPath.includes('low-stock') || currentPageName === 'low-stock') {
                const lowStockLink = document.querySelector('a[href*="low-stock"]');
                if (lowStockLink) {
                    lowStockLink.classList.add('active');
                    foundMatch = true;
                    console.log('Low Stock page detected');

                    // Keep inventory dropdown open
                    const inventoryDropdown = document.getElementById('inventory-submenu');
                    const inventoryArrow = document.getElementById('inventory-arrow');
                    if (inventoryDropdown && inventoryArrow) {
                        inventoryDropdown.classList.remove('hidden');
                        inventoryArrow.style.transform = 'rotate(180deg)';
                        console.log('Inventory dropdown kept open for low-stock');
                    }
                }
            }

            if (currentPath.includes('product-reviews') || currentPageName === 'reviews') {
                const reviewsLink = document.querySelector('a[href*="product-reviews"]');
                if (reviewsLink) {
                    reviewsLink.classList.add('active');
                    foundMatch = true;
                    console.log('Reviews page detected');

                    // Keep inventory dropdown open
                    const inventoryDropdown = document.getElementById('inventory-submenu');
                    const inventoryArrow = document.getElementById('inventory-arrow');
                    if (inventoryDropdown && inventoryArrow) {
                        inventoryDropdown.classList.remove('hidden');
                        inventoryArrow.style.transform = 'rotate(180deg)';
                        console.log('Inventory dropdown kept open for reviews');
                    }
                }
            }

            if (currentPath.includes('orders') || currentPageName === 'orders') {
                const ordersLink = document.querySelector('a[href*="orders"]');
                if (ordersLink) {
                    ordersLink.classList.add('active');
                    foundMatch = true;
                    console.log('Orders page detected');
                }
            }

            if (currentPath.includes('Customer') || currentPageName === 'Customer') {
                const customerLink = document.querySelector('a[href*="Customer"]');
                if (customerLink) {
                    customerLink.classList.add('active');
                    foundMatch = true;
                    console.log('Customer page detected');
                }
            }

            if (currentPath.includes('Admin') || currentPageName === 'Admin') {
                const adminLink = document.querySelector('a[href*="Admin"]');
                if (adminLink) {
                    adminLink.classList.add('active');
                    foundMatch = true;
                    console.log('Admin page detected');
                }
            }

            if (currentPath.includes('settings') || currentPageName === 'settings') {
                const settingsLink = document.querySelector('a[href*="settings"]');
                if (settingsLink) {
                    settingsLink.classList.add('active');
                    foundMatch = true;
                    console.log('Settings page detected');
                }
            }

            if (currentPath.includes('finance') || currentPageName === 'finance') {
                const financeLink = document.querySelector('a[href*="finance"]');
                if (financeLink) {
                    financeLink.classList.add('active');
                    foundMatch = true;
                    console.log('Finance page detected');

                    // Keep finance dropdown open
                    const financeDropdown = document.getElementById('finance-dropdown-menu');
                    const financeArrow = document.querySelector('#finance-dropdown-btn .dropdown-arrow');
                    if (financeDropdown && financeArrow) {
                        financeDropdown.classList.remove('hidden');
                        financeDropdown.classList.add('show');
                        financeArrow.classList.add('rotated');
                        console.log('Finance dropdown kept open for finance page');
                    }
                }
            }

            if (currentPath.includes('analytics') || currentPageName === 'analytics') {
                const analyticsLink = document.querySelector('a[href*="analytics"]');
                if (analyticsLink) {
                    analyticsLink.classList.add('active');
                    foundMatch = true;
                    console.log('Analytics page detected');

                    // Keep finance dropdown open
                    const financeDropdown = document.getElementById('finance-dropdown-menu');
                    const financeArrow = document.querySelector('#finance-dropdown-btn .dropdown-arrow');
                    if (financeDropdown && financeArrow) {
                        financeDropdown.classList.remove('hidden');
                        financeDropdown.classList.add('show');
                        financeArrow.classList.add('rotated');
                        console.log('Finance dropdown kept open for analytics');
                    }
                }
            }

            if (currentPath.includes('reports') || currentPageName === 'reports') {
                const reportsLink = document.querySelector('a[href*="reports"]');
                if (reportsLink) {
                    reportsLink.classList.add('active');
                    foundMatch = true;
                    console.log('Reports page detected');

                    // Keep finance dropdown open
                    const financeDropdown = document.getElementById('finance-dropdown-menu');
                    const financeArrow = document.querySelector('#finance-dropdown-btn .dropdown-arrow');
                    if (financeDropdown && financeArrow) {
                        financeDropdown.classList.remove('hidden');
                        financeDropdown.classList.add('show');
                        financeArrow.classList.add('rotated');
                        console.log('Finance dropdown kept open for reports');
                    }
                }
            }

            if (currentPath.includes('insights') || currentPageName === 'insights') {
                const insightsLink = document.querySelector('a[href*="insights"]');
                if (insightsLink) {
                    insightsLink.classList.add('active');
                    foundMatch = true;
                    console.log('Insights page detected');

                    // Keep finance dropdown open
                    const financeDropdown = document.getElementById('finance-dropdown-menu');
                    const financeArrow = document.querySelector('#finance-dropdown-btn .dropdown-arrow');
                    if (financeDropdown && financeArrow) {
                        financeDropdown.classList.remove('hidden');
                        financeDropdown.classList.add('show');
                        financeArrow.classList.add('rotated');
                        console.log('Finance dropdown kept open for insights');
                    }
                }
            }

            if (currentPath.includes('expenses') || currentPageName === 'expenses') {
                const expensesLink = document.querySelector('a[href*="expenses"]');
                if (expensesLink) {
                    expensesLink.classList.add('active');
                    foundMatch = true;
                    console.log('Expenses page detected');

                    // Keep finance dropdown open
                    const financeDropdown = document.getElementById('finance-dropdown-menu');
                    const financeArrow = document.querySelector('#finance-dropdown-btn .dropdown-arrow');
                    if (financeDropdown && financeArrow) {
                        financeDropdown.classList.remove('hidden');
                        financeDropdown.classList.add('show');
                        financeArrow.classList.add('rotated');
                        console.log('Finance dropdown kept open for expenses');
                    }
                }
            }

            if (currentPath.includes('pos') || currentPageName === 'pos') {
                const posLink = document.querySelector('a[href*="pos"]');
                if (posLink) {
                    posLink.classList.add('active');
                    foundMatch = true;
                    console.log('POS page detected');
                }
            }
        }

        // Run on page load
        document.addEventListener('DOMContentLoaded', highlightActivePage);

        // Also run when navigation changes (for SPA-like behavior)
        window.addEventListener('popstate', highlightActivePage);

    </script>
</body>
<script src="/js/sidebar.js"></script>

</html>