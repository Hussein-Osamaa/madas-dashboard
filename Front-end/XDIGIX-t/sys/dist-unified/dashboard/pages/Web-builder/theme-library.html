<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Theme Library - MADAS Website Builder</title>
    <script src="https://cdn.tailwindcss.com"></script>
    }

    // Close sidebar when clicking outside on mobile
    document.addEventListener('click', (e) => {
    if (window.innerWidth < 1024 && !sidebar.contains(e.target) && !toggleBtn.contains(e.target)) {
        sidebar.classList.add('-translate-x-full'); } }); </script>

        <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
            rel="stylesheet">

        <!-- Firebase SDK -->
        <script type="module">
            import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
            import { getFirestore, collection, getDocs, doc, deleteDoc, updateDoc, addDoc, query, orderBy, where } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
            import { getAuth, onAuthStateChanged, signInAnonymously } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

            // Firebase configuration - Use actual MADAS config
            const firebaseConfig = {
                apiKey: "AIzaSyC-ls1TrvSkrw71KqmB_kHYgPoj0H550a8",
                authDomain: "madas-store.firebaseapp.com",
                projectId: "madas-store",
                storageBucket: "madas-store.firebasestorage.app",
                messagingSenderId: "527071300010",
                appId: "1:527071300010:web:7470e2204065b4590583d3"
            };

            // Initialize Firebase
            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);
            const auth = getAuth(app);

            console.log('✅ Firebase initialized in theme library');

            // Make Firebase available globally
            window.firebase = { db, auth, collection, getDocs, doc, deleteDoc, updateDoc, addDoc, query, orderBy, where, onAuthStateChanged, signInAnonymously };
        </script>
        <style>
            :root {
                /* MADAS Brand Colors - Enhanced */
                --madas-primary: #2b4a24;
                --madas-secondary: #f0c9e0;
                --madas-accent: #f05a2c;
                --madas-success: #10b981;
                --madas-warning: #f59e0b;
                --madas-danger: #ef4444;
                --madas-dark: #171817;
                --madas-light: #f8fafc;
                --madas-gray: #64748b;
                --madas-border: #e2e8f0;

                /* Gradients */
                --gradient-primary: linear-gradient(135deg, #2b4a24 0%, #f0c9e0 100%);
                --gradient-card: linear-gradient(145deg, #ffffff 0%, #f8fafc 100%);
                --gradient-hover: linear-gradient(145deg, #f0c9e0 0%, #ffffff 100%);
            }

            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            body {
                font-family: 'Inter', sans-serif;
                background: var(--madas-light);
                color: var(--madas-dark);
                line-height: 1.6;
            }

            /* Enhanced Animations */
            .theme-card,
            .theme-store-card {
                transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
                border: 1px solid var(--madas-border);
                background: var(--gradient-card);
            }

            .theme-card:hover,
            .theme-store-card:hover {
                transform: translateY(-8px) scale(1.02);
                box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
                border-color: var(--madas-secondary);
            }

            /* Glassmorphism Effect */
            .glass-effect {
                background: rgba(255, 255, 255, 0.25);
                backdrop-filter: blur(10px);
                border: 1px solid rgba(255, 255, 255, 0.18);
            }

            /* Custom Scrollbar */
            ::-webkit-scrollbar {
                width: 8px;
            }

            ::-webkit-scrollbar-track {
                background: #f1f5f9;
            }

            ::-webkit-scrollbar-thumb {
                background: var(--madas-primary);
                border-radius: 4px;
            }

            ::-webkit-scrollbar-thumb:hover {
                background: var(--madas-accent);
            }

            /* Status Badges */
            .status-badge {
                position: relative;
                overflow: hidden;
            }

            .status-badge::before {
                content: '';
                position: absolute;
                top: 0;
                left: -100%;
                width: 100%;
                height: 100%;
                background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
                transition: left 0.5s;
            }

            .status-badge:hover::before {
                left: 100%;
            }

            /* Button Enhancements */
            .btn-primary {
                background: var(--gradient-primary);
                color: white;
                border: none;
                padding: 12px 24px;
                border-radius: 12px;
                font-weight: 600;
                transition: all 0.3s ease;
                position: relative;
                overflow: hidden;
            }

            .btn-primary::before {
                content: '';
                position: absolute;
                top: 0;
                left: -100%;
                width: 100%;
                height: 100%;
                background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
                transition: left 0.5s;
            }

            .btn-primary:hover::before {
                left: 100%;
            }

            .btn-primary:hover {
                transform: translateY(-2px);
                box-shadow: 0 10px 25px rgba(43, 74, 36, 0.3);
            }

            .btn-success {
                background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                color: white;
                border: none;
                padding: 12px 24px;
                border-radius: 12px;
                font-weight: 600;
                transition: all 0.3s ease;
                position: relative;
                overflow: hidden;
            }

            .btn-success::before {
                content: '';
                position: absolute;
                top: 0;
                left: -100%;
                width: 100%;
                height: 100%;
                background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
                transition: left 0.5s;
            }

            .btn-success:hover::before {
                left: 100%;
            }

            .btn-success:hover {
                transform: translateY(-2px);
                box-shadow: 0 10px 25px rgba(16, 185, 129, 0.3);
            }

            /* Search Enhancement */
            .search-container {
                position: relative;
            }

            .search-container::before {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: var(--gradient-primary);
                border-radius: 16px;
                padding: 2px;
                z-index: -1;
            }

            .search-input {
                background: white;
                border: none;
                border-radius: 14px;
                padding: 16px 20px 16px 50px;
                width: 100%;
                font-size: 16px;
                transition: all 0.3s ease;
            }

            .search-input:focus {
                outline: none;
                box-shadow: 0 0 0 4px rgba(240, 201, 224, 0.3);
            }

            /* Filter Enhancements */
            .filter-card {
                background: var(--gradient-card);
                border: 1px solid var(--madas-border);
                border-radius: 16px;
                padding: 24px;
                transition: all 0.3s ease;
            }

            .filter-card:hover {
                border-color: var(--madas-secondary);
                box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            }

            /* Theme Preview Cards */
            .theme-preview {
                position: relative;
                overflow: hidden;
                border-radius: 16px;
                height: 200px;
                background: var(--gradient-primary);
            }

            .theme-preview::after {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: linear-gradient(45deg, rgba(255, 255, 255, 0.1) 25%, transparent 25%, transparent 75%, rgba(255, 255, 255, 0.1) 75%);
                background-size: 20px 20px;
                animation: move 2s linear infinite;
            }

            @keyframes move {
                0% {
                    background-position: 0 0;
                }

                100% {
                    background-position: 20px 20px;
                }
            }

            /* Responsive Grid */
            .theme-grid {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
                gap: 24px;
            }

            @media (max-width: 768px) {
                .theme-grid {
                    grid-template-columns: 1fr;
                    gap: 16px;
                }
            }

            /* Loading Animation */
            .loading-skeleton {
                background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
                background-size: 200% 100%;
                animation: loading 1.5s infinite;
            }

            @keyframes loading {
                0% {
                    background-position: 200% 0;
                }

                100% {
                    background-position: -200% 0;
                }
            }

            /* Notification Enhancements */
            .notification {
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 16px 24px;
                border-radius: 12px;
                color: white;
                font-weight: 500;
                z-index: 1000;
                transform: translateX(400px);
                transition: transform 0.3s ease;
            }

            .notification.show {
                transform: translateX(0);
            }

            .notification.success {
                background: var(--madas-success);
            }

            .notification.error {
                background: var(--madas-danger);
            }

            .notification.info {
                background: var(--madas-accent);
            }

            /* Filter Chips */
            .filter-chip {
                display: flex;
                align-items: center;
                padding: 8px 16px;
                background: var(--madas-light);
                border: 1px solid var(--madas-border);
                border-radius: 20px;
                color: var(--madas-gray);
                font-size: 14px;
                font-weight: 500;
                transition: all 0.3s ease;
                cursor: pointer;
            }

            .filter-chip:hover {
                background: var(--madas-secondary);
                border-color: var(--madas-primary);
                color: var(--madas-primary);
            }

            .filter-chip.active {
                background: var(--madas-primary);
                border-color: var(--madas-primary);
                color: white;
            }

            .filter-chip.active:hover {
                background: var(--madas-accent);
                border-color: var(--madas-accent);
            }

            /* Theme Slider Styles */
            .themes-slider {
                position: relative;
                overflow: hidden;
                border-radius: 20px;
            }

            .themes-slider-container {
                display: flex;
                transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1);
                gap: 24px;
            }

            .themes-slider-item {
                flex: 0 0 auto;
                width: 320px;
            }

            .slider-controls {
                position: absolute;
                top: 50%;
                transform: translateY(-50%);
                z-index: 10;
                background: rgba(255, 255, 255, 0.9);
                backdrop-filter: blur(10px);
                border: 1px solid var(--madas-border);
                border-radius: 50%;
                width: 48px;
                height: 48px;
                display: flex;
                align-items: center;
                justify-content: center;
                cursor: pointer;
                transition: all 0.3s ease;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            }

            .slider-controls:hover {
                background: var(--madas-primary);
                color: white;
                transform: translateY(-50%) scale(1.1);
                box-shadow: 0 8px 20px rgba(43, 74, 36, 0.3);
            }

            .slider-controls.prev {
                left: 16px;
            }

            .slider-controls.next {
                right: 16px;
            }

            .slider-controls:disabled {
                opacity: 0.5;
                cursor: not-allowed;
                transform: translateY(-50%);
            }

            .slider-controls:disabled:hover {
                background: rgba(255, 255, 255, 0.9);
                color: var(--madas-gray);
                transform: translateY(-50%);
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            }

            .slider-dots {
                display: flex;
                justify-content: center;
                gap: 8px;
                margin-top: 24px;
            }

            .slider-dot {
                width: 12px;
                height: 12px;
                border-radius: 50%;
                background: var(--madas-border);
                cursor: pointer;
                transition: all 0.3s ease;
            }

            .slider-dot.active {
                background: var(--madas-primary);
                transform: scale(1.2);
            }

            /* Modal Styles */
            .modal-overlay {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.5);
                z-index: 9999;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .modal-content {
                background: white;
                border-radius: 16px;
                max-width: 800px;
                width: 90%;
                max-height: 90vh;
                overflow-y: auto;
                box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
            }

            /* Animation for theme deletion */
            @keyframes fadeOut {
                from {
                    opacity: 1;
                    transform: scale(1);
                }

                to {
                    opacity: 0;
                    transform: scale(0.8);
                }
            }

            .slider-dot:hover {
                background: var(--madas-secondary);
            }

            /* Responsive adjustments */
            @media (max-width: 768px) {
                .themes-slider-item {
                    width: 280px;
                }

                .slider-controls {
                    width: 40px;
                    height: 40px;
                }

                .slider-controls.prev {
                    left: -20px;
                }

                .slider-controls.next {
                    right: -20px;
                }
            }

            /* Fade animations */
            @keyframes fadeIn {
                from {
                    opacity: 0;
                    transform: translateY(20px);
                }

                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            @keyframes fadeOut {
                from {
                    opacity: 1;
                    transform: translateY(0);
                }

                to {
                    opacity: 0;
                    transform: translateY(-20px);
                }
            }

            /* Enhanced Sidebar Link Styles */
            .sidebar-link {
                position: relative;
                transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                overflow: hidden;
                color: var(--text-main) !important;
            }





            /* Override Tailwind text color classes */
            .sidebar-link.text-gray-700,
            .sidebar-link.text-gray-600 {
                color: var(--text-main) !important;
            }

            /* Dark mode text color for sidebar links */

            body.dark-mode .sidebar-link {
                color: var(--text-main) !important;
            }

            .sidebar-link:hover {
                transform: translateX(6px) scale(1.02);
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
                background: var(--madas-light);
            }

            .sidebar-link:active {
                transform: translateX(3px) scale(0.98);
                transition: all 0.1s ease;
            }

            /* DEBUG: Bright Active state for current page */
            .sidebar-link.active {
                background: #ffeb3b !important;
                color: #d32f2f !important;
                font-weight: 600;
                border: 2px solid #ff5722 !important;
            }

            .sidebar-link.active .material-icons {
                color: #d32f2f !important;
            }

            /* DEBUG: Bright Submenu active state */
            .sidebar-link.submenu-link.active {
                background: #4caf50 !important;
                color: #ffffff !important;
                font-weight: 600;
                border: 2px solid #2e7d32 !important;
            }

            .sidebar-link.submenu-link.active .material-icons {
                color: #ffffff !important;
            }

            /* Simple Dropdown Menu Styling - No 3D Effects */
            .inventory-submenu,
            .finance-dropdown-menu,
            .ecommerce-dropdown-menu {
                background: transparent;
                border: none;
                border-radius: 0;
                box-shadow: none;
                margin: 0;
                padding: 0;
            }

            /* DEBUG: Force dropdown styling even when hidden */
            .inventory-submenu.hidden {
                background: #f0f9ff !important;
                border: 2px solid #3b82f6 !important;
                border-radius: 8px !important;
                box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06) !important;
                margin: 8px 0 !important;
                padding: 8px 0 !important;
            }

            .finance-dropdown-menu.hidden {
                background: #fef3c7 !important;
                border: 2px solid #f59e0b !important;
                border-radius: 8px !important;
                box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06) !important;
                margin: 8px 0 !important;
                padding: 8px 0 !important;
            }

            /* Simple Dropdown Items - Same as Main Navigation */
            .inventory-submenu .sidebar-link,
            .finance-dropdown-menu .sidebar-link,
            .ecommerce-dropdown-menu .sidebar-link {
                padding: 12px 16px;
                margin: 0;
                border-radius: 0;
                transition: all 0.2s ease;
            }

            .inventory-submenu .sidebar-link:hover,
            .finance-dropdown-menu .sidebar-link:hover,
            .ecommerce-dropdown-menu .sidebar-link:hover {
                background: var(--madas-light);
                color: var(--madas-primary);
            }

            /* Ensure dropdown hover maintains color in dark mode */
            body.dark-mode .inventory-submenu .sidebar-link:hover,
            body.dark-mode .finance-dropdown-menu .sidebar-link:hover,
            body.dark-mode .ecommerce-dropdown-menu .sidebar-link:hover {
                color: var(--madas-primary) !important;
            }

            /* Dark mode submenu text color */
            body.dark-mode .sidebar-link.submenu-link {
                color: var(--text-main) !important;
            }

            body.dark-mode .sidebar-link.submenu-link:hover {
                color: var(--text-main) !important;
            }

            /* Dropdown Items Active State - EXACT Same as Main Navigation */
            .inventory-submenu .sidebar-link.active,
            .finance-dropdown-menu .sidebar-link.active,
            .ecommerce-dropdown-menu .sidebar-link.active {
                background: var(--madas-light) !important;
                color: var(--madas-primary) !important;
                font-weight: 600 !important;
            }

            .inventory-submenu .sidebar-link.active .material-icons,
            .finance-dropdown-menu .sidebar-link.active .material-icons,
            .ecommerce-dropdown-menu .sidebar-link.active .material-icons {
                color: var(--madas-primary) !important;
            }

            /* Original Dropdown Button */
            .inventory-dropdown button,
            .finance-dropdown button,
            .ecommerce-dropdown button {
                background: transparent;
                border: none;
                padding: 12px 16px;
                border-radius: 8px;
                transition: all 0.2s ease;
                width: 100%;
                text-align: left;
            }

            .inventory-dropdown button:hover,
            .finance-dropdown button:hover,
            .ecommerce-dropdown button:hover {
                background: #f3f4f6;
            }

            /* Original Dropdown Arrow */
            .dropdown-arrow {
                transition: transform 0.2s ease;
            }

            .dropdown-arrow.rotate {
                transform: rotate(180deg);
            }

            /* Enhanced dropdown menu container */
            .inventory-submenu:not(.hidden),
            .finance-dropdown-menu.show {
                background: rgba(255, 255, 255, 0.05);
                backdrop-filter: blur(10px);
                -webkit-backdrop-filter: blur(10px);
                border: 1px solid rgba(39, 73, 31, 0.1);
                border-radius: 12px;
                box-shadow:
                    0 8px 32px rgba(39, 73, 31, 0.1),
                    inset 0 1px 0 rgba(255, 255, 255, 0.1);
            }

            /* Enhanced dropdown button hover */
            .inventory-dropdown button:hover,
            .finance-dropdown button:hover,
            .ecommerce-dropdown button:hover {
                background: rgba(39, 73, 31, 0.05);
                backdrop-filter: blur(5px);
                -webkit-backdrop-filter: blur(5px);
                border-radius: 12px;
                transform: translateX(2px);
            }

            .sidebar-link.active:hover {
                transform: translateX(6px) scale(1.02);
                box-shadow: 0 6px 20px rgba(39, 73, 31, 0.4);
            }

            /* Icon animation on hover */
            .sidebar-link:hover .material-icons {
                transform: scale(1.1) rotate(2deg);
                transition: all 0.3s ease;
            }

            /* Submenu link enhancements */
            .sidebar-link.submenu-link {
                position: relative;
                margin-left: 1rem;
                border-left: 2px solid transparent;
                transition: all 0.3s ease;
                color: var(--text-main) !important;
            }

            .sidebar-link.submenu-link:hover {
                border-left-color: var(--madas-primary);
                background: var(--madas-light);
                transform: translateX(8px);
                color: var(--text-main) !important;
            }

            .sidebar-link.submenu-link.active {
                border-left-color: var(--madas-primary);
                background: var(--madas-light);
                color: var(--madas-primary);
            }

            /* Dark mode submenu text color */
            body.dark-mode .sidebar-link.submenu-link {
                color: var(--text-main) !important;
            }

            body.dark-mode .sidebar-link.submenu-link:hover {
                color: var(--text-main) !important;
            }

            /* Unified Dropdown Menu Styling - No 3D Effects */
            .inventory-submenu,
            .finance-dropdown-menu,
            .ecommerce-dropdown-menu {
                background: transparent !important;
                border: none !important;
                border-radius: 0 !important;
                box-shadow: none !important;
                margin: 0 !important;
                padding: 0 !important;
            }

            /* Unified Dropdown Items - Same as Main Navigation */
            .inventory-submenu .sidebar-link,
            .finance-dropdown-menu .sidebar-link,
            .ecommerce-dropdown-menu .sidebar-link {
                padding: 10px 14px !important;
                margin: 0 !important;
                border-radius: 0 !important;
                transition: all 0.2s ease !important;
            }

            .inventory-submenu .sidebar-link:hover,
            .finance-dropdown-menu .sidebar-link:hover,
            .ecommerce-dropdown-menu .sidebar-link:hover {
                background: var(--madas-light) !important;
                color: var(--madas-primary) !important;
            }

            /* Ensure dropdown hover maintains color in dark mode */
            body.dark-mode .inventory-submenu .sidebar-link:hover,
            body.dark-mode .finance-dropdown-menu .sidebar-link:hover,
            body.dark-mode .ecommerce-dropdown-menu .sidebar-link:hover {
                color: var(--madas-primary) !important;
            }


            /* Ensure all dropdown text sizes are uniform */
            .inventory-submenu .sidebar-link span,
            .finance-dropdown-menu .sidebar-link span,
            .ecommerce-dropdown-menu .sidebar-link span {
                font-size: 0.8rem !important;
            }

            /* Make dropdown icons smaller */
            .inventory-submenu .material-icons,
            .finance-dropdown-menu .material-icons,
            .ecommerce-dropdown-menu .material-icons {
                font-size: 18px !important;
            }

            /* Unified Dropdown Items Active State - EXACT Same as Main Navigation */
            .inventory-submenu .sidebar-link.active,
            .finance-dropdown-menu .sidebar-link.active,
            .ecommerce-dropdown-menu .sidebar-link.active {
                background: var(--madas-light) !important;
                color: var(--madas-primary) !important;
                font-weight: 600 !important;
            }

            .inventory-submenu .sidebar-link.active .material-icons,
            .finance-dropdown-menu .sidebar-link.active .material-icons,
            .ecommerce-dropdown-menu .sidebar-link.active .material-icons {
                color: var(--madas-primary) !important;
            }

            /* Unified Dropdown Button Styling */
            .inventory-dropdown button,
            .finance-dropdown button,
            .ecommerce-dropdown button {
                background: transparent !important;
                border: none !important;
                padding: 10px 14px !important;
                border-radius: 8px !important;
                transition: all 0.2s ease !important;
                width: 100% !important;
                text-align: left !important;
            }

            .inventory-dropdown button:hover,
            .finance-dropdown button:hover,
            .ecommerce-dropdown button:hover {
                background: var(--madas-light) !important;
            }

            /* Unified Dropdown Arrow */
            .dropdown-arrow {
                transition: transform 0.2s ease !important;
            }

            .dropdown-arrow.rotate {
                transform: rotate(180deg) !important;
            }

            /* Unified Visible States for Dropdowns - No 3D Effects */
            .inventory-submenu:not(.hidden) {
                opacity: 1 !important;
                transform: translateY(0) !important;
                pointer-events: auto !important;
                background: transparent !important;
                border: none !important;
                border-radius: 0 !important;
                box-shadow: none !important;
                margin: 0 !important;
                padding: 0 !important;
            }

            .finance-dropdown-menu.show {
                display: block !important;
                animation: slideDown 0.3s ease !important;
                background: transparent !important;
                border: none !important;
                border-radius: 0 !important;
                box-shadow: none !important;
                margin: 0 !important;
                padding: 0 !important;
            }

            .ecommerce-dropdown-menu.show {
                display: block !important;
                animation: slideDown 0.3s ease !important;
                background: transparent !important;
                border: none !important;
                border-radius: 0 !important;
                box-shadow: none !important;
                margin: 0 !important;
                padding: 0 !important;
            }
        </style>
</head>

<body>
    <!-- Modern Header with Enhanced Design -->
    <!-- Header -->
    <header class="bg-white shadow-sm border-b border-gray-200 fixed top-0 left-0 right-0 z-40 h-16">
        <div class="flex items-center justify-between h-full px-4 lg:px-6">
            <div class="flex items-center space-x-4">
                <button id="menu-toggle" class="lg:hidden text-[var(--madas-primary)] p-2 rounded-lg hover:bg-gray-100">
                    <span class="material-icons">menu</span>
                </button>
                <div class="flex items-center space-x-3">
                    <div class="w-8 h-8 bg-[var(--madas-primary)] rounded-lg flex items-center justify-center">
                        <span class="text-white font-bold text-sm">M</span>
                    </div>
                    <div>
                        <h1 id="business-name" class="text-xl font-bold text-[var(--madas-primary)]">Loading...</h1>
                        <button id="plan-badge" onclick="window.location.href='/pages/settings.html#plans'"
                            class="text-xs px-2 py-0.5 rounded-full bg-blue-100 text-blue-800 hover:bg-blue-200 transition-colors cursor-pointer">
                            Loading Plan...
                        </button>
                    </div>
                </div>
            </div>

            <div class="flex items-center space-x-4">
                <div class="hidden md:flex items-center space-x-2 text-sm text-gray-600">
                    <span class="material-icons text-[var(--madas-primary)]">notifications</span>
                    <span class="bg-red-500 text-white text-xs rounded-full px-2 py-1">3</span>
                </div>
                <div class="flex items-center space-x-3">
                    <!-- Dark mode toggle button -->
                    <button class="dark-toggle" id="darkToggle" title="Toggle dark mode">
                        <svg id="darkToggleIcon" viewBox="0 0 24 24">
                            <path
                                d="M12 2a1 1 0 0 1 1 1v1a1 1 0 1 1-2 0V3a1 1 0 0 1 1-1zm5.657 3.343a1 1 0 0 1 1.414 0l.707.707a1 1 0 1 1-1.414 1.414l-.707-.707a1 1 0 0 1 0-1.414zM21 11a1 1 0 1 1 0 2h-1a1 1 0 1 1 0-2h1zm-2.929 7.071a1 1 0 0 1 0 1.414l-.707.707a1 1 0 1 1-1.414-1.414l.707-.707a1 1 0 0 1 1.414 0zM12 20a1 1 0 0 1-1-1v-1a1 1 0 1 1 2 0v1a1 1 0 0 1-1 1zm-7.071-2.929a1 1 0 0 1-1.414 0l-.707-.707a1 1 0 1 1 1.414-1.414l.707.707a1 1 0 0 1 0 1.414zM4 13a1 1 0 1 1 0-2H3a1 1 0 1 1 0 2h1zm2.343-7.657a1 1 0 0 1 0 1.414l-.707.707A1 1 0 1 1 4.222 6.05l.707-.707a1 1 0 0 1 1.414 0zM12 6a6 6 0 1 1 0 12A6 6 0 0 1 12 6z" />
                        </svg>
                    </button>
                    <div class="hidden md:block text-right">
                        <p id="user-name" class="text-sm font-medium text-gray-900">Loading...</p>
                        <p id="user-email" class="text-xs text-gray-500">loading@example.com</p>
                    </div>
                    <button id="profile-btn"
                        class="w-8 h-8 bg-[var(--madas-accent)] rounded-full flex items-center justify-center hover:bg-yellow-400 transition-colors cursor-pointer">
                        <span class="text-[var(--madas-primary)] font-bold text-sm" id="user-initial">U</span>
                    </button>
                    <button id="logout-btn"
                        class="text-gray-500 hover:text-[var(--madas-primary)] p-2 rounded-lg hover:bg-gray-100">
                        <span class="material-icons">logout</span>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content Area -->
    <main class="min-h-screen bg-gradient-to-br from-[var(--madas-light)] to-white">
        <div class="container mx-auto px-6 py-12">
            <!-- Quick Stats Bar -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-12">
                <div class="bg-white rounded-2xl p-6 shadow-lg border border-[var(--madas-border)]">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-[var(--madas-gray)] text-sm font-medium">Total Themes</p>
                            <p class="text-2xl font-bold text-[var(--madas-dark)]">12</p>
                        </div>
                        <div
                            class="w-12 h-12 bg-[var(--madas-secondary)]/20 rounded-xl flex items-center justify-center">
                            <span class="material-icons text-[var(--madas-primary)]">palette</span>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-2xl p-6 shadow-lg border border-[var(--madas-border)]">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-[var(--madas-gray)] text-sm font-medium">Published</p>
                            <p class="text-2xl font-bold text-[var(--madas-success)]">3</p>
                        </div>
                        <div class="w-12 h-12 bg-green-100 rounded-xl flex items-center justify-center">
                            <span class="material-icons text-green-600">publish</span>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-2xl p-6 shadow-lg border border-[var(--madas-border)]">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-[var(--madas-gray)] text-sm font-medium">Drafts</p>
                            <p class="text-2xl font-bold text-[var(--madas-warning)]">9</p>
                        </div>
                        <div class="w-12 h-12 bg-yellow-100 rounded-xl flex items-center justify-center">
                            <span class="material-icons text-yellow-600">edit</span>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-2xl p-6 shadow-lg border border-[var(--madas-border)]">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-[var(--madas-gray)] text-sm font-medium">Views Today</p>
                            <p class="text-2xl font-bold text-[var(--madas-accent)]">1.2K</p>
                        </div>
                        <div class="w-12 h-12 bg-orange-100 rounded-xl flex items-center justify-center">
                            <span class="material-icons text-orange-600">visibility</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- My Theme Library Section -->
            <div class="mb-16">
                <div class="flex flex-col lg:flex-row items-start lg:items-center justify-between mb-8 gap-6">
                    <div class="flex-1">
                        <div class="flex items-center space-x-3 mb-3">
                            <div class="w-8 h-8 bg-[var(--madas-primary)] rounded-lg flex items-center justify-center">
                                <span class="material-icons text-white text-sm">folder</span>
                            </div>
                            <h2 class="text-3xl font-bold text-[var(--madas-dark)]">My Themes</h2>
                        </div>
                        <p class="text-[var(--madas-gray)] text-lg">Your personal collection of custom themes. Switch
                            between themes by publishing them to your store.</p>
                    </div>
                    <div class="flex items-center space-x-4">
                        <button onclick="showPublishedThemes()"
                            class="btn-secondary flex items-center space-x-2 px-6 py-4">
                            <span class="material-icons text-sm">visibility</span>
                            <span>View Published</span>
                        </button>
                        <button onclick="quickPublishTheme()" class="btn-success flex items-center space-x-2 px-6 py-4">
                            <span class="material-icons text-sm">publish</span>
                            <span>Quick Publish</span>
                        </button>
                        <button id="create-new-theme" class="btn-primary flex items-center space-x-3 px-8 py-4 text-lg"
                            onclick="showCreateThemeModal();">
                            <span class="material-icons">add_circle</span>
                            <span>Create New Theme</span>
                        </button>
                    </div>
                </div>

                <!-- Firebase Themes Slider -->
                <div class="themes-slider">
                    <!-- Loading State -->
                    <div id="themes-loading" class="flex items-center justify-center py-12">
                        <div class="text-center">
                            <div
                                class="w-16 h-16 bg-[var(--madas-primary)]/20 rounded-2xl flex items-center justify-center mx-auto mb-4">
                                <span
                                    class="material-icons text-[var(--madas-primary)] text-3xl animate-spin">refresh</span>
                            </div>
                            <p class="text-[var(--madas-gray)] text-lg">Loading your themes...</p>
                        </div>
                    </div>

                    <!-- Empty State -->
                    <div id="themes-empty" class="hidden flex items-center justify-center py-12">
                        <div class="text-center max-w-md">
                            <div
                                class="w-20 h-20 bg-[var(--madas-secondary)]/20 rounded-2xl flex items-center justify-center mx-auto mb-6">
                                <span class="material-icons text-[var(--madas-primary)] text-4xl">palette</span>
                            </div>
                            <h3 class="text-xl font-bold text-[var(--madas-dark)] mb-3">No themes yet</h3>
                            <p class="text-[var(--madas-gray)] mb-6">Create your first theme to get started with
                                building your website.</p>
                            <button id="create-first-theme" class="btn-primary">
                                <span class="material-icons text-sm mr-2">add_circle</span>
                                Create Your First Theme
                            </button>
                        </div>
                    </div>

                    <!-- Slider Container -->
                    <div class="themes-slider-container hidden" id="themes-slider-container">
                        <!-- Themes will be dynamically loaded here -->
                    </div>

                    <!-- Slider Controls -->
                    <button class="slider-controls prev hidden" id="themes-prev-btn">
                        <span class="material-icons">chevron_left</span>
                    </button>
                    <button class="slider-controls next hidden" id="themes-next-btn">
                        <span class="material-icons">chevron_right</span>
                    </button>

                    <!-- Slider Dots -->
                    <div class="slider-dots hidden" id="themes-slider-dots">
                        <!-- Dots will be generated by JavaScript -->
                    </div>
                </div>
            </div>

            <!-- MADAS Theme Store Section -->
            <div class="mb-16">
                <div class="flex flex-col lg:flex-row items-start lg:items-center justify-between mb-8 gap-6">
                    <div class="flex-1">
                        <div class="flex items-center space-x-3 mb-3">
                            <div class="w-8 h-8 bg-[var(--madas-accent)] rounded-lg flex items-center justify-center">
                                <span class="material-icons text-white text-sm">store</span>
                            </div>
                            <h2 class="text-3xl font-bold text-[var(--madas-dark)]">Theme Store</h2>
                        </div>
                        <p class="text-[var(--madas-gray)] text-lg">Discover professionally designed themes with core
                            features you can easily customize—no coding needed.</p>
                    </div>
                    <div class="flex items-center space-x-3">
                        <div
                            class="flex items-center space-x-2 bg-white rounded-xl px-4 py-2 border border-[var(--madas-border)]">
                            <span class="material-icons text-[var(--madas-primary)] text-sm">filter_list</span>
                            <span class="text-sm font-medium text-[var(--madas-dark)]">Filters</span>
                        </div>
                        <button
                            class="text-sm text-[var(--madas-gray)] hover:text-[var(--madas-primary)] transition-colors">
                            Reset all
                        </button>
                    </div>
                </div>

                <!-- Enhanced Search and Filters -->
                <div class="bg-white rounded-2xl p-6 shadow-lg border border-[var(--madas-border)] mb-8">
                    <div class="flex flex-col lg:flex-row gap-6">
                        <!-- Search Bar -->
                        <div class="flex-1">
                            <div class="search-container">
                                <input type="text" placeholder="Search themes, categories, or features..."
                                    class="search-input">
                                <span
                                    class="material-icons absolute left-4 top-1/2 transform -translate-y-1/2 text-[var(--madas-gray)]">search</span>
                            </div>
                        </div>

                        <!-- Quick Filters -->
                        <div class="flex items-center space-x-3">
                            <button class="filter-chip active" data-filter="all">
                                <span class="material-icons text-sm mr-1">apps</span>
                                All Themes
                            </button>
                            <button class="filter-chip" data-filter="free">
                                <span class="material-icons text-sm mr-1">free_breakfast</span>
                                Free
                            </button>
                            <button class="filter-chip" data-filter="premium">
                                <span class="material-icons text-sm mr-1">workspace_premium</span>
                                Premium
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Enhanced Filter Sidebar and Theme Grid -->
                <div class="flex flex-col lg:flex-row gap-8">
                    <!-- Enhanced Filter Sidebar -->
                    <div class="w-full lg:w-80 flex-shrink-0">
                        <div class="filter-card sticky top-8">
                            <div class="flex items-center space-x-3 mb-6">
                                <div
                                    class="w-8 h-8 bg-[var(--madas-primary)] rounded-lg flex items-center justify-center">
                                    <span class="material-icons text-white text-sm">tune</span>
                                </div>
                                <h3 class="text-xl font-bold text-[var(--madas-dark)]">Filters</h3>
                            </div>

                            <div class="space-y-8">
                                <!-- Price Filter -->
                                <div>
                                    <h4 class="font-semibold text-[var(--madas-dark)] mb-4 flex items-center">
                                        <span
                                            class="material-icons text-sm mr-2 text-[var(--madas-primary)]">attach_money</span>
                                        Price Range
                                    </h4>
                                    <div class="space-y-3">
                                        <label
                                            class="flex items-center p-3 rounded-xl hover:bg-[var(--madas-light)] transition-colors cursor-pointer">
                                            <input type="checkbox"
                                                class="w-4 h-4 text-[var(--madas-primary)] bg-gray-100 border-gray-300 rounded focus:ring-[var(--madas-primary)] focus:ring-2">
                                            <div class="ml-3 flex-1">
                                                <span class="text-sm font-medium text-[var(--madas-dark)]">Free</span>
                                                <span class="text-xs text-[var(--madas-gray)] ml-2">(21 themes)</span>
                                            </div>
                                        </label>
                                        <label
                                            class="flex items-center p-3 rounded-xl hover:bg-[var(--madas-light)] transition-colors cursor-pointer">
                                            <input type="checkbox"
                                                class="w-4 h-4 text-[var(--madas-primary)] bg-gray-100 border-gray-300 rounded focus:ring-[var(--madas-primary)] focus:ring-2">
                                            <div class="ml-3 flex-1">
                                                <span
                                                    class="text-sm font-medium text-[var(--madas-dark)] flex items-center">
                                                    Premium
                                                    <span
                                                        class="material-icons text-xs ml-1 text-[var(--madas-accent)]">workspace_premium</span>
                                                </span>
                                                <span class="text-xs text-[var(--madas-gray)] ml-2">(0 themes)</span>
                                            </div>
                                        </label>
                                    </div>
                                </div>

                                <!-- Category Filter -->
                                <div>
                                    <h4 class="font-semibold text-[var(--madas-dark)] mb-4 flex items-center">
                                        <span
                                            class="material-icons text-sm mr-2 text-[var(--madas-primary)]">category</span>
                                        Categories
                                    </h4>
                                    <div class="space-y-3">
                                        <label
                                            class="flex items-center p-3 rounded-xl hover:bg-[var(--madas-light)] transition-colors cursor-pointer">
                                            <input type="checkbox"
                                                class="w-4 h-4 text-[var(--madas-primary)] bg-gray-100 border-gray-300 rounded focus:ring-[var(--madas-primary)] focus:ring-2">
                                            <div class="ml-3 flex-1">
                                                <span
                                                    class="text-sm font-medium text-[var(--madas-dark)]">Electronics</span>
                                                <span class="text-xs text-[var(--madas-gray)] ml-2">(1 theme)</span>
                                            </div>
                                        </label>
                                        <label
                                            class="flex items-center p-3 rounded-xl hover:bg-[var(--madas-light)] transition-colors cursor-pointer">
                                            <input type="checkbox"
                                                class="w-4 h-4 text-[var(--madas-primary)] bg-gray-100 border-gray-300 rounded focus:ring-[var(--madas-primary)] focus:ring-2">
                                            <div class="ml-3 flex-1">
                                                <span
                                                    class="text-sm font-medium text-[var(--madas-dark)]">Fashion</span>
                                                <span class="text-xs text-[var(--madas-gray)] ml-2">(3 themes)</span>
                                            </div>
                                        </label>
                                        <label
                                            class="flex items-center p-3 rounded-xl hover:bg-[var(--madas-light)] transition-colors cursor-pointer">
                                            <input type="checkbox"
                                                class="w-4 h-4 text-[var(--madas-primary)] bg-gray-100 border-gray-300 rounded focus:ring-[var(--madas-primary)] focus:ring-2">
                                            <div class="ml-3 flex-1">
                                                <span class="text-sm font-medium text-[var(--madas-dark)]">Food &
                                                    Drink</span>
                                                <span class="text-xs text-[var(--madas-gray)] ml-2">(2 themes)</span>
                                            </div>
                                        </label>
                                    </div>
                                </div>

                                <!-- Features Filter -->
                                <div>
                                    <h4 class="font-semibold text-[var(--madas-dark)] mb-4 flex items-center">
                                        <span
                                            class="material-icons text-sm mr-2 text-[var(--madas-primary)]">star</span>
                                        Features
                                    </h4>
                                    <div class="space-y-3">
                                        <label
                                            class="flex items-center p-3 rounded-xl hover:bg-[var(--madas-light)] transition-colors cursor-pointer">
                                            <input type="checkbox"
                                                class="w-4 h-4 text-[var(--madas-primary)] bg-gray-100 border-gray-300 rounded focus:ring-[var(--madas-primary)] focus:ring-2">
                                            <div class="ml-3 flex-1">
                                                <span class="text-sm font-medium text-[var(--madas-dark)]">Mobile
                                                    Responsive</span>
                                            </div>
                                        </label>
                                        <label
                                            class="flex items-center p-3 rounded-xl hover:bg-[var(--madas-light)] transition-colors cursor-pointer">
                                            <input type="checkbox"
                                                class="w-4 h-4 text-[var(--madas-primary)] bg-gray-100 border-gray-300 rounded focus:ring-[var(--madas-primary)] focus:ring-2">
                                            <div class="ml-3 flex-1">
                                                <span class="text-sm font-medium text-[var(--madas-dark)]">E-commerce
                                                    Ready</span>
                                            </div>
                                        </label>
                                        <label
                                            class="flex items-center p-3 rounded-xl hover:bg-[var(--madas-light)] transition-colors cursor-pointer">
                                            <input type="checkbox"
                                                class="w-4 h-4 text-[var(--madas-primary)] bg-gray-100 border-gray-300 rounded focus:ring-[var(--madas-primary)] focus:ring-2">
                                            <div class="ml-3 flex-1">
                                                <span class="text-sm font-medium text-[var(--madas-dark)]">SEO
                                                    Optimized</span>
                                            </div>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Search and Filter Bar -->
                    <div class="mb-8 bg-white rounded-2xl p-6 shadow-lg border border-[var(--madas-border)]">
                        <div class="flex flex-col md:flex-row items-stretch md:items-center gap-4">
                            <!-- Search Input -->
                            <div class="flex-1 relative">
                                <span
                                    class="material-icons absolute left-4 top-1/2 transform -translate-y-1/2 text-[var(--madas-gray)]">search</span>
                                <input type="text" id="theme-search"
                                    placeholder="Search themes by name or description..."
                                    class="w-full pl-12 pr-4 py-3 border border-[var(--madas-border)] rounded-xl focus:outline-none focus:ring-2 focus:ring-[var(--madas-primary)] focus:border-transparent transition-all">
                            </div>

                            <!-- Filter Dropdown -->
                            <div class="relative">
                                <select id="theme-filter"
                                    class="px-6 py-3 border border-[var(--madas-border)] rounded-xl focus:outline-none focus:ring-2 focus:ring-[var(--madas-primary)] bg-white appearance-none pr-10 cursor-pointer">
                                    <option value="all">All Themes</option>
                                    <option value="published">Published Only</option>
                                    <option value="draft">Drafts Only</option>
                                    <option value="recent">Recently Modified</option>
                                </select>
                                <span
                                    class="material-icons absolute right-3 top-1/2 transform -translate-y-1/2 text-[var(--madas-gray)] pointer-events-none">expand_more</span>
                            </div>

                            <!-- Sort Dropdown -->
                            <div class="relative">
                                <select id="theme-sort"
                                    class="px-6 py-3 border border-[var(--madas-border)] rounded-xl focus:outline-none focus:ring-2 focus:ring-[var(--madas-primary)] bg-white appearance-none pr-10 cursor-pointer">
                                    <option value="date-desc">Newest First</option>
                                    <option value="date-asc">Oldest First</option>
                                    <option value="name-asc">Name A-Z</option>
                                    <option value="name-desc">Name Z-A</option>
                                </select>
                                <span
                                    class="material-icons absolute right-3 top-1/2 transform -translate-y-1/2 text-[var(--madas-gray)] pointer-events-none">swap_vert</span>
                            </div>
                        </div>
                    </div>

                    <!-- Theme Grid Container -->
                    <div class="flex-1">
                        <!-- Empty State (shown when no themes exist) -->
                        <div id="empty-state" class="hidden">
                            <div
                                class="bg-white rounded-3xl p-16 shadow-lg border-2 border-dashed border-[var(--madas-border)] text-center">
                                <div
                                    class="w-32 h-32 bg-gradient-to-br from-[var(--madas-primary)]/10 to-[var(--madas-secondary)]/10 rounded-full flex items-center justify-center mx-auto mb-8">
                                    <span class="material-icons text-6xl text-[var(--madas-primary)]">web_asset</span>
                                </div>
                                <h3 class="text-3xl font-bold text-[var(--madas-dark)] mb-4">No Themes Yet</h3>
                                <p class="text-[var(--madas-gray)] text-lg mb-8 max-w-md mx-auto">
                                    Start building your first website theme! Click the button below to create a
                                    beautiful, custom theme for your store.
                                </p>
                                <button onclick="window.location.href='professional-builder-new.html'"
                                    class="inline-flex items-center space-x-3 bg-gradient-to-r from-[var(--madas-primary)] to-[var(--madas-accent)] text-white px-10 py-5 rounded-2xl hover:shadow-2xl transform hover:scale-105 transition-all duration-300 text-lg font-semibold">
                                    <span class="material-icons text-3xl">add_circle</span>
                                    <span>Create Your First Theme</span>
                                </button>
                                <div class="mt-12 grid grid-cols-1 md:grid-cols-3 gap-6 max-w-3xl mx-auto">
                                    <div class="p-6 bg-gradient-to-br from-blue-50 to-indigo-50 rounded-2xl">
                                        <div
                                            class="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center mb-4">
                                            <span class="material-icons text-blue-600">brush</span>
                                        </div>
                                        <h4 class="font-semibold text-[var(--madas-dark)] mb-2">Drag & Drop Builder</h4>
                                        <p class="text-sm text-[var(--madas-gray)]">Easy-to-use visual builder with 10+
                                            section types</p>
                                    </div>
                                    <div class="p-6 bg-gradient-to-br from-green-50 to-emerald-50 rounded-2xl">
                                        <div
                                            class="w-12 h-12 bg-green-100 rounded-xl flex items-center justify-center mb-4">
                                            <span class="material-icons text-green-600">devices</span>
                                        </div>
                                        <h4 class="font-semibold text-[var(--madas-dark)] mb-2">Fully Responsive</h4>
                                        <p class="text-sm text-[var(--madas-gray)]">Looks perfect on desktop, tablet,
                                            and mobile</p>
                                    </div>
                                    <div class="p-6 bg-gradient-to-br from-purple-50 to-pink-50 rounded-2xl">
                                        <div
                                            class="w-12 h-12 bg-purple-100 rounded-xl flex items-center justify-center mb-4">
                                            <span class="material-icons text-purple-600">save</span>
                                        </div>
                                        <h4 class="font-semibold text-[var(--madas-dark)] mb-2">Auto-Save</h4>
                                        <p class="text-sm text-[var(--madas-gray)]">Never lose your work with automatic
                                            saving</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Themes Grid (populated by JavaScript) -->
                        <div class="theme-grid">
                            <!-- Saved themes will be dynamically inserted here by loadSavedThemes() -->
                        </div>

                        <!-- No Results State (shown when search/filter returns nothing) -->
                        <div id="no-results-state" class="hidden">
                            <div
                                class="bg-white rounded-2xl p-12 shadow-lg border border-[var(--madas-border)] text-center">
                                <div
                                    class="w-24 h-24 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-6">
                                    <span class="material-icons text-5xl text-gray-400">search_off</span>
                                </div>
                                <h3 class="text-2xl font-bold text-[var(--madas-dark)] mb-3">No Themes Found</h3>
                                <p class="text-[var(--madas-gray)] text-lg mb-6">
                                    Try adjusting your search or filter criteria
                                </p>
                                <button onclick="clearSearchAndFilters()"
                                    class="inline-flex items-center space-x-2 bg-[var(--madas-primary)] text-white px-6 py-3 rounded-xl hover:bg-[var(--madas-accent)] transition-all duration-300">
                                    <span class="material-icons">clear</span>
                                    <span>Clear Filters</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // Enhanced Theme Library Functionality
        document.addEventListener('DOMContentLoaded', function () {
            // Initialize the theme library
            initializeThemeLibrary();

            // Load saved themes from localStorage
            loadSavedThemes();

            // Initialize event listeners
            initializeEventListeners();

            // Initialize search and filters
            initializeSearchAndFilters();

            // Listen for storage changes (when themes are saved from builder)
            window.addEventListener('storage', function (e) {
                if (e.key === 'savedThemes' || e.key === 'newThemeSaved' || e.key === 'themeUpdated') {
                    console.log('✅ Theme storage changed, reloading themes with isolation...');

                    // Ensure all themes are properly isolated before reloading
                    const savedThemes = JSON.parse(localStorage.getItem('savedThemes') || '[]');
                    const isolatedThemes = savedThemes.map(theme => ensureThemeIsolation(theme));
                    localStorage.setItem('savedThemes', JSON.stringify(isolatedThemes));

                    loadSavedThemes();

                    // Clear the flags
                    if (e.key === 'newThemeSaved' || e.key === 'themeUpdated') {
                        localStorage.removeItem('newThemeSaved');
                        localStorage.removeItem('themeUpdated');
                    }
                }
            });

            // Also check for new themes on focus (when returning from builder)
            window.addEventListener('focus', function () {
                const newThemeFlag = localStorage.getItem('newThemeSaved');
                if (newThemeFlag) {
                    console.log('✅ New theme detected, reloading...');
                    loadSavedThemes();
                    localStorage.removeItem('newThemeSaved');
                    showNotification('Theme saved successfully!', 'success');
                }
            });
        });

        function initializeThemeLibrary() {
            // Add loading animation to stats
            animateStats();

            // Initialize theme cards with enhanced interactions
            initializeThemeCards();

            // Load themes from Firebase
            loadThemesFromFirebase();
        }

        function animateStats() {
            const statNumbers = document.querySelectorAll('.text-2xl.font-bold');
            statNumbers.forEach(stat => {
                const finalValue = parseInt(stat.textContent.replace(/[^\d]/g, ''));
                let currentValue = 0;
                const increment = finalValue / 50;

                const timer = setInterval(() => {
                    currentValue += increment;
                    if (currentValue >= finalValue) {
                        stat.textContent = stat.textContent.replace(/\d+/, finalValue);
                        clearInterval(timer);
                    } else {
                        stat.textContent = stat.textContent.replace(/\d+/, Math.floor(currentValue));
                    }
                }, 30);
            });
        }

        function initializeEventListeners() {
            console.log('Initializing event listeners...');

            // Customize Theme Button
            document.querySelector('.theme-customize-btn')?.addEventListener('click', function () {
                window.location.href = 'professional-builder-new.html';
            });

            // Edit Theme Buttons
            document.querySelectorAll('.theme-edit-btn').forEach(btn => {
                btn.addEventListener('click', function () {
                    window.location.href = 'professional-builder-new.html';
                });
            });

            // Create New Theme Button
            const createBtn = document.getElementById('create-new-theme');
            console.log('Create button found:', createBtn);
            if (createBtn) {
                createBtn.addEventListener('click', function () {
                    console.log('Create New Theme button clicked');
                    // Show the modal for theme details
                    showCreateThemeModal();
                });
            } else {
                console.error('Create New Theme button not found!');
            }
            // Publish Theme Buttons
            document.querySelectorAll('.theme-publish-btn').forEach(btn => {
                btn.addEventListener('click', function () {
                    const card = btn.closest('.theme-card');
                    const themeId = card.getAttribute('data-theme-id');

                    if (themeId && confirm('Are you sure you want to publish this theme? This will make it live on your website and unpublish any other themes.')) {
                        publishTheme(themeId);
                    }
                });
            });

            // More Options Buttons
            document.querySelectorAll('.theme-more-btn').forEach(btn => {
                btn.addEventListener('click', function () {
                    showThemeOptionsModal(btn);
                });
            });

            // Preview Buttons
            document.querySelectorAll('button').forEach(btn => {
                if (btn.textContent.includes('Preview')) {
                    btn.addEventListener('click', function () {
                        showNotification('Preview feature coming soon!', 'info');
                    });
                }
            });
        }

        function initializeSearchAndFilters() {
            // Enhanced Search functionality
            const searchInput = document.querySelector('.search-input');
            if (searchInput) {
                searchInput.addEventListener('input', function () {
                    const searchTerm = this.value.toLowerCase();
                    const themeCards = document.querySelectorAll('.theme-store-card');

                    themeCards.forEach(card => {
                        const title = card.querySelector('h3').textContent.toLowerCase();
                        const description = card.querySelector('p').textContent.toLowerCase();

                        if (title.includes(searchTerm) || description.includes(searchTerm)) {
                            card.style.display = 'block';
                            card.style.animation = 'fadeIn 0.3s ease-in-out';
                        } else {
                            card.style.display = 'none';
                        }
                    });
                });
            }

            // Filter Chips
            document.querySelectorAll('.filter-chip').forEach(chip => {
                chip.addEventListener('click', function () {
                    // Remove active class from all chips
                    document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
                    // Add active class to clicked chip
                    this.classList.add('active');

                    const filter = this.dataset.filter;
                    filterThemes(filter);
                });
            });

            // Enhanced Filter functionality
            document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                checkbox.addEventListener('change', function () {
                    applyFilters();
                });
            });
        }

        function filterThemes(filter) {
            const themeCards = document.querySelectorAll('.theme-store-card');

            themeCards.forEach(card => {
                if (filter === 'all') {
                    card.style.display = 'block';
                } else if (filter === 'free') {
                    const isFree = card.querySelector('.text-[var(--madas-success)]');
                    card.style.display = isFree ? 'block' : 'none';
                } else if (filter === 'premium') {
                    const isPremium = card.querySelector('.text-[var(--madas-accent)]');
                    card.style.display = isPremium ? 'block' : 'none';
                }
            });
        }

        function applyFilters() {
            const checkedFilters = Array.from(document.querySelectorAll('input[type="checkbox"]:checked'))
                .map(cb => cb.closest('label').textContent.trim().toLowerCase());

            const themeCards = document.querySelectorAll('.theme-store-card');

            themeCards.forEach(card => {
                let shouldShow = true;

                // Apply price filters
                if (checkedFilters.includes('free')) {
                    const isFree = card.querySelector('.text-[var(--madas-success)]');
                    if (!isFree) shouldShow = false;
                }

                // Apply category filters
                if (checkedFilters.some(filter => ['electronics', 'fashion', 'food & drink'].includes(filter))) {
                    // Category filtering logic would go here
                }

                // Apply feature filters
                if (checkedFilters.some(filter => ['mobile responsive', 'e-commerce ready', 'seo optimized'].includes(filter))) {
                    // Feature filtering logic would go here
                }

                card.style.display = shouldShow ? 'block' : 'none';
            });
        }

        function showThemeOptionsModal(button, theme) {
            console.log('Opening theme options modal for theme:', theme);
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center';
            modal.innerHTML = `
                <div class="bg-white rounded-2xl max-w-md w-full mx-4 p-6">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-xl font-bold text-[var(--madas-dark)]">Theme Options</h3>
                        <button onclick="this.closest('.fixed').remove()" class="text-[var(--madas-gray)] hover:text-[var(--madas-dark)]">
                            <span class="material-icons">close</span>
                        </button>
                    </div>
                    
                    <div class="space-y-3">
                        <button data-action="duplicate" class="w-full text-left p-4 rounded-xl hover:bg-[var(--madas-light)] transition-colors flex items-center space-x-3">
                            <span class="material-icons text-[var(--madas-primary)]">content_copy</span>
                            <span>Duplicate Theme</span>
                        </button>
                        <button data-action="rename" class="w-full text-left p-4 rounded-xl hover:bg-[var(--madas-light)] transition-colors flex items-center space-x-3">
                            <span class="material-icons text-[var(--madas-primary)]">edit</span>
                            <span>Rename Theme</span>
                        </button>
                        <button data-action="export" class="w-full text-left p-4 rounded-xl hover:bg-[var(--madas-light)] transition-colors flex items-center space-x-3">
                            <span class="material-icons text-[var(--madas-primary)]">download</span>
                            <span>Export Theme</span>
                        </button>
                        <button data-action="delete" class="w-full text-left p-4 rounded-xl hover:bg-red-50 transition-colors flex items-center space-x-3 text-red-600">
                            <span class="material-icons">delete</span>
                            <span>Delete Theme</span>
                        </button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // Add event listeners to modal buttons
            modal.querySelectorAll('button[data-action]').forEach(btn => {
                btn.addEventListener('click', function () {
                    const action = this.getAttribute('data-action');
                    console.log('Button clicked, action:', action, 'theme:', theme);
                    handleThemeAction(action, button, theme);
                    modal.remove();
                });
            });
        }

        function handleThemeAction(action, button, theme) {
            console.log('Theme action:', action, 'Theme:', theme);

            switch (action) {
                case 'duplicate':
                    showNotification('Theme duplicated successfully!', 'success');
                    break;
                case 'rename':
                    const newName = prompt('Enter new theme name:');
                    if (newName && theme) {
                        // Update theme name in localStorage
                        const themes = JSON.parse(localStorage.getItem('firebase_themes') || '[]');
                        const themeIndex = themes.findIndex(t => t.id === theme.id);
                        if (themeIndex !== -1) {
                            themes[themeIndex].name = newName;
                            themes[themeIndex].updatedAt = new Date().toISOString();
                            localStorage.setItem('firebase_themes', JSON.stringify(themes));

                            // Update DOM
                            const card = button.closest('.theme-card');
                            const title = card.querySelector('h3');
                            if (title) title.textContent = newName;

                            showNotification('Theme renamed successfully!', 'success');
                            // Reload themes to update the UI
                            loadThemesFromFirebase();
                        }
                    }
                    break;
                case 'export':
                    showNotification('Theme export feature coming soon!', 'info');
                    break;
                case 'delete':
                    if (confirm('Are you sure you want to delete this theme? This action cannot be undone.')) {
                        deleteTheme(button, theme);
                    }
                    break;
            }
        }

        function deleteTheme(button, theme) {
            try {
                console.log('Deleting theme:', theme);

                if (!theme || !theme.id) {
                    showNotification('Theme data not found', 'error');
                    return;
                }

                // Remove from localStorage
                const themes = JSON.parse(localStorage.getItem('firebase_themes') || '[]');
                const updatedThemes = themes.filter(t => t.id !== theme.id);
                localStorage.setItem('firebase_themes', JSON.stringify(updatedThemes));

                console.log('Theme removed from localStorage');

                // Find and animate the theme card
                const sliderItem = button.closest('.themes-slider-item');
                if (sliderItem) {
                    sliderItem.style.animation = 'fadeOut 0.3s ease-in-out';
                    setTimeout(() => {
                        sliderItem.remove();
                        showNotification('Theme deleted successfully!', 'success');

                        // Reload themes to update the slider
                        loadThemesFromFirebase();
                    }, 300);
                } else {
                    showNotification('Theme deleted successfully!', 'success');
                    // Reload themes to update the slider
                    loadThemesFromFirebase();
                }

            } catch (error) {
                console.error('Error deleting theme:', error);
                showNotification('Error deleting theme', 'error');
            }
        }

        // Enhanced Create Theme Modal
        function showCreateThemeModal() {
            console.log('showCreateThemeModal called');

            // Check if modal already exists
            const existingModal = document.querySelector('.fixed.inset-0');
            if (existingModal) {
                console.log('Modal already exists, removing it');
                existingModal.remove();
            }

            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center';
            modal.innerHTML = `
                <div class="bg-white rounded-2xl max-w-3xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                    <div class="sticky top-0 bg-white border-b border-[var(--madas-border)] p-6">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-3">
                                <div class="w-10 h-10 bg-[var(--madas-primary)] rounded-lg flex items-center justify-center">
                                    <span class="material-icons text-white">add_circle</span>
                                </div>
                                <h3 class="text-2xl font-bold text-[var(--madas-dark)]">Create New Theme</h3>
                            </div>
                            <button onclick="this.closest('.fixed').remove()" class="text-[var(--madas-gray)] hover:text-[var(--madas-dark)] transition-colors">
                                <span class="material-icons">close</span>
                            </button>
                        </div>
                    </div>
                    
                    <div class="p-8">
                        <div class="space-y-8">
                            <!-- Theme Name -->
                            <div>
                                <label class="block text-sm font-semibold text-[var(--madas-dark)] mb-3">Theme Name</label>
                                <input type="text" id="new-theme-name" placeholder="Enter a creative name for your theme" 
                                       class="w-full px-4 py-4 border border-[var(--madas-border)] rounded-xl focus:ring-2 focus:ring-[var(--madas-primary)] focus:border-transparent text-lg">
                            </div>

                            <!-- Theme Description -->
                            <div>
                                <label class="block text-sm font-semibold text-[var(--madas-dark)] mb-3">Description (Optional)</label>
                                <textarea id="new-theme-description" placeholder="Describe your theme's style and purpose" rows="3"
                                          class="w-full px-4 py-4 border border-[var(--madas-border)] rounded-xl focus:ring-2 focus:ring-[var(--madas-primary)] focus:border-transparent"></textarea>
                            </div>

                            <!-- Starting Point -->
                            <div>
                                <label class="block text-sm font-semibold text-[var(--madas-dark)] mb-4">Choose Starting Point</label>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div class="starting-point-option border-2 border-[var(--madas-border)] rounded-2xl p-6 cursor-pointer hover:border-[var(--madas-primary)] transition-all group" data-option="blank">
                                        <div class="flex items-center space-x-4">
                                            <div class="w-16 h-16 bg-[var(--madas-light)] rounded-xl flex items-center justify-center group-hover:bg-[var(--madas-secondary)] transition-colors">
                                                <span class="material-icons text-[var(--madas-primary)] text-2xl">add</span>
                                            </div>
                                            <div>
                                                <h4 class="font-bold text-[var(--madas-dark)] text-lg">Start from Scratch</h4>
                                                <p class="text-[var(--madas-gray)]">Create a completely new theme with full control</p>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="starting-point-option border-2 border-[var(--madas-border)] rounded-2xl p-6 cursor-pointer hover:border-[var(--madas-primary)] transition-all group" data-option="template">
                                        <div class="flex items-center space-x-4">
                                            <div class="w-16 h-16 bg-[var(--madas-secondary)] rounded-xl flex items-center justify-center group-hover:bg-[var(--madas-primary)] transition-colors">
                                                <span class="material-icons text-[var(--madas-primary)] text-2xl group-hover:text-white">content_copy</span>
                                            </div>
                                            <div>
                                                <h4 class="font-bold text-[var(--madas-dark)] text-lg">Use Template</h4>
                                                <p class="text-[var(--madas-gray)]">Start with a pre-built template and customize</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Template Selection (Hidden by default) -->
                            <div id="template-selection" class="hidden">
                                <label class="block text-sm font-semibold text-[var(--madas-dark)] mb-4">Choose Template</label>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div class="template-option border border-[var(--madas-border)] rounded-2xl p-6 cursor-pointer hover:border-[var(--madas-primary)] transition-all group" data-template="modern">
                                        <div class="h-32 bg-gradient-to-br from-blue-500 to-purple-600 rounded-xl mb-4 flex items-center justify-center">
                                            <span class="text-white font-bold text-xl">Modern</span>
                                        </div>
                                        <h4 class="font-bold text-[var(--madas-dark)] text-lg">Modern Store</h4>
                                        <p class="text-[var(--madas-gray)]">Clean and contemporary design</p>
                                    </div>
                                    
                                    <div class="template-option border border-[var(--madas-border)] rounded-2xl p-6 cursor-pointer hover:border-[var(--madas-primary)] transition-all group" data-template="elegant">
                                        <div class="h-32 bg-gradient-to-br from-gray-600 to-gray-800 rounded-xl mb-4 flex items-center justify-center">
                                            <span class="text-white font-bold text-xl">Elegant</span>
                                        </div>
                                        <h4 class="font-bold text-[var(--madas-dark)] text-lg">Elegant Shop</h4>
                                        <p class="text-[var(--madas-gray)]">Sophisticated and refined</p>
                                    </div>
                                    
                                    <div class="template-option border border-[var(--madas-border)] rounded-2xl p-6 cursor-pointer hover:border-[var(--madas-primary)] transition-all group" data-template="vibrant">
                                        <div class="h-32 bg-gradient-to-br from-orange-500 to-red-600 rounded-xl mb-4 flex items-center justify-center">
                                            <span class="text-white font-bold text-xl">Vibrant</span>
                                        </div>
                                        <h4 class="font-bold text-[var(--madas-dark)] text-lg">Vibrant Store</h4>
                                        <p class="text-[var(--madas-gray)]">Bold and energetic</p>
                                    </div>
                                    
                                    <div class="template-option border border-[var(--madas-border)] rounded-2xl p-6 cursor-pointer hover:border-[var(--madas-primary)] transition-all group" data-template="minimal">
                                        <div class="h-32 bg-gradient-to-br from-gray-100 to-gray-300 rounded-xl mb-4 flex items-center justify-center">
                                            <span class="text-gray-700 font-bold text-xl">Minimal</span>
                                        </div>
                                        <h4 class="font-bold text-[var(--madas-dark)] text-lg">Minimal Store</h4>
                                        <p class="text-[var(--madas-gray)]">Simple and clean</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex justify-between items-center mt-10 pt-8 border-t border-[var(--madas-border)]">
                            <button onclick="quickCreateTheme()" 
                                    class="px-6 py-3 text-[var(--madas-primary)] border border-[var(--madas-primary)] rounded-xl hover:bg-[var(--madas-primary)] hover:text-white transition-colors font-semibold">
                                <span class="material-icons text-sm mr-2">flash_on</span>
                                Quick Create
                            </button>
                            <div class="flex space-x-4">
                                <button onclick="this.closest('.fixed').remove()" 
                                        class="px-6 py-3 text-[var(--madas-gray)] border border-[var(--madas-border)] rounded-xl hover:bg-[var(--madas-light)] transition-colors font-semibold">
                                    Cancel
                                </button>
                                <button id="create-theme-btn" 
                                        class="btn-primary px-8 py-3 text-lg">
                                    <span class="material-icons text-sm mr-2">add_circle</span>
                                    Create Theme
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
            console.log('Modal added to DOM:', modal);
            initializeCreateThemeModal();
        }

        function initializeCreateThemeModal() {
            let selectedOption = 'blank';
            let selectedTemplate = null;

            // Starting point selection
            document.querySelectorAll('.starting-point-option').forEach(option => {
                option.addEventListener('click', function () {
                    document.querySelectorAll('.starting-point-option').forEach(opt => {
                        opt.classList.remove('border-[var(--madas-primary)]', 'bg-[var(--madas-secondary)]/20');
                        opt.classList.add('border-[var(--madas-border)]');
                    });

                    this.classList.remove('border-[var(--madas-border)]');
                    this.classList.add('border-[var(--madas-primary)]', 'bg-[var(--madas-secondary)]/20');

                    selectedOption = this.dataset.option;

                    const templateSelection = document.getElementById('template-selection');
                    if (selectedOption === 'template') {
                        templateSelection.classList.remove('hidden');
                    } else {
                        templateSelection.classList.add('hidden');
                        selectedTemplate = null;
                    }
                });
            });

            // Template selection
            document.querySelectorAll('.template-option').forEach(option => {
                option.addEventListener('click', function () {
                    document.querySelectorAll('.template-option').forEach(opt => {
                        opt.classList.remove('border-[var(--madas-primary)]', 'bg-[var(--madas-secondary)]/20');
                        opt.classList.add('border-[var(--madas-border)]');
                    });

                    this.classList.remove('border-[var(--madas-border)]');
                    this.classList.add('border-[var(--madas-primary)]', 'bg-[var(--madas-secondary)]/20');

                    selectedTemplate = this.dataset.template;
                });
            });

            // Create theme button
            document.getElementById('create-theme-btn').addEventListener('click', function () {
                console.log('Create theme button clicked');
                const themeName = document.getElementById('new-theme-name').value.trim();
                const themeDescription = document.getElementById('new-theme-description').value.trim();

                console.log('Theme name:', themeName);
                console.log('Selected option:', selectedOption);
                console.log('Selected template:', selectedTemplate);

                if (!themeName) {
                    showNotification('Please enter a theme name', 'error');
                    return;
                }

                if (selectedOption === 'template' && !selectedTemplate) {
                    showNotification('Please select a template', 'error');
                    return;
                }

                createNewTheme(themeName, themeDescription, selectedOption, selectedTemplate);
                document.querySelector('.fixed').remove();
            });
        }

        // Show published themes modal
        function showPublishedThemes() {
            const allThemes = JSON.parse(localStorage.getItem('savedThemes') || '[]');
            const firebaseThemes = JSON.parse(localStorage.getItem('firebase_themes') || '[]');
            const publishedThemes = [...allThemes, ...firebaseThemes].filter(theme => theme.status === 'published');

            if (publishedThemes.length === 0) {
                showNotification('No published themes found. Publish a theme first!', 'info');
                return;
            }

            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center';
            modal.innerHTML = `
                <div class="bg-white rounded-xl p-8 max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                    <div class="flex items-center justify-between mb-6">
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 bg-[var(--madas-success)] rounded-lg flex items-center justify-center">
                                <span class="material-icons text-white">visibility</span>
                            </div>
                            <h3 class="text-2xl font-bold text-[var(--madas-dark)]">Published Themes</h3>
                        </div>
                        <button onclick="this.closest('.fixed').remove()" class="text-[var(--madas-gray)] hover:text-[var(--madas-dark)] transition-colors">
                            <span class="material-icons">close</span>
                        </button>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        ${publishedThemes.map(theme => `
                            <div class="bg-white border border-[var(--madas-border)] rounded-xl p-6 hover:shadow-lg transition-shadow">
                                <div class="flex items-center justify-between mb-4">
                                    <h4 class="text-lg font-bold text-[var(--madas-dark)]">${theme.name}</h4>
                                    <span class="bg-[var(--madas-success)] text-white px-2 py-1 rounded-full text-xs font-bold">
                                        LIVE
                                    </span>
                                </div>
                                <p class="text-[var(--madas-gray)] text-sm mb-4">${theme.description || 'No description available'}</p>
                                <div class="text-xs text-[var(--madas-gray)] mb-4">
                                    Published: ${new Date(theme.publishedAt || theme.updatedAt).toLocaleDateString()}
                                </div>
                                <div class="flex space-x-2">
                                    <button onclick="window.open('view-published-theme.html?theme=${theme.id}', '_blank')" 
                                            class="flex-1 bg-[var(--madas-primary)] text-white px-4 py-2 rounded-lg hover:bg-opacity-90 transition-colors text-sm font-semibold">
                                        <span class="material-icons text-sm mr-1">open_in_new</span>
                                        View Live
                                    </button>
                                    <button onclick="editPublishedTheme('${theme.id}')" 
                                            class="bg-[var(--madas-light)] text-[var(--madas-dark)] px-4 py-2 rounded-lg hover:bg-[var(--madas-secondary)] transition-colors text-sm">
                                        <span class="material-icons text-sm">edit</span>
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    </div>

                    <div class="mt-6 pt-6 border-t border-[var(--madas-border)] text-center">
                        <p class="text-[var(--madas-gray)] text-sm">
                            Published themes are live and accessible to visitors. 
                            Only one theme can be published at a time.
                        </p>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
        }

        function editPublishedTheme(themeId) {
            // Close modal first
            const modal = document.querySelector('.fixed.inset-0');
            if (modal) modal.remove();

            // Load theme for editing
            const allThemes = JSON.parse(localStorage.getItem('savedThemes') || '[]');
            const firebaseThemes = JSON.parse(localStorage.getItem('firebase_themes') || '[]');
            const theme = [...allThemes, ...firebaseThemes].find(t => t.id === themeId);

            if (theme) {
                localStorage.setItem('editThemeData', JSON.stringify(theme));
                window.location.href = `professional-builder-new.html?mode=edit&theme=${themeId}`;
            } else {
                showNotification('Theme not found', 'error');
            }
        }

        function quickPublishTheme() {
            const allThemes = JSON.parse(localStorage.getItem('savedThemes') || '[]');
            const firebaseThemes = JSON.parse(localStorage.getItem('firebase_themes') || '[]');
            const themes = [...allThemes, ...firebaseThemes];

            if (themes.length === 0) {
                showNotification('No themes found. Create a theme first!', 'warning');
                setTimeout(() => {
                    showCreateThemeModal();
                }, 1000);
                return;
            }

            // Find the first draft theme or most recent theme
            const draftTheme = themes.find(theme => theme.status === 'draft');
            const themeToPublish = draftTheme || themes[0];

            if (confirm(`Quick publish "${themeToPublish.name}"?\n\nThis will make it your live website and unpublish any other themes.`)) {
                // Set all themes to draft first
                themes.forEach(theme => {
                    theme.status = 'draft';
                    theme.updatedAt = new Date().toISOString();
                });

                // Publish the selected theme
                themeToPublish.status = 'published';
                themeToPublish.publishedAt = new Date().toISOString();
                themeToPublish.updatedAt = new Date().toISOString();

                // Save back to localStorage
                localStorage.setItem('savedThemes', JSON.stringify(allThemes));
                localStorage.setItem('firebase_themes', JSON.stringify(firebaseThemes));

                showNotification(`"${themeToPublish.name}" published successfully!`, 'success');

                // Reload themes to update the UI
                loadThemesFromFirebase();

                // Auto-open the published theme after a short delay
                setTimeout(() => {
                    window.open(`view-published-theme.html?theme=${themeToPublish.id}`, '_blank');
                }, 1500);
            }
        }

        // Enhanced notification system
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <div class="flex items-center space-x-3">
                    <span class="material-icons">
                        ${type === 'success' ? 'check_circle' :
                    type === 'error' ? 'error' :
                        type === 'warning' ? 'warning' : 'info'}
                    </span>
                    <span>${message}</span>
                </div>
            `;

            document.body.appendChild(notification);

            // Trigger animation
            setTimeout(() => {
                notification.classList.add('show');
            }, 100);

            // Auto remove
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    notification.remove();
                }, 300);
            }, 3000);
        }

        // Initialize theme cards with enhanced interactions
        function initializeThemeCards() {
            // Add hover effects and interactions
            document.querySelectorAll('.theme-card, .theme-store-card').forEach(card => {
                card.addEventListener('mouseenter', function () {
                    this.style.transform = 'translateY(-8px) scale(1.02)';
                });

                card.addEventListener('mouseleave', function () {
                    this.style.transform = 'translateY(0) scale(1)';
                });
            });
        }

        // Load themes from Firebase with localStorage fallback
        async function loadThemesFromFirebase() {
            const loadingElement = document.getElementById('themes-loading');
            const emptyElement = document.getElementById('themes-empty');
            const sliderContainer = document.getElementById('themes-slider-container');
            const prevBtn = document.getElementById('themes-prev-btn');
            const nextBtn = document.getElementById('themes-next-btn');
            const dotsContainer = document.getElementById('themes-slider-dots');

            try {
                console.log('📚 Loading themes from Firebase...');

                let themes = [];

                // Try to load from Firebase first
                if (window.firebase && window.firebase.db && window.firebase.auth.currentUser) {
                    try {
                        const userThemesRef = window.firebase.collection(window.firebase.db, 'user_themes');
                        const querySnapshot = await window.firebase.getDocs(userThemesRef);

                        themes = querySnapshot.docs.map(doc => ({
                            id: doc.id,
                            ...doc.data()
                        }));

                        console.log(`✅ Loaded ${themes.length} themes from Firebase`);

                        // Update localStorage with Firebase data
                        localStorage.setItem('firebase_themes', JSON.stringify(themes));

                    } catch (firebaseError) {
                        console.warn('⚠️ Firebase load failed, using localStorage:', firebaseError);
                        themes = JSON.parse(localStorage.getItem('firebase_themes') || '[]');
                    }
                } else {
                    console.log('📱 No Firebase auth, using localStorage');
                    themes = JSON.parse(localStorage.getItem('firebase_themes') || '[]');
                }

                if (themes.length === 0) {
                    showEmptyState();
                } else {
                    displayThemes(themes);
                }

                // Update stats
                updateStats(themes);

            } catch (error) {
                console.error('❌ Error loading themes:', error);
                showErrorState();
            }
        }
        function showEmptyState() {
            document.getElementById('themes-loading').classList.add('hidden');
            document.getElementById('themes-empty').classList.remove('hidden');
            document.getElementById('themes-slider-container').classList.add('hidden');
            document.getElementById('themes-prev-btn').classList.add('hidden');
            document.getElementById('themes-next-btn').classList.add('hidden');
            document.getElementById('themes-slider-dots').classList.add('hidden');

            // Add event listener for create first theme button
            document.getElementById('create-first-theme').addEventListener('click', () => {
                showCreateThemeModal();
            });
        }

        function showErrorState() {
            document.getElementById('themes-loading').classList.add('hidden');
            document.getElementById('themes-empty').classList.remove('hidden');
            document.getElementById('themes-empty').innerHTML = `
                <div class="text-center max-w-md">
                    <div class="w-20 h-20 bg-red-100 rounded-2xl flex items-center justify-center mx-auto mb-6">
                        <span class="material-icons text-red-600 text-4xl">error</span>
                    </div>
                    <h3 class="text-xl font-bold text-[var(--madas-dark)] mb-3">Error Loading Themes</h3>
                    <p class="text-[var(--madas-gray)] mb-6">There was an error loading your themes. Please try again.</p>
                    <button onclick="loadThemesFromFirebase()" class="btn-primary">
                        <span class="material-icons text-sm mr-2">refresh</span>
                        Try Again
                    </button>
                </div>
            `;
        }

        function displayThemes(themes) {
            const loadingElement = document.getElementById('themes-loading');
            const emptyElement = document.getElementById('themes-empty');
            const sliderContainer = document.getElementById('themes-slider-container');
            const prevBtn = document.getElementById('themes-prev-btn');
            const nextBtn = document.getElementById('themes-next-btn');
            const dotsContainer = document.getElementById('themes-slider-dots');

            // Hide loading and empty states
            loadingElement.classList.add('hidden');
            emptyElement.classList.add('hidden');

            // Show slider elements
            sliderContainer.classList.remove('hidden');
            prevBtn.classList.remove('hidden');
            nextBtn.classList.remove('hidden');
            dotsContainer.classList.remove('hidden');

            // Clear existing content
            sliderContainer.innerHTML = '';

            // Generate theme cards
            themes.forEach(theme => {
                const themeCard = createThemeCard(theme);
                sliderContainer.appendChild(themeCard);
            });

            // Initialize slider after content is loaded
            setTimeout(() => {
                initializeThemesSlider();
            }, 100);
        }

        function createThemeCard(theme) {
            const sliderItem = document.createElement('div');
            sliderItem.className = 'themes-slider-item';
            sliderItem.setAttribute('data-theme-id', theme.id);

            const statusClass = theme.status === 'published' ?
                'bg-gradient-to-r from-[var(--madas-success)] to-green-400' :
                'bg-gradient-to-r from-[var(--madas-warning)] to-yellow-400';

            const statusText = theme.status === 'published' ? 'PUBLISHED' : 'DRAFT';
            const statusIcon = theme.status === 'published' ? 'star' : 'edit';

            const previewGradient = theme.previewGradient || 'from-[var(--madas-primary)] via-[var(--madas-secondary)] to-[var(--madas-accent)]';
            const previewIcon = theme.previewIcon || 'auto_awesome';

            sliderItem.innerHTML = `
                <div class="theme-card relative overflow-hidden group">
                    <!-- Status Badge -->
                    <div class="absolute top-4 right-4 z-10">
                        <div class="status-badge ${statusClass} text-white px-3 py-1 rounded-full text-xs font-semibold shadow-lg">
                            <span class="material-icons text-xs mr-1">${statusIcon}</span>
                            ${statusText}
                        </div>
                    </div>
                    
                    <!-- Theme Preview -->
                    <div class="theme-preview relative">
                        <div class="absolute inset-0 bg-gradient-to-br ${previewGradient}"></div>
                        <div class="absolute inset-0 bg-black/20"></div>
                        <div class="absolute inset-0 flex items-center justify-center">
                            <div class="text-center text-white">
                                <div class="w-16 h-16 bg-white/20 backdrop-blur-sm rounded-2xl flex items-center justify-center mx-auto mb-4">
                                    <span class="material-icons text-3xl">${previewIcon}</span>
                                </div>
                                <h3 class="text-xl font-bold mb-2">${theme.name}</h3>
                                <p class="text-white/80 text-sm">${theme.description || 'Custom Theme'}</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Theme Info -->
                    <div class="p-6">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="text-lg font-bold text-[var(--madas-dark)]">${theme.name}</h3>
                            <div class="flex items-center space-x-1 ${theme.status === 'published' ? 'text-[var(--madas-success)]' : 'text-[var(--madas-warning)]'}">
                                <span class="material-icons text-sm">${theme.status === 'published' ? 'visibility' : 'edit'}</span>
                                <span class="text-sm font-medium">${theme.status === 'published' ? 'Live' : 'Draft'}</span>
                            </div>
                        </div>
                        <p class="text-[var(--madas-gray)] text-sm mb-4">Last updated ${new Date(theme.updatedAt || theme.createdAt).toLocaleDateString()}</p>
                        <div class="flex space-x-2">
                            ${theme.status === 'draft' ? `
                                <button class="theme-publish-btn bg-[var(--madas-success)] text-white px-4 py-2 rounded-lg hover:bg-green-600 transition-all duration-300 text-sm flex-1 font-semibold">
                                    <span class="material-icons text-sm mr-1">publish</span>
                                    Publish
                                </button>
                            ` : `
                                <button class="theme-view-btn bg-[var(--madas-primary)] text-white px-4 py-2 rounded-lg hover:bg-opacity-90 transition-all duration-300 text-sm flex-1 font-semibold">
                                    <span class="material-icons text-sm mr-1">visibility</span>
                                    View Live
                                </button>
                            `}
                            <button class="theme-edit-btn bg-[var(--madas-light)] text-[var(--madas-dark)] px-4 py-2 rounded-lg hover:bg-[var(--madas-secondary)] transition-all duration-300 text-sm">
                                <span class="material-icons text-sm">edit</span>
                            </button>
                            <button class="theme-more-btn bg-[var(--madas-light)] text-[var(--madas-dark)] px-4 py-2 rounded-lg hover:bg-[var(--madas-secondary)] transition-all duration-300 text-sm">
                                <span class="material-icons text-sm">more_vert</span>
                            </button>
                        </div>
                    </div>
                </div>
            `;

            // Add event listeners
            const editBtn = sliderItem.querySelector('.theme-edit-btn');
            const publishBtn = sliderItem.querySelector('.theme-publish-btn');
            const viewBtn = sliderItem.querySelector('.theme-view-btn');
            const moreBtn = sliderItem.querySelector('.theme-more-btn');

            editBtn?.addEventListener('click', () => {
                window.location.href = `professional-builder-new.html?mode=edit&theme=${theme.id}`;
            });

            publishBtn?.addEventListener('click', () => {
                publishTheme(theme.id);
            });

            viewBtn?.addEventListener('click', () => {
                window.open(`view-published-theme.html?theme=${theme.id}`, '_blank');
            });

            moreBtn?.addEventListener('click', () => {
                showThemeOptionsModal(moreBtn, theme);
            });

            return sliderItem;
        }

        function updateStats(themes) {
            const totalThemes = themes.length;
            const publishedThemes = themes.filter(t => t.status === 'published').length;
            const draftThemes = themes.filter(t => t.status === 'draft').length;

            // Update stats display
            const statsElements = document.querySelectorAll('.text-2xl.font-bold');
            if (statsElements.length >= 3) {
                statsElements[0].textContent = totalThemes.toString();
                statsElements[1].textContent = publishedThemes.toString();
                statsElements[2].textContent = draftThemes.toString();
            }
        }

        async function publishTheme(themeId) {
            try {
                console.log('📤 Publishing theme:', themeId);

                // Get all themes from both localStorage locations
                const allThemes = JSON.parse(localStorage.getItem('savedThemes') || '[]');
                const firebaseThemes = JSON.parse(localStorage.getItem('firebase_themes') || '[]');
                const themes = [...allThemes, ...firebaseThemes];

                const themeIndex = themes.findIndex(theme => theme.id === themeId);

                if (themeIndex !== -1) {
                    // Set all themes to draft first
                    themes.forEach(theme => {
                        theme.status = 'draft';
                        theme.updatedAt = new Date().toISOString();
                    });

                    // Then publish the selected theme
                    themes[themeIndex].status = 'published';
                    themes[themeIndex].publishedAt = new Date().toISOString();
                    themes[themeIndex].updatedAt = new Date().toISOString();

                    // Save to Firebase if available
                    if (window.firebase && window.firebase.db && window.firebase.auth.currentUser) {
                        try {
                            const userThemesRef = window.firebase.collection(window.firebase.db, 'user_themes');

                            // Update all themes in Firebase
                            for (const theme of themes) {
                                const themeDocRef = window.firebase.doc(userThemesRef, theme.id);
                                await window.firebase.setDoc(themeDocRef, theme, { merge: true });
                            }

                            console.log('✅ Theme published to Firebase');
                            showNotification('Theme published successfully! All other themes are now draft.', 'success');

                        } catch (firebaseError) {
                            console.warn('⚠️ Firebase publish failed, using localStorage:', firebaseError);
                            // Fallback to localStorage
                            localStorage.setItem('savedThemes', JSON.stringify(allThemes));
                            localStorage.setItem('firebase_themes', JSON.stringify(firebaseThemes));
                            showNotification('Theme published locally! Cloud sync failed.', 'warning');
                        }
                    } else {
                        // Save to localStorage only
                        localStorage.setItem('savedThemes', JSON.stringify(allThemes));
                        localStorage.setItem('firebase_themes', JSON.stringify(firebaseThemes));
                        console.log('📱 Theme published to localStorage');
                        showNotification('Theme published successfully! All other themes are now draft.', 'success');
                    }

                    // Reload themes
                    loadThemesFromFirebase();
                } else {
                    showNotification('Theme not found', 'error');
                }
            } catch (error) {
                console.error('❌ Error publishing theme:', error);
                showNotification('Error publishing theme', 'error');
            }
        }

        // Initialize Themes Slider
        function initializeThemesSlider() {
            const sliderContainer = document.getElementById('themes-slider-container');
            const prevBtn = document.getElementById('themes-prev-btn');
            const nextBtn = document.getElementById('themes-next-btn');
            const dotsContainer = document.getElementById('themes-slider-dots');

            if (!sliderContainer || !prevBtn || !nextBtn || !dotsContainer) return;

            const items = sliderContainer.querySelectorAll('.themes-slider-item');
            const totalItems = items.length;
            const itemsPerView = getItemsPerView();
            const totalSlides = Math.ceil(totalItems / itemsPerView);

            let currentSlide = 0;

            // Generate dots
            generateSliderDots(dotsContainer, totalSlides);
            const dots = dotsContainer.querySelectorAll('.slider-dot');

            // Update slider position
            function updateSlider() {
                const translateX = -currentSlide * (100 / itemsPerView);
                sliderContainer.style.transform = `translateX(${translateX}%)`;

                // Update dots
                dots.forEach((dot, index) => {
                    dot.classList.toggle('active', index === currentSlide);
                });

                // Update button states
                prevBtn.disabled = currentSlide === 0;
                nextBtn.disabled = currentSlide >= totalSlides - 1;
            }

            // Generate slider dots
            function generateSliderDots(container, totalSlides) {
                container.innerHTML = '';
                for (let i = 0; i < totalSlides; i++) {
                    const dot = document.createElement('div');
                    dot.className = `slider-dot ${i === 0 ? 'active' : ''}`;
                    dot.addEventListener('click', () => {
                        currentSlide = i;
                        updateSlider();
                    });
                    container.appendChild(dot);
                }
            }

            // Get items per view based on screen size
            function getItemsPerView() {
                if (window.innerWidth < 768) return 1;
                if (window.innerWidth < 1024) return 2;
                return 3;
            }

            // Event listeners
            prevBtn.addEventListener('click', () => {
                if (currentSlide > 0) {
                    currentSlide--;
                    updateSlider();
                }
            });

            nextBtn.addEventListener('click', () => {
                if (currentSlide < totalSlides - 1) {
                    currentSlide++;
                    updateSlider();
                }
            });

            // Handle window resize
            window.addEventListener('resize', () => {
                const newItemsPerView = getItemsPerView();
                if (newItemsPerView !== itemsPerView) {
                    currentSlide = 0;
                    updateSlider();
                }
            });

            // Touch/swipe support
            let startX = 0;
            let isDragging = false;

            sliderContainer.addEventListener('touchstart', (e) => {
                startX = e.touches[0].clientX;
                isDragging = true;
            });

            sliderContainer.addEventListener('touchmove', (e) => {
                if (!isDragging) return;
                e.preventDefault();
            });

            sliderContainer.addEventListener('touchend', (e) => {
                if (!isDragging) return;
                isDragging = false;

                const endX = e.changedTouches[0].clientX;
                const diffX = startX - endX;

                if (Math.abs(diffX) > 50) { // Minimum swipe distance
                    if (diffX > 0 && currentSlide < totalSlides - 1) {
                        // Swipe left - next slide
                        currentSlide++;
                        updateSlider();
                    } else if (diffX < 0 && currentSlide > 0) {
                        // Swipe right - previous slide
                        currentSlide--;
                        updateSlider();
                    }
                }
            });

            // Initialize slider
            updateSlider();
        }

        // Quick create theme function
        function quickCreateTheme() {
            const themeName = document.getElementById('new-theme-name')?.value.trim() || `Quick Theme ${Date.now()}`;
            const themeDescription = document.getElementById('new-theme-description')?.value.trim() || 'Quickly created theme';

            // Clear any existing theme data
            localStorage.removeItem('editThemeData');
            localStorage.removeItem('currentThemeId');

            // Create theme metadata
            const themeMetadata = {
                id: 'theme-' + Date.now(),
                name: themeName,
                description: themeDescription,
                startingPoint: 'blank',
                template: null,
                status: 'draft',
                createdAt: new Date().toISOString()
            };

            localStorage.setItem('newThemeMetadata', JSON.stringify(themeMetadata));

            // Close modal and redirect
            const modal = document.querySelector('.fixed.inset-0');
            if (modal) modal.remove();

            showNotification(`Creating "${themeName}"...`, 'info');

            setTimeout(() => {
                window.location.href = `professional-builder-new.html?mode=new&theme=${themeMetadata.id}`;
            }, 500);
        }

        async function createNewTheme(name, description, startingPoint, template) {
            console.log('createNewTheme called with:', { name, description, startingPoint, template });

            try {
                // Ensure data consistency first
                ensureDataConsistency();

                // Check for duplicate names and generate unique name
                const uniqueName = checkForDuplicateName(name);

                const rawTheme = {
                    id: 'theme-' + Date.now() + '-' + Math.random().toString(36).substr(2, 5),
                    name: uniqueName,
                    description: description,
                    startingPoint: startingPoint,
                    template: template,
                    status: 'draft',
                    userId: window.firebase?.auth?.currentUser?.uid || 'demo-user-' + Date.now(),
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString(),
                    uniqueId: generateUniqueId(),
                    // Add preview customization
                    previewGradient: getRandomGradient(),
                    previewIcon: getRandomIcon(),
                    sections: [],
                    theme: {
                        colors: {},
                        fonts: {},
                        layout: {}
                    }
                };

                // Validate theme data
                const newTheme = validateThemeData(rawTheme);

                // Show message if name was changed due to duplicates
                if (uniqueName !== name) {
                    showNotification(`Theme name changed to "${uniqueName}" to avoid duplicates`, 'info');
                }

                console.log('New theme object:', newTheme);

                // Save to Firebase if available
                if (window.firebase && window.firebase.db && window.firebase.auth.currentUser) {
                    try {
                        const userThemesRef = window.firebase.collection(window.firebase.db, 'user_themes');
                        await window.firebase.addDoc(userThemesRef, newTheme);
                        console.log('✅ Theme saved to Firebase');
                        showNotification(`Theme "${name}" created and saved to cloud!`, 'success');
                    } catch (firebaseError) {
                        console.warn('⚠️ Firebase save failed, using localStorage:', firebaseError);
                        // Fallback to localStorage
                        const themes = JSON.parse(localStorage.getItem('firebase_themes') || '[]');
                        themes.push(newTheme);
                        localStorage.setItem('firebase_themes', JSON.stringify(themes));
                        showNotification(`Theme "${name}" created and saved locally!`, 'success');
                    }
                } else {
                    // Save to localStorage only
                    const themes = JSON.parse(localStorage.getItem('firebase_themes') || '[]');
                    themes.push(newTheme);
                    localStorage.setItem('firebase_themes', JSON.stringify(themes));
                    console.log('📱 Theme saved to localStorage');
                    showNotification(`Theme "${name}" created and saved locally!`, 'success');
                }

                // Reload themes
                loadThemesFromFirebase();

                // Store theme metadata for the builder
                localStorage.setItem('newThemeMetadata', JSON.stringify({
                    id: newTheme.id,
                    name: name,
                    description: description,
                    startingPoint: startingPoint,
                    template: template,
                    status: 'draft',
                    createdAt: newTheme.createdAt
                }));

                // Clear any existing theme data
                localStorage.removeItem('editThemeData');
                localStorage.removeItem('currentThemeId');

                setTimeout(() => {
                    console.log('Redirecting to builder with theme ID:', newTheme.id);
                    window.location.href = `professional-builder-new.html?mode=new&theme=${newTheme.id}`;
                }, 1000);

            } catch (error) {
                console.error('❌ Error creating theme:', error);
                showNotification('Error creating theme. Please try again.', 'error');
            }
        }

        function getRandomGradient() {
            const gradients = [
                'from-[var(--madas-primary)] via-[var(--madas-secondary)] to-[var(--madas-accent)]',
                'from-blue-500 to-purple-600',
                'from-green-500 to-teal-600',
                'from-orange-500 to-red-600',
                'from-pink-500 to-rose-600',
                'from-indigo-500 to-blue-600',
                'from-emerald-500 to-green-600',
                'from-amber-500 to-orange-600'
            ];
            return gradients[Math.floor(Math.random() * gradients.length)];
        }

        function getRandomIcon() {
            const icons = [
                'auto_awesome',
                'rocket_launch',
                'notifications',
                'spa',
                'palette',
                'brush',
                'design_services',
                'web',
                'star',
                'favorite'
            ];
            return icons[Math.floor(Math.random() * icons.length)];
        }

        function addThemeToLibrary(theme) {
            const themeCard = document.createElement('div');
            themeCard.className = 'theme-card bg-white rounded-xl p-6 border border-gray-200 hover:shadow-lg transition-shadow';
            themeCard.innerHTML = `
                <div class="mb-4">
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="text-lg font-semibold text-gray-900">${theme.name}</h3>
                        <span class="bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full text-xs font-medium">DRAFT</span>
                    </div>
                    <p class="text-gray-600 text-sm">Added ${theme.createdAt}</p>
                    ${theme.description ? `<p class="text-gray-500 text-xs mt-1">${theme.description}</p>` : ''}
                </div>
                <div class="flex space-x-2">
                    <button class="theme-publish-btn bg-green-600 text-white px-3 py-2 rounded-lg hover:bg-green-700 transition-colors text-sm flex-1">
                        Publish
                    </button>
                    <button class="theme-edit-btn bg-gray-100 text-gray-700 px-3 py-2 rounded-lg hover:bg-gray-200 transition-colors text-sm">
                        Edit
                    </button>
                    <button class="theme-more-btn bg-gray-100 text-gray-700 px-3 py-2 rounded-lg hover:bg-gray-200 transition-colors text-sm">
                        <span class="material-icons text-sm">more_vert</span>
                    </button>
                </div>
            `;

            const themeGrid = document.querySelector('.grid.grid-cols-1.md\\:grid-cols-2.lg\\:grid-cols-3');
            themeGrid.appendChild(themeCard);
            initializeThemeCardEvents(themeCard);
        }

        function initializeThemeCardEvents(card) {
            const themeId = card.getAttribute('data-theme-id');

            // Edit button
            const editBtn = card.querySelector('.theme-edit-btn');
            if (editBtn) {
                editBtn.addEventListener('click', function () {
                    if (themeId) {
                        // Load theme data and pass to builder with proper isolation
                        const savedThemes = JSON.parse(localStorage.getItem('savedThemes') || '[]');
                        const theme = savedThemes.find(t => t.id === themeId);

                        if (theme) {
                            console.log('🔍 Original theme data from library:', {
                                id: theme.id,
                                name: theme.name,
                                description: theme.description,
                                sections: theme.sections?.length || 0
                            });

                            // Create a deep copy of the theme to prevent data sharing
                            const isolatedThemeData = {
                                id: theme.id,
                                name: theme.name, // Preserve the original name
                                description: theme.description,
                                status: theme.status,
                                createdAt: theme.createdAt,
                                lastModified: new Date().toISOString(),
                                sections: theme.sections ? JSON.parse(JSON.stringify(theme.sections)) : [],
                                theme: theme.theme ? JSON.parse(JSON.stringify(theme.theme)) : {},
                                userId: theme.userId,
                                uniqueId: theme.uniqueId || 'unique-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9)
                            };

                            console.log('🎨 Loading isolated theme for editing:', {
                                id: isolatedThemeData.id,
                                name: isolatedThemeData.name,
                                description: isolatedThemeData.description,
                                sections: isolatedThemeData.sections?.length || 0
                            });

                            localStorage.setItem('editThemeData', JSON.stringify(isolatedThemeData));
                            localStorage.setItem('currentEditingThemeId', themeId);
                            window.location.href = 'professional-builder-new.html?mode=edit&theme=' + themeId;
                        } else {
                            console.warn('⚠️ Theme not found, creating new theme');
                            window.location.href = 'professional-builder-new.html';
                        }
                    } else {
                        window.location.href = 'professional-builder-new.html';
                    }
                });
            }

            // Preview button
            const previewBtn = card.querySelector('.theme-preview-btn');
            if (previewBtn) {
                previewBtn.addEventListener('click', function () {
                    if (themeId) {
                        const savedThemes = JSON.parse(localStorage.getItem('savedThemes') || '[]');
                        const theme = savedThemes.find(t => t.id === themeId);
                        if (theme) {
                            // Create isolated preview data to prevent data sharing
                            const isolatedPreviewData = {
                                id: themeId,
                                name: theme.name,
                                description: theme.description,
                                themeData: {
                                    sections: theme.sections ? JSON.parse(JSON.stringify(theme.sections)) : [],
                                    theme: theme.theme ? JSON.parse(JSON.stringify(theme.theme)) : {}
                                },
                                createdAt: new Date().toISOString(),
                                uniqueId: theme.uniqueId || 'unique-' + Date.now()
                            };

                            console.log('👁️ Creating isolated preview data:', isolatedPreviewData);
                            localStorage.setItem(`preview_${themeId}`, JSON.stringify(isolatedPreviewData));
                            window.open(`preview.html?id=${themeId}`, '_blank');
                        }
                    }
                });
            }

            // Publish button
            const publishBtn = card.querySelector('.theme-publish-btn');
            if (publishBtn) {
                publishBtn.addEventListener('click', function () {
                    if (themeId && confirm('Are you sure you want to publish this theme? This will make it live on your website and unpublish any other themes.')) {
                        publishTheme(themeId);
                    }
                });
            }

            // More button (if exists in old cards)
            const moreBtn = card.querySelector('.theme-more-btn');
            if (moreBtn) {
                moreBtn.addEventListener('click', function () {
                    const options = ['Duplicate', 'Rename', 'Delete'];
                    const choice = prompt('Choose an option:\n1. Duplicate\n2. Rename\n3. Delete\n\nEnter number (1-3):');

                    switch (choice) {
                        case '1':
                            showNotification('Theme duplicated successfully!', 'success');
                            break;
                        case '2':
                            const newName = prompt('Enter new theme name:');
                            if (newName) {
                                const title = card.querySelector('h3');
                                title.textContent = newName;
                                showNotification('Theme renamed successfully!', 'success');
                            }
                            break;
                        case '3':
                            if (confirm('Are you sure you want to delete this theme? This action cannot be undone.')) {
                                card.remove();
                                showNotification('Theme deleted successfully!', 'success');
                            }
                            break;
                    }
                });
            }
        }

        // Unified storage configuration
        const STORAGE_KEYS = {
            THEMES: 'madas_themes',
            CURRENT_THEME: 'madas_current_theme',
            EDIT_THEME_DATA: 'madas_edit_theme_data',
            NEW_THEME_DATA: 'madas_new_theme_data',
            USER_PREFERENCES: 'madas_user_preferences'
        };

        // Data validation function
        function validateThemeData(themeData) {
            if (!themeData || typeof themeData !== 'object') {
                throw new Error('Invalid theme data: must be an object');
            }

            return {
                id: themeData.id || generateUniqueId(),
                name: themeData.name && themeData.name.trim() !== '' ? themeData.name.trim() : 'My Website',
                description: themeData.description || '',
                sections: Array.isArray(themeData.sections) ? themeData.sections : [],
                status: themeData.status || 'draft',
                createdAt: themeData.createdAt || new Date().toISOString(),
                lastModified: new Date().toISOString(),
                userId: themeData.userId || 'demo-user',
                uniqueId: themeData.uniqueId || generateUniqueId()
            };
        }

        function generateUniqueId() {
            return 'unique-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
        }

        // Function to ensure theme data isolation
        function ensureThemeIsolation(theme) {
            if (!theme) return null;

            // Generate unique ID to prevent conflicts
            const uniqueId = theme.uniqueId || generateUniqueId();
            const themeId = theme.id || 'theme-' + Date.now() + '-' + Math.random().toString(36).substr(2, 5);

            return {
                id: themeId,
                name: theme.name || 'My Website',
                description: theme.description || 'Your custom website theme',
                status: theme.status || 'draft',
                createdAt: theme.createdAt || new Date().toISOString(),
                lastModified: new Date().toISOString(),
                sections: theme.sections ? JSON.parse(JSON.stringify(theme.sections)) : [],
                theme: theme.theme ? JSON.parse(JSON.stringify(theme.theme)) : {},
                userId: theme.userId || 'demo-user',
                uniqueId: uniqueId
            };
        }

        // Ensure data consistency across all storage locations
        function ensureDataConsistency() {
            try {
                console.log('🔍 Ensuring data consistency in theme library...');

                // Get all theme data from different sources
                const savedThemes = JSON.parse(localStorage.getItem('savedThemes') || '[]');
                const firebaseThemes = JSON.parse(localStorage.getItem('firebase_themes') || '[]');
                const madasThemes = JSON.parse(localStorage.getItem(STORAGE_KEYS.THEMES) || '[]');

                // Merge and deduplicate themes
                const allThemes = [...savedThemes, ...firebaseThemes, ...madasThemes];
                const uniqueThemes = deduplicateThemes(allThemes);

                // Save unified themes
                localStorage.setItem(STORAGE_KEYS.THEMES, JSON.stringify(uniqueThemes));

                console.log(`✅ Data consistency ensured: ${uniqueThemes.length} unique themes`);
                return uniqueThemes;
            } catch (error) {
                console.error('❌ Error ensuring data consistency:', error);
                return [];
            }
        }

        function deduplicateThemes(themes) {
            const seen = new Set();
            return themes.filter(theme => {
                const key = theme.id || theme.uniqueId;
                if (seen.has(key)) {
                    return false;
                }
                seen.add(key);
                return true;
            });
        }

        // Check for duplicate theme names and generate unique name
        function checkForDuplicateName(themeName, excludeId = null) {
            try {
                const savedThemes = JSON.parse(localStorage.getItem('savedThemes') || '[]');
                const firebaseThemes = JSON.parse(localStorage.getItem('firebase_themes') || '[]');
                const allThemes = [...savedThemes, ...firebaseThemes];

                // Filter out the current theme if editing
                const otherThemes = allThemes.filter(theme => theme.id !== excludeId);

                // Check if name exists
                const existingTheme = otherThemes.find(theme =>
                    theme.name && theme.name.toLowerCase() === themeName.toLowerCase()
                );

                if (existingTheme) {
                    // Generate unique name
                    let counter = 1;
                    let newName = `${themeName} (${counter})`;

                    while (otherThemes.find(theme =>
                        theme.name && theme.name.toLowerCase() === newName.toLowerCase()
                    )) {
                        counter++;
                        newName = `${themeName} (${counter})`;
                    }

                    console.log(`⚠️ Duplicate name found: "${themeName}" -> "${newName}"`);
                    return newName;
                }

                return themeName;
            } catch (error) {
                console.error('Error checking for duplicate names:', error);
                return themeName;
            }
        }

        // Function to update a specific theme without affecting others
        function updateThemeInStorage(themeId, updatedData) {
            try {
                const savedThemes = JSON.parse(localStorage.getItem('savedThemes') || '[]');
                const themeIndex = savedThemes.findIndex(t => t.id === themeId);

                if (themeIndex !== -1) {
                    // Create isolated update data
                    const isolatedUpdate = ensureThemeIsolation({
                        ...savedThemes[themeIndex],
                        ...updatedData,
                        lastModified: new Date().toISOString()
                    });

                    // Update only this specific theme
                    savedThemes[themeIndex] = isolatedUpdate;
                    localStorage.setItem('savedThemes', JSON.stringify(savedThemes));

                    console.log('✅ Theme updated with isolation:', isolatedUpdate);
                    return true;
                } else {
                    console.warn('⚠️ Theme not found for update:', themeId);
                    return false;
                }
            } catch (error) {
                console.error('❌ Error updating theme:', error);
                return false;
            }
        }

        // Load saved themes from localStorage
        async function loadSavedThemes() {
            console.log('📚 Loading saved themes...');
            const savedThemes = JSON.parse(localStorage.getItem('savedThemes') || '[]');
            const themeGrid = document.querySelector('.theme-grid');
            const emptyState = document.getElementById('empty-state');
            const noResultsState = document.getElementById('no-results-state');

            console.log('Theme grid element:', themeGrid);
            console.log('Saved themes from localStorage:', savedThemes);

            if (!themeGrid) {
                console.error('❌ Theme grid not found - selector: .theme-grid');
                return;
            }

            // Clear existing saved theme cards
            const existingCards = themeGrid.querySelectorAll('[data-theme-id]');
            console.log(`🗑️ Removing ${existingCards.length} existing theme cards`);
            existingCards.forEach(card => card.remove());

            // Hide no results state
            if (noResultsState) {
                noResultsState.classList.add('hidden');
            }

            if (savedThemes.length > 0) {
                console.log(`✅ Found ${savedThemes.length} saved themes`);

                // Hide empty state, show grid
                if (emptyState) emptyState.classList.add('hidden');
                themeGrid.classList.remove('hidden');

                // Add each theme to the library with proper isolation
                savedThemes.forEach((theme, index) => {
                    console.log(`Adding theme ${index + 1}:`, theme);
                    const isolatedTheme = ensureThemeIsolation(theme);
                    if (isolatedTheme) {
                        addSavedThemeToLibrary(isolatedTheme);
                    }
                });

                // Update stats
                updateStats(savedThemes);

                // Also sync to Firebase if available
                if (window.firebase && window.firebase.db) {
                    try {
                        await syncThemesToFirebase(savedThemes);
                    } catch (error) {
                        console.warn('⚠️ Failed to sync themes to Firebase:', error);
                    }
                }

                console.log('✅ All themes loaded successfully!');
            } else {
                console.log('📭 No saved themes found in localStorage');
                console.log('💡 Create a theme in professional-builder-new.html to see it here!');

                // Show empty state, hide grid
                if (emptyState) emptyState.classList.remove('hidden');
                themeGrid.classList.add('hidden');

                // Update stats to show zero
                updateStats([]);
            }
        }

        // Sync themes to Firebase
        async function syncThemesToFirebase(themes) {
            try {
                const { db, collection: collectionFn, addDoc, query, where, getDocs } = window.firebase;

                for (const theme of themes) {
                    // Check if theme already exists in Firebase
                    const themesRef = collectionFn(db, 'themes');
                    const q = query(themesRef, where('id', '==', theme.id));
                    const querySnapshot = await getDocs(q);

                    if (querySnapshot.empty) {
                        // Theme doesn't exist, add it
                        await addDoc(themesRef, {
                            ...theme,
                            syncedAt: new Date().toISOString()
                        });
                        console.log(`✅ Theme "${theme.name}" synced to Firebase`);
                    }
                }
            } catch (error) {
                console.error('❌ Error syncing themes to Firebase:', error);
            }
        }

        function addSavedThemeToLibrary(theme) {
            const themeGrid = document.querySelector('.theme-grid');

            if (!themeGrid) {
                console.error('Theme grid not found in addSavedThemeToLibrary');
                return;
            }

            // Use the isolation function to ensure proper data separation
            const isolatedTheme = ensureThemeIsolation(theme);

            console.log('🎨 Creating isolated theme:', isolatedTheme);

            const themeCard = document.createElement('div');
            themeCard.className = 'theme-store-card relative overflow-hidden group';
            themeCard.setAttribute('data-theme-id', isolatedTheme.id);
            themeCard.setAttribute('data-unique-id', isolatedTheme.uniqueId);

            const statusClass = isolatedTheme.status === 'published' ? 'from-[var(--madas-success)] to-green-400' : 'from-yellow-500 to-amber-400';
            const statusText = isolatedTheme.status === 'published' ? 'Published' : 'Draft';
            const statusIcon = isolatedTheme.status === 'published' ? 'check_circle' : 'edit_note';

            // Generate a random gradient for theme preview
            const gradients = [
                'from-purple-500 via-pink-600 to-rose-700',
                'from-blue-500 via-indigo-600 to-purple-700',
                'from-green-500 via-teal-600 to-emerald-700',
                'from-orange-500 via-red-600 to-pink-700',
                'from-cyan-500 via-blue-600 to-indigo-700'
            ];
            const randomGradient = gradients[Math.floor(Math.random() * gradients.length)];

            themeCard.innerHTML = `
                <!-- Status Badge -->
                <div class="absolute top-4 left-4 z-10">
                    <div class="bg-gradient-to-r ${statusClass} text-white px-3 py-1 rounded-full text-xs font-semibold shadow-lg">
                        <span class="material-icons text-xs mr-1">${statusIcon}</span>
                        ${statusText}
                    </div>
                </div>

                <!-- My Theme Badge -->
                <div class="absolute top-4 right-4 z-10">
                    <div class="bg-gradient-to-r from-[var(--madas-primary)] to-blue-400 text-white px-3 py-1 rounded-full text-xs font-semibold shadow-lg">
                        <span class="material-icons text-xs mr-1">person</span>
                        My Theme
                    </div>
                </div>

                <!-- Theme Preview -->
                <div class="theme-preview relative">
                    <div class="absolute inset-0 bg-gradient-to-br ${randomGradient}"></div>
                    <div class="absolute inset-0 bg-black/20"></div>
                    <div class="absolute inset-0 flex items-center justify-center">
                        <div class="text-center text-white">
                            <div class="w-16 h-16 bg-white/20 backdrop-blur-sm rounded-2xl flex items-center justify-center mx-auto mb-4">
                                <span class="material-icons text-3xl">web</span>
                            </div>
                            <h3 class="text-xl font-bold mb-2">${theme.name || 'My Theme'}</h3>
                            <p class="text-white/80 text-sm">${theme.description || 'Custom Website'}</p>
                        </div>
                    </div>
                </div>

                <!-- Theme Info -->
                <div class="p-6">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="text-lg font-bold text-[var(--madas-dark)]">${isolatedTheme.name || 'My Theme'}</h3>
                        <div class="flex items-center space-x-1 text-[var(--madas-gray)]">
                            <span class="material-icons text-sm">schedule</span>
                            <span class="text-xs">${new Date(isolatedTheme.lastModified).toLocaleDateString()}</span>
                        </div>
                    </div>
                    <p class="text-[var(--madas-gray)] text-sm mb-4">${isolatedTheme.description || 'Your custom website theme'}</p>
                    <div class="flex items-center justify-between space-x-2">
                        <button class="theme-edit-btn bg-[var(--madas-primary)] text-white px-4 py-2 rounded-lg hover:bg-[var(--madas-accent)] transition-all duration-300 text-sm font-semibold flex items-center space-x-1 flex-1">
                            <span class="material-icons text-sm">edit</span>
                            <span>Edit</span>
                    </button>
                        <button class="theme-preview-btn bg-gray-100 text-[var(--madas-dark)] px-4 py-2 rounded-lg hover:bg-gray-200 transition-all duration-300 text-sm font-semibold flex items-center space-x-1 flex-1">
                            <span class="material-icons text-sm">visibility</span>
                            <span>Preview</span>
                    </button>
                        <button class="theme-publish-btn bg-[var(--madas-success)] text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-all duration-300 text-sm font-semibold">
                            ${theme.status === 'published' ? 'Update' : 'Publish'}
                    </button>
                    </div>
                </div>
            `;

            themeGrid.appendChild(themeCard);
            initializeThemeCardEvents(themeCard);
        }

        // Notification system
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 transition-all duration-300 ${type === 'success' ? 'bg-green-500 text-white' :
                type === 'error' ? 'bg-red-500 text-white' :
                    'bg-blue-500 text-white'
                }`;
            notification.textContent = message;

            document.body.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 3000);
        }
        // Function to redirect to live site (active published theme)
        function redirectToLiveSite() {
            try {
                // Get all themes from localStorage (check both storage locations)
                const allThemes = JSON.parse(localStorage.getItem('savedThemes') || '[]');
                const firebaseThemes = JSON.parse(localStorage.getItem('firebase_themes') || '[]');
                const themes = [...allThemes, ...firebaseThemes];

                // Find the published theme
                const publishedTheme = themes.find(theme => theme.status === 'published');

                if (publishedTheme) {
                    console.log('Found published theme:', publishedTheme);

                    // Redirect to the published theme viewer
                    const liveSiteUrl = `view-published-theme.html?theme=${publishedTheme.id}`;
                    window.open(liveSiteUrl, '_blank');

                    showNotification(`Opening live site: ${publishedTheme.name}`, 'success');
                } else {
                    // No published theme found, show message
                    showNotification('No published theme found. Please publish a theme first.', 'warning');

                    // Show option to create new theme or view published themes
                    setTimeout(() => {
                        const choice = confirm('No published theme found. Would you like to view all your themes?');
                        if (choice) {
                            showPublishedThemes();
                        }
                    }, 1000);
                }

            } catch (error) {
                console.error('Error redirecting to live site:', error);
                showNotification('Error accessing live site', 'error');
            }
        }
        // Make functions globally available
        window.showCreateThemeModal = showCreateThemeModal;
        window.createNewTheme = createNewTheme;
        window.redirectToLiveSite = redirectToLiveSite;

        // Test function availability
        console.log('Global functions available:', {
            showCreateThemeModal: typeof window.showCreateThemeModal,
            createNewTheme: typeof window.createNewTheme,
            redirectToLiveSite: typeof window.redirectToLiveSite
        });

        // Global error handler to suppress extension errors
        window.addEventListener('error', function (event) {
            // Suppress known extension errors
            if (event.message && event.message.includes('Could not establish connection')) {
                event.preventDefault();
                return false;
            }
        });

        // Handle unhandled promise rejections
        window.addEventListener('unhandledrejection', function (event) {
            // Suppress known extension errors
            if (event.reason && event.reason.message && event.reason.message.includes('Could not establish connection')) {
                event.preventDefault();
                return false;
            }
        });
    </script>
    <script type="module">
        // Use existing Firebase instance from the main script
        const auth = window.firebase?.auth;
        const db = window.firebase?.db;

        let currentUserId = null;

        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                window.location.href = "/login";
                return;
            }

            try {
                console.log('🔐 User authenticated:', user.email);

                // ============================================
                // TENANT ISOLATION: Initialize Business Context
                // ============================================

                // Check for super admin users first (bypass business detection)
                const superAdminEmails = [
                    "hesainosama@gmail.com",
                    "test@example.com"
                ];

                if (superAdminEmails.includes(user.email)) {
                    console.log("🔑 Super admin detected - granting full access");
                    window.currentUserRole = "super-admin";
                    window.currentBusinessId = "super-admin";
                    window.currentBusinessData = {
                        businessName: "Super Admin",
                        plan: { type: "enterprise", status: "active" }
                    };

                    // Set super admin permissions
                    const userData = {
                        email: user.email,
                        displayName: user.displayName || "Super Admin",
                        role: "super-admin",
                        approved: true,
                        permissions: {
                            home: ["view"],
                            orders: ["view", "search", "create", "edit"],
                            inventory: ["view", "edit"],
                            customers: ["view", "edit"],
                            employees: ["view", "edit"],
                            finance: ["view", "reports"],
                            analytics: ["view", "export"],
                            settings: ["view", "edit"],
                            admin: ["view", "manage_all_businesses"]
                        }
                    };

                    // Store user data
                    localStorage.setItem("madasUser", JSON.stringify(userData));

                    // Update UI
                    const username = userData.displayName || user.displayName || user.email.split("@")[0];
                    const userNameEl = document.getElementById("user-name");
                    const userEmailEl = document.getElementById("user-email");
                    const userInitialEl = document.getElementById("user-initial");

                    if (userNameEl) userNameEl.textContent = username;
                    if (userEmailEl) userEmailEl.textContent = user.email;
                    if (userInitialEl) userInitialEl.textContent = username.charAt(0).toUpperCase();

                    // Update business name and plan
                    const businessNameEl = document.getElementById("business-name");
                    if (businessNameEl) businessNameEl.textContent = "Super Admin";

                    const planBadge = document.getElementById("plan-badge");
                    if (planBadge) {
                        planBadge.textContent = "Enterprise Plan";
                        planBadge.className = "text-xs px-2 py-0.5 rounded-full bg-purple-100 text-purple-800 hover:bg-purple-200 transition-colors cursor-pointer";
                    }

                    // Hide loading screen if it exists
                    const loadingScreen = document.getElementById('loadingScreen');
                    if (loadingScreen) loadingScreen.style.display = 'none';

                    return;
                }

                // Step 1: Find user's business (check if owner)
                const businessesQuery = query(collection(db, "businesses"), where("owner.userId", "==", user.uid));
                const businessSnapshot = await getDocs(businessesQuery);

                if (!businessSnapshot.empty) {
                    // User is a business owner
                    const businessDoc = businessSnapshot.docs[0];
                    window.currentBusinessId = businessDoc.id;
                    window.currentBusinessData = businessDoc.data();
                    window.currentUserRole = 'owner';

                    console.log('✅ Business Owner:', window.currentBusinessData.businessName);
                    console.log('🏢 Business ID:', window.currentBusinessId);
                    console.log('📋 Plan:', window.currentBusinessData.plan?.type);

                } else {
                    // Step 2: Check if user is staff member
                    const allBusinesses = await getDocs(collection(db, "businesses"));
                    let foundBusiness = false;

                    for (const businessDoc of allBusinesses.docs) {
                        const businessId = businessDoc.id;
                        const staffRef = doc(db, 'businesses', businessId, 'staff', user.uid);
                        const staffDoc = await getDoc(staffRef);

                        if (staffDoc.exists()) {
                            const staffData = staffDoc.data();
                            window.currentBusinessId = businessId;
                            window.currentBusinessData = businessDoc.data();
                            window.currentUserRole = staffData.role;
                            window.currentUserPermissions = staffData.permissions;

                            console.log('✅ Staff Member:', window.currentBusinessData.businessName);
                            console.log('🏢 Business ID:', window.currentBusinessId);
                            console.log('👤 Role:', window.currentUserRole);

                            foundBusiness = true;
                            break;
                        }
                    }

                    if (!foundBusiness) {
                        console.warn("❌ User not associated with any business.");
                        console.log("🔍 User email:", user.email);
                        console.log("🔍 User UID:", user.uid);

                        // For now, create a temporary business context for testing
                        console.log("⚠️ Creating temporary business context for testing...");
                        window.currentBusinessId = "temp-business";
                        window.currentBusinessData = {
                            businessName: "Temporary Business",
                            plan: { type: "basic", status: "active" },
                            owner: { name: user.displayName || user.email.split("@")[0] }
                        };
                        window.currentUserRole = "owner";

                        // Set basic permissions
                        const userData = {
                            email: user.email,
                            displayName: user.displayName || user.email.split("@")[0],
                            role: "owner",
                            approved: true,
                            permissions: {
                                home: ["view"],
                                orders: ["view", "search", "create", "edit"],
                                inventory: ["view", "edit"],
                                customers: ["view", "edit"],
                                employees: ["view", "edit"],
                                finance: ["view", "reports"],
                                analytics: ["view", "export"],
                                settings: ["view", "edit"]
                            }
                        };

                        // Store user data
                        localStorage.setItem("madasUser", JSON.stringify(userData));

                        // Update UI
                        const username = userData.displayName || user.displayName || user.email.split("@")[0];
                        const userNameEl = document.getElementById("user-name");
                        const userEmailEl = document.getElementById("user-email");
                        const userInitialEl = document.getElementById("user-initial");

                        if (userNameEl) userNameEl.textContent = username;
                        if (userEmailEl) userEmailEl.textContent = user.email;
                        if (userInitialEl) userInitialEl.textContent = username.charAt(0).toUpperCase();

                        // Update business name and plan
                        const businessNameEl = document.getElementById("business-name");
                        if (businessNameEl) businessNameEl.textContent = "Temporary Business";

                        const planBadge = document.getElementById("plan-badge");
                        if (planBadge) {
                            planBadge.textContent = "Basic Plan";
                            planBadge.className = "text-xs px-2 py-0.5 rounded-full bg-green-100 text-green-800 hover:bg-green-200 transition-colors cursor-pointer";
                        }

                        // Hide loading screen if it exists
                        const loadingScreen = document.getElementById('loadingScreen');
                        if (loadingScreen) loadingScreen.style.display = 'none';

                        return;
                    }
                }

                // Set user permissions based on role
                let userData = {
                    email: user.email,
                    displayName: user.displayName || window.currentBusinessData.owner?.name,
                    role: window.currentUserRole,
                    approved: true // All business users are approved by default
                };

                // Set permissions based on role
                if (window.currentUserRole === 'owner') {
                    userData.permissions = {
                        home: ["view"],
                        orders: ["view", "search", "create", "edit"],
                        inventory: ["view", "edit"],
                        customers: ["view", "edit"],
                        employees: ["view", "edit"],
                        finance: ["view", "reports"],
                        analytics: ["view", "export"],
                        settings: ["view", "edit"]
                    };
                } else if (window.currentUserRole === 'admin') {
                    userData.permissions = {
                        home: ["view"],
                        orders: ["view", "search", "create", "edit"],
                        inventory: ["view", "edit"],
                        customers: ["view", "edit"],
                        employees: ["view", "edit"],
                        finance: ["view", "reports"],
                        analytics: ["view", "export"],
                        settings: ["view", "edit"]
                    };
                } else {
                    // For staff members, use permissions from their staff document
                    userData.permissions = window.currentUserPermissions || {
                        home: ["view"]
                    };
                }

                ;
            }

                console.log('✅ User data created:', {
                email: userData.email,
                role: userData.role,
                businessId: window.currentBusinessId,
                businessName: window.currentBusinessData?.businessName,
                approved: userData.approved
            });

            // Store user data
            localStorage.setItem("madasUser", JSON.stringify(userData));

            // Update UI
            currentUserId = user.uid;
            const username = userData.displayName || window.currentBusinessData?.owner?.name || user.displayName || user.email.split("@")[0];

            // Update user info if elements exist
            const userNameEl = document.getElementById("user-name");
            const userEmailEl = document.getElementById("user-email");
            const userInitialEl = document.getElementById("user-initial");

            if (userNameEl) userNameEl.textContent = username;
            if (userEmailEl) userEmailEl.textContent = user.email;
            if (userInitialEl) userInitialEl.textContent = username.charAt(0).toUpperCase();

            // Update business name and plan
            const businessName = window.currentBusinessData?.businessName || "DIGIX Admin";
            const planType = window.currentBusinessData?.plan?.type || "basic";
            const planStatus = window.currentBusinessData?.plan?.status || "active";

            const businessNameEl = document.getElementById("business-name");
            if (businessNameEl) businessNameEl.textContent = businessName;

            const planBadge = document.getElementById("plan-badge");
            if (planBadge) {
                planBadge.textContent = `${planType.charAt(0).toUpperCase() + planType.slice(1)} Plan`;

                // Set plan badge color based on plan type
                if (planType === 'enterprise') {
                    planBadge.className = "text-xs px-2 py-0.5 rounded-full bg-purple-100 text-purple-800 hover:bg-purple-200 transition-colors cursor-pointer";
                } else if (planType === 'professional') {
                    planBadge.className = "text-xs px-2 py-0.5 rounded-full bg-blue-100 text-blue-800 hover:bg-blue-200 transition-colors cursor-pointer";
                } else {
                    planBadge.className = "text-xs px-2 py-0.5 rounded-full bg-green-100 text-green-800 hover:bg-green-200 transition-colors cursor-pointer";
                }

                // Add trial badge if in trial
                if (planStatus === 'trial') {
                    planBadge.textContent += ' (Trial)';
                }
            }

            // Hide loading screen if it exists
            const loadingScreen = document.getElementById('loadingScreen');
            if (loadingScreen) loadingScreen.style.display = 'none';

        } catch (error) {
            console.error("Permission check failed:", error);
            window.location.href = "/login";
        }
        });

        // Logout logic
        const logoutBtn = document.getElementById("logout-btn");
        if (logoutBtn) {
            logoutBtn.addEventListener("click", () => {
                auth.signOut().then(() => {
                    window.location.href = "/login";
                }).catch((error) => {
                    console.error("Logout error:", error);
                    window.location.href = "/login";
                });
            });
        }

        // Profile button
        const profileBtn = document.getElementById("profile-btn");
        if (profileBtn) {
            profileBtn.addEventListener("click", () => {
                window.location.href = "/pages/profile.html";
            });
        }

        // Finance Dropdown functionality
        const financeDropdownBtn = document.getElementById("finance-dropdown-btn");
        const financeDropdownMenu = document.getElementById("finance-dropdown-menu");
        const financeArrow = document.querySelector("#finance-dropdown-btn .dropdown-arrow");

        if (financeDropdownBtn && financeDropdownMenu) {
            financeDropdownBtn.addEventListener("click", (e) => {
                e.preventDefault();
                const isOpen = financeDropdownMenu.classList.contains("show");

                if (isOpen) {
                    financeDropdownMenu.classList.remove("show");
                    financeDropdownMenu.classList.add("hidden");
                    if (financeArrow) financeArrow.classList.remove("rotate");
                } else {
                    financeDropdownMenu.classList.remove("hidden");
                    financeDropdownMenu.classList.add("show");
                    if (financeArrow) financeArrow.classList.add("rotate");
                }
            });

            // Close dropdown when clicking outside
            document.addEventListener("click", (e) => {
                if (!financeDropdownBtn.contains(e.target) && !financeDropdownMenu.contains(e.target)) {
                    financeDropdownMenu.classList.remove("show");
                    financeDropdownMenu.classList.add("hidden");
                    if (financeArrow) financeArrow.classList.remove("rotate");
                }
            });
        }

        // E-commerce Dropdown functionality
        const ecommerceDropdownBtn = document.getElementById("ecommerce-dropdown-btn");
        const ecommerceDropdownMenu = document.getElementById("ecommerce-dropdown-menu");
        const ecommerceArrow = document.getElementById("ecommerce-arrow");

        if (ecommerceDropdownBtn && ecommerceDropdownMenu) {
            ecommerceDropdownBtn.addEventListener("click", (e) => {
                e.preventDefault();
                const isOpen = ecommerceDropdownMenu.classList.contains("show");

                if (isOpen) {
                    ecommerceDropdownMenu.classList.remove("show");
                    ecommerceDropdownMenu.classList.add("hidden");
                    if (ecommerceArrow) ecommerceArrow.classList.remove("rotate");
                } else {
                    ecommerceDropdownMenu.classList.remove("hidden");
                    ecommerceDropdownMenu.classList.add("show");
                    if (ecommerceArrow) ecommerceArrow.classList.add("rotate");
                }
            });
        }

        // Dark mode toggle logic
        const darkToggle = document.getElementById('darkToggle');
        const darkIcon = document.getElementById('darkToggleIcon');
        function setDarkMode(on) {
            document.body.classList.toggle('dark-mode', on);
            localStorage.setItem('dark-mode', on ? '1' : '0');
            if (on) {
                darkIcon.innerHTML = '<path d="M21.64 13.64A9 9 0 1 1 10.36 2.36a7 7 0 1 0 11.28 11.28z"/>';
            } else {
                darkIcon.innerHTML = '<path d="M12 2a1 1 0 0 1 1 1v1a1 1 0 1 1-2 0V3a1 1 0 0 1 1-1zm5.657 3.343a1 1 0 0 1 1.414 0l.707.707a1 1 0 1 1-1.414 1.414l-.707-.707a1 1 0 0 1 0-1.414zM21 11a1 1 0 1 1 0 2h-1a1 1 0 1 1 0-2h1zm-2.929 7.071a1 1 0 0 1 0 1.414l-.707.707a1 1 0 1 1-1.414-1.414l.707-.707a1 1 0 0 1 1.414 0zM12 20a1 1 0 0 1-1-1v-1a1 1 0 1 1 2 0v1a1 1 0 0 1-1 1zm-7.071-2.929a1 1 0 0 1-1.414 0l-.707-.707a1 1 0 1 1 1.414-1.414l.707.707a1 1 0 0 1 0 1.414zM4 13a1 1 0 1 1 0-2H3a1 1 0 1 1 0 2h1zm2.343-7.657a1 1 0 0 1 0 1.414l-.707.707A1 1 0 1 1 4.222 6.05l.707-.707a1 1 0 0 1 1.414 0zM12 6a6 6 0 1 1 0 12A6 6 0 0 1 12 6z" />';
            }
        }
        if (darkToggle) {
            darkToggle.addEventListener('click', () => {
                setDarkMode(!document.body.classList.contains('dark-mode'));
            });
        }
        if (localStorage.getItem('dark-mode') === '1') {
            setDarkMode(true);
        }

        // Inventory Dropdown functionality
        document.addEventListener("DOMContentLoaded", () => {
            const inventoryToggle = document.getElementById("inventory-toggle");
            const inventorySubmenu = document.getElementById("inventory-submenu");
            const inventoryArrow = document.getElementById("inventory-arrow");

            if (inventoryToggle && inventorySubmenu && inventoryArrow) {
                inventoryToggle.addEventListener("click", (e) => {
                    e.preventDefault();
                    const isOpen = !inventorySubmenu.classList.contains("hidden");

                    if (isOpen) {
                        inventorySubmenu.classList.add("hidden");
                        inventoryArrow.style.transform = "rotate(0deg)";
                    } else {
                        inventorySubmenu.classList.remove("hidden");
                        inventoryArrow.style.transform = "rotate(180deg)";
                    }
                });
            }
        });

        // Active Page Highlighting and Dropdown Management
        function highlightActivePage() {
            // Remove all active classes first
            document.querySelectorAll('.sidebar-link').forEach(link => {
                link.classList.remove('active');
            });

            // Get current page path
            const currentPath = window.location.pathname;
            const currentPageName = window.location.pathname.split('/').pop().replace('.html', '');

            console.log('Current path:', currentPath);
            console.log('Current page name:', currentPageName);

            // DASHBOARD LINK - Handle separately and FIRST
            const dashboardLink = document.querySelector('a[href="/dashboard"]');
            if (dashboardLink) {
                console.log('🔍 Checking Dashboard link for path:', currentPath);
                console.log('🔍 Current path details:', {
                    path: currentPath,
                    endsWithIndex: currentPath.endsWith('index.html'),
                    includesPages: currentPath.includes('pages'),
                    isRoot: currentPath === '/',
                    isDashboard: currentPath === '/dashboard'
                });

                // Dashboard should ONLY be active on dashboard page
                const isDashboardPage = (
                    currentPath === '/' ||
                    currentPath === '/dashboard' ||
                    currentPath === '/dashboard/' ||
                    currentPath.endsWith('/dashboard/index.html') ||
                    currentPath.endsWith('/index.html') ||
                    (currentPath.includes('index.html') && !currentPath.includes('pages')) ||
                    currentPath.startsWith('/dashboard') && !currentPath.includes('/pages')
                );

                if (isDashboardPage) {
                    dashboardLink.classList.add('active');
                    foundMatch = true;
                    console.log('✅ Dashboard page detected and highlighted for path:', currentPath);
                } else {
                    dashboardLink.classList.remove('active');
                    console.log('❌ Dashboard link NOT highlighted for path:', currentPath);
                }
            }

            // OTHER LINKS - Handle all other links
            sidebarLinks.forEach(link => {
                const href = link.getAttribute('href');
                if (!href || href === '#') return;

                // Skip Dashboard link - already handled above
                if (href === '/dashboard') return;

                // COMPLETELY DISABLE Dashboard highlighting on non-dashboard pages
                // Handle Dashboard link with PRECISE matching
                if (href === '/dashboard') {
                    // Dashboard should ONLY be active on dashboard page
                    const isDashboardPage = (
                        currentPath === '/' ||
                        currentPath === '/dashboard' ||
                        currentPath === '/dashboard/' ||
                        currentPath.endsWith('/dashboard/index.html') ||
                        currentPath.endsWith('/index.html') ||
                        (currentPath.includes('index.html') && !currentPath.includes('pages')) ||
                        currentPath.startsWith('/dashboard') && !currentPath.includes('/pages')
                    );
                    foundMatch = true;
                    console.log('Dashboard page detected and highlighted');
                }
            }
                }

                // Handle other links with normal matching
                else {
            // Check if current path matches this specific link
            if (currentPath === href || currentPath.endsWith(href.replace('/dashboard', ''))) {
                link.classList.add('active');
                foundMatch = true;
                console.log('Exact match found:', href);
            }
            // Check page name matching for other links
            else if (!foundMatch) {
                const linkPageName = href.split('/').pop().replace('.html', '');
                if (currentPageName === linkPageName ||
                    (currentPageName && currentPageName.toLowerCase().includes(linkPageName.toLowerCase())) ||
                    (linkPageName && linkPageName.toLowerCase().includes(currentPageName.toLowerCase()))) {
                    link.classList.add('active');
                    foundMatch = true;
                    console.log('Page name match found:', href, 'for page:', currentPageName);
                }
            }
        }
            });

        // Special cases for specific pages with dropdown management
        if (currentPath.includes('collections') || currentPageName === 'collections') {
            const collectionsLink = document.querySelector('a[href*="collections"]');
            if (collectionsLink) {
                collectionsLink.classList.add('active');
                foundMatch = true;
                console.log('Collections page detected');

                // Keep inventory dropdown open
                const inventoryDropdown = document.getElementById('inventory-submenu');
                const inventoryArrow = document.getElementById('inventory-arrow');
                if (inventoryDropdown && inventoryArrow) {
                    inventoryDropdown.classList.remove('hidden');
                    inventoryArrow.style.transform = 'rotate(180deg)';
                    console.log('Inventory dropdown kept open for collections');
                }
            }
        }

        if (currentPath.includes('products') || currentPageName === 'products') {
            const productsLink = document.querySelector('a[href*="products"]');
            if (productsLink) {
                productsLink.classList.add('active');
                foundMatch = true;
                console.log('Products page detected');

                // Keep inventory dropdown open
                const inventoryDropdown = document.getElementById('inventory-submenu');
                const inventoryArrow = document.getElementById('inventory-arrow');
                if (inventoryDropdown && inventoryArrow) {
                    inventoryDropdown.classList.remove('hidden');
                    inventoryArrow.style.transform = 'rotate(180deg)';
                    console.log('Inventory dropdown kept open for products');
                }
            }
        }

        if (currentPath.includes('low-stock') || currentPageName === 'low-stock') {
            const lowStockLink = document.querySelector('a[href*="low-stock"]');
            if (lowStockLink) {
                lowStockLink.classList.add('active');
                foundMatch = true;
                console.log('Low Stock page detected');

                // Keep inventory dropdown open
                const inventoryDropdown = document.getElementById('inventory-submenu');
                const inventoryArrow = document.getElementById('inventory-arrow');
                if (inventoryDropdown && inventoryArrow) {
                    inventoryDropdown.classList.remove('hidden');
                    inventoryArrow.style.transform = 'rotate(180deg)';
                    console.log('Inventory dropdown kept open for low-stock');
                }
            }
        }

        if (currentPath.includes('product-reviews') || currentPageName === 'reviews') {
            const reviewsLink = document.querySelector('a[href*="product-reviews"]');
            if (reviewsLink) {
                reviewsLink.classList.add('active');
                foundMatch = true;
                console.log('Reviews page detected');

                // Keep inventory dropdown open
                const inventoryDropdown = document.getElementById('inventory-submenu');
                const inventoryArrow = document.getElementById('inventory-arrow');
                if (inventoryDropdown && inventoryArrow) {
                    inventoryDropdown.classList.remove('hidden');
                    inventoryArrow.style.transform = 'rotate(180deg)';
                    console.log('Inventory dropdown kept open for reviews');
                }
            }
        }

        if (currentPath.includes('orders') || currentPageName === 'orders') {
            const ordersLink = document.querySelector('a[href*="orders"]');
            if (ordersLink) {
                ordersLink.classList.add('active');
                foundMatch = true;
                console.log('Orders page detected');
            }
        }

        if (currentPath.includes('Customer') || currentPageName === 'Customer') {
            const customerLink = document.querySelector('a[href*="Customer"]');
            if (customerLink) {
                customerLink.classList.add('active');
                foundMatch = true;
                console.log('Customer page detected');
            }
        }

        if (currentPath.includes('Admin') || currentPageName === 'Admin') {
            const adminLink = document.querySelector('a[href*="Admin"]');
            if (adminLink) {
                adminLink.classList.add('active');
                foundMatch = true;
                console.log('Admin page detected');
            }
        }

        if (currentPath.includes('settings') || currentPageName === 'settings') {
            const settingsLink = document.querySelector('a[href*="settings"]');
            if (settingsLink) {
                settingsLink.classList.add('active');
                foundMatch = true;
                console.log('Settings page detected');
            }
        }

        if (currentPath.includes('finance') || currentPageName === 'finance') {
            const financeLink = document.querySelector('a[href*="finance"]');
            if (financeLink) {
                financeLink.classList.add('active');
                foundMatch = true;
                console.log('Finance page detected');

                // Keep finance dropdown open
                const financeDropdown = document.getElementById('finance-dropdown-menu');
                const financeArrow = document.querySelector('#finance-dropdown-btn .dropdown-arrow');
                if (financeDropdown && financeArrow) {
                    financeDropdown.classList.remove('hidden');
                    financeDropdown.classList.add('show');
                    financeArrow.classList.add('rotated');
                    console.log('Finance dropdown kept open for finance page');
                }
            }
        }

        if (currentPath.includes('analytics') || currentPageName === 'analytics') {
            const analyticsLink = document.querySelector('a[href*="analytics"]');
            if (analyticsLink) {
                analyticsLink.classList.add('active');
                foundMatch = true;
                console.log('Analytics page detected');

                // Keep finance dropdown open
                const financeDropdown = document.getElementById('finance-dropdown-menu');
                const financeArrow = document.querySelector('#finance-dropdown-btn .dropdown-arrow');
                if (financeDropdown && financeArrow) {
                    financeDropdown.classList.remove('hidden');
                    financeDropdown.classList.add('show');
                    financeArrow.classList.add('rotated');
                    console.log('Finance dropdown kept open for analytics');
                }
            }
        }

        if (currentPath.includes('reports') || currentPageName === 'reports') {
            const reportsLink = document.querySelector('a[href*="reports"]');
            if (reportsLink) {
                reportsLink.classList.add('active');
                foundMatch = true;
                console.log('Reports page detected');

                // Keep finance dropdown open
                const financeDropdown = document.getElementById('finance-dropdown-menu');
                const financeArrow = document.querySelector('#finance-dropdown-btn .dropdown-arrow');
                if (financeDropdown && financeArrow) {
                    financeDropdown.classList.remove('hidden');
                    financeDropdown.classList.add('show');
                    financeArrow.classList.add('rotated');
                    console.log('Finance dropdown kept open for reports');
                }
            }
        }

        if (currentPath.includes('insights') || currentPageName === 'insights') {
            const insightsLink = document.querySelector('a[href*="insights"]');
            if (insightsLink) {
                insightsLink.classList.add('active');
                foundMatch = true;
                console.log('Insights page detected');

                // Keep finance dropdown open
                const financeDropdown = document.getElementById('finance-dropdown-menu');
                const financeArrow = document.querySelector('#finance-dropdown-btn .dropdown-arrow');
                if (financeDropdown && financeArrow) {
                    financeDropdown.classList.remove('hidden');
                    financeDropdown.classList.add('show');
                    financeArrow.classList.add('rotated');
                    console.log('Finance dropdown kept open for insights');
                }
            }
        }

        if (currentPath.includes('expenses') || currentPageName === 'expenses') {
            const expensesLink = document.querySelector('a[href*="expenses"]');
            if (expensesLink) {
                expensesLink.classList.add('active');
                foundMatch = true;
                console.log('Expenses page detected');

                // Keep finance dropdown open
                const financeDropdown = document.getElementById('finance-dropdown-menu');
                const financeArrow = document.querySelector('#finance-dropdown-btn .dropdown-arrow');
                if (financeDropdown && financeArrow) {
                    financeDropdown.classList.remove('hidden');
                    financeDropdown.classList.add('show');
                    financeArrow.classList.add('rotated');
                    console.log('Finance dropdown kept open for expenses');
                }
            }
        }

        if (currentPath.includes('pos') || currentPageName === 'pos') {
            const posLink = document.querySelector('a[href*="pos"]');
            if (posLink) {
                posLink.classList.add('active');
                foundMatch = true;
                console.log('POS page detected');
            }
        }
        }

        // Run on page load
        document.addEventListener('DOMContentLoaded', highlightActivePage);

        // Also run when navigation changes (for SPA-like behavior)
        window.addEventListener('popstate', highlightActivePage);

    </script>
</body>
<script src="/js/sidebar.js"></script>

</html>